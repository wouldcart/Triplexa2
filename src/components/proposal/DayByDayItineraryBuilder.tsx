import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Plus, X, MapPin, Clock, DollarSign, Save, Send, Wand2, Trash2, Car, Hotel, Activity, Eye, Camera, Calendar, LogOut, LogIn, CheckCircle2, Package, Calculator, Settings, Users, UtensilsCrossed } from "lucide-react";
import { Checkbox } from "@/components/ui/checkbox";
import { useProposalBuilder } from "@/hooks/useProposalBuilder";
import { useAutoSaveProposal } from "@/hooks/useAutoSaveProposal";
import { Query } from '@/types/query';
import { AutoDayGenerator } from './AutoDayGenerator';
import { EnhancedInventorySuggestionPanel } from './EnhancedInventorySuggestionPanel';
import { SmartSuggestionsPopover } from './SmartSuggestionsPopover';
import { formatCurrency } from '@/utils/currencyUtils';
import { useCitiesData } from '@/hooks/useCitiesData';
import { AccommodationSelector } from './AccommodationSelector';
import { CompactProposalSummary } from './CompactProposalSummary';
import { AccommodationStay, calculateTotalAccommodationCost, groupAccommodationsByDay } from '@/utils/accommodationCalculations';
import { useToast } from '@/hooks/use-toast';
import { CapacityValidator } from './transfer/CapacityValidator';
import { VehicleQuantitySelector } from './transfer/VehicleQuantitySelector';
import { useProposalPersistence } from '@/hooks/useProposalPersistence';
export interface ItineraryActivity {
  id: string;
  name: string;
  description: string;
  duration: string;
  cost: number;
  type: 'sightseeing' | 'transport' | 'meal' | 'accommodation' | 'activity';
  startTime?: string;
  endTime?: string;
  pickupLocation?: string;
  dropoffLocation?: string;
  transportType?: string;
  transportLabel?: string;
  packageOptions?: string[];
  selectedOptions?: any[];
  category?: string;
  vehicleType?: string;
  effectivePax?: number;
  priceUnit?: string;
  seatingCapacity?: number;
  vehicleCount?: number;
}
export interface ItineraryDay {
  id: string;
  dayNumber: number;
  date: string;
  city: string;
  title: string;
  description: string;
  activities: ItineraryActivity[];
  accommodation?: {
    id: string;
    name: string;
    type: string;
    price: number;
    hotel?: string;
    roomType?: string;
  };
  transport: {
    id: string;
    name: string;
    from: string;
    to: string;
    price: number;
    type?: string;
    routeCode?: string;
    vehicleType?: string;
    pickupLocation?: string;
    dropLocation?: string;
    pickupTime?: string;
    dropTime?: string;
    vehicleSummary?: string;
    totalCapacity?: number;
    totalPax?: number;
  }[];
  accommodations: {
    id: string;
    name: string;
    type: string;
    price: number;
    hotel?: string;
    roomType?: string;
  }[];
  hotelCheckout?: {
    id: string;
    name: string;
    checkoutTime: string;
    price: number;
  };
  hotelCheckin?: {
    id: string;
    name: string;
    checkinTime: string;
    price: number;
  };
  meals: {
    breakfast: boolean;
    lunch: boolean;
    dinner: boolean;
  };
  totalCost: number;
}
interface DayByDayItineraryBuilderProps {
  queryId: string;
  query?: Query;
  initialDays?: ItineraryDay[];
  onSave?: (days: ItineraryDay[]) => void;
  onDataChange?: (days: ItineraryDay[]) => void;
}
export const DayByDayItineraryBuilder: React.FC<DayByDayItineraryBuilderProps> = ({
  queryId,
  query,
  initialDays = [],
  onSave,
  onDataChange
}) => {
  const {
    toast
  } = useToast();
  
  // Editable heading state
  const [itineraryTitle, setItineraryTitle] = useState("Itinerary Builder");
  const [isEditingTitle, setIsEditingTitle] = useState(false);

  // Generate dynamic title for the itinerary
  const generateDynamicTitle = () => {
    if (query) {
      const cities = query.destination.cities?.join(", ") || query.destination.country;
      const dayCount = days.length || query.tripDuration?.days || 0;
      return `${queryId} - ${cities} - ${dayCount} Days Itinerary`;
    }
    return "Itinerary Builder";
  };

  const {
    days,
    totalCost,
    loading,
    selectedDayId,
    setSelectedDayId,
    addDay,
    addMultipleDays,
    updateDay,
    removeDay,
    autoGenerateDaysFromQuery,
    generateDaysFromCityAllocations,
    addHotelToDay,
    addTransportToDay,
    addSightseeingToDay,
    saveDraft,
    generateProposal
  } = useProposalBuilder(queryId);

  // Auto-save integration
  const {
    triggerAutoSave,
    manualSave
  } = useAutoSaveProposal({
    queryId,
    days,
    totalCost,
    enabled: true,
    debounceMs: 2000
  });

  // Proposal persistence integration for accommodation data
  const persistence = useProposalPersistence(queryId, 'daywise');

  // Auto-save status indicator
  const [lastAutoSave, setLastAutoSave] = useState<string>('');
  const [isSaving, setIsSaving] = useState(false);

  // Enhanced Effect: Sync with parent and handle data persistence - Reduced frequency
  useEffect(() => {
    // Only sync with parent when data changes, remove excessive saving
    if (onDataChange && days.length > 0) {
      onDataChange(days);
    }
  }, [days, onDataChange]);

  // Update last auto-save timestamp - Event-driven approach instead of polling
  useEffect(() => {
    const updateLastSave = () => {
      const saved = localStorage.getItem(`proposal_draft_${queryId}`);
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data.savedAt) {
            const saveTime = new Date(data.savedAt);
            setLastAutoSave(saveTime.toLocaleTimeString());
          }
        } catch (error) {
          console.error('Error parsing saved data:', error);
        }
      }
    };

    // Listen for storage events from auto-save hook
    window.addEventListener('proposal-saved', updateLastSave);
    
    // Initial check
    updateLastSave();
    
    return () => {
      window.removeEventListener('proposal-saved', updateLastSave);
    };
  }, [queryId]);

  // Load cities data
  const {
    getCitiesByCountry,
    getActiveCities
  } = useCitiesData();

  // Enhanced city list based on enquiry details
  const getAvailableCities = () => {
    if (!query) {
      return getActiveCities().map(city => city.name);
    }
    const citiesSet = new Set<string>();

    // 1. Add all cities from the query destination (primary cities)
    if (query.destination.cities && query.destination.cities.length > 0) {
      query.destination.cities.forEach(city => citiesSet.add(city));
    }

    // 2. Add all cities from the same country as secondary options
    const countryCities = getCitiesByCountry(query.destination.country);
    countryCities.forEach(city => citiesSet.add(city.name));

    // 3. Convert to array and sort with query cities first
    const allCities = Array.from(citiesSet);
    const queryCities = query.destination.cities || [];
    const otherCities = allCities.filter(city => !queryCities.includes(city)).sort();
    return [...queryCities, ...otherCities];
  };
  const availableCities = getAvailableCities();

  // Add accommodation state
  const [accommodations, setAccommodations] = useState<AccommodationStay[]>([]);
  const [accommodationsByDay, setAccommodationsByDay] = useState<Record<number, AccommodationStay[]>>({});

  // Auto-generate days when query is available and no days exist - ONLY if no saved draft exists
  useEffect(() => {
    if (query && days.length === 0) {
      // Check if there's any saved draft data first
      const draftKeys = [
        `proposal_draft_${queryId}`,
        `itinerary_builder_${queryId}`,
        `proposal_persistence_${queryId}`,
        `proposal_complete_${queryId}`
      ];
      
      const hasSavedDraft = draftKeys.some(key => {
        const saved = localStorage.getItem(key);
        if (saved) {
          try {
            const data = JSON.parse(saved);
            return data.days && data.days.length > 0;
          } catch (e) {
            return false;
          }
        }
        return false;
      });
      
      // Only auto-generate if no saved draft exists
      if (!hasSavedDraft) {
        autoGenerateDaysFromQuery(query);
      }
    }
  }, [query, days.length, autoGenerateDaysFromQuery, queryId]);

  // Load existing data on component mount - Enhanced to check URL parameters and load accommodation data
  useEffect(() => {
    const loadSavedData = () => {
      try {
        // Check URL parameters for draft loading
        const urlParams = new URLSearchParams(window.location.search);
        const loadDraft = urlParams.get('loadDraft') === 'true';
        const draftType = urlParams.get('draftType') || 'daywise';
        const draftId = urlParams.get('draftId') || queryId;
        
        // Priority loading based on URL parameters
        if (loadDraft && draftId) {
          const draftKey = `proposal_draft_${draftId}`;
          const savedDraft = localStorage.getItem(draftKey);
          if (savedDraft) {
            try {
              const draftData = JSON.parse(savedDraft);
              if (draftData.days && draftData.days.length > 0) {
                // Draft data will be loaded by the useProposalBuilder hook
                console.log('Draft will be loaded by useProposalBuilder for draft:', draftId);
                return;
              }
            } catch (e) {
              console.error('Error parsing draft data:', e);
            }
          }
        }
        
        // Load complete proposal data
        const savedProposal = localStorage.getItem(`proposal_complete_${queryId}`);
        if (savedProposal) {
          const proposalData = JSON.parse(savedProposal);

          // Load accommodations if they exist
          if (proposalData.accommodationSelections) {
            setAccommodations(proposalData.accommodationSelections);
            setAccommodationsByDay(groupAccommodationsByDay(proposalData.accommodationSelections));
          }
          console.log('Loaded saved proposal data:', {
            queryId,
            daysCount: proposalData.days?.length || 0,
            accommodationsCount: proposalData.accommodationSelections?.length || 0,
            savedAt: proposalData.timestamp
          });
        }

        // Load accommodation data from persistence system
        if (persistence.data.accommodationData?.selectedAccommodations?.length > 0) {
          const persistedAccommodations = persistence.data.accommodationData.selectedAccommodations;
          console.log('Loading accommodations from persistence:', persistedAccommodations.length);
          
          // Convert AccommodationOption[] to AccommodationStay[]
          const convertedAccommodations: AccommodationStay[] = persistedAccommodations.map(acc => ({
            id: acc.id,
            city: acc.city || '',
            hotelId: acc.id,
            hotelName: acc.hotelName,
            hotelCategory: acc.type === 'standard' ? '4-star' : acc.type === 'optional' ? '5-star' : '3-star',
            numberOfNights: acc.nights,
            numberOfRooms: acc.numberOfRooms,
            roomType: acc.roomType,
            pricePerNightPerRoom: acc.pricePerNight,
            totalPrice: acc.totalPrice,
            checkInDay: 1, // Default, will be calculated
            checkOutDay: acc.nights + 1, // Default, will be calculated
            stayDays: Array.from({ length: acc.nights }, (_, i) => i + 1),
            optionNumber: acc.type === 'standard' ? 1 : acc.type === 'optional' ? 2 : 3
          }));
          
          setAccommodations(convertedAccommodations);
          setAccommodationsByDay(groupAccommodationsByDay(convertedAccommodations));
        }
      } catch (error) {
        console.error('Error loading saved proposal data:', error);
      }
    };
    if (queryId) {
      loadSavedData();
    }
  }, [queryId, persistence.data.accommodationData]);

  // New function to get hotel status for a day
  const getHotelStatusForDay = (dayNumber: number) => {
    const dayAccommodations = accommodationsByDay[dayNumber] || [];
    const isCheckInDay = dayAccommodations.some(acc => acc.checkInDay === dayNumber);
    const isCheckOutDay = dayAccommodations.some(acc => acc.checkOutDay === dayNumber);
    const isStayDay = dayAccommodations.some(acc => acc.stayDays.includes(dayNumber) && acc.checkInDay !== dayNumber);

    // Check if there are multiple hotels on the same day (checkout + checkin)
    const checkoutHotels = dayAccommodations.filter(acc => acc.checkOutDay === dayNumber);
    const checkinHotels = dayAccommodations.filter(acc => acc.checkInDay === dayNumber);

    // Enhanced logic: For accommodations that span multiple days, checkout should be on the day after the last stay day
    // Example: 2 nights selected (Day 1 checkin, Day 2 stay, Day 3 checkout)
    const extendedCheckoutHotels = accommodations.filter(acc => {
      // If accommodation has 2 nights starting from day 1, checkout should be on day 3
      const expectedCheckoutDay = acc.checkInDay + acc.numberOfNights;
      return expectedCheckoutDay === dayNumber;
    });
    const allCheckoutHotels = [...checkoutHotels, ...extendedCheckoutHotels];
    return {
      isCheckInDay,
      isCheckOutDay: allCheckoutHotels.length > 0,
      isStayDay,
      hasMultipleHotels: allCheckoutHotels.length > 0 && checkinHotels.length > 0,
      checkoutHotels: allCheckoutHotels,
      checkinHotels,
      stayHotels: dayAccommodations.filter(acc => acc.stayDays.includes(dayNumber) && acc.checkInDay !== dayNumber && acc.checkOutDay !== dayNumber)
    };
  };

  // New function to add hotel checkout to a day
  const addHotelCheckout = (dayId: string, hotelName: string, checkoutTime: string = "12:00") => {
    const day = days.find(d => d.id === dayId);
    if (!day) return;
    const checkoutHotel = {
      id: `checkout_${Date.now()}`,
      name: hotelName,
      checkoutTime,
      price: 0 // Usually no additional cost for checkout
    };
    updateDay(dayId, {
      hotelCheckout: checkoutHotel
    });
  };

  // New function to add hotel checkin to a day
  const addHotelCheckin = (dayId: string, hotelName: string, checkinTime: string = "15:00", price: number = 0) => {
    const day = days.find(d => d.id === dayId);
    if (!day) return;
    const checkinHotel = {
      id: `checkin_${Date.now()}`,
      name: hotelName,
      checkinTime,
      price
    };
    const updatedTotalCost = calculateDayTotalCost(day, {
      hotelCheckin: checkinHotel
    });
    updateDay(dayId, {
      hotelCheckin: checkinHotel,
      totalCost: updatedTotalCost
    });
  };
  const addActivity = (dayId: string) => {
    const day = days.find(d => d.id === dayId);
    if (!day) return;
    const newActivity: ItineraryActivity = {
      id: `activity_${Date.now()}`,
      name: '',
      description: '',
      duration: '2 hours',
      cost: 0,
      type: 'activity'
    };
    const updatedActivities = [...day.activities, newActivity];
    const updatedTotalCost = calculateDayTotalCost(day, {
      activities: updatedActivities
    });
    updateDay(dayId, {
      activities: updatedActivities,
      totalCost: updatedTotalCost
    });
  };
  const updateActivity = (dayId: string, activityId: string, updates: Partial<ItineraryActivity>) => {
    const day = days.find(d => d.id === dayId);
    if (!day) return;
    const updatedActivities = day.activities.map(activity => activity.id === activityId ? {
      ...activity,
      ...updates
    } : activity);
    const updatedTotalCost = calculateDayTotalCost(day, {
      activities: updatedActivities
    });
    updateDay(dayId, {
      activities: updatedActivities,
      totalCost: updatedTotalCost
    });
  };
  const removeActivity = (dayId: string, activityId: string) => {
    const day = days.find(d => d.id === dayId);
    if (!day) return;
    const updatedActivities = day.activities.filter(activity => activity.id !== activityId);
    const updatedTotalCost = calculateDayTotalCost(day, {
      activities: updatedActivities
    });
    updateDay(dayId, {
      activities: updatedActivities,
      totalCost: updatedTotalCost
    });
  };

  // Meal handling functions
  const updateMeals = (dayId: string, mealType: 'breakfast' | 'lunch' | 'dinner', value: boolean) => {
    const day = days.find(d => d.id === dayId);
    if (!day) return;
    
    const updatedMeals = {
      ...day.meals,
      [mealType]: value
    };
    
    updateDay(dayId, {
      meals: updatedMeals
    });
  };

  // Function to check if a day has accommodations with meal plans
  const getDayAccommodationMealPlan = (dayNumber: number) => {
    const dayAccommodations = accommodationsByDay[dayNumber] || [];
    const mealPlans = dayAccommodations
      .filter(acc => acc.mealPlan)
      .map(acc => acc.mealPlan);
    
    return mealPlans;
  };

  // Function to auto-select breakfast based on accommodations
  const getAutoSelectedMeals = (dayNumber: number) => {
    const mealPlans = getDayAccommodationMealPlan(dayNumber);
    const hasAccommodation = (accommodationsByDay[dayNumber] || []).length > 0;
    
    return {
      breakfast: hasAccommodation, // Auto-select breakfast if there's accommodation
      lunch: false, // Keep manual selection
      dinner: false // Keep manual selection
    };
  };

  // Helper function to calculate total cost for a day
  const calculateDayTotalCost = (day: ItineraryDay, updates: Partial<ItineraryDay> = {}) => {
    const activities = updates.activities || day.activities;
    const transport = updates.transport || day.transport || [];
    const accommodations = updates.accommodations || day.accommodations || [];
    const accommodation = updates.accommodation || day.accommodation;
    const hotelCheckout = updates.hotelCheckout || day.hotelCheckout;
    const hotelCheckin = updates.hotelCheckin || day.hotelCheckin;
    const activitiesCost = activities.reduce((sum, activity) => sum + activity.cost, 0);
    const transportCost = transport.reduce((sum, t) => sum + t.price, 0);
    const accommodationsCost = accommodations.reduce((sum, acc) => sum + acc.price, 0);
    const singleAccommodationCost = accommodation?.price || 0;
    const checkoutCost = hotelCheckout?.price || 0;
    const checkinCost = hotelCheckin?.price || 0;
    return activitiesCost + transportCost + accommodationsCost + singleAccommodationCost + checkoutCost + checkinCost;
  };

  // Enhanced handlers for smart suggestions with multiple options support
  const handleSmartAddHotel = (dayId: string, hotel: any, price: number) => {
    const day = days.find(d => d.id === dayId);
    if (!day) return;
    const newAccommodation = {
      id: `hotel_${Date.now()}`,
      name: hotel.name,
      type: 'hotel',
      price: price,
      hotel: hotel.name,
      roomType: hotel.roomTypes?.[0]?.name || 'Standard Room'
    };
    const updatedAccommodations = [...(day.accommodations || []), newAccommodation];
    const updatedTotalCost = calculateDayTotalCost(day, {
      accommodations: updatedAccommodations
    });
    updateDay(dayId, {
      accommodations: updatedAccommodations,
      totalCost: updatedTotalCost
    });
  };
  const handleSmartAddTransport = (dayId: string, transport: any, price: number) => {
    const day = days.find(d => d.id === dayId);
    if (!day) return;
    const newTransport = {
      id: `transport_${Date.now()}`,
      name: transport.name,
      from: transport.startLocationFullName || transport.startLocation || 'Origin',
      to: transport.endLocationFullName || transport.endLocation || 'Destination',
      price: price,
      type: transport.transferType || transport.type,
      routeCode: transport.code || transport.routeCode,
      vehicleType: transport.selectedVehicleType || transport.vehicleType,
      pickupLocation: '',
      dropLocation: '',
      pickupTime: '',
      dropTime: '',
      // Enhanced vehicle selection data from Smart Combinations and Manual Selection
      isMultiVehicle: transport.isMultiVehicle || false,
      vehicleSummary: transport.vehicleSummary,
      multiVehicleSelection: transport.multiVehicleSelection,
      selectedVehicles: transport.selectedVehicles,
      totalCapacity: transport.totalCapacity,
      vehicleCount: transport.vehicleCount,
      totalPax: query?.paxDetails ? query.paxDetails.adults + query.paxDetails.children : undefined,
      // For single vehicle selections, ensure we still show configuration
      ...(transport.selectedVehicleType && !transport.isMultiVehicle && {
        vehicleSummary: `1x ${transport.selectedVehicleType}`,
        totalCapacity: transport.capacity || 4,
        vehicleCount: 1
      })
    };
    const updatedTransport = [...(day.transport || []), newTransport];
    const updatedTotalCost = calculateDayTotalCost(day, {
      transport: updatedTransport
    });
    updateDay(dayId, {
      transport: updatedTransport,
      totalCost: updatedTotalCost
    });
  };
  const handleSmartAddActivity = (dayId: string, activity: any, price: number) => {
    // Extract enhanced data from SmartSuggestionsPopover
    const pricingSelection = activity.pricingSelection || {};
    const selectedOptions = activity.selectedOptions || {};
    const newActivity: ItineraryActivity = {
      id: `activity_${Date.now()}`,
      name: activity.name,
      description: activity.description || '',
      duration: activity.duration || selectedOptions.duration || '2 hours',
      cost: price,
      type: 'sightseeing',
      pickupLocation: activity.pickupLocation || '',
      dropoffLocation: activity.dropoffLocation || '',
      // Preserve enhanced data structure for summary display
      category: activity.category,
      effectivePax: activity.effectivePax || pricingSelection.customPax,
      priceUnit: activity.priceUnit,
      // Map pricing selection to selectedOptions format for compatibility - preserve full object structure
      selectedOptions: pricingSelection.pricingType === 'package' && pricingSelection.selectedPackageOption ? 
        activity.packageOptions?.filter((pkg: any) => pkg.id === pricingSelection.selectedPackageOption) || [] : 
        pricingSelection.pricingType === 'option' && pricingSelection.selectedPricingOption ? 
        activity.pricingOptions?.filter((opt: any) => opt.id === pricingSelection.selectedPricingOption) || [] : [],
      // Preserve package options for display
      packageOptions: activity.packageOptions?.map((pkg: any) => pkg.name || pkg.title || pkg.id) || [],
      // Map transfer information to transport fields
      transportType: pricingSelection.transferOption?.included ? pricingSelection.transferOption.type || 'private_car' : 'none',
      vehicleType: pricingSelection.transferOption?.included ? pricingSelection.transferOption.type : undefined,
      transportLabel: pricingSelection.transferOption?.included ? `${pricingSelection.transferOption.priceUnit === 'per-vehicle' ? 'Private' : 'Shared'} Transfer` : undefined
    };
    const day = days.find(d => d.id === dayId);
    if (!day) return;
    const updatedActivities = [...day.activities, newActivity];
    const updatedTotalCost = calculateDayTotalCost(day, {
      activities: updatedActivities
    });
    updateDay(dayId, {
      activities: updatedActivities,
      totalCost: updatedTotalCost
    });
  };

  // Functions to remove multiple options
  const removeTransportFromDay = (dayId: string, transportId: string) => {
    const day = days.find(d => d.id === dayId);
    if (!day) return;
    const updatedTransport = (day.transport || []).filter(t => t.id !== transportId);
    const updatedTotalCost = calculateDayTotalCost(day, {
      transport: updatedTransport
    });
    updateDay(dayId, {
      transport: updatedTransport,
      totalCost: updatedTotalCost
    });
  };
  const removeAccommodationFromDay = (dayId: string, accommodationId: string) => {
    const day = days.find(d => d.id === dayId);
    if (!day) return;
    const updatedAccommodations = (day.accommodations || []).filter(acc => acc.id !== accommodationId);
    const updatedTotalCost = calculateDayTotalCost(day, {
      accommodations: updatedAccommodations
    });
    updateDay(dayId, {
      accommodations: updatedAccommodations,
      totalCost: updatedTotalCost
    });
  };

  // Update total cost calculation to include accommodations
  const accommodationCost = calculateTotalAccommodationCost(accommodations);
  const enhancedTotalCost = totalCost + accommodationCost;

  // Handle accommodation changes - Enhanced with persistence
  const handleAccommodationAdd = (accommodation: AccommodationStay) => {
    const updatedAccommodations = [...accommodations, accommodation];
    setAccommodations(updatedAccommodations);
    setAccommodationsByDay(groupAccommodationsByDay(updatedAccommodations));
    
    // Save to persistence system
    const accommodationData = {
      selectedAccommodations: updatedAccommodations.map(acc => ({
        id: acc.id,
        hotelName: acc.hotelName,
        roomType: acc.roomType,
        nights: acc.numberOfNights,
        pricePerNight: acc.pricePerNightPerRoom,
        numberOfRooms: acc.numberOfRooms,
        totalPrice: acc.totalPrice,
        type: (acc.optionNumber === 1 ? 'standard' : acc.optionNumber === 2 ? 'optional' : 'alternative') as 'standard' | 'optional' | 'alternative',
        dayId: acc.checkInDay.toString(),
        city: acc.city
      })),
      markupData: persistence.data.accommodationData.markupData
    };
    
    persistence.updateAccommodationData(accommodationData);
    console.log('Added accommodation with persistence:', accommodation);
  };
  
  const handleAccommodationUpdate = (updatedAccommodation: AccommodationStay) => {
    const updatedAccommodations = accommodations.map(acc => acc.id === updatedAccommodation.id ? updatedAccommodation : acc);
    setAccommodations(updatedAccommodations);
    setAccommodationsByDay(groupAccommodationsByDay(updatedAccommodations));
    
    // Save to persistence system
    const accommodationData = {
      selectedAccommodations: updatedAccommodations.map(acc => ({
        id: acc.id,
        hotelName: acc.hotelName,
        roomType: acc.roomType,
        nights: acc.numberOfNights,
        pricePerNight: acc.pricePerNightPerRoom,
        numberOfRooms: acc.numberOfRooms,
        totalPrice: acc.totalPrice,
        type: (acc.optionNumber === 1 ? 'standard' : acc.optionNumber === 2 ? 'optional' : 'alternative') as 'standard' | 'optional' | 'alternative',
        dayId: acc.checkInDay.toString(),
        city: acc.city
      })),
      markupData: persistence.data.accommodationData.markupData
    };
    
    persistence.updateAccommodationData(accommodationData);
    console.log('Updated accommodation with persistence:', updatedAccommodation);
  };
  
  const handleAccommodationRemove = (accommodationId: string) => {
    const updatedAccommodations = accommodations.filter(acc => acc.id !== accommodationId);
    setAccommodations(updatedAccommodations);
    setAccommodationsByDay(groupAccommodationsByDay(updatedAccommodations));
    
    // Save to persistence system
    const accommodationData = {
      selectedAccommodations: updatedAccommodations.map(acc => ({
        id: acc.id,
        hotelName: acc.hotelName,
        roomType: acc.roomType,
        nights: acc.numberOfNights,
        pricePerNight: acc.pricePerNightPerRoom,
        numberOfRooms: acc.numberOfRooms,
        totalPrice: acc.totalPrice,
        type: (acc.optionNumber === 1 ? 'standard' : acc.optionNumber === 2 ? 'optional' : 'alternative') as 'standard' | 'optional' | 'alternative',
        dayId: acc.checkInDay.toString(),
        city: acc.city
      })),
      markupData: persistence.data.accommodationData.markupData
    };
    
    persistence.updateAccommodationData(accommodationData);
    console.log('Removed accommodation with persistence:', accommodationId);
  };

  // Enhanced save function to capture ALL selection data
  const handleSaveProposal = async () => {
    try {
      setIsSaving(true);

      // Comprehensive data collection
      const proposalData = {
        queryId,
        timestamp: new Date().toISOString(),
        version: Date.now(),
        // Core itinerary data
        days: days.map(day => ({
          ...day,
          // Ensure all day data is captured
          activities: day.activities || [],
          transport: day.transport || [],
          accommodations: day.accommodations || [],
          meals: day.meals || {
            breakfast: false,
            lunch: false,
            dinner: false
          },
          totalCost: day.totalCost || 0
        })),
        // Accommodation selections
        accommodationSelections: accommodations.map(acc => ({
          ...acc,
          selectionTimestamp: new Date().toISOString()
        })),
        // Cost calculations
        costBreakdown: {
          daysCost: totalCost,
          accommodationCost: calculateTotalAccommodationCost(accommodations),
          totalCost: totalCost + calculateTotalAccommodationCost(accommodations)
        },
        // Query context
        queryContext: {
          destination: query?.destination,
          travelDates: query?.travelDates,
          paxDetails: query?.paxDetails,
          packageType: query?.packageType
        },
        // User selections and preferences
        userSelections: {
          selectedDayId,
          totalDays: days.length,
          citiesVisited: [...new Set(days.map(day => day.city))],
          activitiesCount: days.reduce((sum, day) => sum + day.activities.length, 0),
          transportCount: days.reduce((sum, day) => sum + (day.transport?.length || 0), 0),
          accommodationsCount: accommodations.length
        }
      };

      // Save to multiple storage locations for redundancy

      // 1. Save to localStorage (primary storage)
      localStorage.setItem(`proposal_complete_${queryId}`, JSON.stringify(proposalData));

      // 2. Save to sessionStorage (backup)
      sessionStorage.setItem(`proposal_session_${queryId}`, JSON.stringify(proposalData));

      // 3. Save days data separately for backward compatibility
      localStorage.setItem(`proposal_days_${queryId}`, JSON.stringify(days));

      // 4. Save accommodations separately
      localStorage.setItem(`proposal_accommodations_${queryId}`, JSON.stringify(accommodations));

      // 5. Trigger the hook-based save
      await saveDraft();
      manualSave();

      // 6. Call parent onSave if provided
      if (onSave) {
        onSave(days);
      }

      // Log successful save
      console.log('Complete proposal data saved:', {
        queryId,
        daysCount: days.length,
        accommodationsCount: accommodations.length,
        totalCost: proposalData.costBreakdown.totalCost,
        timestamp: proposalData.timestamp
      });

      // Show success toast
      toast({
        title: "Proposal Saved Successfully",
        description: `Saved ${days.length} days, ${accommodations.length} accommodations, and all selections.`,
        variant: "default"
      });
    } catch (error) {
      console.error('Error saving comprehensive proposal data:', error);

      // Show error toast
      toast({
        title: "Save Failed",
        description: "Unable to save proposal data. Please try again.",
        variant: "destructive"
      });
    } finally {
      setIsSaving(false);
    }
  };
  const handleGenerateProposal = async () => {
    try {
      const proposalId = await generateProposal();
      console.log('Generated proposal:', proposalId);
    } catch (error) {
      console.error('Error generating proposal:', error);
    }
  };
  const handleDayCardClick = (dayId: string) => {
    setSelectedDayId(selectedDayId === dayId ? null : dayId);
  };
  return <div className="w-full max-w-none space-y-6">
      {/* Enhanced Header Section - Full Width */}
      <div className="space-y-4">
        {/* Title and Summary Row */}
        <div className="flex flex-col xl:flex-row xl:items-start xl:justify-between gap-3">
          <div className="space-y-2 flex-1">
            {isEditingTitle ? (
              <Input
                value={itineraryTitle}
                onChange={(e) => setItineraryTitle(e.target.value)}
                onBlur={() => setIsEditingTitle(false)}
                onKeyDown={(e) => {
                  if (e.key === 'Enter') {
                    setIsEditingTitle(false);
                  }
                  if (e.key === "Escape") {
                    setItineraryTitle(generateDynamicTitle());
                    setIsEditingTitle(false);
                  }
                }}
                className="text-xl sm:text-2xl font-bold border-none p-0 h-auto bg-transparent focus:ring-0 focus:border-b-2 focus:border-primary"
                autoFocus
              />
            ) : (
              <h2 
                className="text-xl sm:text-2xl font-bold cursor-pointer hover:text-primary transition-colors"
                onClick={() => setIsEditingTitle(true)}
                title="Click to edit title"
              >
                {query ? 
                  `${queryId} - ${query.destination.cities?.join(", ") || query.destination.country} - ${days.length || query.tripDuration?.days || 0} Days Itinerary` : 
                  "Itinerary Builder"
                }
              </h2>
            )}
            <div className="flex flex-wrap items-center gap-2 text-sm text-muted-foreground">
              <div className="flex items-center gap-1">
                <DollarSign className="h-4 w-4" />
                <span className="font-semibold">{formatCurrency(enhancedTotalCost, query?.destination.country || 'USA')}</span>
              </div>
              {accommodationCost > 0 && <>
                  <span>•</span>
                  <span className="text-green-600">
                    Hotels: {formatCurrency(accommodationCost, query?.destination.country || 'USA')}
                  </span>
                </>}
              {query && <>
                  <span>•</span>
                  <span>{query.paxDetails.adults + query.paxDetails.children} travelers</span>
                  {query.travelDates?.from && query.travelDates?.to && <>
                      <span>•</span>
                      <span className="text-blue-600">
                        {new Date(query.travelDates.from).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                  })} - {new Date(query.travelDates.to).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                  })}
                      </span>
                    </>}
                </>}
            </div>
          </div>
          
          {/* Action Buttons with Auto-save Status */}
          <div className="flex flex-col gap-2 xl:items-end">
            <div className="flex flex-wrap gap-2">
              <Button variant="outline" size="sm" onClick={addDay} className="flex-1 sm:flex-none">
                <Plus className="h-4 w-4 mr-1" />
                <span className="hidden xs:inline">Add Day</span>
                <span className="xs:hidden">Day</span>
              </Button>
              <Button variant="outline" size="sm" onClick={handleSaveProposal} disabled={loading || isSaving} className="flex-1 sm:flex-none">
                <Save className="h-4 w-4 mr-1" />
                <span className="hidden xs:inline">{isSaving ? 'Saving...' : 'Save'}</span>
                <span className="xs:hidden">{isSaving ? '...' : 'Save'}</span>
              </Button>
              <Button size="sm" onClick={handleGenerateProposal} disabled={loading || days.length === 0} className="flex-1 sm:flex-none">
                <Send className="h-4 w-4 mr-1" />
                <span className="hidden xs:inline">Generate</span>
              </Button>
            </div>
            
            {/* Auto-save Status */}
            {lastAutoSave && <div className="flex items-center gap-1 text-xs text-green-600 bg-green-50 dark:bg-green-950/20 px-2 py-1 rounded border border-green-200 dark:border-green-800">
                <CheckCircle2 className="h-3 w-3" />
                <span>Auto-saved {lastAutoSave}</span>
              </div>}
          </div>
        </div>

        {/* Compact Proposal Summary */}
        <CompactProposalSummary days={days} query={query} accommodations={accommodations} accommodationsByDay={accommodationsByDay} />

        {/* Destination and Stats Badges */}
        {query && <div className="flex flex-wrap items-center gap-2">
            <Badge variant="outline" className="text-xs">
              <MapPin className="h-3 w-3 mr-1" />
              {query.destination.country}
            </Badge>
            <Badge variant="secondary" className="text-xs">
              {availableCities.length} cities
            </Badge>
            {query.destination.cities.length > 0 && <Badge variant="default" className="text-xs">
                {query.destination.cities.slice(0, 2).join(', ')}
                {query.destination.cities.length > 2 && ` +${query.destination.cities.length - 2}`}
              </Badge>}
            {/* Travel Period Badge */}
            {query.travelDates?.from && query.travelDates?.to && <Badge variant="outline" className="text-xs bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 border-green-200 dark:border-green-800">
                <Calendar className="h-3 w-3 mr-1" />
                {new Date(query.travelDates.from).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric'
          })} - {new Date(query.travelDates.to).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric'
          })}
              </Badge>}
          </div>}
      </div>

      {/* Full Width Content Layout */}
      <div className="grid grid-cols-1 xl:grid-cols-4 gap-6">
        {/* Main Content - Takes up more space */}
        <div className="xl:col-span-4 space-y-6">
          {/* Auto Day Generator */}
          {query && <AutoDayGenerator query={query} currentDayCount={days.length} onGenerateDays={count => addMultipleDays(count)} onGenerateDaysFromCityAllocations={generateDaysFromCityAllocations} onAddSingleDay={addDay} />}

          {/* Accommodation Section */}
          {query && <AccommodationSelector query={query} days={days} accommodations={accommodations} onAccommodationAdd={handleAccommodationAdd} onAccommodationRemove={handleAccommodationRemove} onAccommodationUpdate={handleAccommodationUpdate} queryId={queryId} />}

          {/* Days List with Enhanced Hotel Status */}
          <div className="space-y-4">
            {days.map(day => {
            const hotelStatus = getHotelStatusForDay(day.dayNumber);
            return <Card key={day.id} className={`overflow-hidden cursor-pointer transition-all border ${selectedDayId === day.id ? 'ring-2 ring-primary border-primary bg-primary/5 dark:bg-primary/10' : 'hover:shadow-md hover:border-primary/20 dark:hover:border-primary/30'}`} onClick={() => handleDayCardClick(day.id)}>
                  <CardHeader className="pb-2 space-y-2 bg-gradient-to-r from-slate-50 via-blue-50 to-purple-50 dark:from-slate-900/50 dark:via-blue-900/20 dark:to-purple-900/20 border-b border-gradient-to-r from-slate-200 via-blue-200 to-purple-200 dark:from-slate-700 dark:via-blue-800 dark:to-purple-800">
                    <div className="flex items-start justify-between gap-3">
                      {/* Left Side - Day Badge and Title */}
                      <div className="flex items-start gap-2 min-w-0 flex-1">
                        <Badge variant={selectedDayId === day.id ? "default" : "outline"} className={`shrink-0 text-xs px-2 py-1 font-semibold ${selectedDayId === day.id ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white border-0' : 'bg-gradient-to-r from-blue-100 to-purple-100 dark:from-blue-900/40 dark:to-purple-900/40 text-blue-800 dark:text-blue-200 border-blue-300 dark:border-blue-700'}`}>
                          Day {day.dayNumber}
                        </Badge>
                        <div className="min-w-0 flex-1 space-y-1">
                          <CardTitle className="text-lg font-bold bg-gradient-to-r from-slate-800 via-blue-700 to-purple-700 dark:from-slate-200 dark:via-blue-300 dark:to-purple-300 bg-clip-text text-transparent leading-tight">
                            {day.title || `Day ${day.dayNumber}`}
                          </CardTitle>
                          
                          {/* Location and Date Row */}
                          <div className="flex flex-wrap items-center gap-2 text-xs">
                            <div className="flex items-center gap-1 bg-gradient-to-r from-emerald-100 to-teal-100 dark:from-emerald-900/30 dark:to-teal-900/30 px-2 py-1 rounded border border-emerald-200 dark:border-emerald-800">
                              <MapPin className="h-3 w-3 text-emerald-600 dark:text-emerald-400" />
                              <span className="font-medium text-emerald-800 dark:text-emerald-200">{day.city}</span>
                            </div>
                            <div className="flex items-center gap-1 bg-gradient-to-r from-amber-100 to-orange-100 dark:from-amber-900/30 dark:to-orange-900/30 px-2 py-1 rounded border border-amber-200 dark:border-amber-800">
                              <Calendar className="h-3 w-3 text-amber-600 dark:text-amber-400" />
                              <span className="font-medium text-amber-800 dark:text-amber-200">{day.date}</span>
                            </div>
                          </div>

                          {/* Compact Activity Summary */}
                          <div className="flex flex-wrap items-center gap-1 text-xs">
                            {/* Activities Count */}
                            <div className="flex items-center gap-1 bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/40 dark:to-pink-900/40 text-purple-800 dark:text-purple-200 px-2 py-1 rounded border border-purple-200 dark:border-purple-700">
                              <Activity className="h-3 w-3 text-purple-600 dark:text-purple-400" />
                              <span className="font-medium">{day.activities.length}</span>
                            </div>
                            
                            {/* Transport Count */}
                            {day.transport && day.transport.length > 0 && <div className="flex items-center gap-1 bg-gradient-to-r from-blue-100 to-cyan-100 dark:from-blue-900/40 dark:to-cyan-900/40 text-blue-800 dark:text-blue-200 px-2 py-1 rounded border border-blue-200 dark:border-blue-700">
                                <Car className="h-3 w-3 text-blue-600 dark:text-blue-400" />
                                <span className="font-medium">{day.transport.length}</span>
                              </div>}
                            
                            {/* Enhanced Hotel Status Badges */}
                            {hotelStatus.isCheckOutDay && <Badge className="bg-gradient-to-r from-orange-500 to-red-500 text-white text-xs px-2 py-0.5 border-0">
                                <LogOut className="h-3 w-3 mr-1" />
                                Check-out
                              </Badge>}
                            {hotelStatus.isCheckInDay && <Badge className="bg-gradient-to-r from-green-500 to-emerald-500 text-white text-xs px-2 py-0.5 border-0">
                                <LogIn className="h-3 w-3 mr-1" />
                                Check-in
                              </Badge>}
                            {hotelStatus.isStayDay && !hotelStatus.isCheckInDay && !hotelStatus.isCheckOutDay && <Badge className="bg-gradient-to-r from-slate-400 to-slate-500 text-white text-xs px-2 py-0.5 border-0">
                                <Hotel className="h-3 w-3 mr-1" />
                                Stay
                              </Badge>}
                            {hotelStatus.hasMultipleHotels && <Badge className="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs px-2 py-0.5 border-0">
                                Hotel Transfer
                              </Badge>}
                          </div>
                        </div>
                      </div>

                      {/* Right Side - Cost and Actions */}
                      <div className="flex items-start gap-2 shrink-0">
                        <div className="text-right bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 p-2 rounded border border-green-200 dark:border-green-800">
                          <div className="flex items-center gap-1 text-sm font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">
                            <DollarSign className="h-4 w-4 text-green-600 dark:text-green-400" />
                            <span>{formatCurrency(day.totalCost, query?.destination.country || 'USA')}</span>
                          </div>
                          <div className="text-xs font-medium text-green-700 dark:text-green-300">per day</div>
                        </div>
                        <Button variant="ghost" size="sm" onClick={e => {
                      e.stopPropagation();
                      removeDay(day.id);
                    }} className="text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 shrink-0 h-8 w-8 p-0 rounded transition-all duration-200">
                          <X className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>

                    {/* Compact Description Preview */}
                    {day.description && <div className="bg-gradient-to-r from-slate-100/80 to-blue-100/80 dark:from-slate-800/50 dark:to-blue-900/30 p-2 rounded border border-slate-200 dark:border-slate-700">
                        <p className="text-xs text-slate-700 dark:text-slate-300 line-clamp-1 leading-relaxed">
                          {day.description}
                        </p>
                      </div>}
                  </CardHeader>
                  <CardContent className="space-y-4">
                    {/* Enhanced Hotel Checkout/Checkin Display */}
                    {(hotelStatus.checkoutHotels.length > 0 || hotelStatus.checkinHotels.length > 0 || hotelStatus.stayHotels.length > 0 || day.hotelCheckout || day.hotelCheckin) && <div className="space-y-6 p-4 bg-secondary/5 rounded-lg border border-secondary/20">
                        <h4 className="font-medium flex items-center gap-2">
                          <Hotel className="h-4 w-4" />
                          Hotel Activities
                        </h4>
                        
                        {/* Hotel Checkout - Enhanced to show accommodations checkout */}
                        {(day.hotelCheckout || hotelStatus.checkoutHotels.length > 0) && <div className="border-l-4 border-l-orange-600/60 shadow-sm hover:shadow-md transition-all duration-200 bg-gradient-to-r from-card to-orange-50/50 dark:to-orange-950/20 rounded-lg">
                            <div className="p-4">
                              <div className="flex items-center gap-2 mb-3">
                                <LogOut className="h-4 w-4 text-orange-600" />
                                <h5 className="font-semibold text-base text-orange-900 dark:text-orange-100">Hotel Check-out</h5>
                                <Badge variant="outline" className="text-xs bg-orange-100 dark:bg-orange-900/20 border-orange-300 dark:border-orange-700 text-orange-600 dark:text-orange-400">
                                  Departure
                                </Badge>
                              </div>
                              
                              {day.hotelCheckout && <div className="space-y-2 mb-3 p-3 bg-orange-50/50 dark:bg-orange-950/30 rounded-md">
                                  <div className="flex items-center gap-2">
                                    <Hotel className="h-3 w-3 text-orange-600" />
                                    <p className="font-medium text-sm text-orange-800 dark:text-orange-200">{day.hotelCheckout.name}</p>
                                  </div>
                                  <p className="text-xs text-orange-700 dark:text-orange-300 ml-5">Check-out time: {day.hotelCheckout.checkoutTime}</p>
                                </div>}
                              
                              {hotelStatus.checkoutHotels.map(hotel => <div key={hotel.id} className="space-y-2 p-3 bg-orange-50/50 dark:bg-orange-950/30 rounded-md border border-orange-200/50 dark:border-orange-800/30">
                                  <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                      <Hotel className="h-3 w-3 text-orange-600" />
                                      <p className="font-medium text-sm text-orange-800 dark:text-orange-200">{hotel.hotelName}</p>
                                    </div>
                                    <Badge variant="secondary" className="text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300">
                                      Completed
                                    </Badge>
                                  </div>
                                  <div className="ml-5 space-y-1">
                                    <p className="text-xs text-orange-700 dark:text-orange-300">
                                      Completed {hotel.numberOfNights} night{hotel.numberOfNights > 1 ? 's' : ''} stay
                                    </p>
                                    <p className="text-xs font-medium text-orange-600 dark:text-orange-400">
                                      Total cost: {formatCurrency(hotel.totalPrice, query?.destination.country || 'USA')}
                                    </p>
                                  </div>
                                </div>)}
                            </div>
                          </div>}

                        {/* Hotel Check-in */}
                        {(day.hotelCheckin || hotelStatus.checkinHotels.length > 0) && <div className="border-l-4 border-l-green-600/60 shadow-sm hover:shadow-md transition-all duration-200 bg-gradient-to-r from-card to-green-50/50 dark:to-green-950/20 rounded-lg">
                            <div className="p-4">
                              <div className="flex items-center gap-2 mb-3">
                                <LogIn className="h-4 w-4 text-green-600" />
                                <h5 className="font-semibold text-base text-green-900 dark:text-green-100">Hotel Check-in</h5>
                                <Badge variant="outline" className="text-xs bg-green-100 dark:bg-green-900/20 border-green-300 dark:border-green-700 text-green-600 dark:text-green-400">
                                  Arrival
                                </Badge>
                              </div>
                              
                              {day.hotelCheckin && <div className="space-y-2 mb-3 p-3 bg-green-50/50 dark:bg-green-950/30 rounded-md">
                                  <div className="flex items-center gap-2">
                                    <Hotel className="h-3 w-3 text-green-600" />
                                    <p className="font-medium text-sm text-green-800 dark:text-green-200">{day.hotelCheckin.name}</p>
                                  </div>
                                  <p className="text-xs text-green-700 dark:text-green-300 ml-5">Check-in time: {day.hotelCheckin.checkinTime}</p>
                                  {day.hotelCheckin.price > 0 && <p className="text-xs font-medium text-green-700 dark:text-green-300 ml-5">
                                      Additional cost: {formatCurrency(day.hotelCheckin.price, query?.destination.country || 'USA')}
                                    </p>}
                                </div>}
                              
                              {hotelStatus.checkinHotels.map(hotel => <div key={hotel.id} className="space-y-2 p-3 bg-green-50/50 dark:bg-green-950/30 rounded-md border border-green-200/50 dark:border-green-800/30">
                                  <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                      <Hotel className="h-3 w-3 text-green-600" />
                                      <p className="font-medium text-sm text-green-800 dark:text-green-200">{hotel.hotelName}</p>
                                    </div>
                                    <Badge variant="secondary" className="text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">
                                      {hotel.numberOfNights}N
                                    </Badge>
                                  </div>
                                  <div className="ml-5 space-y-1">
                                    <p className="text-xs text-green-700 dark:text-green-300">
                                      Starting {hotel.numberOfNights} night{hotel.numberOfNights > 1 ? 's' : ''} stay
                                    </p>
                                    <p className="text-xs font-medium text-green-600 dark:text-green-400">
                                      Total cost: {formatCurrency(hotel.totalPrice, query?.destination.country || 'USA')}
                                    </p>
                                  </div>
                                </div>)}
                            </div>
                          </div>}

                        {/* Staying Hotels */}
                        {hotelStatus.stayHotels.length > 0 && <div className="border-l-4 border-l-blue-600/60 shadow-sm hover:shadow-md transition-all duration-200 bg-gradient-to-r from-card to-blue-50/50 dark:to-blue-950/20 rounded-lg">
                            <div className="p-4">
                              <div className="flex items-center gap-2 mb-3">
                                <Hotel className="h-4 w-4 text-blue-600" />
                                <h5 className="font-semibold text-base text-blue-900 dark:text-blue-100">Staying at Hotel</h5>
                                <Badge variant="outline" className="text-xs bg-blue-100 dark:bg-blue-900/20 border-blue-300 dark:border-blue-700 text-blue-600 dark:text-blue-400">
                                  Ongoing
                                </Badge>
                              </div>
                              
                              {hotelStatus.stayHotels.map(hotel => <div key={hotel.id} className="space-y-2 p-3 bg-blue-50/50 dark:bg-blue-950/30 rounded-md border border-blue-200/50 dark:border-blue-800/30">
                                  <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                      <Hotel className="h-3 w-3 text-blue-600" />
                                      <p className="font-medium text-sm text-blue-800 dark:text-blue-200">{hotel.hotelName}</p>
                                    </div>
                                    <Badge variant="secondary" className="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
                                      Night {hotel.stayDays.indexOf(day.dayNumber) + 1}/{hotel.numberOfNights}
                                    </Badge>
                                  </div>
                                  <div className="ml-5">
                                    <p className="text-xs text-blue-700 dark:text-blue-300">
                                      Continuing stay • Room: {hotel.roomType || 'Standard Room'}
                                    </p>
                                  </div>
                                </div>)}
                            </div>
                          </div>}
                      </div>}

                    {/* 1. Day Title */}
                    <div>
                      <label className="text-sm font-medium">Day Title</label>
                      <Input value={day.title} onChange={e => updateDay(day.id, {
                    title: e.target.value
                  })} placeholder={`Day ${day.dayNumber} - Enter title`} onClick={e => e.stopPropagation()} />
                    </div>

                    {/* 2. City/Destination */}
                    <div>
                      <label className="text-sm font-medium flex items-center gap-2">
                        City/Destination
                        {query && query.destination.cities.includes(day.city) && <Badge variant="outline" className="text-xs">Primary</Badge>}
                      </label>
                      <Select value={day.city} onValueChange={value => updateDay(day.id, {
                    city: value
                  })}>
                        <SelectTrigger onClick={e => e.stopPropagation()}>
                          <SelectValue placeholder="Select city/destination" />
                        </SelectTrigger>
                        <SelectContent>
                          {query && query.destination.cities.length > 0 && <>
                              <div className="px-2 py-1.5 text-xs font-semibold text-muted-foreground">
                                Primary Destinations
                              </div>
                              {query.destination.cities.map(city => <SelectItem key={`primary-${city}`} value={city}>
                                  <div className="flex items-center gap-2">
                                    <span>{city}</span>
                                    <Badge variant="default" className="text-xs">Primary</Badge>
                                  </div>
                                </SelectItem>)}
                              <div className="border-t my-1"></div>
                              <div className="px-2 py-1.5 text-xs font-semibold text-muted-foreground">
                                Other Cities in {query.destination.country}
                              </div>
                            </>}
                          {availableCities.filter(city => !query?.destination.cities.includes(city)).map(city => <SelectItem key={`other-${city}`} value={city}>
                                {city}
                              </SelectItem>)}
                        </SelectContent>
                      </Select>
                    </div>

                    {/* 3. Description */}
                    <div>
                      <label className="text-sm font-medium">Description</label>
                      <Textarea value={day.description} onChange={e => updateDay(day.id, {
                    description: e.target.value
                  })} placeholder="Brief description of the day" rows={2} onClick={e => e.stopPropagation()} />
                    </div>

                    <Separator />

                     {/* 4. Transport Options */}
                     {day.transport && day.transport.length > 0 && <div className="space-y-3">
                         <h4 className="font-medium flex items-center gap-2">
                           <Car className="h-4 w-4" />
                           Transport Options ({day.transport.length})
                         </h4>
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {day.transport.map(transport => <div key={transport.id} className="p-3 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800/50 rounded-lg hover:shadow-sm transition-shadow">
                                <div className="flex items-start justify-between">
                                  <div className="flex-1 space-y-3">
                                    {/* Header - Route Info */}
                                    <div className="flex items-center justify-between">
                                      <div className="flex items-center gap-2">
                                        <h5 className="font-semibold text-blue-900 dark:text-blue-100">{transport.name}</h5>
                                        {transport.routeCode && <Badge variant="secondary" className="text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300">
                                            {transport.routeCode}
                                          </Badge>}
                                      </div>
                                      <Badge variant={transport.type === 'private' ? 'default' : 'secondary'} className="text-xs">
                                        {transport.type === 'private' ? 'Private' : transport.type === 'shared' ? 'Shared' : 'Standard'}
                                      </Badge>
                                    </div>

                                    {/* Route Direction */}
                                    <div className="flex items-center gap-1 text-sm text-blue-700 dark:text-blue-300">
                                      <span className="font-medium">{transport.from ?? 'Unknown'}</span>
                                      <span className="text-blue-500 dark:text-blue-400">→</span>
                                      <span className="font-medium">{transport.to ?? 'Unknown'}</span>
                                    </div>
                                    
                                    {/* Pickup and Drop Details - Compact */}
                                    {(transport.pickupLocation || transport.dropLocation || transport.pickupTime || transport.dropTime) && <div className="grid grid-cols-1 gap-1 text-xs text-blue-600 dark:text-blue-400 bg-blue-100/50 dark:bg-blue-900/30 p-2 rounded">
                                        {transport.pickupLocation && <div className="flex items-center gap-1">
                                            <MapPin className="h-3 w-3 shrink-0" />
                                            <span className="font-medium">Pickup:</span>
                                            <span className="truncate">{transport.pickupLocation}</span>
                                            {transport.pickupTime && <span className="text-blue-500">@ {transport.pickupTime}</span>}
                                          </div>}
                                        {transport.dropLocation && <div className="flex items-center gap-1">
                                            <MapPin className="h-3 w-3 shrink-0" />
                                            <span className="font-medium">Drop:</span>
                                            <span className="truncate">{transport.dropLocation}</span>
                                            {transport.dropTime && <span className="text-blue-500">@ {transport.dropTime}</span>}
                                          </div>}
                                      </div>}
                                    
                                    {/* Enhanced Transport Routes & Vehicle Details */}
                                    {(transport.vehicleSummary || transport.vehicleType) && <div className="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/30 rounded-lg border border-blue-200 dark:border-blue-800 p-4 space-y-4">
                                        
                                        {/* Transport Header with Route Information */}
                                        <div className="flex items-center justify-between border-b border-blue-200 dark:border-blue-700 pb-3">
                                          <div className="flex items-center gap-2">
                                            <Car className="h-5 w-5 text-blue-600 dark:text-blue-400" />
                                            <h4 className="font-semibold text-blue-900 dark:text-blue-100">Transport Configuration</h4>
                                          </div>
                                          <div className="flex items-center gap-2">
                                            <Badge variant="outline" className="text-xs">
                                              Route Active
                                            </Badge>
                                          </div>
                                        </div>

                                        {/* Smart Vehicle Combinations */}
                                        {transport.vehicleSummary && transport.vehicleSummary.includes(' + ') && <div className="space-y-3">
                                            <div className="flex items-center justify-between">
                                              <div className="flex items-center gap-2">
                                                <Calculator className="h-4 w-4 text-green-600 dark:text-green-400" />
                                                <span className="text-green-600 dark:text-green-400 font-semibold text-sm">Optimized Vehicle Fleet</span>
                                              </div>
                                              {transport.totalPax && transport.totalCapacity && <Badge variant={transport.totalPax <= transport.totalCapacity ? "default" : "destructive"} className="text-xs">
                                                  {transport.totalPax}/{transport.totalCapacity} PAX
                                                </Badge>}
                                            </div>
                                            
                                            {/* Enhanced Vehicle Grid with Full Details */}
                                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
                                              {transport.vehicleSummary.split(' + ').map((vehicle: string, idx: number) => {
                                  const vehicleName = vehicle.split('(')[0].trim();
                                  const capacityMatch = vehicle.match(/\((\d+)\s*seat/);
                                  const capacity = capacityMatch ? parseInt(capacityMatch[1]) : null;
                                  const quantityMatch = vehicle.match(/^(\d+)\s*x?\s*/);
                                  const quantity = quantityMatch ? parseInt(quantityMatch[1]) : 1;
                                  const actualVehicleName = vehicleName.replace(/^\d+\s*x?\s*/, '');
                                  return <div key={`transport-vehicle-${transport.id || `${transport.from ?? 'unknown'}-${transport.to ?? 'unknown'}`}-${idx}-${vehicle.replace(/\s+/g, '-')}`} className="bg-white dark:bg-gray-900/70 rounded-lg border border-blue-200 dark:border-blue-700 p-4 space-y-3">
                                                    {/* Vehicle Header with Enhanced Numbers */}
                                                    <div className="flex items-center justify-between">
                                                      <div className="flex items-center gap-3">
                                                        <div className="flex items-center justify-center w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                                                          <Car className="h-4 w-4 text-blue-600 dark:text-blue-400" />
                                                        </div>
                                                        <div>
                                                          <div className="text-sm font-bold text-blue-900 dark:text-blue-100">
                                                            {actualVehicleName}
                                                          </div>
                                                          <div className="text-xs text-muted-foreground">
                                                            Vehicle #{idx + 1}
                                                          </div>
                                                        </div>
                                                      </div>
                                                      <div className="flex flex-col items-end gap-1">
                                                        <Badge variant="default" className="text-xs font-bold bg-blue-600">
                                                          {quantity} Unit{quantity > 1 ? 's' : ''}
                                                        </Badge>
                                                        {quantity > 1 && <div className="text-xs text-muted-foreground">
                                                            Multi-vehicle
                                                          </div>}
                                                      </div>
                                                    </div>
                                                    
                                                    {/* Vehicle Specifications with Enhanced Display */}
                                                    <div className="grid grid-cols-2 gap-3">
                                                      <div className="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-2">
                                                        <div className="flex items-center gap-2 mb-1">
                                                          <Users className="h-3 w-3 text-blue-600" />
                                                          <span className="text-xs font-medium text-gray-700 dark:text-gray-300">Per Vehicle</span>
                                                        </div>
                                                        <div className="text-sm font-bold text-gray-900 dark:text-gray-100">
                                                          {capacity || 4} seats
                                                        </div>
                                                      </div>
                                                      <div className="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-2">
                                                        <div className="flex items-center gap-2 mb-1">
                                                          <Calculator className="h-3 w-3 text-green-600" />
                                                          <span className="text-xs font-medium text-gray-700 dark:text-gray-300">Total Capacity</span>
                                                        </div>
                                                        <div className="text-sm font-bold text-green-600 dark:text-green-400">
                                                          {capacity ? capacity * quantity : quantity * 4} seats
                                                        </div>
                                                      </div>
                                                    </div>
                                                    
                                                    {/* Vehicle Pricing and Position */}
                                                    <div className="flex items-center justify-between pt-2 border-t border-gray-200 dark:border-gray-700">
                                                      <div className="flex items-center gap-2">
                                                        <div className="w-2 h-2 bg-blue-600 rounded-full"></div>
                                                        <span className="text-xs text-gray-600 dark:text-gray-400">
                                                          Vehicle {idx + 1} of {transport.vehicleSummary.split(' + ').length}
                                                        </span>
                                                      </div>
                                                      <div className="text-xs font-medium text-blue-600 dark:text-blue-400">
                                                        ${Math.round(transport.price / transport.vehicleSummary.split(' + ').length)} estimated
                                                      </div>
                                                    </div>
                                                  </div>;
                                })}
                                            </div>
                                            {/* Fleet Summary Dashboard */}
                                            <div className="grid grid-cols-4 gap-3 text-xs bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-950/20 dark:to-emerald-950/20 p-3 rounded-lg border border-green-200 dark:border-green-800">
                                              <div className="text-center">
                                                <div className="font-bold text-green-700 dark:text-green-300 text-lg">
                                                  {transport.vehicleSummary.split(' + ').reduce((total: number, vehicle: string) => {
                                      const quantityMatch = vehicle.match(/^(\d+)\s*x?\s*/);
                                      return total + (quantityMatch ? parseInt(quantityMatch[1]) : 1);
                                    }, 0)}
                                                </div>
                                                <div className="text-green-600 dark:text-green-400 font-medium">Total Vehicles</div>
                                              </div>
                                              <div className="text-center">
                                                <div className="font-bold text-green-700 dark:text-green-300 text-lg">
                                                  {transport.totalCapacity || 'N/A'}
                                                </div>
                                                <div className="text-green-600 dark:text-green-400 font-medium">Total Capacity</div>
                                              </div>
                                              <div className="text-center">
                                                <div className="font-bold text-green-700 dark:text-green-300 text-lg">
                                                  {transport.totalCapacity && transport.totalPax ? `${Math.round(transport.totalPax / transport.totalCapacity * 100)}%` : 'N/A'}
                                                </div>
                                                <div className="text-green-600 dark:text-green-400 font-medium">Utilization</div>
                                              </div>
                                              <div className="text-center">
                                                <div className="font-bold text-green-700 dark:text-green-300 text-lg">
                                                  {transport.totalCapacity && transport.totalPax ? transport.totalCapacity - transport.totalPax : 'N/A'}
                                                </div>
                                                <div className="text-green-600 dark:text-green-400 font-medium">Available Seats</div>
                                              </div>
                                            </div>
                                          </div>}
                                        
                                        {/* Manual Vehicle Selection - Enhanced */}
                                        {transport.vehicleType && !transport.vehicleSummary && <div className="space-y-3">
                                            <div className="flex items-center justify-between">
                                              <div className="flex items-center gap-2">
                                                <Settings className="h-4 w-4 text-blue-600 dark:text-blue-400" />
                                                <span className="text-blue-600 dark:text-blue-400 font-semibold text-sm">Manual Vehicle Selection</span>
                                              </div>
                                              <Badge variant="outline" className="text-xs">
                                                Standard Configuration
                                              </Badge>
                                            </div>
                                            
                                            <div className="bg-white dark:bg-gray-900/70 rounded-lg border border-blue-200 dark:border-blue-700 p-4 space-y-3">
                                              {/* Enhanced Single Vehicle Header */}
                                              <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                  <div className="flex items-center justify-center w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                                                    <Car className="h-4 w-4 text-blue-600 dark:text-blue-400" />
                                                  </div>
                                                  <div>
                                                    <div className="text-sm font-bold text-blue-900 dark:text-blue-100">
                                                      {transport.vehicleType}
                                                    </div>
                                                    <div className="text-xs text-muted-foreground">
                                                      Vehicle #1 • Single Unit
                                                    </div>
                                                  </div>
                                                </div>
                                                <Badge variant="outline" className="text-xs font-medium">
                                                  1 Vehicle
                                                </Badge>
                                              </div>
                                              
                                              {/* Enhanced Single Vehicle Specifications */}
                                              <div className="grid grid-cols-3 gap-3">
                                                <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 text-center">
                                                  <div className="text-lg font-bold text-blue-900 dark:text-blue-100">1</div>
                                                  <div className="text-xs text-blue-600 dark:text-blue-400 font-medium">Vehicle</div>
                                                  <div className="text-xs text-muted-foreground mt-1">Active</div>
                                                </div>
                                                <div className="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3 text-center">
                                                  <div className="text-lg font-bold text-gray-900 dark:text-gray-100">
                                                    {transport.totalCapacity || '4'}
                                                  </div>
                                                  <div className="text-xs text-gray-600 dark:text-gray-400 font-medium">Seats</div>
                                                  <div className="text-xs text-muted-foreground mt-1">Capacity</div>
                                                </div>
                                                <div className="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 text-center">
                                                  <div className="text-lg font-bold text-green-900 dark:text-green-100">Standard</div>
                                                  <div className="text-xs text-green-600 dark:text-green-400 font-medium">Config</div>
                                                  <div className="text-xs text-muted-foreground mt-1">Basic</div>
                                                </div>
                                              </div>
                                              
                                              {/* Vehicle Utilization Info */}
                                              {transport.totalPax && <div className="bg-amber-50 dark:bg-amber-900/20 rounded-lg p-3">
                                                  <div className="flex items-center justify-between text-sm">
                                                    <span className="font-medium text-amber-800 dark:text-amber-200">Passenger Load:</span>
                                                    <span className="font-bold text-amber-900 dark:text-amber-100">
                                                      {transport.totalPax}/{transport.totalCapacity || 4} passengers
                                                    </span>
                                                  </div>
                                                </div>}
                                            </div>
                                          </div>}
                                        
                                        {/* Enhanced Capacity Utilization */}
                                        {transport.totalCapacity && transport.totalPax && <div className="space-y-2">
                                            <div className="flex justify-between items-center text-xs">
                                              <span className="font-medium text-gray-700 dark:text-gray-300">Capacity Utilization</span>
                                              <span className="font-bold text-blue-600 dark:text-blue-400">
                                                {Math.round(transport.totalPax / transport.totalCapacity * 100)}%
                                              </span>
                                            </div>
                                            <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                              <div className="bg-gradient-to-r from-blue-500 to-blue-600 h-2.5 rounded-full transition-all duration-300" style={{
                                  width: `${Math.min(transport.totalPax / transport.totalCapacity * 100, 100)}%`
                                }} />
                                            </div>
                                            <div className="flex justify-between text-xs text-gray-500">
                                              <span>{transport.totalPax} passengers</span>
                                              <span>{transport.totalCapacity - transport.totalPax} free seats</span>
                                            </div>
                                          </div>}
                                      </div>}
                                    <div className="flex items-center gap-1">
                                     <DollarSign className="h-3 w-3 text-green-600 dark:text-green-400" />
                                     <p className="text-sm font-semibold text-green-700 dark:text-green-400">
                                       {formatCurrency(transport.price, query?.destination.country || 'USA')}
                                     </p>
                                   </div>
                                 </div>
                                 <Button variant="ghost" size="sm" onClick={e => {
                          e.stopPropagation();
                          removeTransportFromDay(day.id, transport.id);
                        }} className="text-destructive hover:text-destructive hover:bg-destructive/10 h-8 w-8 p-0 shrink-0">
                                   <Trash2 className="h-3 w-3" />
                                 </Button>
                               </div>
                               
                                {/* Hidden - Editable Pickup/Drop Location Fields removed as requested */}
                              </div>)}
                        </div>
                      </div>}

                    {/* 5. Accommodation Options */}
                    {day.accommodations && day.accommodations.length > 0 && <div className="space-y-3">
                        <h4 className="font-medium flex items-center gap-2">
                          <Hotel className="h-4 w-4" />
                          Accommodation Options ({day.accommodations.length})
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          {day.accommodations.map(accommodation => <div key={accommodation.id} className="p-4 bg-emerald-50 dark:bg-emerald-950/20 border border-emerald-200 dark:border-emerald-800/50 rounded-lg hover:shadow-sm transition-shadow">
                              <div className="flex items-start justify-between">
                                <div className="flex-1 space-y-2">
                                  <h5 className="font-semibold text-emerald-900 dark:text-emerald-100">{accommodation.name}</h5>
                                  <p className="text-sm text-emerald-700 dark:text-emerald-300 bg-emerald-100 dark:bg-emerald-900/30 px-2 py-1 rounded-md inline-block">
                                    {accommodation.roomType}
                                  </p>
                                  <div className="flex items-center gap-1">
                                    <DollarSign className="h-3 w-3 text-green-600 dark:text-green-400" />
                                    <p className="text-sm font-semibold text-green-700 dark:text-green-400">
                                      {formatCurrency(accommodation.price, query?.destination.country || 'USA')}/night
                                    </p>
                                  </div>
                                </div>
                                <Button variant="ghost" size="sm" onClick={e => {
                          e.stopPropagation();
                          removeAccommodationFromDay(day.id, accommodation.id);
                        }} className="text-destructive hover:text-destructive hover:bg-destructive/10 h-8 w-8 p-0 shrink-0">
                                  <Trash2 className="h-3 w-3" />
                                </Button>
                              </div>
                            </div>)}
                        </div>
                      </div>}

                    {/* Legacy Single Accommodation */}
                    {day.accommodation && <div className="p-4 bg-emerald-50 dark:bg-emerald-950/20 border border-emerald-200 dark:border-emerald-800/50 rounded-lg">
                        <div className="space-y-2">
                          <h5 className="font-semibold text-emerald-900 dark:text-emerald-100 flex items-center gap-2">
                            <Hotel className="h-4 w-4" />
                            Accommodation
                          </h5>
                          <p className="text-sm text-emerald-700 dark:text-emerald-300">{day.accommodation.name}</p>
                          <div className="flex items-center gap-1">
                            <DollarSign className="h-3 w-3 text-green-600 dark:text-green-400" />
                            <p className="text-sm font-semibold text-green-700 dark:text-green-400">
                              {formatCurrency(day.accommodation.price, query?.destination.country || 'USA')}/night
                            </p>
                          </div>
                        </div>
                      </div>}

                    {/* 6. Sightseeing & Activities */}
                    <div>
                      <div className="flex items-center justify-between mb-3">
                        <h4 className="font-medium flex items-center gap-2">
                          <Eye className="h-4 w-4" />
                          Sightseeing & Activities ({day.activities.length})
                        </h4>
                        <Button variant="outline" size="sm" onClick={e => {
                      e.stopPropagation();
                      addActivity(day.id);
                    }}>
                          <Plus className="h-3 w-3 mr-1" />
                          Add Activity
                        </Button>
                      </div>

                      {day.activities.length > 0 ? <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          {day.activities.map((activity, index) => <div key={`activity-${activity.id || `${day.id}-${index}`}`} className="p-4 bg-purple-50 dark:bg-purple-950/20 border border-purple-200 dark:border-purple-800/50 rounded-lg hover:shadow-sm transition-shadow">
                              <div className="flex items-start justify-between">
                                <div className="flex-1 space-y-2">
                                  <div className="flex items-center gap-2">
                                    <Badge variant="secondary" className="text-xs bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300">
                                      #{index + 1}
                                    </Badge>
                                    <h5 className="font-semibold text-purple-900 dark:text-purple-100">
                                      {activity.name || 'Untitled Activity'}
                                    </h5>
                                  </div>
                                  
                                  {activity.description && <p className="text-sm text-purple-700 dark:text-purple-300 line-clamp-2">
                                      {activity.description}
                                    </p>}
                                  
                                  <div className="flex items-center gap-3 text-xs">
                                    <div className="flex items-center gap-1 text-purple-600 dark:text-purple-400">
                                      <Clock className="h-3 w-3" />
                                      <span>{activity.duration}</span>
                                    </div>
                                    <div className="flex items-center gap-1 text-purple-600 dark:text-purple-400">
                                      <Activity className="h-3 w-3" />
                                      <span className="capitalize">{activity.type}</span>
                                    </div>
                                    {activity.transportType && activity.transportType !== 'none' && activity.transportType !== 'walking' && <div className="flex items-center gap-1 text-purple-600 dark:text-purple-400">
                                        <Car className="h-3 w-3" />
                                        <span className="capitalize">
                                          {(() => {
                                  // Check for private transport types
                                  if (activity.transportType === 'private_car' || activity.transportType === 'private_van' || activity.transportType === 'private' || activity.vehicleType?.toLowerCase().includes('private')) {
                                    return 'PVT';
                                  }
                                  // Default to SIC for shared transfers
                                  return 'SIC';
                                })()}
                                        </span>
                                      </div>}
                                   </div>
                                    
                                    {/* Enhanced Activity Details */}
                                    {(activity.category || activity.selectedOptions || activity.effectivePax) && <div className="mt-2 p-2 bg-purple-25 dark:bg-purple-950/40 border border-purple-150 dark:border-purple-800/30 rounded-md">
                                        <div className="flex items-center gap-2 mb-2">
                                          <Activity className="h-3 w-3 text-purple-600 dark:text-purple-400" />
                                          <span className="text-xs font-medium text-purple-800 dark:text-purple-200">Activity Details</span>
                                        </div>
                                        <div className="space-y-1 text-xs">
                                          {activity.category && <div className="flex items-center justify-between">
                                              <span className="text-purple-600 dark:text-purple-400 font-medium">Category:</span>
                                              <Badge variant="outline" className="text-xs h-4 bg-purple-50 dark:bg-purple-900/30 border-purple-200 dark:border-purple-700">
                                                {activity.category}
                                              </Badge>
                                            </div>}
                                          {activity.effectivePax && <div className="flex items-center justify-between">
                                              <span className="text-purple-600 dark:text-purple-400 font-medium">Group Size:</span>
                                              <span className="text-purple-800 dark:text-purple-200 font-medium">{activity.effectivePax} people</span>
                                            </div>}
                                          {activity.priceUnit && <div className="flex items-center justify-between">
                                              <span className="text-purple-600 dark:text-purple-400 font-medium">Pricing:</span>
                                              <span className="text-purple-800 dark:text-purple-200 capitalize">{activity.priceUnit.replace('-', ' ')}</span>
                                            </div>}
                                        </div>
                                        
                                        {/* Package Options */}
                                        {activity.selectedOptions && activity.selectedOptions.length > 0 && <div className="mt-2 pt-2 border-t border-purple-200 dark:border-purple-800/30">
                                            <div className="flex items-center gap-1 mb-1">
                                              <Package className="h-3 w-3 text-purple-600 dark:text-purple-400" />
                                              <span className="text-xs font-medium text-purple-800 dark:text-purple-200">Package Includes:</span>
                                            </div>
                                            <div className="flex flex-wrap gap-1">
                                              {activity.selectedOptions.slice(0, 3).map((option: any, i: number) => <Badge key={`activity-option-${activity.id || activity.name}-${i}-${typeof option === 'object' ? (option.id || option.name || option.title) : option}`} variant="secondary" className="text-xs h-4 bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-700 text-green-700 dark:text-green-300">
                                                  {typeof option === 'object' ? (option.name || option.title || option.id) : option}
                                                </Badge>)}
                                              {activity.selectedOptions.length > 3 && <Badge variant="outline" className="text-xs h-4">+{activity.selectedOptions.length - 3} more</Badge>}
                                            </div>
                                          </div>}
                                      </div>}
                                    
                                    {/* Transfer Configuration */}
                                    {activity.transportType && activity.transportType !== 'none' && activity.transportType !== 'walking' && <div className="mt-2 p-2 bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800/50 rounded-md">
                                        <div className="flex items-center gap-2 mb-2">
                                          <Car className="h-3 w-3 text-blue-600 dark:text-blue-400" />
                                          <span className="text-xs font-medium text-blue-800 dark:text-blue-200">Transfer Configuration</span>
                                        </div>
                                        
                                        {(() => {
                              // Helper function to convert type indicators to proper vehicle names
                              const getVehicleNameFromType = (vehicleType: string): string => {
                                const type = vehicleType.toLowerCase().trim();
                                switch (type) {
                                  case 'private':
                                    return 'Private Car';
                                  case 'sic':
                                    return 'Shared Vehicle';
                                  case 'private_car':
                                    return 'Private Car';
                                  case 'private_van':
                                    return 'Private Van';
                                  case 'shared_car':
                                    return 'Shared Car';
                                  case 'bus':
                                    return 'Tour Bus';
                                  case 'minibus':
                                    return 'Mini Bus';
                                  case 'suv':
                                    return 'SUV';
                                  case 'taxi':
                                    return 'Taxi';
                                  case 'tuk_tuk':
                                    return 'Tuk Tuk';
                                  case 'songthaew':
                                    return 'Red Songthaew';
                                  default:
                                    return vehicleType;
                                }
                              };

                              // Get vehicle name
                              let vehicleName = 'Standard Vehicle';
                              if (activity.vehicleType && activity.vehicleType.trim() !== '' && activity.vehicleType !== 'Standard Vehicle' && activity.vehicleType !== 'standard') {
                                vehicleName = getVehicleNameFromType(activity.vehicleType);
                              } else if (activity.selectedOptions && typeof activity.selectedOptions === 'object' && !Array.isArray(activity.selectedOptions) && (activity.selectedOptions as any).transferOption?.vehicleType && (activity.selectedOptions as any).transferOption.vehicleType.trim() !== '') {
                                vehicleName = getVehicleNameFromType((activity.selectedOptions as any).transferOption.vehicleType);
                              } else if (activity.transportType === 'private_car' || activity.transportType === 'private' || activity.transportLabel && activity.transportLabel.toLowerCase().includes('private')) {
                                vehicleName = 'Private Car';
                              } else if (activity.transportType === 'private_van') vehicleName = 'Private Van';else if (activity.transportType === 'shared_car') vehicleName = 'Shared Car';else if (activity.transportType === 'bus') vehicleName = 'Tour Bus';else if (activity.transportType === 'minibus') vehicleName = 'Mini Bus';else if (activity.transportType === 'suv') vehicleName = 'SUV';else if (activity.transportType === 'taxi') vehicleName = 'Taxi';else if (activity.transportType === 'tuk_tuk') vehicleName = 'Tuk Tuk';else if (activity.transportType === 'songthaew') vehicleName = 'Red Songthaew';else if (activity.transportType && (activity.transportType.toLowerCase().includes('private') || activity.transportType === 'suv')) vehicleName = 'Private Car';

                              // Get vehicle capacity (default values based on vehicle type)
                              const getVehicleCapacity = (vehicleName: string): number => {
                                switch (vehicleName.toLowerCase()) {
                                  case 'private car':
                                    return 4;
                                  case 'private van':
                                    return 8;
                                  case 'suv':
                                    return 6;
                                  case 'mini bus':
                                    return 15;
                                  case 'tour bus':
                                    return 45;
                                  case 'taxi':
                                    return 4;
                                  case 'tuk tuk':
                                    return 3;
                                  case 'red songthaew':
                                    return 10;
                                  case 'shared vehicle':
                                    return 12;
                                  case 'shared car':
                                    return 4;
                                  default:
                                    return 4;
                                }
                              };
                              const vehicleCapacity = activity.seatingCapacity || getVehicleCapacity(vehicleName);
                              const totalPax = activity.effectivePax || query?.paxDetails?.adults || 2;
                              const vehicleCount = activity.vehicleCount || Math.ceil(totalPax / vehicleCapacity);
                              const pricePerVehicle = activity.cost || 0;

                              // Transfer type determination
                              const getTransferType = () => {
                                if (activity.transportType && (activity.transportType.toLowerCase().includes('private') || activity.transportType === 'private_car' || activity.transportType === 'private_van' || activity.transportType === 'suv')) {
                                  return 'PVT';
                                }
                                if (activity.transportType && (activity.transportType.toLowerCase().includes('shared') || activity.transportType.toLowerCase().includes('sic') || activity.transportType === 'bus' || activity.transportType === 'minibus')) {
                                  return 'SIC';
                                }
                                if (activity.transportLabel && activity.transportLabel.toLowerCase().includes('private')) {
                                  return 'PVT';
                                }
                                if (activity.transportLabel && activity.transportLabel.toLowerCase().includes('sic')) {
                                  return 'SIC';
                                }
                                if (activity.vehicleType && activity.vehicleType.toLowerCase().includes('private')) {
                                  return 'PVT';
                                }
                                return 'SIC';
                              };
                              return <div className="space-y-3">
                                              {/* Basic Info */}
                                              <div className="grid grid-cols-2 gap-2 text-xs">
                                                <div>
                                                  <span className="text-blue-600 dark:text-blue-400 font-medium">Vehicle Name:</span>
                                                  <span className="ml-1 text-blue-800 dark:text-blue-200 capitalize font-medium">
                                                    {vehicleName}
                                                  </span>
                                                </div>
                                                <div>
                                                  <span className="text-blue-600 dark:text-blue-400 font-medium">Type:</span>
                                                  <span className="ml-1 text-blue-800 dark:text-blue-200">
                                                    {getTransferType()}
                                                  </span>
                                                </div>
                                              </div>

                                              {/* Capacity Management */}
                                              <CapacityValidator totalPax={totalPax} vehicleCapacity={vehicleCapacity} vehicleName={vehicleName} />
                                              
                                              {totalPax > vehicleCapacity && <VehicleQuantitySelector vehicleCount={vehicleCount} onVehicleCountChange={count => {
                                  // Update activity with new vehicle count and pricing
                                  const updatedActivity = {
                                    ...activity,
                                    vehicleCount: count,
                                    cost: pricePerVehicle * count
                                  };
                                  const updatedDay = {
                                    ...day,
                                    activities: day.activities.map(a => a === activity ? updatedActivity : a)
                                  };
                                  const updatedDays = days.map(d => d.id === day.id ? updatedDay : d);
                                  onDataChange?.(updatedDays);
                                }} vehicleName={vehicleName} vehicleCapacity={vehicleCapacity} totalPax={totalPax} pricePerVehicle={pricePerVehicle} currency={query?.destination.country || 'USD'} />}
                                            </div>;
                            })()}
                                      </div>}
                                    
                                   {/* Pickup and Drop Locations */}
                                   {(activity.pickupLocation || activity.dropoffLocation) && <div className="space-y-1 border-t border-purple-200 dark:border-purple-800/50 pt-2">
                                       {activity.pickupLocation && <div className="flex items-center gap-1 text-xs text-purple-600 dark:text-purple-400">
                                           <MapPin className="h-3 w-3" />
                                           <span className="font-medium">Pickup:</span>
                                           <span>{activity.pickupLocation}</span>
                                         </div>}
                                       {activity.dropoffLocation && <div className="flex items-center gap-1 text-xs text-purple-600 dark:text-purple-400">
                                           <MapPin className="h-3 w-3" />
                                           <span className="font-medium">Drop:</span>
                                           <span>{activity.dropoffLocation}</span>
                                         </div>}
                                     </div>}
                                   
                                   {activity.cost > 0 && <div className="flex items-center gap-1">
                                       <DollarSign className="h-3 w-3 text-green-600 dark:text-green-400" />
                                       <p className="text-sm font-semibold text-green-700 dark:text-green-400">
                                         {formatCurrency(activity.cost, query?.destination.country || 'USA')}
                                       </p>
                                     </div>}
                                </div>
                                
                                <Button variant="ghost" size="sm" onClick={e => {
                          e.stopPropagation();
                          removeActivity(day.id, activity.id);
                        }} className="text-destructive hover:text-destructive hover:bg-destructive/10 h-8 w-8 p-0 shrink-0">
                                  <Trash2 className="h-3 w-3" />
                                </Button>
                              </div>

                              {/* Editable Fields - Only show for activities with missing data */}
                              {(!activity.name || !activity.description) && <div className="mt-3 pt-3 border-t border-purple-200 dark:border-purple-800/50 space-y-2">
                                  {!activity.name && <Input value={activity.name ?? ''} onChange={e => updateActivity(day.id, activity.id, {
                          name: e.target.value
                        })} placeholder="Enter activity name" onClick={e => e.stopPropagation()} className="border-purple-200 dark:border-purple-800/50 focus:border-purple-400 text-sm" />}
                                  {!activity.description && <Textarea value={activity.description ?? ''} onChange={e => updateActivity(day.id, activity.id, {
                          description: e.target.value
                        })} placeholder="Describe the activity..." rows={2} onClick={e => e.stopPropagation()} className="border-purple-200 dark:border-purple-800/50 focus:border-purple-400 text-sm" />}
                                   <div className="grid grid-cols-2 gap-2">
                                     <Input value={activity.duration ?? ''} onChange={e => updateActivity(day.id, activity.id, {
                            duration: e.target.value
                          })} placeholder="Duration" onClick={e => e.stopPropagation()} className="border-purple-200 dark:border-purple-800/50 focus:border-purple-400 text-sm" />
                                     <Input type="number" value={activity.cost ?? 0} onChange={e => updateActivity(day.id, activity.id, {
                            cost: parseFloat(e.target.value) || 0
                          })} placeholder="Cost" onClick={e => e.stopPropagation()} className="border-purple-200 dark:border-purple-800/50 focus:border-purple-400 text-sm" />
                                   </div>
                                   <div className="grid grid-cols-2 gap-2">
                                     <Input value={activity.pickupLocation || ''} onChange={e => updateActivity(day.id, activity.id, {
                            pickupLocation: e.target.value
                          })} placeholder="Pickup location" onClick={e => e.stopPropagation()} className="border-purple-200 dark:border-purple-800/50 focus:border-purple-400 text-sm" />
                                     <Input value={activity.dropoffLocation || ''} onChange={e => updateActivity(day.id, activity.id, {
                            dropoffLocation: e.target.value
                          })} placeholder="Drop-off location" onClick={e => e.stopPropagation()} className="border-purple-200 dark:border-purple-800/50 focus:border-purple-400 text-sm" />
                                   </div>
                                </div>}
                            </div>)}
                        </div> : <div className="text-center py-4 border-2 border-dashed border-purple-200 dark:border-purple-800/50 rounded-lg bg-purple-50/50 dark:bg-purple-950/10">
                          <Camera className="mx-auto h-8 w-8 text-purple-400 dark:text-purple-500 mb-2" />
                          <h3 className="text-sm font-medium text-purple-700 dark:text-purple-300 mb-1">No activities added</h3>
                          <p className="text-xs text-purple-600 dark:text-purple-400 mb-3">
                            Add sightseeing activities and attractions for this day
                          </p>
                          <Button variant="outline" size="sm" onClick={e => {
                      e.stopPropagation();
                      addActivity(day.id);
                    }} className="border-purple-300 text-purple-700 hover:bg-purple-50 dark:border-purple-700 dark:text-purple-300 dark:hover:bg-purple-950/20">
                            <Plus className="h-3 w-3 mr-1" />
                            Add First Activity
                          </Button>
                        </div>}
                    </div>

                    {/* 7. Smart Suggestions */}
                    {query && <div onClick={e => e.stopPropagation()}>
                        <SmartSuggestionsPopover query={query} dayCity={day.city} onAddHotel={(hotel, price) => handleSmartAddHotel(day.id, hotel, price)} onAddTransport={(transport, price) => handleSmartAddTransport(day.id, transport, price)} onAddActivity={(activity, price) => handleSmartAddActivity(day.id, activity, price)} />
                      </div>}

                    {/* 8. Meals Included */}
                    <div>
                      <h4 className="font-medium mb-2 flex items-center gap-2">
                        <UtensilsCrossed className="h-4 w-4 text-primary" />
                        Meals Included
                        {(() => {
                          const autoMeals = getAutoSelectedMeals(day.dayNumber);
                          const mealPlans = getDayAccommodationMealPlan(day.dayNumber);
                          const hasAccommodation = (accommodationsByDay[day.dayNumber] || []).length > 0;
                          
                          return hasAccommodation && (
                            <Badge variant="secondary" className="text-xs">
                              Auto: {mealPlans.length > 0 ? mealPlans.join(', ') : 'Breakfast'}
                            </Badge>
                          );
                        })()}
                      </h4>
                      
                      <div className="grid grid-cols-3 gap-4 p-3 bg-muted/30 rounded-lg border">
                        {/* Breakfast Checkbox */}
                        <div className="flex items-center space-x-2">
                          <Checkbox
                            id={`breakfast-${day.id}`}
                            checked={(() => {
                              const autoMeals = getAutoSelectedMeals(day.dayNumber);
                              return day.meals?.breakfast !== undefined ? day.meals.breakfast : autoMeals.breakfast;
                            })()}
                            onCheckedChange={(checked) => updateMeals(day.id, 'breakfast', !!checked)}
                          />
                          <label
                            htmlFor={`breakfast-${day.id}`}
                            className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 flex items-center gap-1"
                          >
                            🍳 Breakfast
                            {(() => {
                              const autoMeals = getAutoSelectedMeals(day.dayNumber);
                              return autoMeals.breakfast && (
                                <span className="text-xs text-primary">(Auto)</span>
                              );
                            })()}
                          </label>
                        </div>

                        {/* Lunch Checkbox */}
                        <div className="flex items-center space-x-2">
                          <Checkbox
                            id={`lunch-${day.id}`}
                            checked={day.meals?.lunch || false}
                            onCheckedChange={(checked) => updateMeals(day.id, 'lunch', !!checked)}
                          />
                          <label
                            htmlFor={`lunch-${day.id}`}
                            className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 flex items-center gap-1"
                          >
                            🥗 Lunch
                          </label>
                        </div>

                        {/* Dinner Checkbox */}
                        <div className="flex items-center space-x-2">
                          <Checkbox
                            id={`dinner-${day.id}`}
                            checked={day.meals?.dinner || false}
                            onCheckedChange={(checked) => updateMeals(day.id, 'dinner', !!checked)}
                          />
                          <label
                            htmlFor={`dinner-${day.id}`}
                            className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 flex items-center gap-1"
                          >
                            🍽️ Dinner
                          </label>
                        </div>
                      </div>

                      {/* Meal Plan Info */}
                      {(() => {
                        const mealPlans = getDayAccommodationMealPlan(day.dayNumber);
                        const hasAccommodation = (accommodationsByDay[day.dayNumber] || []).length > 0;
                        
                        return (hasAccommodation || mealPlans.length > 0) && (
                          <div className="mt-2 p-2 bg-blue-50/50 dark:bg-blue-950/20 rounded border border-blue-200/50 dark:border-blue-800/50">
                            <p className="text-xs text-blue-700 dark:text-blue-300">
                              <strong>Accommodation Info:</strong> 
                              {mealPlans.length > 0 
                                ? ` ${mealPlans.join(', ')} included with selected hotels`
                                : ' Breakfast automatically included with accommodation'
                              }
                            </p>
                          </div>
                        );
                      })()}
                    </div>
                  </CardContent>
                </Card>;
          })}
          </div>

          {days.length === 0 && <Card>
              <CardContent className="py-12 text-center">
                <div className="w-16 h-16 bg-primary/10 dark:bg-primary/20 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Wand2 className="h-8 w-8 text-primary" />
                </div>
                <h3 className="text-lg font-medium mb-2">Start Building Your Itinerary</h3>
                <p className="text-muted-foreground mb-4">
                  {query ? 'Auto-generate days based on your travel dates or start from scratch' : 'Add your first day to begin planning'}
                </p>
                <Button onClick={addDay}>
                  <Plus className="h-4 w-4 mr-2" />
                  Add First Day
                </Button>
              </CardContent>
            </Card>}
        </div>

        {/* Compact Suggestion Panel - Takes up less space */}
        
      </div>
    </div>
};

export default DayByDayItineraryBuilder;