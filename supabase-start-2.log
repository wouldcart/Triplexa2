open supabase/.temp/profile: no such file or directory
Supabase CLI 2.53.6
Using profile: supabase (supabase.co)
Loading project ref from file: supabase/.temp/project-ref
Using access token for profile: supabase
Using access token for profile: supabase
2025/11/05 15:50:05 HTTP GET: https://api.supabase.com/v1/projects/xzofytokwszfwiupsdvi/api-keys?reveal=true
2025/11/05 15:50:05 HTTP GET: https://api.supabase.com/v1/projects
2025/11/05 15:50:06 HTTP GET: https://xzofytokwszfwiupsdvi.supabase.co/auth/v1/health
2025/11/05 15:50:06 HTTP GET: https://xzofytokwszfwiupsdvi.supabase.co/rest/v1/
WARNING: You are running different service versions locally than your linked project:
supabase/gotrue:v2.179.0 => v2.180.0
Run supabase link to update them.
Starting database...
2025/11/05 15:50:19 PG Send: {"Type":"StartupMessage","ProtocolVersion":196608,"Parameters":{"database":"postgres","user":"postgres"}}
2025/11/05 15:50:19 PG Recv: {"Type":"AuthenticationSASL","AuthMechanisms":["SCRAM-SHA-256"]}
2025/11/05 15:50:19 PG Send: {"Type":"SASLInitialResponse","AuthMechanism":"SCRAM-SHA-256","Data":"n,,n=,r=33W1lOsaEjDm9U5BK2HCh7TD"}
2025/11/05 15:50:19 PG Recv: {"Type":"AuthenticationSASLContinue","Data":"r=33W1lOsaEjDm9U5BK2HCh7TDX0gtd8ymflyoSqgsEzWkAqWJ,s=pfhmEfILCh/sLwqjG/Yyog==,i=4096"}
2025/11/05 15:50:19 PG Send: {"Type":"SASLResponse","Data":"c=biws,r=33W1lOsaEjDm9U5BK2HCh7TDX0gtd8ymflyoSqgsEzWkAqWJ,p=R3Z6Prt9DueP8ScaZHptPHm5Wv01fkOHLEvywfptnqM="}
2025/11/05 15:50:19 PG Recv: {"Type":"AuthenticationSASLFinal","Data":"v=c0igBEKTuJSYf2a/6M9fhWcVrBY/r1cHjCCQZvEL8rw="}
2025/11/05 15:50:19 PG Recv: {"Type":"AuthenticationOK"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"in_hot_standby","Value":"off"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"integer_datetimes","Value":"on"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"TimeZone","Value":"UTC"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"IntervalStyle","Value":"postgres"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"is_superuser","Value":"off"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"application_name","Value":""}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"default_transaction_read_only","Value":"off"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"scram_iterations","Value":"4096"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"DateStyle","Value":"ISO, MDY"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"standard_conforming_strings","Value":"on"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"session_authorization","Value":"postgres"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"client_encoding","Value":"UTF8"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"server_version","Value":"17.6"}
2025/11/05 15:50:19 PG Recv: {"Type":"ParameterStatus","Name":"server_encoding","Value":"UTF8"}
2025/11/05 15:50:19 PG Recv: {"Type":"BackendKeyData","ProcessID":213,"SecretKey":2973840857}
2025/11/05 15:50:19 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Initialising schema...
+ ulimit -n
+ '[' '!' -z '' ']'
+ export ERL_CRASH_DUMP=/tmp/erl_crash.dump
+ ERL_CRASH_DUMP=/tmp/erl_crash.dump
+ '[' false = true ']'
+ [[ -n '' ]]
+ echo 'Running migrations'
+ sudo -E -u nobody /app/bin/migrate
+ '[' true = true ']'
+ echo 'Seeding selfhosted Realtime'
+ sudo -E -u nobody /app/bin/realtime eval 'Realtime.Release.seeds(Realtime.Repo)'
[os_mon] cpu supervisor port (cpu_sup): Erlang has closed
[os_mon] memory supervisor port (memsup): Erlang has closed
+ echo 'Starting Realtime'
+ ulimit -n
+ exec /app/bin/realtime eval '{:ok, _} = Application.ensure_all_started(:realtime)
{:ok, _} = Realtime.Tenants.health_check("realtime-dev")'
[os_mon] memory supervisor port (memsup): Erlang has closed
[os_mon] cpu supervisor port (cpu_sup): Erlang has closed
Seeding globals from roles.sql...
Skipping migration 2025-01-27-create-branding-bucket.sql... (file name must match pattern "<timestamp>_name.sql")
Skipping migration 2025-10-04-sightseeing-schema.sql... (file name must match pattern "<timestamp>_name.sql")
Skipping migration 2025-10-24-agent-branding-and-rls.sql... (file name must match pattern "<timestamp>_name.sql")
Skipping migration 2025-10-29-fix-agent-branding-upload-rls.sql... (file name must match pattern "<timestamp>_name.sql")
Skipping migration 2025-11-04_sales_enquiries.sql... (file name must match pattern "<timestamp>_name.sql")
Skipping migration enquriy.sql... (file name must match pattern "<timestamp>_name.sql")
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"SET lock_timeout = '4s'","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE SCHEMA IF NOT EXISTS supabase_migrations","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE TABLE IF NOT EXISTS supabase_migrations.schema_migrations (version text NOT NULL PRIMARY KEY)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"ALTER TABLE supabase_migrations.schema_migrations ADD COLUMN IF NOT EXISTS statements text[]","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"ALTER TABLE supabase_migrations.schema_migrations ADD COLUMN IF NOT EXISTS name text","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"SET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE SCHEMA"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240701000000_init_core_schema.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Minimal core schema to satisfy early triggers and profileâ†”agent sync\n-- Creates public.profiles and public.agents with required columns used by triggers\n\n-- Ensure pgcrypto for gen_random_uuid() is available (safe if already enabled)\nCREATE EXTENSION IF NOT EXISTS pgcrypto","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create profiles table (minimal columns used in triggers and app)\nCREATE TABLE IF NOT EXISTS public.profiles (\n  id uuid PRIMARY KEY,\n  name text,\n  email text,\n  role text DEFAULT ''::text,\n  company_name text,\n  phone text,\n  created_at timestamp without time zone DEFAULT now(),\n  updated_at timestamp without time zone DEFAULT now()\n)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create agents table (minimal columns referenced by triggers)\nCREATE TABLE IF NOT EXISTS public.agents (\n  id uuid PRIMARY KEY,\n  user_id uuid NOT NULL UNIQUE,\n  status text NOT NULL DEFAULT 'inactive'::text,\n  name text,\n  email text,\n  business_phone text,\n  agency_name text,\n  source_type text,\n  source_details text,\n  created_at timestamp with time zone NOT NULL DEFAULT now(),\n  updated_at timestamp with time zone NOT NULL DEFAULT now(),\n  CONSTRAINT agents_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)\n)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Helpful indexes (optional but safe)\nCREATE INDEX IF NOT EXISTS idx_profiles_email ON public.profiles(email)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE INDEX IF NOT EXISTS idx_agents_email ON public.agents(email)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE INDEX IF NOT EXISTS idx_agents_user_id ON public.agents(user_id)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240701000000"},{"text":"init_core_schema"},{"binary":"0000000100000000000000190000000600000001000001162d2d204d696e696d616c20636f726520736368656d6120746f2073617469736679206561726c7920747269676765727320616e642070726f66696c65e286946167656e742073796e630a2d2d2043726561746573207075626c69632e70726f66696c657320616e64207075626c69632e6167656e7473207769746820726571756972656420636f6c756d6e7320757365642062792074726967676572730a0a2d2d20456e7375726520706763727970746f20666f722067656e5f72616e646f6d5f75756964282920697320617661696c61626c6520287361666520696620616c726561647920656e61626c6564290a43524541544520455854454e53494f4e204946204e4f542045584953545320706763727970746f000001542d2d204372656174652070726f66696c6573207461626c6520286d696e696d616c20636f6c756d6e73207573656420696e20747269676765727320616e6420617070290a435245415445205441424c45204946204e4f5420455849535453207075626c69632e70726f66696c657320280a202069642075756964205052494d415259204b45592c0a20206e616d6520746578742c0a2020656d61696c20746578742c0a2020726f6c6520746578742044454641554c542027273a3a746578742c0a2020636f6d70616e795f6e616d6520746578742c0a202070686f6e6520746578742c0a2020637265617465645f61742074696d657374616d7020776974686f75742074696d65207a6f6e652044454641554c54206e6f7728292c0a2020757064617465645f61742074696d657374616d7020776974686f75742074696d65207a6f6e652044454641554c54206e6f7728290a29000002172d2d20437265617465206167656e7473207461626c6520286d696e696d616c20636f6c756d6e73207265666572656e636564206279207472696767657273290a435245415445205441424c45204946204e4f5420455849535453207075626c69632e6167656e747320280a202069642075756964205052494d415259204b45592c0a2020757365725f69642075756964204e4f54204e554c4c20554e495155452c0a20207374617475732074657874204e4f54204e554c4c2044454641554c542027696e616374697665273a3a746578742c0a20206e616d6520746578742c0a2020656d61696c20746578742c0a2020627573696e6573735f70686f6e6520746578742c0a20206167656e63795f6e616d6520746578742c0a2020736f757263655f7479706520746578742c0a2020736f757263655f64657461696c7320746578742c0a2020637265617465645f61742074696d657374616d7020776974682074696d65207a6f6e65204e4f54204e554c4c2044454641554c54206e6f7728292c0a2020757064617465645f61742074696d657374616d7020776974682074696d65207a6f6e65204e4f54204e554c4c2044454641554c54206e6f7728292c0a2020434f4e53545241494e54206167656e74735f757365725f69645f666b657920464f524549474e204b45592028757365725f696429205245464552454e434553207075626c69632e70726f66696c6573286964290a290000006e2d2d2048656c7066756c20696e646578657320286f7074696f6e616c206275742073616665290a43524541544520494e444558204946204e4f5420455849535453206964785f70726f66696c65735f656d61696c204f4e207075626c69632e70726f66696c657328656d61696c290000004343524541544520494e444558204946204e4f5420455849535453206964785f6167656e74735f656d61696c204f4e207075626c69632e6167656e747328656d61696c290000004743524541544520494e444558204946204e4f5420455849535453206964785f6167656e74735f757365725f6964204f4e207075626c69632e6167656e747328757365725f696429"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"42710","Message":"extension \"pgcrypto\" already exists, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"extension.c","Line":1791,"Routine":"CreateExtension","UnknownFields":null}
NOTICE (42710): extension "pgcrypto" already exists, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE EXTENSION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240701120000_init_user_roles.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Minimal user_roles table to satisfy later policy migrations\nCREATE TABLE IF NOT EXISTS public.user_roles (\n  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\n  user_id uuid NOT NULL,\n  role text NOT NULL,\n  source text,\n  assigned_by uuid,\n  created_at timestamp without time zone DEFAULT now(),\n  updated_at timestamp without time zone DEFAULT now()\n)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Foreign key to profiles (if profiles exists)\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'profiles'\n  ) AND NOT EXISTS (\n    SELECT 1 FROM pg_constraint WHERE conname = 'user_roles_user_id_fkey'\n  ) THEN\n    ALTER TABLE public.user_roles\n      ADD CONSTRAINT user_roles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id) ON DELETE CASCADE;\n  END IF;\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240701120000"},{"text":"init_user_roles"},{"binary":"00000001000000000000001900000002000000010000016a2d2d204d696e696d616c20757365725f726f6c6573207461626c6520746f2073617469736679206c6174657220706f6c696379206d6967726174696f6e730a435245415445205441424c45204946204e4f5420455849535453207075626c69632e757365725f726f6c657320280a2020696420626967696e742047454e4552415445442042592044454641554c54204153204944454e54495459205052494d415259204b45592c0a2020757365725f69642075756964204e4f54204e554c4c2c0a2020726f6c652074657874204e4f54204e554c4c2c0a2020736f7572636520746578742c0a202061737369676e65645f627920757569642c0a2020637265617465645f61742074696d657374616d7020776974686f75742074696d65207a6f6e652044454641554c54206e6f7728292c0a2020757064617465645f61742074696d657374616d7020776974686f75742074696d65207a6f6e652044454641554c54206e6f7728290a29000001bf2d2d20466f726569676e206b657920746f2070726f66696c6573202869662070726f66696c657320657869737473290a444f2024240a424547494e0a202049462045584953545320280a2020202053454c45435420312046524f4d20696e666f726d6174696f6e5f736368656d612e7461626c6573205748455245207461626c655f736368656d61203d20277075626c69632720414e44207461626c655f6e616d65203d202770726f66696c6573270a20202920414e44204e4f542045584953545320280a2020202053454c45435420312046524f4d2070675f636f6e73747261696e7420574845524520636f6e6e616d65203d2027757365725f726f6c65735f757365725f69645f666b6579270a202029205448454e0a20202020414c544552205441424c45207075626c69632e757365725f726f6c65730a20202020202041444420434f4e53545241494e5420757365725f726f6c65735f757365725f69645f666b657920464f524549474e204b45592028757365725f696429205245464552454e434553207075626c69632e70726f66696c657328696429204f4e2044454c45544520434153434144453b0a2020454e442049463b0a454e44202424"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240702000000_timestamp_helpers.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Helper trigger functions for updated_at maintenance\nCREATE OR REPLACE FUNCTION public.update_updated_at_column()\nRETURNS trigger\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nBEGIN\n  NEW.updated_at := NOW();\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Compatibility helper used by some legacy triggers\nCREATE OR REPLACE FUNCTION public.set_updated_at()\nRETURNS trigger\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nBEGIN\n  NEW.updated_at := NOW();\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240702000000"},{"text":"timestamp_helpers"},{"binary":"0000000100000000000000190000000200000001000000fb2d2d2048656c70657220747269676765722066756e6374696f6e7320666f7220757064617465645f6174206d61696e74656e616e63650a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e7570646174655f757064617465645f61745f636f6c756d6e28290a52455455524e5320747269676765720a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a424547494e0a20204e45572e757064617465645f6174203a3d204e4f5728293b0a202052455455524e204e45573b0a454e443b0a2424000000ef2d2d20436f6d7061746962696c6974792068656c706572207573656420627920736f6d65206c65676163792074726967676572730a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e7365745f757064617465645f617428290a52455455524e5320747269676765720a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a424547494e0a20204e45572e757064617465645f6174203a3d204e4f5728293b0a202052455455524e204e45573b0a454e443b0a2424"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240703000000_create_transport_routes.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"create table public.transport_routes (\n  id uuid not null default gen_random_uuid (),\n  route_code character varying(100) not null,\n  route_name character varying(255) not null,\n  country text null,\n  transfer_type character varying(50) not null,\n  start_location character varying(100) not null,\n  start_location_full_name character varying(255) null,\n  start_coordinates jsonb null,\n  end_location character varying(100) not null,\n  end_location_full_name character varying(255) null,\n  end_coordinates jsonb null,\n  distance integer null,\n  duration character varying(100) null,\n  notes text null,\n  status character varying(20) not null default 'active'::character varying,\n  enable_sightseeing boolean not null default false,\n  created_at timestamp with time zone null default now(),\n  updated_at timestamp with time zone null default now(),\n  name text not null default ''::text,\n  vehicle_types json null,\n  constraint transport_routes_pkey primary key (id),\n  constraint transport_routes_status_check check (\n    (\n      (status)::text = any (\n        (\n          array[\n            'active'::character varying,\n            'inactive'::character varying\n          ]\n        )::text[]\n      )\n    )\n  ),\n  constraint transport_routes_transfer_type_check check (\n    (\n      (transfer_type)::text = any (\n        (\n          array[\n            'One-Way'::character varying,\n            'Round-Trip'::character varying,\n            'Multi-Stop'::character varying,\n            'en route'::character varying\n          ]\n        )::text[]\n      )\n    )\n  )\n) TABLESPACE pg_default","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"create trigger set_updated_at_transport_routes BEFORE\nupdate on transport_routes for EACH row\nexecute FUNCTION set_updated_at ()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240703000000"},{"text":"create_transport_routes"},{"binary":"00000001000000000000001900000002000000010000062f637265617465207461626c65207075626c69632e7472616e73706f72745f726f7574657320280a202069642075756964206e6f74206e756c6c2064656661756c742067656e5f72616e646f6d5f757569642028292c0a2020726f7574655f636f6465206368617261637465722076617279696e672831303029206e6f74206e756c6c2c0a2020726f7574655f6e616d65206368617261637465722076617279696e672832353529206e6f74206e756c6c2c0a2020636f756e7472792074657874206e756c6c2c0a20207472616e736665725f74797065206368617261637465722076617279696e6728353029206e6f74206e756c6c2c0a202073746172745f6c6f636174696f6e206368617261637465722076617279696e672831303029206e6f74206e756c6c2c0a202073746172745f6c6f636174696f6e5f66756c6c5f6e616d65206368617261637465722076617279696e672832353529206e756c6c2c0a202073746172745f636f6f7264696e61746573206a736f6e62206e756c6c2c0a2020656e645f6c6f636174696f6e206368617261637465722076617279696e672831303029206e6f74206e756c6c2c0a2020656e645f6c6f636174696f6e5f66756c6c5f6e616d65206368617261637465722076617279696e672832353529206e756c6c2c0a2020656e645f636f6f7264696e61746573206a736f6e62206e756c6c2c0a202064697374616e636520696e7465676572206e756c6c2c0a20206475726174696f6e206368617261637465722076617279696e672831303029206e756c6c2c0a20206e6f7465732074657874206e756c6c2c0a2020737461747573206368617261637465722076617279696e6728323029206e6f74206e756c6c2064656661756c742027616374697665273a3a6368617261637465722076617279696e672c0a2020656e61626c655f7369676874736565696e6720626f6f6c65616e206e6f74206e756c6c2064656661756c742066616c73652c0a2020637265617465645f61742074696d657374616d7020776974682074696d65207a6f6e65206e756c6c2064656661756c74206e6f7728292c0a2020757064617465645f61742074696d657374616d7020776974682074696d65207a6f6e65206e756c6c2064656661756c74206e6f7728292c0a20206e616d652074657874206e6f74206e756c6c2064656661756c742027273a3a746578742c0a202076656869636c655f7479706573206a736f6e206e756c6c2c0a2020636f6e73747261696e74207472616e73706f72745f726f757465735f706b6579207072696d617279206b657920286964292c0a2020636f6e73747261696e74207472616e73706f72745f726f757465735f7374617475735f636865636b20636865636b20280a20202020280a20202020202028737461747573293a3a74657874203d20616e7920280a2020202020202020280a2020202020202020202061727261795b0a20202020202020202020202027616374697665273a3a6368617261637465722076617279696e672c0a20202020202020202020202027696e616374697665273a3a6368617261637465722076617279696e670a202020202020202020205d0a2020202020202020293a3a746578745b5d0a202020202020290a20202020290a2020292c0a2020636f6e73747261696e74207472616e73706f72745f726f757465735f7472616e736665725f747970655f636865636b20636865636b20280a20202020280a202020202020287472616e736665725f74797065293a3a74657874203d20616e7920280a2020202020202020280a2020202020202020202061727261795b0a202020202020202020202020274f6e652d576179273a3a6368617261637465722076617279696e672c0a20202020202020202020202027526f756e642d54726970273a3a6368617261637465722076617279696e672c0a202020202020202020202020274d756c74692d53746f70273a3a6368617261637465722076617279696e672c0a20202020202020202020202027656e20726f757465273a3a6368617261637465722076617279696e670a202020202020202020205d0a2020202020202020293a3a746578745b5d0a202020202020290a20202020290a2020290a29205441424c4553504143452070675f64656661756c74000000806372656174652074726967676572207365745f757064617465645f61745f7472616e73706f72745f726f75746573204245464f52450a757064617465206f6e207472616e73706f72745f726f7574657320666f72204541434820726f770a657865637574652046554e4354494f4e207365745f757064617465645f6174202829"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240703010000_create_intermediate_stops.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"create table public.intermediate_stops (\n  id uuid not null default gen_random_uuid (),\n  route_id uuid not null,\n  stop_order integer not null,\n  location_code character varying(100) not null,\n  full_name character varying(255) not null,\n  coordinates jsonb null,\n  created_at timestamp with time zone null default now(),\n  updated_at timestamp with time zone null default now(),\n  transfer_method_notes text null,\n  constraint intermediate_stops_pkey primary key (id),\n  constraint intermediate_stops_route_id_fkey foreign KEY (route_id) references transport_routes (id) on delete CASCADE\n) TABLESPACE pg_default","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"create trigger set_updated_at_intermediate_stops BEFORE\nupdate on intermediate_stops for EACH row\nexecute FUNCTION set_updated_at ()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240703010000"},{"text":"create_intermediate_stops"},{"binary":"000000010000000000000019000000020000000100000266637265617465207461626c65207075626c69632e696e7465726d6564696174655f73746f707320280a202069642075756964206e6f74206e756c6c2064656661756c742067656e5f72616e646f6d5f757569642028292c0a2020726f7574655f69642075756964206e6f74206e756c6c2c0a202073746f705f6f7264657220696e7465676572206e6f74206e756c6c2c0a20206c6f636174696f6e5f636f6465206368617261637465722076617279696e672831303029206e6f74206e756c6c2c0a202066756c6c5f6e616d65206368617261637465722076617279696e672832353529206e6f74206e756c6c2c0a2020636f6f7264696e61746573206a736f6e62206e756c6c2c0a2020637265617465645f61742074696d657374616d7020776974682074696d65207a6f6e65206e756c6c2064656661756c74206e6f7728292c0a2020757064617465645f61742074696d657374616d7020776974682074696d65207a6f6e65206e756c6c2064656661756c74206e6f7728292c0a20207472616e736665725f6d6574686f645f6e6f7465732074657874206e756c6c2c0a2020636f6e73747261696e7420696e7465726d6564696174655f73746f70735f706b6579207072696d617279206b657920286964292c0a2020636f6e73747261696e7420696e7465726d6564696174655f73746f70735f726f7574655f69645f666b657920666f726569676e204b45592028726f7574655f696429207265666572656e636573207472616e73706f72745f726f757465732028696429206f6e2064656c65746520434153434144450a29205441424c4553504143452070675f64656661756c74000000846372656174652074726967676572207365745f757064617465645f61745f696e7465726d6564696174655f73746f7073204245464f52450a757064617465206f6e20696e7465726d6564696174655f73746f707320666f72204541434820726f770a657865637574652046554e4354494f4e207365745f757064617465645f6174202829"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240704000000_create_sightseeing.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create sightseeing table for inventory management\n-- Uses bigserial id to align with existing number-based IDs in frontend\n\nDO $$\nBEGIN\n  IF NOT EXISTS (\n    SELECT 1 FROM information_schema.tables \n    WHERE table_schema = 'public' AND table_name = 'sightseeing'\n  ) THEN\n    CREATE TABLE public.sightseeing (\n      id BIGSERIAL PRIMARY KEY,\n      name TEXT NOT NULL,\n      description TEXT,\n      country TEXT NOT NULL,\n      city TEXT NOT NULL,\n      category TEXT,\n      status TEXT DEFAULT 'active' NOT NULL,\n      image_url TEXT,\n      images JSONB,\n      activities JSONB,\n      duration TEXT,\n      transfer_types JSONB,\n      transfer_options JSONB,\n      address TEXT,\n      google_map_link TEXT,\n      latitude NUMERIC,\n      longitude NUMERIC,\n      price JSONB,\n      difficulty_level TEXT,\n      season TEXT,\n      allowed_age_group TEXT,\n      days_of_week JSONB,\n      timing TEXT,\n      pickup_time TEXT,\n      package_options JSONB,\n      group_size_options JSONB,\n      pricing_options JSONB,\n      other_inclusions TEXT,\n      advisory TEXT,\n      cancellation_policy TEXT,\n      refund_policy TEXT,\n      confirmation_policy TEXT,\n      terms_conditions TEXT,\n      is_free BOOLEAN DEFAULT FALSE,\n      policies JSONB,\n      validity_period JSONB,\n      is_expired BOOLEAN DEFAULT FALSE,\n      expiration_notified BOOLEAN DEFAULT FALSE,\n      currency TEXT,\n      sic_available BOOLEAN DEFAULT FALSE,\n      sic_pricing JSONB,\n      requires_mandatory_transfer BOOLEAN DEFAULT FALSE,\n      transfer_mandatory BOOLEAN DEFAULT FALSE,\n      created_at TIMESTAMPTZ DEFAULT timezone('utc'::text, now()) NOT NULL,\n      last_updated TIMESTAMPTZ DEFAULT timezone('utc'::text, now()) NOT NULL\n    );\n\n    -- Indexes for common filters\n    CREATE INDEX IF NOT EXISTS idx_sightseeing_status ON public.sightseeing(status);\n    CREATE INDEX IF NOT EXISTS idx_sightseeing_country_city ON public.sightseeing(country, city);\n  END IF;\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Ensure status values are constrained to known states\nDO $$\nBEGIN\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_constraint WHERE conname = 'sightseeing_status_check'\n  ) THEN\n    ALTER TABLE public.sightseeing\n    ADD CONSTRAINT sightseeing_status_check CHECK (status IN ('active', 'inactive'));\n  END IF;\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Trigger to auto-update last_updated on row change\nCREATE OR REPLACE FUNCTION public.update_sightseeing_last_updated()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.last_updated = timezone('utc'::text, now());\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DO $$\nBEGIN\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_trigger WHERE tgname = 'trg_update_sightseeing_last_updated'\n  ) THEN\n    CREATE TRIGGER trg_update_sightseeing_last_updated\n    BEFORE UPDATE ON public.sightseeing\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_sightseeing_last_updated();\n  END IF;\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240704000000"},{"text":"create_sightseeing"},{"binary":"00000001000000000000001900000004000000010000079d2d2d20437265617465207369676874736565696e67207461626c6520666f7220696e76656e746f7279206d616e6167656d656e740a2d2d20557365732062696773657269616c20696420746f20616c69676e2077697468206578697374696e67206e756d6265722d62617365642049447320696e2066726f6e74656e640a0a444f2024240a424547494e0a20204946204e4f542045584953545320280a2020202053454c45435420312046524f4d20696e666f726d6174696f6e5f736368656d612e7461626c6573200a202020205748455245207461626c655f736368656d61203d20277075626c69632720414e44207461626c655f6e616d65203d20277369676874736565696e67270a202029205448454e0a20202020435245415445205441424c45207075626c69632e7369676874736565696e6720280a20202020202069642042494753455249414c205052494d415259204b45592c0a2020202020206e616d652054455854204e4f54204e554c4c2c0a2020202020206465736372697074696f6e20544558542c0a202020202020636f756e7472792054455854204e4f54204e554c4c2c0a202020202020636974792054455854204e4f54204e554c4c2c0a20202020202063617465676f727920544558542c0a20202020202073746174757320544558542044454641554c54202761637469766527204e4f54204e554c4c2c0a202020202020696d6167655f75726c20544558542c0a202020202020696d61676573204a534f4e422c0a20202020202061637469766974696573204a534f4e422c0a2020202020206475726174696f6e20544558542c0a2020202020207472616e736665725f7479706573204a534f4e422c0a2020202020207472616e736665725f6f7074696f6e73204a534f4e422c0a2020202020206164647265737320544558542c0a202020202020676f6f676c655f6d61705f6c696e6b20544558542c0a2020202020206c61746974756465204e554d455249432c0a2020202020206c6f6e676974756465204e554d455249432c0a2020202020207072696365204a534f4e422c0a202020202020646966666963756c74795f6c6576656c20544558542c0a202020202020736561736f6e20544558542c0a202020202020616c6c6f7765645f6167655f67726f757020544558542c0a202020202020646179735f6f665f7765656b204a534f4e422c0a20202020202074696d696e6720544558542c0a2020202020207069636b75705f74696d6520544558542c0a2020202020207061636b6167655f6f7074696f6e73204a534f4e422c0a20202020202067726f75705f73697a655f6f7074696f6e73204a534f4e422c0a20202020202070726963696e675f6f7074696f6e73204a534f4e422c0a2020202020206f746865725f696e636c7573696f6e7320544558542c0a20202020202061647669736f727920544558542c0a20202020202063616e63656c6c6174696f6e5f706f6c69637920544558542c0a202020202020726566756e645f706f6c69637920544558542c0a202020202020636f6e6669726d6174696f6e5f706f6c69637920544558542c0a2020202020207465726d735f636f6e646974696f6e7320544558542c0a20202020202069735f6672656520424f4f4c45414e2044454641554c542046414c53452c0a202020202020706f6c6963696573204a534f4e422c0a20202020202076616c69646974795f706572696f64204a534f4e422c0a20202020202069735f6578706972656420424f4f4c45414e2044454641554c542046414c53452c0a20202020202065787069726174696f6e5f6e6f74696669656420424f4f4c45414e2044454641554c542046414c53452c0a20202020202063757272656e637920544558542c0a2020202020207369635f617661696c61626c6520424f4f4c45414e2044454641554c542046414c53452c0a2020202020207369635f70726963696e67204a534f4e422c0a20202020202072657175697265735f6d616e6461746f72795f7472616e7366657220424f4f4c45414e2044454641554c542046414c53452c0a2020202020207472616e736665725f6d616e6461746f727920424f4f4c45414e2044454641554c542046414c53452c0a202020202020637265617465645f61742054494d455354414d50545a2044454641554c542074696d657a6f6e652827757463273a3a746578742c206e6f77282929204e4f54204e554c4c2c0a2020202020206c6173745f757064617465642054494d455354414d50545a2044454641554c542074696d657a6f6e652827757463273a3a746578742c206e6f77282929204e4f54204e554c4c0a20202020293b0a0a202020202d2d20496e646578657320666f7220636f6d6d6f6e2066696c746572730a2020202043524541544520494e444558204946204e4f5420455849535453206964785f7369676874736565696e675f737461747573204f4e207075626c69632e7369676874736565696e6728737461747573293b0a2020202043524541544520494e444558204946204e4f5420455849535453206964785f7369676874736565696e675f636f756e7472795f63697479204f4e207075626c69632e7369676874736565696e6728636f756e7472792c2063697479293b0a2020454e442049463b0a454e44202424000001332d2d20456e73757265207374617475732076616c7565732061726520636f6e73747261696e656420746f206b6e6f776e207374617465730a444f2024240a424547494e0a20204946204e4f542045584953545320280a2020202053454c45435420312046524f4d2070675f636f6e73747261696e7420574845524520636f6e6e616d65203d20277369676874736565696e675f7374617475735f636865636b270a202029205448454e0a20202020414c544552205441424c45207075626c69632e7369676874736565696e670a2020202041444420434f4e53545241494e54207369676874736565696e675f7374617475735f636865636b20434845434b202873746174757320494e202827616374697665272c2027696e6163746976652729293b0a2020454e442049463b0a454e44202424000000ee2d2d205472696767657220746f206175746f2d757064617465206c6173745f75706461746564206f6e20726f77206368616e67650a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e7570646174655f7369676874736565696e675f6c6173745f7570646174656428290a52455455524e5320545249474745522041532024240a424547494e0a20204e45572e6c6173745f75706461746564203d2074696d657a6f6e652827757463273a3a746578742c206e6f772829293b0a202052455455524e204e45573b0a454e443b0a2424204c414e475541474520706c706773716c00000138444f2024240a424547494e0a20204946204e4f542045584953545320280a2020202053454c45435420312046524f4d2070675f747269676765722057484552452074676e616d65203d20277472675f7570646174655f7369676874736565696e675f6c6173745f75706461746564270a202029205448454e0a202020204352454154452054524947474552207472675f7570646174655f7369676874736565696e675f6c6173745f757064617465640a202020204245464f524520555044415445204f4e207075626c69632e7369676874736565696e670a20202020464f52204541434820524f570a20202020455845435554452046554e4354494f4e207075626c69632e7570646174655f7369676874736565696e675f6c6173745f7570646174656428293b0a2020454e442049463b0a454e44202424"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240704010000_create_sightseeing_options.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"create table public.sightseeing_options (\n  id uuid not null default gen_random_uuid (),\n  route_id uuid not null,\n  location character varying(255) not null,\n  description text null,\n  adult_price numeric(10, 2) not null,\n  child_price numeric(10, 2) not null,\n  additional_charges numeric(10, 2) null default 0,\n  created_at timestamp with time zone null default now(),\n  updated_at timestamp with time zone null default now(),\n  constraint sightseeing_options_pkey primary key (id),\n  constraint sightseeing_options_route_id_fkey foreign KEY (route_id) references transport_routes (id) on delete CASCADE\n) TABLESPACE pg_default","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"create trigger set_updated_at_sightseeing_options BEFORE\nupdate on sightseeing_options for EACH row\nexecute FUNCTION set_updated_at ()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240704010000"},{"text":"create_sightseeing_options"},{"binary":"000000010000000000000019000000020000000100000276637265617465207461626c65207075626c69632e7369676874736565696e675f6f7074696f6e7320280a202069642075756964206e6f74206e756c6c2064656661756c742067656e5f72616e646f6d5f757569642028292c0a2020726f7574655f69642075756964206e6f74206e756c6c2c0a20206c6f636174696f6e206368617261637465722076617279696e672832353529206e6f74206e756c6c2c0a20206465736372697074696f6e2074657874206e756c6c2c0a20206164756c745f7072696365206e756d657269632831302c203229206e6f74206e756c6c2c0a20206368696c645f7072696365206e756d657269632831302c203229206e6f74206e756c6c2c0a20206164646974696f6e616c5f63686172676573206e756d657269632831302c203229206e756c6c2064656661756c7420302c0a2020637265617465645f61742074696d657374616d7020776974682074696d65207a6f6e65206e756c6c2064656661756c74206e6f7728292c0a2020757064617465645f61742074696d657374616d7020776974682074696d65207a6f6e65206e756c6c2064656661756c74206e6f7728292c0a2020636f6e73747261696e74207369676874736565696e675f6f7074696f6e735f706b6579207072696d617279206b657920286964292c0a2020636f6e73747261696e74207369676874736565696e675f6f7074696f6e735f726f7574655f69645f666b657920666f726569676e204b45592028726f7574655f696429207265666572656e636573207472616e73706f72745f726f757465732028696429206f6e2064656c65746520434153434144450a29205441424c4553504143452070675f64656661756c74000000866372656174652074726967676572207365745f757064617465645f61745f7369676874736565696e675f6f7074696f6e73204245464f52450a757064617465206f6e207369676874736565696e675f6f7074696f6e7320666f72204541434820726f770a657865637574652046554e4354494f4e207365745f757064617465645f6174202829"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240704090000_create_get_current_user_role_function.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Early definition of get_current_user_role used by RLS policies\nCREATE OR REPLACE FUNCTION get_current_user_role()\nRETURNS TEXT\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n    user_role TEXT;\nBEGIN\n    IF auth.uid() IS NULL THEN\n        RETURN 'guest';\n    END IF;\n\n    SELECT role INTO user_role\n    FROM public.user_roles\n    WHERE user_id = auth.uid()\n    LIMIT 1;\n\n    IF user_role IS NULL THEN\n        RETURN 'user';\n    END IF;\n\n    RETURN user_role;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION get_current_user_role() TO authenticated, anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240704090000"},{"text":"create_get_current_user_role_function"},{"binary":"0000000100000000000000190000000200000001000001ef2d2d204561726c7920646566696e6974696f6e206f66206765745f63757272656e745f757365725f726f6c65207573656420627920524c5320706f6c69636965730a435245415445204f52205245504c4143452046554e4354494f4e206765745f63757272656e745f757365725f726f6c6528290a52455455524e5320544558540a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a4445434c4152450a20202020757365725f726f6c6520544558543b0a424547494e0a20202020494620617574682e7569642829204953204e554c4c205448454e0a202020202020202052455455524e20276775657374273b0a20202020454e442049463b0a0a2020202053454c45435420726f6c6520494e544f20757365725f726f6c650a2020202046524f4d207075626c69632e757365725f726f6c65730a20202020574845524520757365725f6964203d20617574682e75696428290a202020204c494d495420313b0a0a20202020494620757365725f726f6c65204953204e554c4c205448454e0a202020202020202052455455524e202775736572273b0a20202020454e442049463b0a0a2020202052455455524e20757365725f726f6c653b0a454e443b0a2424000000484752414e542045584543555445204f4e2046554e4354494f4e206765745f63757272656e745f757365725f726f6c65282920544f2061757468656e746963617465642c20616e6f6e"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240705000000_create_staff_sequence.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Staff Sequence table for auto-assignment order\n-- Creates a persistent sequence for staff used by the /queries/assign module\n\n-- Table\nCREATE TABLE IF NOT EXISTS public.staff_sequence (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  staff_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,\n  sequence_order INTEGER NOT NULL,\n  auto_assign_enabled BOOLEAN DEFAULT true,\n\n  created_by UUID REFERENCES public.profiles(id) ON DELETE SET NULL,\n  updated_by UUID REFERENCES public.profiles(id) ON DELETE SET NULL,\n\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n\n  CONSTRAINT unique_staff_sequence UNIQUE(staff_id),\n  CONSTRAINT valid_sequence_order CHECK (sequence_order \u003e 0)\n)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Indexes\nCREATE INDEX IF NOT EXISTS idx_staff_sequence_order ON public.staff_sequence(sequence_order)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE INDEX IF NOT EXISTS idx_staff_sequence_staff ON public.staff_sequence(staff_id)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- RLS\nALTER TABLE public.staff_sequence ENABLE ROW LEVEL SECURITY","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Policies\nCREATE POLICY \"Authenticated can view staff sequence\" ON public.staff_sequence\n  FOR SELECT USING (\n    get_current_user_role() IN ('staff', 'manager', 'super_admin')\n  )","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE POLICY \"Admins can manage staff sequence\" ON public.staff_sequence\n  FOR ALL USING (\n    get_current_user_role() IN ('manager', 'super_admin')\n  )","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Trigger to update updated_at\nCREATE TRIGGER update_staff_sequence_updated_at BEFORE UPDATE ON public.staff_sequence\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Comment\nCOMMENT ON TABLE public.staff_sequence IS 'Persistent staff sequence order for auto-assignment with RLS policies'","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240705000000"},{"text":"create_staff_sequence"},{"binary":"0000000100000000000000190000000800000001000002ea2d2d2053746166662053657175656e6365207461626c6520666f72206175746f2d61737369676e6d656e74206f726465720a2d2d204372656174657320612070657273697374656e742073657175656e636520666f72207374616666207573656420627920746865202f717565726965732f61737369676e206d6f64756c650a0a2d2d205461626c650a435245415445205441424c45204946204e4f5420455849535453207075626c69632e73746166665f73657175656e636520280a202069642055554944205052494d415259204b45592044454641554c542067656e5f72616e646f6d5f7575696428292c0a202073746166665f69642055554944204e4f54204e554c4c205245464552454e434553207075626c69632e70726f66696c657328696429204f4e2044454c45544520434153434144452c0a202073657175656e63655f6f7264657220494e5445474552204e4f54204e554c4c2c0a20206175746f5f61737369676e5f656e61626c656420424f4f4c45414e2044454641554c5420747275652c0a0a2020637265617465645f62792055554944205245464552454e434553207075626c69632e70726f66696c657328696429204f4e2044454c45544520534554204e554c4c2c0a2020757064617465645f62792055554944205245464552454e434553207075626c69632e70726f66696c657328696429204f4e2044454c45544520534554204e554c4c2c0a0a2020637265617465645f61742054494d455354414d50545a204e4f54204e554c4c2044454641554c54204e4f5728292c0a2020757064617465645f61742054494d455354414d50545a204e4f54204e554c4c2044454641554c54204e4f5728292c0a0a2020434f4e53545241494e5420756e697175655f73746166665f73657175656e636520554e495155452873746166665f6964292c0a2020434f4e53545241494e542076616c69645f73657175656e63655f6f7264657220434845434b202873657175656e63655f6f72646572203e2030290a29000000672d2d20496e64657865730a43524541544520494e444558204946204e4f5420455849535453206964785f73746166665f73657175656e63655f6f72646572204f4e207075626c69632e73746166665f73657175656e63652873657175656e63655f6f72646572290000005643524541544520494e444558204946204e4f5420455849535453206964785f73746166665f73657175656e63655f7374616666204f4e207075626c69632e73746166665f73657175656e63652873746166665f696429000000422d2d20524c530a414c544552205441424c45207075626c69632e73746166665f73657175656e636520454e41424c4520524f57204c4556454c205345435552495459000000b62d2d20506f6c69636965730a43524541544520504f4c494359202241757468656e746963617465642063616e20766965772073746166662073657175656e636522204f4e207075626c69632e73746166665f73657175656e63650a2020464f522053454c454354205553494e4720280a202020206765745f63757272656e745f757365725f726f6c65282920494e2028277374616666272c20276d616e61676572272c202773757065725f61646d696e27290a2020290000009943524541544520504f4c494359202241646d696e732063616e206d616e6167652073746166662073657175656e636522204f4e207075626c69632e73746166665f73657175656e63650a2020464f5220414c4c205553494e4720280a202020206765745f63757272656e745f757365725f726f6c65282920494e2028276d616e61676572272c202773757065725f61646d696e27290a202029000000b32d2d205472696767657220746f2075706461746520757064617465645f61740a4352454154452054524947474552207570646174655f73746166665f73657175656e63655f757064617465645f6174204245464f524520555044415445204f4e207075626c69632e73746166665f73657175656e63650a20202020464f52204541434820524f5720455845435554452046554e4354494f4e207570646174655f757064617465645f61745f636f6c756d6e28290000007c2d2d20436f6d6d656e740a434f4d4d454e54204f4e205441424c45207075626c69632e73746166665f73657175656e6365204953202750657273697374656e742073746166662073657175656e6365206f7264657220666f72206175746f2d61737369676e6d656e74207769746820524c5320706f6c696369657327"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMENT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240712100000_handle_new_user_trigger.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- supabase/migrations/20240712100000_handle_new_user_trigger.sql\n\n-- Drop the existing trigger and function if they exist, to ensure a clean setup\nDROP TRIGGER IF EXISTS on_auth_user_created ON auth.users","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DROP FUNCTION IF EXISTS public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create the function to handle new user creation\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nBEGIN\n  -- Insert a new profile record for the new user\n  -- The 'id' comes from the new user record in auth.users\n  -- 'name' can be a default value or extracted from raw_user_meta_data if available\n  -- 'email' is also available from the new user record\n  INSERT INTO public.profiles (id, name, email)\n  VALUES (\n    NEW.id,\n    COALESCE(NEW.raw_user_meta_data-\u003e\u003e'name', 'New User'),\n    NEW.email\n  )\n  ON CONFLICT (id) DO NOTHING; -- Avoid errors if a profile already exists\n\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create the trigger to call the function after a new user is created\nCREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW\n  EXECUTE FUNCTION public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240712100000"},{"text":"handle_new_user_trigger"},{"binary":"0000000100000000000000190000000400000001000000cd2d2d2073757061626173652f6d6967726174696f6e732f32303234303731323130303030305f68616e646c655f6e65775f757365725f747269676765722e73716c0a0a2d2d2044726f7020746865206578697374696e67207472696767657220616e642066756e6374696f6e20696620746865792065786973742c20746f20656e73757265206120636c65616e2073657475700a44524f50205452494747455220494620455849535453206f6e5f617574685f757365725f63726561746564204f4e20617574682e75736572730000003044524f502046554e4354494f4e20494620455849535453207075626c69632e68616e646c655f6e65775f757365722829000002ad2d2d20437265617465207468652066756e6374696f6e20746f2068616e646c65206e65772075736572206372656174696f6e0a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a424547494e0a20202d2d20496e736572742061206e65772070726f66696c65207265636f726420666f7220746865206e657720757365720a20202d2d20546865202769642720636f6d65732066726f6d20746865206e65772075736572207265636f726420696e20617574682e75736572730a20202d2d20276e616d65272063616e20626520612064656661756c742076616c7565206f72206578747261637465642066726f6d207261775f757365725f6d6574615f6461746120696620617661696c61626c650a20202d2d2027656d61696c2720697320616c736f20617661696c61626c652066726f6d20746865206e65772075736572207265636f72640a2020494e5345525420494e544f207075626c69632e70726f66696c6573202869642c206e616d652c20656d61696c290a202056414c55455320280a202020204e45572e69642c0a20202020434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c20274e6577205573657227292c0a202020204e45572e656d61696c0a2020290a20204f4e20434f4e464c494354202869642920444f204e4f5448494e473b202d2d2041766f6964206572726f727320696620612070726f66696c6520616c7265616479206578697374730a0a202052455455524e204e45573b0a454e443b0a2424000000c22d2d2043726561746520746865207472696767657220746f2063616c6c207468652066756e6374696f6e2061667465722061206e6577207573657220697320637265617465640a4352454154452054524947474552206f6e5f617574685f757365725f637265617465640a2020414654455220494e53455254204f4e20617574682e75736572730a2020464f52204541434820524f570a2020455845435554452046554e4354494f4e207075626c69632e68616e646c655f6e65775f757365722829"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"trigger \"on_auth_user_created\" for relation \"auth.users\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
NOTICE (00000): trigger "on_auth_user_created" for relation "auth.users" does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"function public.handle_new_user() does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
NOTICE (00000): function public.handle_new_user() does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240715120000_fix_handle_new_user_trigger.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- supabase/migrations/20240715120000_fix_handle_new_user_trigger.sql\n\n-- Drop the existing trigger and function to ensure a clean slate\nDROP TRIGGER IF EXISTS on_auth_user_created ON auth.users","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DROP FUNCTION IF EXISTS public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Profileâ†”Agent sync housekeeping\nDROP TRIGGER IF EXISTS on_profile_insert_sync_agent ON public.profiles","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DROP TRIGGER IF EXISTS on_profile_update_sync_agent ON public.profiles","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Also drop potential legacy-named triggers\nDROP TRIGGER IF EXISTS on_agent_profile_insert ON public.profiles","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DROP TRIGGER IF EXISTS on_agent_profile_update ON public.profiles","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Use CASCADE to remove dependent triggers if any remain\nDROP FUNCTION IF EXISTS public.handle_agent_profile_insert() CASCADE","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DROP FUNCTION IF EXISTS public.handle_agent_profile_update() CASCADE","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create the function to insert a new user profile\nCREATE FUNCTION public.handle_new_user()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nBEGIN\n  -- Insert a new profile record for the new user\n  INSERT INTO public.profiles (id, email, name, role)\n  VALUES (\n    NEW.id,\n    NEW.email,\n    NEW.raw_user_meta_data-\u003e\u003e'name',\n    'agent' -- Default role for new sign-ups\n  )\n  ON CONFLICT (id) DO NOTHING;\n\n  -- Also insert/upsert an agent record linked to the same user\n  INSERT INTO public.agents (\n    id,\n    user_id,\n    status,\n    name,\n    email,\n    business_phone,\n    source_type,\n    source_details\n  )\n  VALUES (\n    NEW.id,\n    NEW.id,\n    'inactive',\n    COALESCE(NEW.raw_user_meta_data-\u003e\u003e'name', NEW.email),\n    NEW.email,\n    NULLIF(NEW.raw_user_meta_data-\u003e\u003e'phone', ''),\n    'auth',\n    'on_auth_user_created'\n  )\n  ON CONFLICT (id) DO UPDATE SET\n    user_id = EXCLUDED.user_id,\n    name = COALESCE(EXCLUDED.name, agents.name),\n    email = COALESCE(EXCLUDED.email, agents.email),\n    status = COALESCE(EXCLUDED.status, agents.status),\n    business_phone = COALESCE(EXCLUDED.business_phone, agents.business_phone),\n    updated_at = now();\n\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create the trigger to execute the function after a new user is created in auth.users\nCREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW\n  EXECUTE FUNCTION public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Sync agent on profile INSERT\nCREATE FUNCTION public.handle_agent_profile_insert()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nBEGIN\n  INSERT INTO public.agents (\n    id,\n    user_id,\n    status,\n    name,\n    email,\n    agency_name,\n    source_type,\n    source_details\n  )\n  VALUES (\n    NEW.id,\n    NEW.id,\n    'inactive',\n    COALESCE(NEW.name, NEW.email),\n    COALESCE(NEW.email, NEW.id::text),\n    NULLIF(NEW.company_name, ''),\n    'profile',\n    'on_profile_insert'\n  )\n  ON CONFLICT (id) DO UPDATE SET\n    user_id = EXCLUDED.user_id,\n    name = COALESCE(EXCLUDED.name, agents.name),\n    email = COALESCE(EXCLUDED.email, agents.email),\n    agency_name = COALESCE(EXCLUDED.agency_name, agents.agency_name),\n    updated_at = now();\n\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE TRIGGER on_profile_insert_sync_agent\n  AFTER INSERT ON public.profiles\n  FOR EACH ROW\n  EXECUTE FUNCTION public.handle_agent_profile_insert()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Sync agent on profile UPDATE\nCREATE FUNCTION public.handle_agent_profile_update()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nBEGIN\n  UPDATE public.agents AS a SET\n    name = COALESCE(NEW.name, a.name),\n    email = COALESCE(NEW.email, a.email),\n    agency_name = COALESCE(NULLIF(NEW.company_name, ''), a.agency_name),\n    updated_at = now()\n  WHERE a.id = NEW.id;\n\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE TRIGGER on_profile_update_sync_agent\n  AFTER UPDATE ON public.profiles\n  FOR EACH ROW\n  EXECUTE FUNCTION public.handle_agent_profile_update()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240715120000"},{"text":"fix_handle_new_user_trigger"},{"binary":"0000000100000000000000190000000e00000001000000c22d2d2073757061626173652f6d6967726174696f6e732f32303234303731353132303030305f6669785f68616e646c655f6e65775f757365725f747269676765722e73716c0a0a2d2d2044726f7020746865206578697374696e67207472696767657220616e642066756e6374696f6e20746f20656e73757265206120636c65616e20736c6174650a44524f50205452494747455220494620455849535453206f6e5f617574685f757365725f63726561746564204f4e20617574682e75736572730000003044524f502046554e4354494f4e20494620455849535453207075626c69632e68616e646c655f6e65775f7573657228290000006b2d2d2050726f66696c65e286944167656e742073796e6320686f7573656b656570696e670a44524f50205452494747455220494620455849535453206f6e5f70726f66696c655f696e736572745f73796e635f6167656e74204f4e207075626c69632e70726f66696c65730000004644524f50205452494747455220494620455849535453206f6e5f70726f66696c655f7570646174655f73796e635f6167656e74204f4e207075626c69632e70726f66696c65730000006e2d2d20416c736f2064726f7020706f74656e7469616c206c65676163792d6e616d65642074726967676572730a44524f50205452494747455220494620455849535453206f6e5f6167656e745f70726f66696c655f696e73657274204f4e207075626c69632e70726f66696c65730000004144524f50205452494747455220494620455849535453206f6e5f6167656e745f70726f66696c655f757064617465204f4e207075626c69632e70726f66696c65730000007e2d2d20557365204341534341444520746f2072656d6f766520646570656e64656e7420747269676765727320696620616e792072656d61696e0a44524f502046554e4354494f4e20494620455849535453207075626c69632e68616e646c655f6167656e745f70726f66696c655f696e73657274282920434153434144450000004444524f502046554e4354494f4e20494620455849535453207075626c69632e68616e646c655f6167656e745f70726f66696c655f75706461746528292043415343414445000004bb2d2d20437265617465207468652066756e6374696f6e20746f20696e736572742061206e657720757365722070726f66696c650a4352454154452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a424547494e0a20202d2d20496e736572742061206e65772070726f66696c65207265636f726420666f7220746865206e657720757365720a2020494e5345525420494e544f207075626c69632e70726f66696c6573202869642c20656d61696c2c206e616d652c20726f6c65290a202056414c55455320280a202020204e45572e69642c0a202020204e45572e656d61696c2c0a202020204e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c0a20202020276167656e7427202d2d2044656661756c7420726f6c6520666f72206e6577207369676e2d7570730a2020290a20204f4e20434f4e464c494354202869642920444f204e4f5448494e473b0a0a20202d2d20416c736f20696e736572742f75707365727420616e206167656e74207265636f7264206c696e6b656420746f207468652073616d6520757365720a2020494e5345525420494e544f207075626c69632e6167656e747320280a2020202069642c0a20202020757365725f69642c0a202020207374617475732c0a202020206e616d652c0a20202020656d61696c2c0a20202020627573696e6573735f70686f6e652c0a20202020736f757263655f747970652c0a20202020736f757263655f64657461696c730a2020290a202056414c55455320280a202020204e45572e69642c0a202020204e45572e69642c0a2020202027696e616374697665272c0a20202020434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c204e45572e656d61696c292c0a202020204e45572e656d61696c2c0a202020204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2770686f6e65272c202727292c0a202020202761757468272c0a20202020276f6e5f617574685f757365725f63726561746564270a2020290a20204f4e20434f4e464c494354202869642920444f20555044415445205345540a20202020757365725f6964203d204558434c554445442e757365725f69642c0a202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c206167656e74732e6e616d65292c0a20202020656d61696c203d20434f414c45534345284558434c554445442e656d61696c2c206167656e74732e656d61696c292c0a20202020737461747573203d20434f414c45534345284558434c554445442e7374617475732c206167656e74732e737461747573292c0a20202020627573696e6573735f70686f6e65203d20434f414c45534345284558434c554445442e627573696e6573735f70686f6e652c206167656e74732e627573696e6573735f70686f6e65292c0a20202020757064617465645f6174203d206e6f7728293b0a0a202052455455524e204e45573b0a454e443b0a2424000000d32d2d2043726561746520746865207472696767657220746f2065786563757465207468652066756e6374696f6e2061667465722061206e65772075736572206973206372656174656420696e20617574682e75736572730a4352454154452054524947474552206f6e5f617574685f757365725f637265617465640a2020414654455220494e53455254204f4e20617574682e75736572730a2020464f52204541434820524f570a2020455845435554452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290000031d2d2d2053796e63206167656e74206f6e2070726f66696c6520494e534552540a4352454154452046554e4354494f4e207075626c69632e68616e646c655f6167656e745f70726f66696c655f696e7365727428290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a424547494e0a2020494e5345525420494e544f207075626c69632e6167656e747320280a2020202069642c0a20202020757365725f69642c0a202020207374617475732c0a202020206e616d652c0a20202020656d61696c2c0a202020206167656e63795f6e616d652c0a20202020736f757263655f747970652c0a20202020736f757263655f64657461696c730a2020290a202056414c55455320280a202020204e45572e69642c0a202020204e45572e69642c0a2020202027696e616374697665272c0a20202020434f414c45534345284e45572e6e616d652c204e45572e656d61696c292c0a20202020434f414c45534345284e45572e656d61696c2c204e45572e69643a3a74657874292c0a202020204e554c4c4946284e45572e636f6d70616e795f6e616d652c202727292c0a202020202770726f66696c65272c0a20202020276f6e5f70726f66696c655f696e73657274270a2020290a20204f4e20434f4e464c494354202869642920444f20555044415445205345540a20202020757365725f6964203d204558434c554445442e757365725f69642c0a202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c206167656e74732e6e616d65292c0a20202020656d61696c203d20434f414c45534345284558434c554445442e656d61696c2c206167656e74732e656d61696c292c0a202020206167656e63795f6e616d65203d20434f414c45534345284558434c554445442e6167656e63795f6e616d652c206167656e74732e6167656e63795f6e616d65292c0a20202020757064617465645f6174203d206e6f7728293b0a0a202052455455524e204e45573b0a454e443b0a2424000000944352454154452054524947474552206f6e5f70726f66696c655f696e736572745f73796e635f6167656e740a2020414654455220494e53455254204f4e207075626c69632e70726f66696c65730a2020464f52204541434820524f570a2020455845435554452046554e4354494f4e207075626c69632e68616e646c655f6167656e745f70726f66696c655f696e736572742829000001aa2d2d2053796e63206167656e74206f6e2070726f66696c65205550444154450a4352454154452046554e4354494f4e207075626c69632e68616e646c655f6167656e745f70726f66696c655f75706461746528290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a424547494e0a2020555044415445207075626c69632e6167656e74732041532061205345540a202020206e616d65203d20434f414c45534345284e45572e6e616d652c20612e6e616d65292c0a20202020656d61696c203d20434f414c45534345284e45572e656d61696c2c20612e656d61696c292c0a202020206167656e63795f6e616d65203d20434f414c45534345284e554c4c4946284e45572e636f6d70616e795f6e616d652c202727292c20612e6167656e63795f6e616d65292c0a20202020757064617465645f6174203d206e6f7728290a2020574845524520612e6964203d204e45572e69643b0a0a202052455455524e204e45573b0a454e443b0a2424000000944352454154452054524947474552206f6e5f70726f66696c655f7570646174655f73796e635f6167656e740a2020414654455220555044415445204f4e207075626c69632e70726f66696c65730a2020464f52204541434820524f570a2020455845435554452046554e4354494f4e207075626c69632e68616e646c655f6167656e745f70726f66696c655f7570646174652829"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"trigger \"on_profile_insert_sync_agent\" for relation \"public.profiles\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
NOTICE (00000): trigger "on_profile_insert_sync_agent" for relation "public.profiles" does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"trigger \"on_profile_update_sync_agent\" for relation \"public.profiles\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"trigger \"on_agent_profile_insert\" for relation \"public.profiles\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"trigger \"on_agent_profile_update\" for relation \"public.profiles\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"function public.handle_agent_profile_insert() does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
NOTICE (00000): trigger "on_profile_update_sync_agent" for relation "public.profiles" does not exist, skipping
NOTICE (00000): trigger "on_agent_profile_insert" for relation "public.profiles" does not exist, skipping
NOTICE (00000): trigger "on_agent_profile_update" for relation "public.profiles" does not exist, skipping
NOTICE (00000): function public.handle_agent_profile_insert() does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"function public.handle_agent_profile_update() does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
NOTICE (00000): function public.handle_agent_profile_update() does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240716170000_comprehensive_user_creation_fix.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Comprehensive fix for user creation trigger to handle all required profile fields\n-- This addresses the \"Database error saving new user\" issue\n\n-- Drop existing trigger and function\nDROP TRIGGER IF EXISTS on_auth_user_created ON auth.users","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DROP FUNCTION IF EXISTS public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create comprehensive function to handle new user creation\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  user_name TEXT;\n  user_role TEXT;\n  user_phone TEXT;\n  user_department TEXT;\n  user_position TEXT;\n  user_employee_id TEXT;\nBEGIN\n  -- Extract metadata with fallbacks\n  user_name := COALESCE(NEW.raw_user_meta_data-\u003e\u003e'name', split_part(NEW.email, '@', 1));\n  user_role := COALESCE(NEW.raw_user_meta_data-\u003e\u003e'role', 'agent');\n  user_phone := NEW.raw_user_meta_data-\u003e\u003e'phone';\n  user_department := COALESCE(NEW.raw_user_meta_data-\u003e\u003e'department', 'Agents');\n  user_position := COALESCE(NEW.raw_user_meta_data-\u003e\u003e'position', 'External Agent');\n  user_employee_id := NEW.raw_user_meta_data-\u003e\u003e'employee_id';\n\n  -- Insert profile with all required fields\n  INSERT INTO public.profiles (\n    id, \n    email, \n    name, \n    role, \n    phone, \n    department, \n    position, \n    employee_id,\n    status,\n    created_at,\n    updated_at\n  ) VALUES (\n    NEW.id,\n    NEW.email,\n    user_name,\n    user_role,\n    user_phone,\n    user_department,\n    user_position,\n    user_employee_id,\n    'active',\n    NOW(),\n    NOW()\n  )\n  ON CONFLICT (id) DO UPDATE SET\n    email = EXCLUDED.email,\n    name = COALESCE(EXCLUDED.name, profiles.name),\n    role = COALESCE(EXCLUDED.role, profiles.role),\n    phone = COALESCE(EXCLUDED.phone, profiles.phone),\n    department = COALESCE(EXCLUDED.department, profiles.department),\n    position = COALESCE(EXCLUDED.position, profiles.position),\n    employee_id = COALESCE(EXCLUDED.employee_id, profiles.employee_id),\n    updated_at = NOW();\n\n  -- If role is 'agent', also create agent record\n  IF user_role = 'agent' THEN\n    INSERT INTO public.agents (\n      user_id, \n      name, \n      email, \n      status, \n      created_at, \n      updated_at\n    ) VALUES (\n      NEW.id,\n      user_name,\n      NEW.email,\n      'active',\n      NOW(),\n      NOW()\n    )\n    ON CONFLICT (user_id) DO NOTHING;\n  END IF;\n\n  RETURN NEW;\nEXCEPTION\n  WHEN OTHERS THEN\n    -- Log error but don't fail the auth process\n    RAISE WARNING 'Error in handle_new_user: %', SQLERRM;\n    RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create the trigger\nCREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW\n  EXECUTE FUNCTION public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Grant necessary permissions\nGRANT USAGE ON SCHEMA public TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT ALL ON public.profiles TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT ALL ON public.agents TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240716170000"},{"text":"comprehensive_user_creation_fix"},{"binary":"0000000100000000000000190000000700000001000000f22d2d20436f6d70726568656e736976652066697820666f722075736572206372656174696f6e207472696767657220746f2068616e646c6520616c6c2072657175697265642070726f66696c65206669656c64730a2d2d2054686973206164647265737365732074686520224461746162617365206572726f7220736176696e67206e65772075736572222069737375650a0a2d2d2044726f70206578697374696e67207472696767657220616e642066756e6374696f6e0a44524f50205452494747455220494620455849535453206f6e5f617574685f757365725f63726561746564204f4e20617574682e75736572730000003044524f502046554e4354494f4e20494620455849535453207075626c69632e68616e646c655f6e65775f757365722829000008972d2d2043726561746520636f6d70726568656e736976652066756e6374696f6e20746f2068616e646c65206e65772075736572206372656174696f6e0a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a4445434c4152450a2020757365725f6e616d6520544558543b0a2020757365725f726f6c6520544558543b0a2020757365725f70686f6e6520544558543b0a2020757365725f6465706172746d656e7420544558543b0a2020757365725f706f736974696f6e20544558543b0a2020757365725f656d706c6f7965655f696420544558543b0a424547494e0a20202d2d2045787472616374206d6574616461746120776974682066616c6c6261636b730a2020757365725f6e616d65203a3d20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c2073706c69745f70617274284e45572e656d61696c2c202740272c203129293b0a2020757365725f726f6c65203a3d20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e27726f6c65272c20276167656e7427293b0a2020757365725f70686f6e65203a3d204e45572e7261775f757365725f6d6574615f646174612d3e3e2770686f6e65273b0a2020757365725f6465706172746d656e74203a3d20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e276465706172746d656e74272c20274167656e747327293b0a2020757365725f706f736974696f6e203a3d20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e27706f736974696f6e272c202745787465726e616c204167656e7427293b0a2020757365725f656d706c6f7965655f6964203a3d204e45572e7261775f757365725f6d6574615f646174612d3e3e27656d706c6f7965655f6964273b0a0a20202d2d20496e736572742070726f66696c65207769746820616c6c207265717569726564206669656c64730a2020494e5345525420494e544f207075626c69632e70726f66696c657320280a2020202069642c200a20202020656d61696c2c200a202020206e616d652c200a20202020726f6c652c200a2020202070686f6e652c200a202020206465706172746d656e742c200a20202020706f736974696f6e2c200a20202020656d706c6f7965655f69642c0a202020207374617475732c0a20202020637265617465645f61742c0a20202020757064617465645f61740a2020292056414c55455320280a202020204e45572e69642c0a202020204e45572e656d61696c2c0a20202020757365725f6e616d652c0a20202020757365725f726f6c652c0a20202020757365725f70686f6e652c0a20202020757365725f6465706172746d656e742c0a20202020757365725f706f736974696f6e2c0a20202020757365725f656d706c6f7965655f69642c0a2020202027616374697665272c0a202020204e4f5728292c0a202020204e4f5728290a2020290a20204f4e20434f4e464c494354202869642920444f20555044415445205345540a20202020656d61696c203d204558434c554445442e656d61696c2c0a202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c2070726f66696c65732e6e616d65292c0a20202020726f6c65203d20434f414c45534345284558434c554445442e726f6c652c2070726f66696c65732e726f6c65292c0a2020202070686f6e65203d20434f414c45534345284558434c554445442e70686f6e652c2070726f66696c65732e70686f6e65292c0a202020206465706172746d656e74203d20434f414c45534345284558434c554445442e6465706172746d656e742c2070726f66696c65732e6465706172746d656e74292c0a20202020706f736974696f6e203d20434f414c45534345284558434c554445442e706f736974696f6e2c2070726f66696c65732e706f736974696f6e292c0a20202020656d706c6f7965655f6964203d20434f414c45534345284558434c554445442e656d706c6f7965655f69642c2070726f66696c65732e656d706c6f7965655f6964292c0a20202020757064617465645f6174203d204e4f5728293b0a0a20202d2d20496620726f6c6520697320276167656e74272c20616c736f20637265617465206167656e74207265636f72640a2020494620757365725f726f6c65203d20276167656e7427205448454e0a20202020494e5345525420494e544f207075626c69632e6167656e747320280a202020202020757365725f69642c200a2020202020206e616d652c200a202020202020656d61696c2c200a2020202020207374617475732c200a202020202020637265617465645f61742c200a202020202020757064617465645f61740a20202020292056414c55455320280a2020202020204e45572e69642c0a202020202020757365725f6e616d652c0a2020202020204e45572e656d61696c2c0a20202020202027616374697665272c0a2020202020204e4f5728292c0a2020202020204e4f5728290a20202020290a202020204f4e20434f4e464c4943542028757365725f69642920444f204e4f5448494e473b0a2020454e442049463b0a0a202052455455524e204e45573b0a455843455054494f4e0a20205748454e204f5448455253205448454e0a202020202d2d204c6f67206572726f722062757420646f6e2774206661696c2074686520617574682070726f636573730a202020205241495345205741524e494e4720274572726f7220696e2068616e646c655f6e65775f757365723a2025272c2053514c4552524d3b0a2020202052455455524e204e45573b0a454e443b0a2424000000912d2d204372656174652074686520747269676765720a4352454154452054524947474552206f6e5f617574685f757365725f637265617465640a2020414654455220494e53455254204f4e20617574682e75736572730a2020464f52204541434820524f570a2020455845435554452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290000004c2d2d204772616e74206e6563657373617279207065726d697373696f6e730a4752414e54205553414745204f4e20534348454d41207075626c696320544f2061757468656e746963617465640000002d4752414e5420414c4c204f4e207075626c69632e70726f66696c657320544f2061757468656e746963617465640000002b4752414e5420414c4c204f4e207075626c69632e6167656e747320544f2061757468656e74696361746564"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20240716180000_fix_rls_for_user_creation.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Fix RLS issues for user creation triggers\n-- This migration addresses the \"new row violates row-level security policy\" error\n\n-- First, let's ensure RLS is properly configured for profiles table\nALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create RLS policies for profiles table\n-- Policy 1: Allow users to read their own profile\nDROP POLICY IF EXISTS \"Users can read own profile\" ON public.profiles","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE POLICY \"Users can read own profile\" ON public.profiles\n  FOR SELECT\n  USING (auth.uid() = id)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Policy 2: Allow users to update their own profile  \nDROP POLICY IF EXISTS \"Users can update own profile\" ON public.profiles","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE POLICY \"Users can update own profile\" ON public.profiles\n  FOR UPDATE\n  USING (auth.uid() = id)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Policy 3: Allow service role to manage all profiles (for admin operations)\nDROP POLICY IF EXISTS \"Service role can manage all profiles\" ON public.profiles","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE POLICY \"Service role can manage all profiles\" ON public.profiles\n  FOR ALL\n  USING (current_setting('role') = 'service_role')","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Policy 4: Allow authenticated users to insert their own profile during signup\n-- This is crucial for the trigger to work\nDROP POLICY IF EXISTS \"Allow profile creation during signup\" ON public.profiles","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE POLICY \"Allow profile creation during signup\" ON public.profiles\n  FOR INSERT\n  WITH CHECK (true)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Allow all inserts - the trigger will handle the logic\n\n-- Now recreate the handle_new_user function with SECURITY DEFINER\n-- This allows the function to bypass RLS policies\nDROP FUNCTION IF EXISTS public.handle_new_user() CASCADE","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER -- This is the key change - allows bypassing RLS\nSET search_path = public\nAS $$\nDECLARE\n  user_name TEXT;\n  user_role TEXT;\n  user_phone TEXT;\n  user_department TEXT;\n  user_position TEXT;\n  user_employee_id TEXT;\nBEGIN\n  -- Extract metadata with fallbacks\n  user_name := COALESCE(NEW.raw_user_meta_data-\u003e\u003e'name', split_part(NEW.email, '@', 1));\n  user_role := COALESCE(NEW.raw_user_meta_data-\u003e\u003e'role', 'agent');\n  user_phone := NEW.raw_user_meta_data-\u003e\u003e'phone';\n  user_department := NEW.raw_user_meta_data-\u003e\u003e'department';\n  user_position := NEW.raw_user_meta_data-\u003e\u003e'position';\n  user_employee_id := NEW.raw_user_meta_data-\u003e\u003e'employee_id';\n\n  -- Insert into profiles with UPSERT to handle duplicates\n  INSERT INTO public.profiles (\n    id,\n    email,\n    name,\n    role,\n    phone,\n    department,\n    position,\n    employee_id,\n    created_at,\n    updated_at\n  ) VALUES (\n    NEW.id,\n    NEW.email,\n    user_name,\n    user_role,\n    user_phone,\n    user_department,\n    user_position,\n    user_employee_id,\n    NOW(),\n    NOW()\n  )\n  ON CONFLICT (id) DO UPDATE SET\n    name = COALESCE(EXCLUDED.name, profiles.name),\n    role = COALESCE(EXCLUDED.role, profiles.role),\n    phone = COALESCE(EXCLUDED.phone, profiles.phone),\n    department = COALESCE(EXCLUDED.department, profiles.department),\n    position = COALESCE(EXCLUDED.position, profiles.position),\n    employee_id = COALESCE(EXCLUDED.employee_id, profiles.employee_id),\n    updated_at = NOW();\n\n  -- If role is 'agent', create agent record\n  IF user_role = 'agent' THEN\n    INSERT INTO public.agents (\n      id,\n      user_id,\n      company_name,\n      contact_person,\n      phone,\n      email,\n      status,\n      created_at,\n      updated_at\n    ) VALUES (\n      gen_random_uuid(),\n      NEW.id,\n      COALESCE(NEW.raw_user_meta_data-\u003e\u003e'company_name', 'Unknown Company'),\n      user_name,\n      user_phone,\n      NEW.email,\n      'pending',\n      NOW(),\n      NOW()\n    )\n    ON CONFLICT (user_id) DO UPDATE SET\n      company_name = COALESCE(EXCLUDED.company_name, agents.company_name),\n      contact_person = COALESCE(EXCLUDED.contact_person, agents.contact_person),\n      phone = COALESCE(EXCLUDED.phone, agents.phone),\n      updated_at = NOW();\n  END IF;\n\n  RETURN NEW;\nEXCEPTION\n  WHEN OTHERS THEN\n    -- Log the error but don't fail the user creation\n    RAISE WARNING 'Error in handle_new_user: %', SQLERRM;\n    RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Recreate the trigger\nDROP TRIGGER IF EXISTS on_auth_user_created ON auth.users","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW\n  EXECUTE FUNCTION public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Grant necessary permissions\nGRANT USAGE ON SCHEMA public TO authenticated, anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT SELECT, INSERT, UPDATE ON public.profiles TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT SELECT, INSERT, UPDATE ON public.agents TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Grant execute permission on the function to the roles that need it\nGRANT EXECUTE ON FUNCTION public.handle_new_user() TO authenticated, anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Ensure the function owner has the right permissions\nALTER FUNCTION public.handle_new_user() OWNER TO postgres","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20240716180000"},{"text":"fix_rls_for_user_creation"},{"binary":"0000000100000000000000190000001200000001000000fb2d2d2046697820524c532069737375657320666f722075736572206372656174696f6e2074726967676572730a2d2d2054686973206d6967726174696f6e206164647265737365732074686520226e657720726f772076696f6c6174657320726f772d6c6576656c20736563757269747920706f6c69637922206572726f720a0a2d2d2046697273742c206c6574277320656e7375726520524c532069732070726f7065726c7920636f6e6669677572656420666f722070726f66696c6573207461626c650a414c544552205441424c45207075626c69632e70726f66696c657320454e41424c4520524f57204c4556454c205345435552495459000000a22d2d2043726561746520524c5320706f6c696369657320666f722070726f66696c6573207461626c650a2d2d20506f6c69637920313a20416c6c6f7720757365727320746f2072656164207468656972206f776e2070726f66696c650a44524f5020504f4c49435920494620455849535453202255736572732063616e2072656164206f776e2070726f66696c6522204f4e207075626c69632e70726f66696c65730000006443524541544520504f4c494359202255736572732063616e2072656164206f776e2070726f66696c6522204f4e207075626c69632e70726f66696c65730a2020464f522053454c4543540a20205553494e472028617574682e7569642829203d206964290000007e2d2d20506f6c69637920323a20416c6c6f7720757365727320746f20757064617465207468656972206f776e2070726f66696c6520200a44524f5020504f4c49435920494620455849535453202255736572732063616e20757064617465206f776e2070726f66696c6522204f4e207075626c69632e70726f66696c65730000006643524541544520504f4c494359202255736572732063616e20757064617465206f776e2070726f66696c6522204f4e207075626c69632e70726f66696c65730a2020464f52205550444154450a20205553494e472028617574682e7569642829203d206964290000009d2d2d20506f6c69637920333a20416c6c6f77207365727669636520726f6c6520746f206d616e61676520616c6c2070726f66696c65732028666f722061646d696e206f7065726174696f6e73290a44524f5020504f4c4943592049462045584953545320225365727669636520726f6c652063616e206d616e61676520616c6c2070726f66696c657322204f4e207075626c69632e70726f66696c65730000008443524541544520504f4c49435920225365727669636520726f6c652063616e206d616e61676520616c6c2070726f66696c657322204f4e207075626c69632e70726f66696c65730a2020464f5220414c4c0a20205553494e47202863757272656e745f73657474696e672827726f6c652729203d2027736572766963655f726f6c652729000000cb2d2d20506f6c69637920343a20416c6c6f772061757468656e7469636174656420757365727320746f20696e73657274207468656972206f776e2070726f66696c6520647572696e67207369676e75700a2d2d2054686973206973206372756369616c20666f7220746865207472696767657220746f20776f726b0a44524f5020504f4c494359204946204558495354532022416c6c6f772070726f66696c65206372656174696f6e20647572696e67207369676e757022204f4e207075626c69632e70726f66696c65730000006843524541544520504f4c4943592022416c6c6f772070726f66696c65206372656174696f6e20647572696e67207369676e757022204f4e207075626c69632e70726f66696c65730a2020464f5220494e534552540a20205749544820434845434b20287472756529000000e82d2d20416c6c6f7720616c6c20696e7365727473202d2074686520747269676765722077696c6c2068616e646c6520746865206c6f6769630a0a2d2d204e6f77207265637265617465207468652068616e646c655f6e65775f757365722066756e6374696f6e207769746820534543555249545920444546494e45520a2d2d205468697320616c6c6f7773207468652066756e6374696f6e20746f2062797061737320524c5320706f6c69636965730a44524f502046554e4354494f4e20494620455849535453207075626c69632e68616e646c655f6e65775f7573657228292043415343414445000009c2435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e4552202d2d205468697320697320746865206b6579206368616e6765202d20616c6c6f777320627970617373696e6720524c530a534554207365617263685f70617468203d207075626c69630a41532024240a4445434c4152450a2020757365725f6e616d6520544558543b0a2020757365725f726f6c6520544558543b0a2020757365725f70686f6e6520544558543b0a2020757365725f6465706172746d656e7420544558543b0a2020757365725f706f736974696f6e20544558543b0a2020757365725f656d706c6f7965655f696420544558543b0a424547494e0a20202d2d2045787472616374206d6574616461746120776974682066616c6c6261636b730a2020757365725f6e616d65203a3d20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c2073706c69745f70617274284e45572e656d61696c2c202740272c203129293b0a2020757365725f726f6c65203a3d20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e27726f6c65272c20276167656e7427293b0a2020757365725f70686f6e65203a3d204e45572e7261775f757365725f6d6574615f646174612d3e3e2770686f6e65273b0a2020757365725f6465706172746d656e74203a3d204e45572e7261775f757365725f6d6574615f646174612d3e3e276465706172746d656e74273b0a2020757365725f706f736974696f6e203a3d204e45572e7261775f757365725f6d6574615f646174612d3e3e27706f736974696f6e273b0a2020757365725f656d706c6f7965655f6964203a3d204e45572e7261775f757365725f6d6574615f646174612d3e3e27656d706c6f7965655f6964273b0a0a20202d2d20496e7365727420696e746f2070726f66696c657320776974682055505345525420746f2068616e646c65206475706c6963617465730a2020494e5345525420494e544f207075626c69632e70726f66696c657320280a2020202069642c0a20202020656d61696c2c0a202020206e616d652c0a20202020726f6c652c0a2020202070686f6e652c0a202020206465706172746d656e742c0a20202020706f736974696f6e2c0a20202020656d706c6f7965655f69642c0a20202020637265617465645f61742c0a20202020757064617465645f61740a2020292056414c55455320280a202020204e45572e69642c0a202020204e45572e656d61696c2c0a20202020757365725f6e616d652c0a20202020757365725f726f6c652c0a20202020757365725f70686f6e652c0a20202020757365725f6465706172746d656e742c0a20202020757365725f706f736974696f6e2c0a20202020757365725f656d706c6f7965655f69642c0a202020204e4f5728292c0a202020204e4f5728290a2020290a20204f4e20434f4e464c494354202869642920444f20555044415445205345540a202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c2070726f66696c65732e6e616d65292c0a20202020726f6c65203d20434f414c45534345284558434c554445442e726f6c652c2070726f66696c65732e726f6c65292c0a2020202070686f6e65203d20434f414c45534345284558434c554445442e70686f6e652c2070726f66696c65732e70686f6e65292c0a202020206465706172746d656e74203d20434f414c45534345284558434c554445442e6465706172746d656e742c2070726f66696c65732e6465706172746d656e74292c0a20202020706f736974696f6e203d20434f414c45534345284558434c554445442e706f736974696f6e2c2070726f66696c65732e706f736974696f6e292c0a20202020656d706c6f7965655f6964203d20434f414c45534345284558434c554445442e656d706c6f7965655f69642c2070726f66696c65732e656d706c6f7965655f6964292c0a20202020757064617465645f6174203d204e4f5728293b0a0a20202d2d20496620726f6c6520697320276167656e74272c20637265617465206167656e74207265636f72640a2020494620757365725f726f6c65203d20276167656e7427205448454e0a20202020494e5345525420494e544f207075626c69632e6167656e747320280a20202020202069642c0a202020202020757365725f69642c0a202020202020636f6d70616e795f6e616d652c0a202020202020636f6e746163745f706572736f6e2c0a20202020202070686f6e652c0a202020202020656d61696c2c0a2020202020207374617475732c0a202020202020637265617465645f61742c0a202020202020757064617465645f61740a20202020292056414c55455320280a20202020202067656e5f72616e646f6d5f7575696428292c0a2020202020204e45572e69642c0a202020202020434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f6d70616e795f6e616d65272c2027556e6b6e6f776e20436f6d70616e7927292c0a202020202020757365725f6e616d652c0a202020202020757365725f70686f6e652c0a2020202020204e45572e656d61696c2c0a2020202020202770656e64696e67272c0a2020202020204e4f5728292c0a2020202020204e4f5728290a20202020290a202020204f4e20434f4e464c4943542028757365725f69642920444f20555044415445205345540a202020202020636f6d70616e795f6e616d65203d20434f414c45534345284558434c554445442e636f6d70616e795f6e616d652c206167656e74732e636f6d70616e795f6e616d65292c0a202020202020636f6e746163745f706572736f6e203d20434f414c45534345284558434c554445442e636f6e746163745f706572736f6e2c206167656e74732e636f6e746163745f706572736f6e292c0a20202020202070686f6e65203d20434f414c45534345284558434c554445442e70686f6e652c206167656e74732e70686f6e65292c0a202020202020757064617465645f6174203d204e4f5728293b0a2020454e442049463b0a0a202052455455524e204e45573b0a455843455054494f4e0a20205748454e204f5448455253205448454e0a202020202d2d204c6f6720746865206572726f722062757420646f6e2774206661696c207468652075736572206372656174696f6e0a202020205241495345205741524e494e4720274572726f7220696e2068616e646c655f6e65775f757365723a2025272c2053514c4552524d3b0a2020202052455455524e204e45573b0a454e443b0a2424000000512d2d2052656372656174652074686520747269676765720a44524f50205452494747455220494620455849535453206f6e5f617574685f757365725f63726561746564204f4e20617574682e75736572730000007b4352454154452054524947474552206f6e5f617574685f757365725f637265617465640a2020414654455220494e53455254204f4e20617574682e75736572730a2020464f52204541434820524f570a2020455845435554452046554e4354494f4e207075626c69632e68616e646c655f6e65775f757365722829000000522d2d204772616e74206e6563657373617279207065726d697373696f6e730a4752414e54205553414745204f4e20534348454d41207075626c696320544f2061757468656e746963617465642c20616e6f6e000000404752414e542053454c4543542c20494e534552542c20555044415445204f4e207075626c69632e70726f66696c657320544f2061757468656e746963617465640000003e4752414e542053454c4543542c20494e534552542c20555044415445204f4e207075626c69632e6167656e747320544f2061757468656e746963617465640000008f2d2d204772616e742065786563757465207065726d697373696f6e206f6e207468652066756e6374696f6e20746f2074686520726f6c65732074686174206e6565642069740a4752414e542045584543555445204f4e2046554e4354494f4e207075626c69632e68616e646c655f6e65775f75736572282920544f2061757468656e746963617465642c20616e6f6e000000702d2d20456e73757265207468652066756e6374696f6e206f776e65722068617320746865207269676874207065726d697373696f6e730a414c5445522046554e4354494f4e207075626c69632e68616e646c655f6e65775f757365722829204f574e455220544f20706f737467726573"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"policy \"Users can read own profile\" for relation \"public.profiles\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
NOTICE (00000): policy "Users can read own profile" for relation "public.profiles" does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"policy \"Users can update own profile\" for relation \"public.profiles\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
NOTICE (00000): policy "Users can update own profile" for relation "public.profiles" does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"policy \"Service role can manage all profiles\" for relation \"public.profiles\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
NOTICE (00000): policy "Service role can manage all profiles" for relation "public.profiles" does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"policy \"Allow profile creation during signup\" for relation \"public.profiles\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
NOTICE (00000): policy "Allow profile creation during signup" for relation "public.profiles" does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"drop cascades to trigger on_auth_user_created on table auth.users","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dependency.c","Line":1176,"Routine":"reportDependentObjects","UnknownFields":null}
NOTICE (00000): drop cascades to trigger on_auth_user_created on table auth.users
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"trigger \"on_auth_user_created\" for relation \"auth.users\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
NOTICE (00000): trigger "on_auth_user_created" for relation "auth.users" does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20241201_add_get_agent_credentials_status_rpc.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add RPC function to get agent credentials status\nCREATE OR REPLACE FUNCTION get_agent_credentials_status(p_username TEXT)\nRETURNS TABLE(\n  found BOOLEAN,\n  is_temporary BOOLEAN,\n  agent_id UUID\n) \nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nBEGIN\n  RETURN QUERY\n  SELECT \n    TRUE as found,\n    ac.is_temporary,\n    ac.agent_id\n  FROM public.agent_credentials ac\n  WHERE ac.username = p_username;\n  \n  -- If no record found, return false\n  IF NOT FOUND THEN\n    RETURN QUERY SELECT FALSE as found, FALSE as is_temporary, NULL::UUID as agent_id;\n  END IF;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Grant execute permission to authenticated users\nGRANT EXECUTE ON FUNCTION get_agent_credentials_status(TEXT) TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20241201"},{"text":"add_get_agent_credentials_status_rpc"},{"binary":"0000000100000000000000190000000200000001000002312d2d20416464205250432066756e6374696f6e20746f20676574206167656e742063726564656e7469616c73207374617475730a435245415445204f52205245504c4143452046554e4354494f4e206765745f6167656e745f63726564656e7469616c735f73746174757328705f757365726e616d652054455854290a52455455524e53205441424c45280a2020666f756e6420424f4f4c45414e2c0a202069735f74656d706f7261727920424f4f4c45414e2c0a20206167656e745f696420555549440a29200a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a41532024240a424547494e0a202052455455524e2051554552590a202053454c454354200a202020205452554520617320666f756e642c0a2020202061632e69735f74656d706f726172792c0a2020202061632e6167656e745f69640a202046524f4d207075626c69632e6167656e745f63726564656e7469616c732061630a202057484552452061632e757365726e616d65203d20705f757365726e616d653b0a20200a20202d2d204966206e6f207265636f726420666f756e642c2072657475726e2066616c73650a20204946204e4f5420464f554e44205448454e0a2020202052455455524e2051554552592053454c4543542046414c534520617320666f756e642c2046414c53452061732069735f74656d706f726172792c204e554c4c3a3a55554944206173206167656e745f69643b0a2020454e442049463b0a454e443b0a2424000000802d2d204772616e742065786563757465207065726d697373696f6e20746f2061757468656e746963617465642075736572730a4752414e542045584543555445204f4e2046554e4354494f4e206765745f6167656e745f63726564656e7469616c735f73746174757328544558542920544f2061757468656e74696361746564"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20241231000001_add_user_roles_rls_policies.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Enable RLS on user_roles table if not already enabled\nALTER TABLE user_roles ENABLE ROW LEVEL SECURITY","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Policy to allow users to read their own roles\nCREATE POLICY \"Users can read their own roles\" ON user_roles\n  FOR SELECT\n  USING (auth.uid() = user_id)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Policy to allow users to insert their own roles (for role syncing)\nCREATE POLICY \"Users can insert their own roles\" ON user_roles\n  FOR INSERT\n  WITH CHECK (auth.uid() = user_id)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Policy to allow users to update their own roles (for role syncing)\nCREATE POLICY \"Users can update their own roles\" ON user_roles\n  FOR UPDATE\n  USING (auth.uid() = user_id)\n  WITH CHECK (auth.uid() = user_id)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Policy to allow service role to manage all user roles (for admin operations)\nCREATE POLICY \"Service role can manage all user roles\" ON user_roles\n  FOR ALL\n  USING (auth.jwt() -\u003e\u003e 'role' = 'service_role')\n  WITH CHECK (auth.jwt() -\u003e\u003e 'role' = 'service_role')","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20241231000001"},{"text":"add_user_roles_rls_policies"},{"binary":"0000000100000000000000190000000500000001000000692d2d20456e61626c6520524c53206f6e20757365725f726f6c6573207461626c65206966206e6f7420616c726561647920656e61626c65640a414c544552205441424c4520757365725f726f6c657320454e41424c4520524f57204c4556454c205345435552495459000000992d2d20506f6c69637920746f20616c6c6f7720757365727320746f2072656164207468656972206f776e20726f6c65730a43524541544520504f4c494359202255736572732063616e2072656164207468656972206f776e20726f6c657322204f4e20757365725f726f6c65730a2020464f522053454c4543540a20205553494e472028617574682e7569642829203d20757365725f696429000000b52d2d20506f6c69637920746f20616c6c6f7720757365727320746f20696e73657274207468656972206f776e20726f6c65732028666f7220726f6c652073796e63696e67290a43524541544520504f4c494359202255736572732063616e20696e73657274207468656972206f776e20726f6c657322204f4e20757365725f726f6c65730a2020464f5220494e534552540a20205749544820434845434b2028617574682e7569642829203d20757365725f696429000000d42d2d20506f6c69637920746f20616c6c6f7720757365727320746f20757064617465207468656972206f776e20726f6c65732028666f7220726f6c652073796e63696e67290a43524541544520504f4c494359202255736572732063616e20757064617465207468656972206f776e20726f6c657322204f4e20757365725f726f6c65730a2020464f52205550444154450a20205553494e472028617574682e7569642829203d20757365725f6964290a20205749544820434845434b2028617574682e7569642829203d20757365725f696429000001052d2d20506f6c69637920746f20616c6c6f77207365727669636520726f6c6520746f206d616e61676520616c6c207573657220726f6c65732028666f722061646d696e206f7065726174696f6e73290a43524541544520504f4c49435920225365727669636520726f6c652063616e206d616e61676520616c6c207573657220726f6c657322204f4e20757365725f726f6c65730a2020464f5220414c4c0a20205553494e472028617574682e6a77742829202d3e3e2027726f6c6527203d2027736572766963655f726f6c6527290a20205749544820434845434b2028617574682e6a77742829202d3e3e2027726f6c6527203d2027736572766963655f726f6c652729"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE POLICY"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20250101_enhanced_handle_new_user_auth_data.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Enhanced handle_new_user trigger to load comprehensive auth user data\n-- This migration expands the trigger to extract and populate additional fields\n-- from auth.users.raw_user_meta_data into the profiles and agents tables\n\nBEGIN","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Drop existing trigger and function\nDROP TRIGGER IF EXISTS on_auth_user_created ON auth.users","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DROP FUNCTION IF EXISTS public.handle_new_user() CASCADE","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create enhanced function to handle comprehensive auth user data loading\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  -- Basic profile fields\n  user_name TEXT;\n  user_role TEXT;\n  user_phone TEXT;\n  user_department TEXT;\n  user_position TEXT;\n  user_employee_id TEXT;\n  user_company_name TEXT;\n  user_city TEXT;\n  user_country TEXT;\n  \n  -- Extended profile fields\n  user_profile_image TEXT;\n  user_preferred_language TEXT;\n  user_business_address TEXT;\n  user_business_type TEXT;\n  user_specialization TEXT;\n  user_specializations TEXT[];\n  user_source_type TEXT;\n  user_source_details TEXT;\n  user_status TEXT;\n  \n  -- Additional metadata fields\n  user_work_location TEXT;\n  user_join_date TEXT;\n  user_reporting_manager TEXT;\n  user_avatar TEXT;\n  user_timezone TEXT;\n  user_nationality TEXT;\n  user_date_of_birth TEXT;\n  user_emergency_contact_name TEXT;\n  user_emergency_contact_phone TEXT;\n  user_emergency_contact_relationship TEXT;\nBEGIN\n  -- Extract basic metadata with sensible fallbacks\n  user_name := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'name', ''), split_part(NEW.email, '@', 1));\n  user_role := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'role', ''), 'agent');\n  user_phone := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'phone', '');\n  user_department := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'department', '');\n  user_position := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'position', '');\n  user_employee_id := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'employee_id', '');\n  user_company_name := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'company_name', '');\n  user_city := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'city', '');\n  user_country := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'country', '');\n  \n  -- Extract extended metadata fields\n  user_profile_image := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'profile_image', '');\n  user_preferred_language := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'preferred_language', ''), 'en');\n  user_business_address := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'business_address', '');\n  user_business_type := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'business_type', '');\n  user_specialization := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'specialization', '');\n  user_source_type := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'source_type', ''), 'organic');\n  user_source_details := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'source_details', ''), 'direct_signup');\n  user_status := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'status', ''), 'active');\n  \n  -- Extract additional metadata fields\n  user_work_location := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'work_location', '');\n  user_join_date := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'join_date', '');\n  user_reporting_manager := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'reporting_manager', '');\n  user_avatar := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'avatar', '');\n  user_timezone := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'timezone', '');\n  user_nationality := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'nationality', '');\n  user_date_of_birth := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'date_of_birth', '');\n  user_emergency_contact_name := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'emergency_contact_name', '');\n  user_emergency_contact_phone := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'emergency_contact_phone', '');\n  user_emergency_contact_relationship := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'emergency_contact_relationship', '');\n  \n  -- Handle specializations array\n  IF NEW.raw_user_meta_data ? 'specializations' THEN\n    user_specializations := ARRAY(SELECT jsonb_array_elements_text(NEW.raw_user_meta_data-\u003e'specializations'));\n  ELSIF user_specialization IS NOT NULL THEN\n    user_specializations := ARRAY[user_specialization];\n  END IF;\n\n  -- Upsert comprehensive profile data\n  INSERT INTO public.profiles (\n    id, email, name, role, phone, department, position, employee_id, \n    company_name, city, country, profile_image, preferred_language,\n    status, created_at, updated_at\n  ) VALUES (\n    NEW.id, NEW.email, user_name, user_role, user_phone, user_department, \n    user_position, user_employee_id, user_company_name, user_city, user_country,\n    user_profile_image, user_preferred_language, user_status, NOW(), NOW()\n  )\n  ON CONFLICT (id) DO UPDATE SET\n    email = EXCLUDED.email,\n    name = COALESCE(EXCLUDED.name, profiles.name),\n    role = COALESCE(EXCLUDED.role, profiles.role),\n    phone = COALESCE(EXCLUDED.phone, profiles.phone),\n    department = COALESCE(EXCLUDED.department, profiles.department),\n    position = COALESCE(EXCLUDED.position, profiles.position),\n    employee_id = COALESCE(EXCLUDED.employee_id, profiles.employee_id),\n    company_name = COALESCE(EXCLUDED.company_name, profiles.company_name),\n    city = COALESCE(EXCLUDED.city, profiles.city),\n    country = COALESCE(EXCLUDED.country, profiles.country),\n    profile_image = COALESCE(EXCLUDED.profile_image, profiles.profile_image),\n    preferred_language = COALESCE(EXCLUDED.preferred_language, profiles.preferred_language),\n    status = COALESCE(EXCLUDED.status, profiles.status),\n    updated_at = NOW();\n\n  -- Create agent record if role is 'agent' with comprehensive data\n  IF user_role = 'agent' THEN\n    INSERT INTO public.agents (\n      id, user_id, name, email, agency_name, business_phone, business_address,\n      city, country, agent_type, specializations, source_type, source_details,\n      status, created_at, updated_at, created_by\n    ) VALUES (\n      NEW.id, NEW.id, user_name, NEW.email, user_company_name, user_phone, \n      user_business_address, user_city, user_country, user_business_type,\n      user_specializations, user_source_type, user_source_details,\n      CASE WHEN user_status = 'active' THEN 'active' ELSE 'inactive' END,\n      NOW(), NOW(), NEW.id\n    )\n    ON CONFLICT (user_id) DO UPDATE SET\n      name = COALESCE(EXCLUDED.name, agents.name),\n      email = COALESCE(EXCLUDED.email, agents.email),\n      agency_name = COALESCE(EXCLUDED.agency_name, agents.agency_name),\n      business_phone = COALESCE(EXCLUDED.business_phone, agents.business_phone),\n      business_address = COALESCE(EXCLUDED.business_address, agents.business_address),\n      city = COALESCE(EXCLUDED.city, agents.city),\n      country = COALESCE(EXCLUDED.country, agents.country),\n      agent_type = COALESCE(EXCLUDED.agent_type, agents.agent_type),\n      specializations = COALESCE(EXCLUDED.specializations, agents.specializations),\n      source_type = COALESCE(EXCLUDED.source_type, agents.source_type),\n      source_details = COALESCE(EXCLUDED.source_details, agents.source_details),\n      status = COALESCE(EXCLUDED.status, agents.status),\n      updated_at = NOW();\n  END IF;\n\n  RETURN NEW;\nEXCEPTION\n  WHEN OTHERS THEN\n    -- Log error but don't fail the auth process\n    RAISE WARNING 'Error in enhanced handle_new_user: %', SQLERRM;\n    RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create the trigger\nCREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW\n  EXECUTE FUNCTION public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Grant necessary permissions\nGRANT EXECUTE ON FUNCTION public.handle_new_user() TO authenticated, anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"ALTER FUNCTION public.handle_new_user() OWNER TO postgres","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add helpful comment\nCOMMENT ON FUNCTION public.handle_new_user() IS 'Enhanced trigger function that extracts comprehensive auth user metadata and populates profiles and agents tables with all available fields from raw_user_meta_data'","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"COMMIT","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20250101"},{"text":"enhanced_handle_new_user_auth_data"},{"binary":"0000000100000000000000190000000900000001000000e92d2d20456e68616e6365642068616e646c655f6e65775f75736572207472696767657220746f206c6f616420636f6d70726568656e736976652061757468207573657220646174610a2d2d2054686973206d6967726174696f6e20657870616e647320746865207472696767657220746f206578747261637420616e6420706f70756c617465206164646974696f6e616c206669656c64730a2d2d2066726f6d20617574682e75736572732e7261775f757365725f6d6574615f6461746120696e746f207468652070726f66696c657320616e64206167656e7473207461626c65730a0a424547494e0000005f2d2d2044726f70206578697374696e67207472696767657220616e642066756e6374696f6e0a44524f50205452494747455220494620455849535453206f6e5f617574685f757365725f63726561746564204f4e20617574682e75736572730000003844524f502046554e4354494f4e20494620455849535453207075626c69632e68616e646c655f6e65775f757365722829204341534341444500001a8a2d2d2043726561746520656e68616e6365642066756e6374696f6e20746f2068616e646c6520636f6d70726568656e73697665206175746820757365722064617461206c6f6164696e670a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a4445434c4152450a20202d2d2042617369632070726f66696c65206669656c64730a2020757365725f6e616d6520544558543b0a2020757365725f726f6c6520544558543b0a2020757365725f70686f6e6520544558543b0a2020757365725f6465706172746d656e7420544558543b0a2020757365725f706f736974696f6e20544558543b0a2020757365725f656d706c6f7965655f696420544558543b0a2020757365725f636f6d70616e795f6e616d6520544558543b0a2020757365725f6369747920544558543b0a2020757365725f636f756e74727920544558543b0a20200a20202d2d20457874656e6465642070726f66696c65206669656c64730a2020757365725f70726f66696c655f696d61676520544558543b0a2020757365725f7072656665727265645f6c616e677561676520544558543b0a2020757365725f627573696e6573735f6164647265737320544558543b0a2020757365725f627573696e6573735f7479706520544558543b0a2020757365725f7370656369616c697a6174696f6e20544558543b0a2020757365725f7370656369616c697a6174696f6e7320544558545b5d3b0a2020757365725f736f757263655f7479706520544558543b0a2020757365725f736f757263655f64657461696c7320544558543b0a2020757365725f73746174757320544558543b0a20200a20202d2d204164646974696f6e616c206d65746164617461206669656c64730a2020757365725f776f726b5f6c6f636174696f6e20544558543b0a2020757365725f6a6f696e5f6461746520544558543b0a2020757365725f7265706f7274696e675f6d616e6167657220544558543b0a2020757365725f61766174617220544558543b0a2020757365725f74696d657a6f6e6520544558543b0a2020757365725f6e6174696f6e616c69747920544558543b0a2020757365725f646174655f6f665f626972746820544558543b0a2020757365725f656d657267656e63795f636f6e746163745f6e616d6520544558543b0a2020757365725f656d657267656e63795f636f6e746163745f70686f6e6520544558543b0a2020757365725f656d657267656e63795f636f6e746163745f72656c6174696f6e7368697020544558543b0a424547494e0a20202d2d2045787472616374206261736963206d6574616461746120776974682073656e7369626c652066616c6c6261636b730a2020757365725f6e616d65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c202727292c2073706c69745f70617274284e45572e656d61696c2c202740272c203129293b0a2020757365725f726f6c65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27726f6c65272c202727292c20276167656e7427293b0a2020757365725f70686f6e65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2770686f6e65272c202727293b0a2020757365725f6465706172746d656e74203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276465706172746d656e74272c202727293b0a2020757365725f706f736974696f6e203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27706f736974696f6e272c202727293b0a2020757365725f656d706c6f7965655f6964203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27656d706c6f7965655f6964272c202727293b0a2020757365725f636f6d70616e795f6e616d65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f6d70616e795f6e616d65272c202727293b0a2020757365725f63697479203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2763697479272c202727293b0a2020757365725f636f756e747279203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f756e747279272c202727293b0a20200a20202d2d204578747261637420657874656e646564206d65746164617461206669656c64730a2020757365725f70726f66696c655f696d616765203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2770726f66696c655f696d616765272c202727293b0a2020757365725f7072656665727265645f6c616e6775616765203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e277072656665727265645f6c616e6775616765272c202727292c2027656e27293b0a2020757365725f627573696e6573735f61646472657373203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27627573696e6573735f61646472657373272c202727293b0a2020757365725f627573696e6573735f74797065203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27627573696e6573735f74797065272c202727293b0a2020757365725f7370656369616c697a6174696f6e203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e277370656369616c697a6174696f6e272c202727293b0a2020757365725f736f757263655f74797065203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27736f757263655f74797065272c202727292c20276f7267616e696327293b0a2020757365725f736f757263655f64657461696c73203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27736f757263655f64657461696c73272c202727292c20276469726563745f7369676e757027293b0a2020757365725f737461747573203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27737461747573272c202727292c202761637469766527293b0a20200a20202d2d2045787472616374206164646974696f6e616c206d65746164617461206669656c64730a2020757365725f776f726b5f6c6f636174696f6e203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27776f726b5f6c6f636174696f6e272c202727293b0a2020757365725f6a6f696e5f64617465203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276a6f696e5f64617465272c202727293b0a2020757365725f7265706f7274696e675f6d616e61676572203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e277265706f7274696e675f6d616e61676572272c202727293b0a2020757365725f617661746172203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27617661746172272c202727293b0a2020757365725f74696d657a6f6e65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2774696d657a6f6e65272c202727293b0a2020757365725f6e6174696f6e616c697479203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276e6174696f6e616c697479272c202727293b0a2020757365725f646174655f6f665f6269727468203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27646174655f6f665f6269727468272c202727293b0a2020757365725f656d657267656e63795f636f6e746163745f6e616d65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27656d657267656e63795f636f6e746163745f6e616d65272c202727293b0a2020757365725f656d657267656e63795f636f6e746163745f70686f6e65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27656d657267656e63795f636f6e746163745f70686f6e65272c202727293b0a2020757365725f656d657267656e63795f636f6e746163745f72656c6174696f6e73686970203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27656d657267656e63795f636f6e746163745f72656c6174696f6e73686970272c202727293b0a20200a20202d2d2048616e646c65207370656369616c697a6174696f6e732061727261790a20204946204e45572e7261775f757365725f6d6574615f64617461203f20277370656369616c697a6174696f6e7327205448454e0a20202020757365725f7370656369616c697a6174696f6e73203a3d2041525241592853454c454354206a736f6e625f61727261795f656c656d656e74735f74657874284e45572e7261775f757365725f6d6574615f646174612d3e277370656369616c697a6174696f6e732729293b0a2020454c53494620757365725f7370656369616c697a6174696f6e204953204e4f54204e554c4c205448454e0a20202020757365725f7370656369616c697a6174696f6e73203a3d2041525241595b757365725f7370656369616c697a6174696f6e5d3b0a2020454e442049463b0a0a20202d2d2055707365727420636f6d70726568656e736976652070726f66696c6520646174610a2020494e5345525420494e544f207075626c69632e70726f66696c657320280a2020202069642c20656d61696c2c206e616d652c20726f6c652c2070686f6e652c206465706172746d656e742c20706f736974696f6e2c20656d706c6f7965655f69642c200a20202020636f6d70616e795f6e616d652c20636974792c20636f756e7472792c2070726f66696c655f696d6167652c207072656665727265645f6c616e67756167652c0a202020207374617475732c20637265617465645f61742c20757064617465645f61740a2020292056414c55455320280a202020204e45572e69642c204e45572e656d61696c2c20757365725f6e616d652c20757365725f726f6c652c20757365725f70686f6e652c20757365725f6465706172746d656e742c200a20202020757365725f706f736974696f6e2c20757365725f656d706c6f7965655f69642c20757365725f636f6d70616e795f6e616d652c20757365725f636974792c20757365725f636f756e7472792c0a20202020757365725f70726f66696c655f696d6167652c20757365725f7072656665727265645f6c616e67756167652c20757365725f7374617475732c204e4f5728292c204e4f5728290a2020290a20204f4e20434f4e464c494354202869642920444f20555044415445205345540a20202020656d61696c203d204558434c554445442e656d61696c2c0a202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c2070726f66696c65732e6e616d65292c0a20202020726f6c65203d20434f414c45534345284558434c554445442e726f6c652c2070726f66696c65732e726f6c65292c0a2020202070686f6e65203d20434f414c45534345284558434c554445442e70686f6e652c2070726f66696c65732e70686f6e65292c0a202020206465706172746d656e74203d20434f414c45534345284558434c554445442e6465706172746d656e742c2070726f66696c65732e6465706172746d656e74292c0a20202020706f736974696f6e203d20434f414c45534345284558434c554445442e706f736974696f6e2c2070726f66696c65732e706f736974696f6e292c0a20202020656d706c6f7965655f6964203d20434f414c45534345284558434c554445442e656d706c6f7965655f69642c2070726f66696c65732e656d706c6f7965655f6964292c0a20202020636f6d70616e795f6e616d65203d20434f414c45534345284558434c554445442e636f6d70616e795f6e616d652c2070726f66696c65732e636f6d70616e795f6e616d65292c0a2020202063697479203d20434f414c45534345284558434c554445442e636974792c2070726f66696c65732e63697479292c0a20202020636f756e747279203d20434f414c45534345284558434c554445442e636f756e7472792c2070726f66696c65732e636f756e747279292c0a2020202070726f66696c655f696d616765203d20434f414c45534345284558434c554445442e70726f66696c655f696d6167652c2070726f66696c65732e70726f66696c655f696d616765292c0a202020207072656665727265645f6c616e6775616765203d20434f414c45534345284558434c554445442e7072656665727265645f6c616e67756167652c2070726f66696c65732e7072656665727265645f6c616e6775616765292c0a20202020737461747573203d20434f414c45534345284558434c554445442e7374617475732c2070726f66696c65732e737461747573292c0a20202020757064617465645f6174203d204e4f5728293b0a0a20202d2d20437265617465206167656e74207265636f726420696620726f6c6520697320276167656e7427207769746820636f6d70726568656e7369766520646174610a2020494620757365725f726f6c65203d20276167656e7427205448454e0a20202020494e5345525420494e544f207075626c69632e6167656e747320280a20202020202069642c20757365725f69642c206e616d652c20656d61696c2c206167656e63795f6e616d652c20627573696e6573735f70686f6e652c20627573696e6573735f616464726573732c0a202020202020636974792c20636f756e7472792c206167656e745f747970652c207370656369616c697a6174696f6e732c20736f757263655f747970652c20736f757263655f64657461696c732c0a2020202020207374617475732c20637265617465645f61742c20757064617465645f61742c20637265617465645f62790a20202020292056414c55455320280a2020202020204e45572e69642c204e45572e69642c20757365725f6e616d652c204e45572e656d61696c2c20757365725f636f6d70616e795f6e616d652c20757365725f70686f6e652c200a202020202020757365725f627573696e6573735f616464726573732c20757365725f636974792c20757365725f636f756e7472792c20757365725f627573696e6573735f747970652c0a202020202020757365725f7370656369616c697a6174696f6e732c20757365725f736f757263655f747970652c20757365725f736f757263655f64657461696c732c0a20202020202043415345205748454e20757365725f737461747573203d202761637469766527205448454e20276163746976652720454c53452027696e6163746976652720454e442c0a2020202020204e4f5728292c204e4f5728292c204e45572e69640a20202020290a202020204f4e20434f4e464c4943542028757365725f69642920444f20555044415445205345540a2020202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c206167656e74732e6e616d65292c0a202020202020656d61696c203d20434f414c45534345284558434c554445442e656d61696c2c206167656e74732e656d61696c292c0a2020202020206167656e63795f6e616d65203d20434f414c45534345284558434c554445442e6167656e63795f6e616d652c206167656e74732e6167656e63795f6e616d65292c0a202020202020627573696e6573735f70686f6e65203d20434f414c45534345284558434c554445442e627573696e6573735f70686f6e652c206167656e74732e627573696e6573735f70686f6e65292c0a202020202020627573696e6573735f61646472657373203d20434f414c45534345284558434c554445442e627573696e6573735f616464726573732c206167656e74732e627573696e6573735f61646472657373292c0a20202020202063697479203d20434f414c45534345284558434c554445442e636974792c206167656e74732e63697479292c0a202020202020636f756e747279203d20434f414c45534345284558434c554445442e636f756e7472792c206167656e74732e636f756e747279292c0a2020202020206167656e745f74797065203d20434f414c45534345284558434c554445442e6167656e745f747970652c206167656e74732e6167656e745f74797065292c0a2020202020207370656369616c697a6174696f6e73203d20434f414c45534345284558434c554445442e7370656369616c697a6174696f6e732c206167656e74732e7370656369616c697a6174696f6e73292c0a202020202020736f757263655f74797065203d20434f414c45534345284558434c554445442e736f757263655f747970652c206167656e74732e736f757263655f74797065292c0a202020202020736f757263655f64657461696c73203d20434f414c45534345284558434c554445442e736f757263655f64657461696c732c206167656e74732e736f757263655f64657461696c73292c0a202020202020737461747573203d20434f414c45534345284558434c554445442e7374617475732c206167656e74732e737461747573292c0a202020202020757064617465645f6174203d204e4f5728293b0a2020454e442049463b0a0a202052455455524e204e45573b0a455843455054494f4e0a20205748454e204f5448455253205448454e0a202020202d2d204c6f67206572726f722062757420646f6e2774206661696c2074686520617574682070726f636573730a202020205241495345205741524e494e4720274572726f7220696e20656e68616e6365642068616e646c655f6e65775f757365723a2025272c2053514c4552524d3b0a2020202052455455524e204e45573b0a454e443b0a2424000000912d2d204372656174652074686520747269676765720a4352454154452054524947474552206f6e5f617574685f757365725f637265617465640a2020414654455220494e53455254204f4e20617574682e75736572730a2020464f52204541434820524f570a2020455845435554452046554e4354494f4e207075626c69632e68616e646c655f6e65775f757365722829000000682d2d204772616e74206e6563657373617279207065726d697373696f6e730a4752414e542045584543555445204f4e2046554e4354494f4e207075626c69632e68616e646c655f6e65775f75736572282920544f2061757468656e746963617465642c20616e6f6e00000039414c5445522046554e4354494f4e207075626c69632e68616e646c655f6e65775f757365722829204f574e455220544f20706f737467726573000000ec2d2d204164642068656c7066756c20636f6d6d656e740a434f4d4d454e54204f4e2046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228292049532027456e68616e63656420747269676765722066756e6374696f6e207468617420657874726163747320636f6d70726568656e7369766520617574682075736572206d6574616461746120616e6420706f70756c617465732070726f66696c657320616e64206167656e7473207461626c6573207769746820616c6c20617661696c61626c65206669656c64732066726f6d207261775f757365725f6d6574615f646174612700000006434f4d4d4954"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"BEGIN"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMENT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMIT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20250102_update_profile_creation_trigger.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Update profile creation trigger to match the complete profiles table schema\n-- This migration ensures that when a user is created, a profile is automatically created\n-- with role and department information from the user metadata\n\nBEGIN","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Drop existing trigger and function to ensure clean update\nDROP TRIGGER IF EXISTS on_auth_user_created ON auth.users","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DROP FUNCTION IF EXISTS public.handle_new_user() CASCADE","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create updated function to handle comprehensive profile creation\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  user_name TEXT;\n  user_role TEXT;\n  user_phone TEXT;\n  user_department TEXT;\n  user_position TEXT;\n  user_employee_id TEXT;\n  user_company_name TEXT;\n  user_avatar TEXT;\n  user_preferred_language TEXT;\n  user_country TEXT;\n  user_city TEXT;\n  user_status TEXT;\n  user_must_change_password BOOLEAN;\nBEGIN\n  -- Extract metadata with sensible fallbacks\n  user_name := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'name', ''), split_part(NEW.email, '@', 1));\n  user_role := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'role', ''), 'agent');\n  user_phone := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'phone', '');\n  user_department := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'department', '');\n  user_position := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'position', '');\n  user_employee_id := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'employee_id', '');\n  user_company_name := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'company_name', '');\n  user_avatar := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'avatar', '');\n  user_preferred_language := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'preferred_language', ''), 'en');\n  user_country := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'country', '');\n  user_city := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'city', '');\n  user_status := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'status', ''), 'inactive');\n  user_must_change_password := COALESCE((NEW.raw_user_meta_data-\u003e\u003e'must_change_password')::boolean, false);\n\n  -- Insert/update profile with all available fields\n  INSERT INTO public.profiles (\n    id,\n    name,\n    email,\n    role,\n    department,\n    phone,\n    status,\n    position,\n    employee_id,\n    created_at,\n    updated_at,\n    company_name,\n    avatar,\n    preferred_language,\n    country,\n    city,\n    must_change_password\n  ) VALUES (\n    NEW.id,\n    user_name,\n    NEW.email,\n    user_role,\n    user_department,\n    user_phone,\n    user_status,\n    user_position,\n    user_employee_id,\n    NOW(),\n    NOW(),\n    user_company_name,\n    user_avatar,\n    user_preferred_language,\n    user_country,\n    user_city,\n    user_must_change_password\n  )\n  ON CONFLICT (id) DO UPDATE SET\n    name = COALESCE(EXCLUDED.name, profiles.name),\n    email = EXCLUDED.email,\n    role = COALESCE(EXCLUDED.role, profiles.role),\n    department = COALESCE(EXCLUDED.department, profiles.department),\n    phone = COALESCE(EXCLUDED.phone, profiles.phone),\n    status = COALESCE(EXCLUDED.status, profiles.status),\n    position = COALESCE(EXCLUDED.position, profiles.position),\n    employee_id = COALESCE(EXCLUDED.employee_id, profiles.employee_id),\n    company_name = COALESCE(EXCLUDED.company_name, profiles.company_name),\n    avatar = COALESCE(EXCLUDED.avatar, profiles.avatar),\n    preferred_language = COALESCE(EXCLUDED.preferred_language, profiles.preferred_language),\n    country = COALESCE(EXCLUDED.country, profiles.country),\n    city = COALESCE(EXCLUDED.city, profiles.city),\n    must_change_password = COALESCE(EXCLUDED.must_change_password, profiles.must_change_password),\n    updated_at = NOW();\n\n  -- If role is 'agent', also create/update agent record\n  IF user_role = 'agent' THEN\n    INSERT INTO public.agents (\n      id,\n      user_id,\n      name,\n      email,\n      agency_name,\n      business_phone,\n      city,\n      country,\n      status,\n      created_at,\n      updated_at,\n      created_by\n    ) VALUES (\n      NEW.id,\n      NEW.id,\n      user_name,\n      NEW.email,\n      user_company_name,\n      user_phone,\n      user_city,\n      user_country,\n      CASE WHEN user_status = 'active' THEN 'active' ELSE 'inactive' END,\n      NOW(),\n      NOW(),\n      NEW.id\n    )\n    ON CONFLICT (user_id) DO UPDATE SET\n      name = COALESCE(EXCLUDED.name, agents.name),\n      email = COALESCE(EXCLUDED.email, agents.email),\n      agency_name = COALESCE(EXCLUDED.agency_name, agents.agency_name),\n      business_phone = COALESCE(EXCLUDED.business_phone, agents.business_phone),\n      city = COALESCE(EXCLUDED.city, agents.city),\n      country = COALESCE(EXCLUDED.country, agents.country),\n      status = COALESCE(EXCLUDED.status, agents.status),\n      updated_at = NOW();\n  END IF;\n\n  RETURN NEW;\nEXCEPTION\n  WHEN OTHERS THEN\n    -- Log error but don't fail the auth process\n    RAISE WARNING 'Error in handle_new_user: %', SQLERRM;\n    RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create the trigger to execute after user creation\nCREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW\n  EXECUTE FUNCTION public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Grant necessary permissions\nGRANT EXECUTE ON FUNCTION public.handle_new_user() TO authenticated, anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"ALTER FUNCTION public.handle_new_user() OWNER TO postgres","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add helpful comment\nCOMMENT ON FUNCTION public.handle_new_user() IS 'Trigger function that automatically creates a profile record with role and department when a new user is created in auth.users. Extracts metadata from raw_user_meta_data and populates all profile fields.'","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"COMMIT","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20250102"},{"text":"update_profile_creation_trigger"},{"binary":"0000000100000000000000190000000900000001000000ee2d2d205570646174652070726f66696c65206372656174696f6e207472696767657220746f206d617463682074686520636f6d706c6574652070726f66696c6573207461626c6520736368656d610a2d2d2054686973206d6967726174696f6e20656e73757265732074686174207768656e2061207573657220697320637265617465642c20612070726f66696c65206973206175746f6d61746963616c6c7920637265617465640a2d2d207769746820726f6c6520616e64206465706172746d656e7420696e666f726d6174696f6e2066726f6d207468652075736572206d657461646174610a0a424547494e000000762d2d2044726f70206578697374696e67207472696767657220616e642066756e6374696f6e20746f20656e7375726520636c65616e207570646174650a44524f50205452494747455220494620455849535453206f6e5f617574685f757365725f63726561746564204f4e20617574682e75736572730000003844524f502046554e4354494f4e20494620455849535453207075626c69632e68616e646c655f6e65775f75736572282920434153434144450000114b2d2d2043726561746520757064617465642066756e6374696f6e20746f2068616e646c6520636f6d70726568656e736976652070726f66696c65206372656174696f6e0a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a4445434c4152450a2020757365725f6e616d6520544558543b0a2020757365725f726f6c6520544558543b0a2020757365725f70686f6e6520544558543b0a2020757365725f6465706172746d656e7420544558543b0a2020757365725f706f736974696f6e20544558543b0a2020757365725f656d706c6f7965655f696420544558543b0a2020757365725f636f6d70616e795f6e616d6520544558543b0a2020757365725f61766174617220544558543b0a2020757365725f7072656665727265645f6c616e677561676520544558543b0a2020757365725f636f756e74727920544558543b0a2020757365725f6369747920544558543b0a2020757365725f73746174757320544558543b0a2020757365725f6d7573745f6368616e67655f70617373776f726420424f4f4c45414e3b0a424547494e0a20202d2d2045787472616374206d6574616461746120776974682073656e7369626c652066616c6c6261636b730a2020757365725f6e616d65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c202727292c2073706c69745f70617274284e45572e656d61696c2c202740272c203129293b0a2020757365725f726f6c65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27726f6c65272c202727292c20276167656e7427293b0a2020757365725f70686f6e65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2770686f6e65272c202727293b0a2020757365725f6465706172746d656e74203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276465706172746d656e74272c202727293b0a2020757365725f706f736974696f6e203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27706f736974696f6e272c202727293b0a2020757365725f656d706c6f7965655f6964203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27656d706c6f7965655f6964272c202727293b0a2020757365725f636f6d70616e795f6e616d65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f6d70616e795f6e616d65272c202727293b0a2020757365725f617661746172203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27617661746172272c202727293b0a2020757365725f7072656665727265645f6c616e6775616765203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e277072656665727265645f6c616e6775616765272c202727292c2027656e27293b0a2020757365725f636f756e747279203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f756e747279272c202727293b0a2020757365725f63697479203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2763697479272c202727293b0a2020757365725f737461747573203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27737461747573272c202727292c2027696e61637469766527293b0a2020757365725f6d7573745f6368616e67655f70617373776f7264203a3d20434f414c4553434528284e45572e7261775f757365725f6d6574615f646174612d3e3e276d7573745f6368616e67655f70617373776f726427293a3a626f6f6c65616e2c2066616c7365293b0a0a20202d2d20496e736572742f7570646174652070726f66696c65207769746820616c6c20617661696c61626c65206669656c64730a2020494e5345525420494e544f207075626c69632e70726f66696c657320280a2020202069642c0a202020206e616d652c0a20202020656d61696c2c0a20202020726f6c652c0a202020206465706172746d656e742c0a2020202070686f6e652c0a202020207374617475732c0a20202020706f736974696f6e2c0a20202020656d706c6f7965655f69642c0a20202020637265617465645f61742c0a20202020757064617465645f61742c0a20202020636f6d70616e795f6e616d652c0a202020206176617461722c0a202020207072656665727265645f6c616e67756167652c0a20202020636f756e7472792c0a20202020636974792c0a202020206d7573745f6368616e67655f70617373776f72640a2020292056414c55455320280a202020204e45572e69642c0a20202020757365725f6e616d652c0a202020204e45572e656d61696c2c0a20202020757365725f726f6c652c0a20202020757365725f6465706172746d656e742c0a20202020757365725f70686f6e652c0a20202020757365725f7374617475732c0a20202020757365725f706f736974696f6e2c0a20202020757365725f656d706c6f7965655f69642c0a202020204e4f5728292c0a202020204e4f5728292c0a20202020757365725f636f6d70616e795f6e616d652c0a20202020757365725f6176617461722c0a20202020757365725f7072656665727265645f6c616e67756167652c0a20202020757365725f636f756e7472792c0a20202020757365725f636974792c0a20202020757365725f6d7573745f6368616e67655f70617373776f72640a2020290a20204f4e20434f4e464c494354202869642920444f20555044415445205345540a202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c2070726f66696c65732e6e616d65292c0a20202020656d61696c203d204558434c554445442e656d61696c2c0a20202020726f6c65203d20434f414c45534345284558434c554445442e726f6c652c2070726f66696c65732e726f6c65292c0a202020206465706172746d656e74203d20434f414c45534345284558434c554445442e6465706172746d656e742c2070726f66696c65732e6465706172746d656e74292c0a2020202070686f6e65203d20434f414c45534345284558434c554445442e70686f6e652c2070726f66696c65732e70686f6e65292c0a20202020737461747573203d20434f414c45534345284558434c554445442e7374617475732c2070726f66696c65732e737461747573292c0a20202020706f736974696f6e203d20434f414c45534345284558434c554445442e706f736974696f6e2c2070726f66696c65732e706f736974696f6e292c0a20202020656d706c6f7965655f6964203d20434f414c45534345284558434c554445442e656d706c6f7965655f69642c2070726f66696c65732e656d706c6f7965655f6964292c0a20202020636f6d70616e795f6e616d65203d20434f414c45534345284558434c554445442e636f6d70616e795f6e616d652c2070726f66696c65732e636f6d70616e795f6e616d65292c0a20202020617661746172203d20434f414c45534345284558434c554445442e6176617461722c2070726f66696c65732e617661746172292c0a202020207072656665727265645f6c616e6775616765203d20434f414c45534345284558434c554445442e7072656665727265645f6c616e67756167652c2070726f66696c65732e7072656665727265645f6c616e6775616765292c0a20202020636f756e747279203d20434f414c45534345284558434c554445442e636f756e7472792c2070726f66696c65732e636f756e747279292c0a2020202063697479203d20434f414c45534345284558434c554445442e636974792c2070726f66696c65732e63697479292c0a202020206d7573745f6368616e67655f70617373776f7264203d20434f414c45534345284558434c554445442e6d7573745f6368616e67655f70617373776f72642c2070726f66696c65732e6d7573745f6368616e67655f70617373776f7264292c0a20202020757064617465645f6174203d204e4f5728293b0a0a20202d2d20496620726f6c6520697320276167656e74272c20616c736f206372656174652f757064617465206167656e74207265636f72640a2020494620757365725f726f6c65203d20276167656e7427205448454e0a20202020494e5345525420494e544f207075626c69632e6167656e747320280a20202020202069642c0a202020202020757365725f69642c0a2020202020206e616d652c0a202020202020656d61696c2c0a2020202020206167656e63795f6e616d652c0a202020202020627573696e6573735f70686f6e652c0a202020202020636974792c0a202020202020636f756e7472792c0a2020202020207374617475732c0a202020202020637265617465645f61742c0a202020202020757064617465645f61742c0a202020202020637265617465645f62790a20202020292056414c55455320280a2020202020204e45572e69642c0a2020202020204e45572e69642c0a202020202020757365725f6e616d652c0a2020202020204e45572e656d61696c2c0a202020202020757365725f636f6d70616e795f6e616d652c0a202020202020757365725f70686f6e652c0a202020202020757365725f636974792c0a202020202020757365725f636f756e7472792c0a20202020202043415345205748454e20757365725f737461747573203d202761637469766527205448454e20276163746976652720454c53452027696e6163746976652720454e442c0a2020202020204e4f5728292c0a2020202020204e4f5728292c0a2020202020204e45572e69640a20202020290a202020204f4e20434f4e464c4943542028757365725f69642920444f20555044415445205345540a2020202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c206167656e74732e6e616d65292c0a202020202020656d61696c203d20434f414c45534345284558434c554445442e656d61696c2c206167656e74732e656d61696c292c0a2020202020206167656e63795f6e616d65203d20434f414c45534345284558434c554445442e6167656e63795f6e616d652c206167656e74732e6167656e63795f6e616d65292c0a202020202020627573696e6573735f70686f6e65203d20434f414c45534345284558434c554445442e627573696e6573735f70686f6e652c206167656e74732e627573696e6573735f70686f6e65292c0a20202020202063697479203d20434f414c45534345284558434c554445442e636974792c206167656e74732e63697479292c0a202020202020636f756e747279203d20434f414c45534345284558434c554445442e636f756e7472792c206167656e74732e636f756e747279292c0a202020202020737461747573203d20434f414c45534345284558434c554445442e7374617475732c206167656e74732e737461747573292c0a202020202020757064617465645f6174203d204e4f5728293b0a2020454e442049463b0a0a202052455455524e204e45573b0a455843455054494f4e0a20205748454e204f5448455253205448454e0a202020202d2d204c6f67206572726f722062757420646f6e2774206661696c2074686520617574682070726f636573730a202020205241495345205741524e494e4720274572726f7220696e2068616e646c655f6e65775f757365723a2025272c2053514c4552524d3b0a2020202052455455524e204e45573b0a454e443b0a2424000000b02d2d2043726561746520746865207472696767657220746f20657865637574652061667465722075736572206372656174696f6e0a4352454154452054524947474552206f6e5f617574685f757365725f637265617465640a2020414654455220494e53455254204f4e20617574682e75736572730a2020464f52204541434820524f570a2020455845435554452046554e4354494f4e207075626c69632e68616e646c655f6e65775f757365722829000000682d2d204772616e74206e6563657373617279207065726d697373696f6e730a4752414e542045584543555445204f4e2046554e4354494f4e207075626c69632e68616e646c655f6e65775f75736572282920544f2061757468656e746963617465642c20616e6f6e00000039414c5445522046554e4354494f4e207075626c69632e68616e646c655f6e65775f757365722829204f574e455220544f20706f737467726573000001142d2d204164642068656c7066756c20636f6d6d656e740a434f4d4d454e54204f4e2046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228292049532027547269676765722066756e6374696f6e2074686174206175746f6d61746963616c6c79206372656174657320612070726f66696c65207265636f7264207769746820726f6c6520616e64206465706172746d656e74207768656e2061206e65772075736572206973206372656174656420696e20617574682e75736572732e204578747261637473206d657461646174612066726f6d207261775f757365725f6d6574615f6461746120616e6420706f70756c6174657320616c6c2070726f66696c65206669656c64732e2700000006434f4d4d4954"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"BEGIN"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMENT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMIT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20250103_final_trigger_fix.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Drop existing trigger and function\nDROP TRIGGER IF EXISTS on_auth_user_created ON auth.users","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DROP FUNCTION IF EXISTS public.handle_new_user() CASCADE","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create the new function\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  user_name TEXT;\n  user_role TEXT;\n  user_phone TEXT;\n  user_company_name TEXT;\n  user_country TEXT;\n  user_city TEXT;\n  user_status TEXT;\nBEGIN\n  -- Extract metadata\n  user_name := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'name', ''), split_part(NEW.email, '@', 1));\n  user_role := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'role', ''), 'agent');\n  user_phone := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'phone', '');\n  user_company_name := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'company_name', '');\n  user_country := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'country', '');\n  user_city := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'city', '');\n  user_status := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'status', ''), 'inactive');\n\n  -- Insert/update profile\n  INSERT INTO public.profiles (\n    id, email, name, role, phone, company_name, country, city, status, created_at, updated_at\n  ) VALUES (\n    NEW.id, NEW.email, user_name, user_role, user_phone, user_company_name, user_country, user_city, user_status, NOW(), NOW()\n  )\n  ON CONFLICT (id) DO UPDATE SET\n    email = EXCLUDED.email,\n    name = COALESCE(EXCLUDED.name, profiles.name),\n    role = COALESCE(EXCLUDED.role, profiles.role),\n    phone = COALESCE(EXCLUDED.phone, profiles.phone),\n    company_name = COALESCE(EXCLUDED.company_name, profiles.company_name),\n    country = COALESCE(EXCLUDED.country, profiles.country),\n    city = COALESCE(EXCLUDED.city, profiles.city),\n    status = COALESCE(EXCLUDED.status, profiles.status),\n    updated_at = NOW();\n\n  -- Create agent record if role is agent\n  IF user_role = 'agent' THEN\n    INSERT INTO public.agents (\n      user_id, name, email, agency_name, business_phone, city, country, status, source_type, created_at, updated_at, created_by\n    ) VALUES (\n      NEW.id, user_name, NEW.email, user_company_name, user_phone, user_city, user_country,\n      CASE WHEN user_status = 'active' THEN 'active' ELSE 'inactive' END,\n      'auth_signup', NOW(), NOW(), NEW.id\n    )\n    ON CONFLICT (user_id) DO UPDATE SET\n      name = COALESCE(EXCLUDED.name, agents.name),\n      email = COALESCE(EXCLUDED.email, agents.email),\n      agency_name = COALESCE(EXCLUDED.agency_name, agents.agency_name),\n      business_phone = COALESCE(EXCLUDED.business_phone, agents.business_phone),\n      city = COALESCE(EXCLUDED.city, agents.city),\n      country = COALESCE(EXCLUDED.country, agents.country),\n      status = COALESCE(EXCLUDED.status, agents.status),\n      updated_at = NOW();\n  END IF;\n\n  RETURN NEW;\nEXCEPTION\n  WHEN OTHERS THEN\n    RAISE WARNING 'Error in handle_new_user: %', SQLERRM;\n    RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create the trigger\nCREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW\n  EXECUTE FUNCTION public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Grant permissions\nGRANT EXECUTE ON FUNCTION public.handle_new_user() TO authenticated, anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"ALTER FUNCTION public.handle_new_user() OWNER TO postgres","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20250103"},{"text":"final_trigger_fix"},{"binary":"00000001000000000000001900000006000000010000005f2d2d2044726f70206578697374696e67207472696767657220616e642066756e6374696f6e0a44524f50205452494747455220494620455849535453206f6e5f617574685f757365725f63726561746564204f4e20617574682e75736572730000003844524f502046554e4354494f4e20494620455849535453207075626c69632e68616e646c655f6e65775f757365722829204341534341444500000ab12d2d2043726561746520746865206e65772066756e6374696f6e0a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a4445434c4152450a2020757365725f6e616d6520544558543b0a2020757365725f726f6c6520544558543b0a2020757365725f70686f6e6520544558543b0a2020757365725f636f6d70616e795f6e616d6520544558543b0a2020757365725f636f756e74727920544558543b0a2020757365725f6369747920544558543b0a2020757365725f73746174757320544558543b0a424547494e0a20202d2d2045787472616374206d657461646174610a2020757365725f6e616d65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c202727292c2073706c69745f70617274284e45572e656d61696c2c202740272c203129293b0a2020757365725f726f6c65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27726f6c65272c202727292c20276167656e7427293b0a2020757365725f70686f6e65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2770686f6e65272c202727293b0a2020757365725f636f6d70616e795f6e616d65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f6d70616e795f6e616d65272c202727293b0a2020757365725f636f756e747279203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f756e747279272c202727293b0a2020757365725f63697479203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2763697479272c202727293b0a2020757365725f737461747573203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27737461747573272c202727292c2027696e61637469766527293b0a0a20202d2d20496e736572742f7570646174652070726f66696c650a2020494e5345525420494e544f207075626c69632e70726f66696c657320280a2020202069642c20656d61696c2c206e616d652c20726f6c652c2070686f6e652c20636f6d70616e795f6e616d652c20636f756e7472792c20636974792c207374617475732c20637265617465645f61742c20757064617465645f61740a2020292056414c55455320280a202020204e45572e69642c204e45572e656d61696c2c20757365725f6e616d652c20757365725f726f6c652c20757365725f70686f6e652c20757365725f636f6d70616e795f6e616d652c20757365725f636f756e7472792c20757365725f636974792c20757365725f7374617475732c204e4f5728292c204e4f5728290a2020290a20204f4e20434f4e464c494354202869642920444f20555044415445205345540a20202020656d61696c203d204558434c554445442e656d61696c2c0a202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c2070726f66696c65732e6e616d65292c0a20202020726f6c65203d20434f414c45534345284558434c554445442e726f6c652c2070726f66696c65732e726f6c65292c0a2020202070686f6e65203d20434f414c45534345284558434c554445442e70686f6e652c2070726f66696c65732e70686f6e65292c0a20202020636f6d70616e795f6e616d65203d20434f414c45534345284558434c554445442e636f6d70616e795f6e616d652c2070726f66696c65732e636f6d70616e795f6e616d65292c0a20202020636f756e747279203d20434f414c45534345284558434c554445442e636f756e7472792c2070726f66696c65732e636f756e747279292c0a2020202063697479203d20434f414c45534345284558434c554445442e636974792c2070726f66696c65732e63697479292c0a20202020737461747573203d20434f414c45534345284558434c554445442e7374617475732c2070726f66696c65732e737461747573292c0a20202020757064617465645f6174203d204e4f5728293b0a0a20202d2d20437265617465206167656e74207265636f726420696620726f6c65206973206167656e740a2020494620757365725f726f6c65203d20276167656e7427205448454e0a20202020494e5345525420494e544f207075626c69632e6167656e747320280a202020202020757365725f69642c206e616d652c20656d61696c2c206167656e63795f6e616d652c20627573696e6573735f70686f6e652c20636974792c20636f756e7472792c207374617475732c20736f757263655f747970652c20637265617465645f61742c20757064617465645f61742c20637265617465645f62790a20202020292056414c55455320280a2020202020204e45572e69642c20757365725f6e616d652c204e45572e656d61696c2c20757365725f636f6d70616e795f6e616d652c20757365725f70686f6e652c20757365725f636974792c20757365725f636f756e7472792c0a20202020202043415345205748454e20757365725f737461747573203d202761637469766527205448454e20276163746976652720454c53452027696e6163746976652720454e442c0a20202020202027617574685f7369676e7570272c204e4f5728292c204e4f5728292c204e45572e69640a20202020290a202020204f4e20434f4e464c4943542028757365725f69642920444f20555044415445205345540a2020202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c206167656e74732e6e616d65292c0a202020202020656d61696c203d20434f414c45534345284558434c554445442e656d61696c2c206167656e74732e656d61696c292c0a2020202020206167656e63795f6e616d65203d20434f414c45534345284558434c554445442e6167656e63795f6e616d652c206167656e74732e6167656e63795f6e616d65292c0a202020202020627573696e6573735f70686f6e65203d20434f414c45534345284558434c554445442e627573696e6573735f70686f6e652c206167656e74732e627573696e6573735f70686f6e65292c0a20202020202063697479203d20434f414c45534345284558434c554445442e636974792c206167656e74732e63697479292c0a202020202020636f756e747279203d20434f414c45534345284558434c554445442e636f756e7472792c206167656e74732e636f756e747279292c0a202020202020737461747573203d20434f414c45534345284558434c554445442e7374617475732c206167656e74732e737461747573292c0a202020202020757064617465645f6174203d204e4f5728293b0a2020454e442049463b0a0a202052455455524e204e45573b0a455843455054494f4e0a20205748454e204f5448455253205448454e0a202020205241495345205741524e494e4720274572726f7220696e2068616e646c655f6e65775f757365723a2025272c2053514c4552524d3b0a2020202052455455524e204e45573b0a454e443b0a2424000000912d2d204372656174652074686520747269676765720a4352454154452054524947474552206f6e5f617574685f757365725f637265617465640a2020414654455220494e53455254204f4e20617574682e75736572730a2020464f52204541434820524f570a2020455845435554452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290000005e2d2d204772616e74207065726d697373696f6e730a4752414e542045584543555445204f4e2046554e4354494f4e207075626c69632e68616e646c655f6e65775f75736572282920544f2061757468656e746963617465642c20616e6f6e00000039414c5445522046554e4354494f4e207075626c69632e68616e646c655f6e65775f757365722829204f574e455220544f20706f737467726573"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20250114000000_init_hotels.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Minimal hotels table to support subsequent index migrations\nCREATE TABLE IF NOT EXISTS public.hotels (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  external_id integer,\n  name text,\n  country text,\n  city text,\n  created_at timestamp with time zone DEFAULT now(),\n  updated_at timestamp with time zone DEFAULT now()\n)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20250114000000"},{"text":"init_hotels"},{"binary":"0000000100000000000000190000000100000001000001462d2d204d696e696d616c20686f74656c73207461626c6520746f20737570706f72742073756273657175656e7420696e646578206d6967726174696f6e730a435245415445205441424c45204946204e4f5420455849535453207075626c69632e686f74656c7320280a202069642075756964205052494d415259204b45592044454641554c542067656e5f72616e646f6d5f7575696428292c0a202065787465726e616c5f696420696e74656765722c0a20206e616d6520746578742c0a2020636f756e74727920746578742c0a20206369747920746578742c0a2020637265617465645f61742074696d657374616d7020776974682074696d65207a6f6e652044454641554c54206e6f7728292c0a2020757064617465645f61742074696d657374616d7020776974682074696d65207a6f6e652044454641554c54206e6f7728290a29"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20250115000000_add_hotels_external_id_unique_index.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add unique index for external_id in hotels table\n-- This ensures external_id values are unique when not null\n\nCREATE UNIQUE INDEX IF NOT EXISTS idx_hotels_external_id \nON public.hotels (external_id) \nWHERE external_id IS NOT NULL","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add comment for documentation\nCOMMENT ON INDEX idx_hotels_external_id IS 'Unique index on hotels.external_id to ensure uniqueness of auto-generated external IDs'","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20250115000000"},{"text":"add_hotels_external_id_unique_index"},{"binary":"0000000100000000000000190000000200000001000000e82d2d2041646420756e6971756520696e64657820666f722065787465726e616c5f696420696e20686f74656c73207461626c650a2d2d205468697320656e73757265732065787465726e616c5f69642076616c7565732061726520756e69717565207768656e206e6f74206e756c6c0a0a43524541544520554e4951554520494e444558204946204e4f5420455849535453206964785f686f74656c735f65787465726e616c5f6964200a4f4e207075626c69632e686f74656c73202865787465726e616c5f696429200a57484552452065787465726e616c5f6964204953204e4f54204e554c4c000000a42d2d2041646420636f6d6d656e7420666f7220646f63756d656e746174696f6e0a434f4d4d454e54204f4e20494e444558206964785f686f74656c735f65787465726e616c5f69642049532027556e6971756520696e646578206f6e20686f74656c732e65787465726e616c5f696420746f20656e7375726520756e697175656e657373206f66206175746f2d67656e6572617465642065787465726e616c2049447327"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMENT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20250127120000_add_sightseeing_pricing_currency.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add pricing currency fields to sightseeing table\n-- This migration adds support for storing pricing currency information\n-- that is automatically loaded based on the selected country\n\n-- Add pricing_currency field to store the currency code (e.g., USD, EUR)\nalter table public.sightseeing add column if not exists pricing_currency text","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add pricing_currency_symbol field to store the currency symbol (e.g., $, â‚¬)\nalter table public.sightseeing add column if not exists pricing_currency_symbol text","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add comment to document the purpose of these fields\ncomment on column public.sightseeing.pricing_currency is 'Currency code for pricing (e.g., USD, EUR) - automatically loaded from countries table'","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"comment on column public.sightseeing.pricing_currency_symbol is 'Currency symbol for pricing (e.g., $, â‚¬) - automatically loaded from countries table'","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create index for pricing_currency for better query performance\ncreate index if not exists idx_sightseeing_pricing_currency on public.sightseeing using btree (pricing_currency)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20250127120000"},{"text":"add_sightseeing_pricing_currency"},{"binary":"0000000100000000000000190000000500000001000001522d2d204164642070726963696e672063757272656e6379206669656c647320746f207369676874736565696e67207461626c650a2d2d2054686973206d6967726174696f6e206164647320737570706f727420666f722073746f72696e672070726963696e672063757272656e637920696e666f726d6174696f6e0a2d2d2074686174206973206175746f6d61746963616c6c79206c6f61646564206261736564206f6e207468652073656c656374656420636f756e7472790a0a2d2d204164642070726963696e675f63757272656e6379206669656c6420746f2073746f7265207468652063757272656e637920636f64652028652e672e2c205553442c20455552290a616c746572207461626c65207075626c69632e7369676874736565696e672061646420636f6c756d6e206966206e6f74206578697374732070726963696e675f63757272656e63792074657874000000a52d2d204164642070726963696e675f63757272656e63795f73796d626f6c206669656c6420746f2073746f7265207468652063757272656e63792073796d626f6c2028652e672e2c20242c20e282ac290a616c746572207461626c65207075626c69632e7369676874736565696e672061646420636f6c756d6e206966206e6f74206578697374732070726963696e675f63757272656e63795f73796d626f6c2074657874000000c82d2d2041646420636f6d6d656e7420746f20646f63756d656e742074686520707572706f7365206f66207468657365206669656c64730a636f6d6d656e74206f6e20636f6c756d6e207075626c69632e7369676874736565696e672e70726963696e675f63757272656e6379206973202743757272656e637920636f646520666f722070726963696e672028652e672e2c205553442c2045555229202d206175746f6d61746963616c6c79206c6f616465642066726f6d20636f756e7472696573207461626c652700000098636f6d6d656e74206f6e20636f6c756d6e207075626c69632e7369676874736565696e672e70726963696e675f63757272656e63795f73796d626f6c206973202743757272656e63792073796d626f6c20666f722070726963696e672028652e672e2c20242c20e282ac29202d206175746f6d61746963616c6c79206c6f616465642066726f6d20636f756e7472696573207461626c6527000000b22d2d2043726561746520696e64657820666f722070726963696e675f63757272656e637920666f722062657474657220717565727920706572666f726d616e63650a63726561746520696e646578206966206e6f7420657869737473206964785f7369676874736565696e675f70726963696e675f63757272656e6379206f6e207075626c69632e7369676874736565696e67207573696e67206274726565202870726963696e675f63757272656e637929"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMENT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMENT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20250127130000_create_get_current_user_role_function.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create the get_current_user_role function\n-- This function returns the role of the currently authenticated user\n\nCREATE OR REPLACE FUNCTION get_current_user_role()\nRETURNS TEXT\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n    user_role TEXT;\nBEGIN\n    -- Check if user is authenticated\n    IF auth.uid() IS NULL THEN\n        RETURN 'guest';\n    END IF;\n    \n    -- Get the user's role from the user_roles table\n    SELECT role INTO user_role\n    FROM user_roles\n    WHERE user_id = auth.uid()\n    LIMIT 1;\n    \n    -- If no role found, return default role\n    IF user_role IS NULL THEN\n        RETURN 'user';\n    END IF;\n    \n    RETURN user_role;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Grant execute permission to authenticated users\nGRANT EXECUTE ON FUNCTION get_current_user_role() TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION get_current_user_role() TO anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20250127130000"},{"text":"create_get_current_user_role_function"},{"binary":"0000000100000000000000190000000300000001000002952d2d2043726561746520746865206765745f63757272656e745f757365725f726f6c652066756e6374696f6e0a2d2d20546869732066756e6374696f6e2072657475726e732074686520726f6c65206f66207468652063757272656e746c792061757468656e7469636174656420757365720a0a435245415445204f52205245504c4143452046554e4354494f4e206765745f63757272656e745f757365725f726f6c6528290a52455455524e5320544558540a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a41532024240a4445434c4152450a20202020757365725f726f6c6520544558543b0a424547494e0a202020202d2d20436865636b20696620757365722069732061757468656e746963617465640a20202020494620617574682e7569642829204953204e554c4c205448454e0a202020202020202052455455524e20276775657374273b0a20202020454e442049463b0a202020200a202020202d2d20476574207468652075736572277320726f6c652066726f6d2074686520757365725f726f6c6573207461626c650a2020202053454c45435420726f6c6520494e544f20757365725f726f6c650a2020202046524f4d20757365725f726f6c65730a20202020574845524520757365725f6964203d20617574682e75696428290a202020204c494d495420313b0a202020200a202020202d2d204966206e6f20726f6c6520666f756e642c2072657475726e2064656661756c7420726f6c650a20202020494620757365725f726f6c65204953204e554c4c205448454e0a202020202020202052455455524e202775736572273b0a20202020454e442049463b0a202020200a2020202052455455524e20757365725f726f6c653b0a454e443b0a2424000000752d2d204772616e742065786563757465207065726d697373696f6e20746f2061757468656e746963617465642075736572730a4752414e542045584543555445204f4e2046554e4354494f4e206765745f63757272656e745f757365725f726f6c65282920544f2061757468656e74696361746564000000394752414e542045584543555445204f4e2046554e4354494f4e206765745f63757272656e745f757365725f726f6c65282920544f20616e6f6e"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251006090000_add_hotel_currency.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add currency columns to hotels table\n-- This migration adds `currency` and `currency_symbol` to support per-hotel pricing display\n\nDO $$\nBEGIN\n  -- Add currency code column if it doesn't exist\n  IF NOT EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_schema = 'public' \n      AND table_name = 'hotels' \n      AND column_name = 'currency'\n  ) THEN\n    ALTER TABLE public.hotels \n      ADD COLUMN currency TEXT;\n    COMMENT ON COLUMN public.hotels.currency IS 'ISO currency code used for hotel pricing (e.g., AED, USD)';\n  END IF;\n\n  -- Add currency symbol column if it doesn't exist\n  IF NOT EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_schema = 'public' \n      AND table_name = 'hotels' \n      AND column_name = 'currency_symbol'\n  ) THEN\n    ALTER TABLE public.hotels \n      ADD COLUMN currency_symbol TEXT;\n    COMMENT ON COLUMN public.hotels.currency_symbol IS 'Currency symbol used for hotel pricing (e.g., Ø¯.Ø¥, $)';\n  END IF;\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Optional indexes for filtering/searching by currency\nCREATE INDEX IF NOT EXISTS idx_hotels_currency ON public.hotels(currency)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251006090000"},{"text":"add_hotel_currency"},{"binary":"0000000100000000000000190000000200000001000003de2d2d204164642063757272656e637920636f6c756d6e7320746f20686f74656c73207461626c650a2d2d2054686973206d6967726174696f6e2061646473206063757272656e63796020616e64206063757272656e63795f73796d626f6c6020746f20737570706f7274207065722d686f74656c2070726963696e6720646973706c61790a0a444f2024240a424547494e0a20202d2d204164642063757272656e637920636f646520636f6c756d6e20696620697420646f65736e27742065786973740a20204946204e4f542045584953545320280a2020202053454c45435420312046524f4d20696e666f726d6174696f6e5f736368656d612e636f6c756d6e73200a202020205748455245207461626c655f736368656d61203d20277075626c696327200a202020202020414e44207461626c655f6e616d65203d2027686f74656c7327200a202020202020414e4420636f6c756d6e5f6e616d65203d202763757272656e6379270a202029205448454e0a20202020414c544552205441424c45207075626c69632e686f74656c73200a20202020202041444420434f4c554d4e2063757272656e637920544558543b0a20202020434f4d4d454e54204f4e20434f4c554d4e207075626c69632e686f74656c732e63757272656e6379204953202749534f2063757272656e637920636f6465207573656420666f7220686f74656c2070726963696e672028652e672e2c204145442c2055534429273b0a2020454e442049463b0a0a20202d2d204164642063757272656e63792073796d626f6c20636f6c756d6e20696620697420646f65736e27742065786973740a20204946204e4f542045584953545320280a2020202053454c45435420312046524f4d20696e666f726d6174696f6e5f736368656d612e636f6c756d6e73200a202020205748455245207461626c655f736368656d61203d20277075626c696327200a202020202020414e44207461626c655f6e616d65203d2027686f74656c7327200a202020202020414e4420636f6c756d6e5f6e616d65203d202763757272656e63795f73796d626f6c270a202029205448454e0a20202020414c544552205441424c45207075626c69632e686f74656c73200a20202020202041444420434f4c554d4e2063757272656e63795f73796d626f6c20544558543b0a20202020434f4d4d454e54204f4e20434f4c554d4e207075626c69632e686f74656c732e63757272656e63795f73796d626f6c204953202743757272656e63792073796d626f6c207573656420666f7220686f74656c2070726963696e672028652e672e2c20d8af2ed8a52c202429273b0a2020454e442049463b0a454e44202424000000812d2d204f7074696f6e616c20696e646578657320666f722066696c746572696e672f736561726368696e672062792063757272656e63790a43524541544520494e444558204946204e4f5420455849535453206964785f686f74656c735f63757272656e6379204f4e207075626c69632e686f74656c732863757272656e637929"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251008_add_agent_management_rpcs.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- RPCs for agent admin actions: approve, reject, suspend, reactivate\n-- These functions validate caller role and update the public.agents table accordingly.\n\n-- Helper: check if current user is admin or super_admin\nCREATE OR REPLACE FUNCTION is_current_user_admin()\nRETURNS BOOLEAN\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n    r TEXT;\nBEGIN\n    r := get_current_user_role();\n    RETURN (r = 'admin' OR r = 'super_admin');\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION is_current_user_admin() TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION is_current_user_admin() TO anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Approve agent: set status active and assign staff\nCREATE OR REPLACE FUNCTION approve_managed_agent(p_id UUID, p_assigned_staff UUID[] DEFAULT NULL)\nRETURNS public.agents\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n    result public.agents;\nBEGIN\n    -- Enforce admin role when called with user context\n    IF auth.uid() IS NOT NULL AND NOT is_current_user_admin() THEN\n        RAISE EXCEPTION 'Permission denied: admin role required';\n    END IF;\n\n    UPDATE public.agents\n    SET status = 'active',\n        assigned_staff = COALESCE(p_assigned_staff, assigned_staff),\n        suspended_at = NULL,\n        suspension_reason = NULL,\n        updated_at = NOW()\n    WHERE id = p_id\n    RETURNING * INTO result;\n\n    IF result IS NULL THEN\n        RAISE EXCEPTION 'Agent not found';\n    END IF;\n\n    RETURN result;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION approve_managed_agent(UUID, UUID[]) TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION approve_managed_agent(UUID, UUID[]) TO anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Reject agent: set status rejected with reason\nCREATE OR REPLACE FUNCTION reject_managed_agent(p_id UUID, p_reason TEXT)\nRETURNS public.agents\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n    result public.agents;\nBEGIN\n    IF auth.uid() IS NOT NULL AND NOT is_current_user_admin() THEN\n        RAISE EXCEPTION 'Permission denied: admin role required';\n    END IF;\n\n    UPDATE public.agents\n    -- Map \"reject\" to a safe status within agents' allowed values\n    -- Accepted statuses: 'active', 'inactive', 'suspended'\n    SET status = 'inactive',\n        updated_at = NOW()\n    WHERE id = p_id\n    RETURNING * INTO result;\n\n    IF result IS NULL THEN\n        RAISE EXCEPTION 'Agent not found';\n    END IF;\n\n    RETURN result;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION reject_managed_agent(UUID, TEXT) TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION reject_managed_agent(UUID, TEXT) TO anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Suspend agent: set status suspended with reason\nCREATE OR REPLACE FUNCTION suspend_managed_agent(p_id UUID, p_reason TEXT)\nRETURNS public.agents\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n    result public.agents;\nBEGIN\n    IF auth.uid() IS NOT NULL AND NOT is_current_user_admin() THEN\n        RAISE EXCEPTION 'Permission denied: admin role required';\n    END IF;\n\n    UPDATE public.agents\n    SET status = 'suspended',\n        suspension_reason = p_reason,\n        suspended_at = NOW(),\n        updated_at = NOW()\n    WHERE id = p_id\n    RETURNING * INTO result;\n\n    IF result IS NULL THEN\n        RAISE EXCEPTION 'Agent not found';\n    END IF;\n\n    RETURN result;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION suspend_managed_agent(UUID, TEXT) TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION suspend_managed_agent(UUID, TEXT) TO anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Reactivate agent: set status active from suspended/rejected\nCREATE OR REPLACE FUNCTION reactivate_managed_agent(p_id UUID)\nRETURNS public.agents\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n    result public.agents;\nBEGIN\n    IF auth.uid() IS NOT NULL AND NOT is_current_user_admin() THEN\n        RAISE EXCEPTION 'Permission denied: admin role required';\n    END IF;\n\n    UPDATE public.agents\n    SET status = 'active',\n        suspended_at = NULL,\n        suspension_reason = NULL,\n        updated_at = NOW()\n    WHERE id = p_id\n    RETURNING * INTO result;\n\n    IF result IS NULL THEN\n        RAISE EXCEPTION 'Agent not found';\n    END IF;\n\n    RETURN result;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION reactivate_managed_agent(UUID) TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION reactivate_managed_agent(UUID) TO anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251008"},{"text":"add_agent_management_rpcs"},{"binary":"0000000100000000000000190000000f00000001000001b52d2d205250437320666f72206167656e742061646d696e20616374696f6e733a20617070726f76652c2072656a6563742c2073757370656e642c20726561637469766174650a2d2d2054686573652066756e6374696f6e732076616c69646174652063616c6c657220726f6c6520616e642075706461746520746865207075626c69632e6167656e7473207461626c65206163636f7264696e676c792e0a0a2d2d2048656c7065723a20636865636b2069662063757272656e7420757365722069732061646d696e206f722073757065725f61646d696e0a435245415445204f52205245504c4143452046554e4354494f4e2069735f63757272656e745f757365725f61646d696e28290a52455455524e5320424f4f4c45414e0a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a41532024240a4445434c4152450a202020207220544558543b0a424547494e0a2020202072203a3d206765745f63757272656e745f757365725f726f6c6528293b0a2020202052455455524e202872203d202761646d696e27204f522072203d202773757065725f61646d696e27293b0a454e443b0a2424000000424752414e542045584543555445204f4e2046554e4354494f4e2069735f63757272656e745f757365725f61646d696e282920544f2061757468656e74696361746564000000394752414e542045584543555445204f4e2046554e4354494f4e2069735f63757272656e745f757365725f61646d696e282920544f20616e6f6e000003392d2d20417070726f7665206167656e743a20736574207374617475732061637469766520616e642061737369676e2073746166660a435245415445204f52205245504c4143452046554e4354494f4e20617070726f76655f6d616e616765645f6167656e7428705f696420555549442c20705f61737369676e65645f737461666620555549445b5d2044454641554c54204e554c4c290a52455455524e53207075626c69632e6167656e74730a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a41532024240a4445434c4152450a20202020726573756c74207075626c69632e6167656e74733b0a424547494e0a202020202d2d20456e666f7263652061646d696e20726f6c65207768656e2063616c6c65642077697468207573657220636f6e746578740a20202020494620617574682e7569642829204953204e4f54204e554c4c20414e44204e4f542069735f63757272656e745f757365725f61646d696e2829205448454e0a2020202020202020524149534520455843455054494f4e20275065726d697373696f6e2064656e6965643a2061646d696e20726f6c65207265717569726564273b0a20202020454e442049463b0a0a20202020555044415445207075626c69632e6167656e74730a2020202053455420737461747573203d2027616374697665272c0a202020202020202061737369676e65645f7374616666203d20434f414c4553434528705f61737369676e65645f73746166662c2061737369676e65645f7374616666292c0a202020202020202073757370656e6465645f6174203d204e554c4c2c0a202020202020202073757370656e73696f6e5f726561736f6e203d204e554c4c2c0a2020202020202020757064617465645f6174203d204e4f5728290a202020205748455245206964203d20705f69640a2020202052455455524e494e47202a20494e544f20726573756c743b0a0a20202020494620726573756c74204953204e554c4c205448454e0a2020202020202020524149534520455843455054494f4e20274167656e74206e6f7420666f756e64273b0a20202020454e442049463b0a0a2020202052455455524e20726573756c743b0a454e443b0a24240000004e4752414e542045584543555445204f4e2046554e4354494f4e20617070726f76655f6d616e616765645f6167656e7428555549442c20555549445b5d2920544f2061757468656e74696361746564000000454752414e542045584543555445204f4e2046554e4354494f4e20617070726f76655f6d616e616765645f6167656e7428555549442c20555549445b5d2920544f20616e6f6e000002e22d2d2052656a656374206167656e743a20736574207374617475732072656a6563746564207769746820726561736f6e0a435245415445204f52205245504c4143452046554e4354494f4e2072656a6563745f6d616e616765645f6167656e7428705f696420555549442c20705f726561736f6e2054455854290a52455455524e53207075626c69632e6167656e74730a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a41532024240a4445434c4152450a20202020726573756c74207075626c69632e6167656e74733b0a424547494e0a20202020494620617574682e7569642829204953204e4f54204e554c4c20414e44204e4f542069735f63757272656e745f757365725f61646d696e2829205448454e0a2020202020202020524149534520455843455054494f4e20275065726d697373696f6e2064656e6965643a2061646d696e20726f6c65207265717569726564273b0a20202020454e442049463b0a0a20202020555044415445207075626c69632e6167656e74730a202020202d2d204d6170202272656a6563742220746f20612073616665207374617475732077697468696e206167656e74732720616c6c6f7765642076616c7565730a202020202d2d2041636365707465642073746174757365733a2027616374697665272c2027696e616374697665272c202773757370656e646564270a2020202053455420737461747573203d2027696e616374697665272c0a2020202020202020757064617465645f6174203d204e4f5728290a202020205748455245206964203d20705f69640a2020202052455455524e494e47202a20494e544f20726573756c743b0a0a20202020494620726573756c74204953204e554c4c205448454e0a2020202020202020524149534520455843455054494f4e20274167656e74206e6f7420666f756e64273b0a20202020454e442049463b0a0a2020202052455455524e20726573756c743b0a454e443b0a24240000004b4752414e542045584543555445204f4e2046554e4354494f4e2072656a6563745f6d616e616765645f6167656e7428555549442c20544558542920544f2061757468656e74696361746564000000424752414e542045584543555445204f4e2046554e4354494f4e2072656a6563745f6d616e616765645f6167656e7428555549442c20544558542920544f20616e6f6e000002ab2d2d2053757370656e64206167656e743a20736574207374617475732073757370656e646564207769746820726561736f6e0a435245415445204f52205245504c4143452046554e4354494f4e2073757370656e645f6d616e616765645f6167656e7428705f696420555549442c20705f726561736f6e2054455854290a52455455524e53207075626c69632e6167656e74730a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a41532024240a4445434c4152450a20202020726573756c74207075626c69632e6167656e74733b0a424547494e0a20202020494620617574682e7569642829204953204e4f54204e554c4c20414e44204e4f542069735f63757272656e745f757365725f61646d696e2829205448454e0a2020202020202020524149534520455843455054494f4e20275065726d697373696f6e2064656e6965643a2061646d696e20726f6c65207265717569726564273b0a20202020454e442049463b0a0a20202020555044415445207075626c69632e6167656e74730a2020202053455420737461747573203d202773757370656e646564272c0a202020202020202073757370656e73696f6e5f726561736f6e203d20705f726561736f6e2c0a202020202020202073757370656e6465645f6174203d204e4f5728292c0a2020202020202020757064617465645f6174203d204e4f5728290a202020205748455245206964203d20705f69640a2020202052455455524e494e47202a20494e544f20726573756c743b0a0a20202020494620726573756c74204953204e554c4c205448454e0a2020202020202020524149534520455843455054494f4e20274167656e74206e6f7420666f756e64273b0a20202020454e442049463b0a0a2020202052455455524e20726573756c743b0a454e443b0a24240000004c4752414e542045584543555445204f4e2046554e4354494f4e2073757370656e645f6d616e616765645f6167656e7428555549442c20544558542920544f2061757468656e74696361746564000000434752414e542045584543555445204f4e2046554e4354494f4e2073757370656e645f6d616e616765645f6167656e7428555549442c20544558542920544f20616e6f6e000002a32d2d2052656163746976617465206167656e743a2073657420737461747573206163746976652066726f6d2073757370656e6465642f72656a65637465640a435245415445204f52205245504c4143452046554e4354494f4e20726561637469766174655f6d616e616765645f6167656e7428705f69642055554944290a52455455524e53207075626c69632e6167656e74730a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a41532024240a4445434c4152450a20202020726573756c74207075626c69632e6167656e74733b0a424547494e0a20202020494620617574682e7569642829204953204e4f54204e554c4c20414e44204e4f542069735f63757272656e745f757365725f61646d696e2829205448454e0a2020202020202020524149534520455843455054494f4e20275065726d697373696f6e2064656e6965643a2061646d696e20726f6c65207265717569726564273b0a20202020454e442049463b0a0a20202020555044415445207075626c69632e6167656e74730a2020202053455420737461747573203d2027616374697665272c0a202020202020202073757370656e6465645f6174203d204e554c4c2c0a202020202020202073757370656e73696f6e5f726561736f6e203d204e554c4c2c0a2020202020202020757064617465645f6174203d204e4f5728290a202020205748455245206964203d20705f69640a2020202052455455524e494e47202a20494e544f20726573756c743b0a0a20202020494620726573756c74204953204e554c4c205448454e0a2020202020202020524149534520455843455054494f4e20274167656e74206e6f7420666f756e64273b0a20202020454e442049463b0a0a2020202052455455524e20726573756c743b0a454e443b0a2424000000494752414e542045584543555445204f4e2046554e4354494f4e20726561637469766174655f6d616e616765645f6167656e7428555549442920544f2061757468656e74696361746564000000404752414e542045584543555445204f4e2046554e4354494f4e20726561637469766174655f6d616e616765645f6167656e7428555549442920544f20616e6f6e"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251009_agent_profile_fields.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Ensure profiles has extended fields for management editing\nALTER TABLE public.profiles\n  ADD COLUMN IF NOT EXISTS profile_image text,\n  ADD COLUMN IF NOT EXISTS preferred_language text,\n  ADD COLUMN IF NOT EXISTS country text,\n  ADD COLUMN IF NOT EXISTS city text","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Ensure agents has extended fields for management editing\nALTER TABLE public.agents\n  ADD COLUMN IF NOT EXISTS agent_type text,\n  ADD COLUMN IF NOT EXISTS commission_type text,\n  ADD COLUMN IF NOT EXISTS commission_value numeric,\n  ADD COLUMN IF NOT EXISTS source_type text,\n  ADD COLUMN IF NOT EXISTS source_details text","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add FK from agents.id to profiles.id if missing\nDO $$\nBEGIN\n  IF NOT EXISTS (\n    SELECT 1\n    FROM pg_constraint c\n    JOIN pg_class t ON c.conrelid = t.oid\n    WHERE t.relname = 'agents'\n      AND c.conname = 'agents_id_fkey'\n  ) THEN\n    ALTER TABLE public.agents\n      ADD CONSTRAINT agents_id_fkey FOREIGN KEY (id) REFERENCES public.profiles(id) ON DELETE CASCADE;\n  END IF;\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Optional: indexes for lookup\nCREATE INDEX IF NOT EXISTS idx_profiles_country ON public.profiles(country)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE INDEX IF NOT EXISTS idx_profiles_city ON public.profiles(city)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE INDEX IF NOT EXISTS idx_agents_type ON public.agents(agent_type)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE INDEX IF NOT EXISTS idx_agents_status ON public.agents(status)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251009"},{"text":"agent_profile_fields"},{"binary":"00000001000000000000001900000007000000010000010a2d2d20456e737572652070726f66696c65732068617320657874656e646564206669656c647320666f72206d616e6167656d656e742065646974696e670a414c544552205441424c45207075626c69632e70726f66696c65730a202041444420434f4c554d4e204946204e4f54204558495354532070726f66696c655f696d61676520746578742c0a202041444420434f4c554d4e204946204e4f5420455849535453207072656665727265645f6c616e677561676520746578742c0a202041444420434f4c554d4e204946204e4f542045584953545320636f756e74727920746578742c0a202041444420434f4c554d4e204946204e4f542045584953545320636974792074657874000001432d2d20456e73757265206167656e74732068617320657874656e646564206669656c647320666f72206d616e6167656d656e742065646974696e670a414c544552205441424c45207075626c69632e6167656e74730a202041444420434f4c554d4e204946204e4f5420455849535453206167656e745f7479706520746578742c0a202041444420434f4c554d4e204946204e4f542045584953545320636f6d6d697373696f6e5f7479706520746578742c0a202041444420434f4c554d4e204946204e4f542045584953545320636f6d6d697373696f6e5f76616c7565206e756d657269632c0a202041444420434f4c554d4e204946204e4f542045584953545320736f757263655f7479706520746578742c0a202041444420434f4c554d4e204946204e4f542045584953545320736f757263655f64657461696c732074657874000001852d2d2041646420464b2066726f6d206167656e74732e696420746f2070726f66696c65732e6964206966206d697373696e670a444f2024240a424547494e0a20204946204e4f542045584953545320280a2020202053454c45435420310a2020202046524f4d2070675f636f6e73747261696e7420630a202020204a4f494e2070675f636c6173732074204f4e20632e636f6e72656c6964203d20742e6f69640a20202020574845524520742e72656c6e616d65203d20276167656e7473270a202020202020414e4420632e636f6e6e616d65203d20276167656e74735f69645f666b6579270a202029205448454e0a20202020414c544552205441424c45207075626c69632e6167656e74730a20202020202041444420434f4e53545241494e54206167656e74735f69645f666b657920464f524549474e204b45592028696429205245464552454e434553207075626c69632e70726f66696c657328696429204f4e2044454c45544520434153434144453b0a2020454e442049463b0a454e442024240000006b2d2d204f7074696f6e616c3a20696e646578657320666f72206c6f6f6b75700a43524541544520494e444558204946204e4f5420455849535453206964785f70726f66696c65735f636f756e747279204f4e207075626c69632e70726f66696c657328636f756e747279290000004543524541544520494e444558204946204e4f5420455849535453206964785f70726f66696c65735f63697479204f4e207075626c69632e70726f66696c65732863697479290000004743524541544520494e444558204946204e4f5420455849535453206964785f6167656e74735f74797065204f4e207075626c69632e6167656e7473286167656e745f74797065290000004543524541544520494e444558204946204e4f5420455849535453206964785f6167656e74735f737461747573204f4e207075626c69632e6167656e74732873746174757329"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"42701","Message":"column \"source_type\" of relation \"agents\" already exists, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"tablecmds.c","Line":7471,"Routine":"check_for_column_name_collision","UnknownFields":null}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"42701","Message":"column \"source_details\" of relation \"agents\" already exists, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"tablecmds.c","Line":7471,"Routine":"check_for_column_name_collision","UnknownFields":null}
NOTICE (42701): column "source_type" of relation "agents" already exists, skipping
NOTICE (42701): column "source_details" of relation "agents" already exists, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251010120000_add_approve_agent_rpc.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Migration: Add approve_agent RPC to enforce admin approval and profile completeness\n-- Ensures only admins can approve and that the agent profile has required fields\n\ncreate or replace function public.approve_agent(p_id uuid)\nreturns jsonb\nlanguage plpgsql\nsecurity definer\nset search_path = public\nas $$\ndeclare\n  v_role text;\n  v_name text;\n  v_email text;\n  v_phone text;\n  v_company text;\nbegin\n  -- Require authenticated context\n  if auth.uid() is null then\n    return jsonb_build_object('ok', false, 'error', 'Unauthorized');\n  end if;\n\n  -- Ensure caller is admin or super_admin\n  select get_current_user_role() into v_role;\n  if v_role not in ('admin', 'super_admin') then\n    return jsonb_build_object('ok', false, 'error', 'Permission denied: admin role required');\n  end if;\n\n  -- Validate profile completeness (name, email, phone, company)\n  select p.name, p.email, p.phone, p.company_name\n    into v_name, v_email, v_phone, v_company\n  from public.profiles p\n  where p.id = p_id\n  limit 1;\n\n  if v_name is null or v_email is null then\n    return jsonb_build_object('ok', false, 'error', 'Profile incomplete: name and email required');\n  end if;\n\n  if v_phone is null or v_company is null then\n    return jsonb_build_object('ok', false, 'error', 'Profile incomplete: phone and company required');\n  end if;\n\n  -- Approve agent\n  update public.agents\n  set status = 'active', updated_at = now()\n  where id = p_id;\n\n  if not found then\n    return jsonb_build_object('ok', false, 'error', 'Agent not found');\n  end if;\n\n  return jsonb_build_object('ok', true);\nend;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"grant execute on function public.approve_agent(uuid) to authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251010120000"},{"text":"add_approve_agent_rpc"},{"binary":"00000001000000000000001900000002000000010000062c2d2d204d6967726174696f6e3a2041646420617070726f76655f6167656e742052504320746f20656e666f7263652061646d696e20617070726f76616c20616e642070726f66696c6520636f6d706c6574656e6573730a2d2d20456e7375726573206f6e6c792061646d696e732063616e20617070726f766520616e64207468617420746865206167656e742070726f66696c6520686173207265717569726564206669656c64730a0a637265617465206f72207265706c6163652066756e6374696f6e207075626c69632e617070726f76655f6167656e7428705f69642075756964290a72657475726e73206a736f6e620a6c616e677561676520706c706773716c0a736563757269747920646566696e65720a736574207365617263685f70617468203d207075626c69630a61732024240a6465636c6172650a2020765f726f6c6520746578743b0a2020765f6e616d6520746578743b0a2020765f656d61696c20746578743b0a2020765f70686f6e6520746578743b0a2020765f636f6d70616e7920746578743b0a626567696e0a20202d2d20526571756972652061757468656e7469636174656420636f6e746578740a2020696620617574682e7569642829206973206e756c6c207468656e0a2020202072657475726e206a736f6e625f6275696c645f6f626a65637428276f6b272c2066616c73652c20276572726f72272c2027556e617574686f72697a656427293b0a2020656e642069663b0a0a20202d2d20456e737572652063616c6c65722069732061646d696e206f722073757065725f61646d696e0a202073656c656374206765745f63757272656e745f757365725f726f6c65282920696e746f20765f726f6c653b0a2020696620765f726f6c65206e6f7420696e20282761646d696e272c202773757065725f61646d696e2729207468656e0a2020202072657475726e206a736f6e625f6275696c645f6f626a65637428276f6b272c2066616c73652c20276572726f72272c20275065726d697373696f6e2064656e6965643a2061646d696e20726f6c6520726571756972656427293b0a2020656e642069663b0a0a20202d2d2056616c69646174652070726f66696c6520636f6d706c6574656e65737320286e616d652c20656d61696c2c2070686f6e652c20636f6d70616e79290a202073656c65637420702e6e616d652c20702e656d61696c2c20702e70686f6e652c20702e636f6d70616e795f6e616d650a20202020696e746f20765f6e616d652c20765f656d61696c2c20765f70686f6e652c20765f636f6d70616e790a202066726f6d207075626c69632e70726f66696c657320700a2020776865726520702e6964203d20705f69640a20206c696d697420313b0a0a2020696620765f6e616d65206973206e756c6c206f7220765f656d61696c206973206e756c6c207468656e0a2020202072657475726e206a736f6e625f6275696c645f6f626a65637428276f6b272c2066616c73652c20276572726f72272c202750726f66696c6520696e636f6d706c6574653a206e616d6520616e6420656d61696c20726571756972656427293b0a2020656e642069663b0a0a2020696620765f70686f6e65206973206e756c6c206f7220765f636f6d70616e79206973206e756c6c207468656e0a2020202072657475726e206a736f6e625f6275696c645f6f626a65637428276f6b272c2066616c73652c20276572726f72272c202750726f66696c6520696e636f6d706c6574653a2070686f6e6520616e6420636f6d70616e7920726571756972656427293b0a2020656e642069663b0a0a20202d2d20417070726f7665206167656e740a2020757064617465207075626c69632e6167656e74730a202073657420737461747573203d2027616374697665272c20757064617465645f6174203d206e6f7728290a20207768657265206964203d20705f69643b0a0a20206966206e6f7420666f756e64207468656e0a2020202072657475726e206a736f6e625f6275696c645f6f626a65637428276f6b272c2066616c73652c20276572726f72272c20274167656e74206e6f7420666f756e6427293b0a2020656e642069663b0a0a202072657475726e206a736f6e625f6275696c645f6f626a65637428276f6b272c2074727565293b0a656e643b0a2424000000456772616e742065786563757465206f6e2066756e6374696f6e207075626c69632e617070726f76655f6167656e7428757569642920746f2061757468656e74696361746564"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251010130000_add_authenticate_managed_agent_rpc.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Migration: Add authenticate_managed_agent RPC for agent login\n-- Creates a secure RPC that validates agent credentials against public.agent_credentials\n-- and returns basic agent info when the agent is active.\n\n-- Ensure pgcrypto is available for password verification\ncreate extension if not exists pgcrypto","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- RPC: authenticate_managed_agent\n-- Params: p_username (text), p_password (text)\n-- Returns: jsonb { ok: boolean, agent?: { id, name, email, role }, error?: text }\ncreate or replace function public.authenticate_managed_agent(\n  p_username text,\n  p_password text\n)\nreturns jsonb\nlanguage plpgsql\nsecurity definer\nset search_path = public\nas $$\ndeclare\n  v_username text := lower(trim(p_username));\n  v_agent_id uuid;\n  v_password_hash text;\n  v_is_temporary boolean;\n  v_status text;\n  v_name text;\n  v_email text;\n  v_role text;\nbegin\n  -- Lookup credentials by normalized username\n  select c.agent_id, c.password_hash, c.is_temporary\n    into v_agent_id, v_password_hash, v_is_temporary\n  from public.agent_credentials c\n  join public.profiles p on p.id = c.agent_id\n  where c.username = v_username\n     or lower(p.email) = v_username\n  limit 1;\n\n  if v_agent_id is null then\n    return jsonb_build_object('ok', false, 'error', 'Credentials not found');\n  end if;\n\n  -- Verify password using pgcrypto\n  if crypt(p_password, v_password_hash) \u003c\u003e v_password_hash then\n    return jsonb_build_object('ok', false, 'error', 'Invalid credentials');\n  end if;\n\n  -- Enforce password-change gating for temporary credentials at DB level\n  if coalesce(v_is_temporary, false) then\n    return jsonb_build_object('ok', false, 'error', 'Password change required');\n  end if;\n\n  -- Ensure agent exists and is active\n  select a.status into v_status\n  from public.agents a\n  where a.id = v_agent_id\n  limit 1;\n\n  if v_status is null then\n    return jsonb_build_object('ok', false, 'error', 'Agent not found');\n  end if;\n\n  if v_status \u003c\u003e 'active' then\n    return jsonb_build_object('ok', false, 'error', 'Agent inactive');\n  end if;\n\n  -- Load basic profile info\n  select p.name, p.email, coalesce(p.role, 'agent')\n    into v_name, v_email, v_role\n  from public.profiles p\n  where p.id = v_agent_id\n  limit 1;\n\n  return jsonb_build_object(\n    'ok', true,\n    'agent', jsonb_build_object(\n      'id', v_agent_id::text,\n      'name', coalesce(v_name, 'Agent'),\n      'email', coalesce(v_email, v_username),\n      'role', coalesce(v_role, 'agent')\n    )\n  );\nend;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Allow unauthenticated and authenticated clients to execute during login\ngrant execute on function public.authenticate_managed_agent(text, text) to authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"grant execute on function public.authenticate_managed_agent(text, text) to anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251010130000"},{"text":"add_authenticate_managed_agent_rpc"},{"binary":"0000000100000000000000190000000400000001000001372d2d204d6967726174696f6e3a204164642061757468656e7469636174655f6d616e616765645f6167656e742052504320666f72206167656e74206c6f67696e0a2d2d20437265617465732061207365637572652052504320746861742076616c696461746573206167656e742063726564656e7469616c7320616761696e7374207075626c69632e6167656e745f63726564656e7469616c730a2d2d20616e642072657475726e73206261736963206167656e7420696e666f207768656e20746865206167656e74206973206163746976652e0a0a2d2d20456e7375726520706763727970746f20697320617661696c61626c6520666f722070617373776f726420766572696669636174696f6e0a63726561746520657874656e73696f6e206966206e6f742065786973747320706763727970746f000008652d2d205250433a2061757468656e7469636174655f6d616e616765645f6167656e740a2d2d20506172616d733a20705f757365726e616d65202874657874292c20705f70617373776f7264202874657874290a2d2d2052657475726e733a206a736f6e62207b206f6b3a20626f6f6c65616e2c206167656e743f3a207b2069642c206e616d652c20656d61696c2c20726f6c65207d2c206572726f723f3a2074657874207d0a637265617465206f72207265706c6163652066756e6374696f6e207075626c69632e61757468656e7469636174655f6d616e616765645f6167656e74280a2020705f757365726e616d6520746578742c0a2020705f70617373776f726420746578740a290a72657475726e73206a736f6e620a6c616e677561676520706c706773716c0a736563757269747920646566696e65720a736574207365617263685f70617468203d207075626c69630a61732024240a6465636c6172650a2020765f757365726e616d652074657874203a3d206c6f776572287472696d28705f757365726e616d6529293b0a2020765f6167656e745f696420757569643b0a2020765f70617373776f72645f6861736820746578743b0a2020765f69735f74656d706f7261727920626f6f6c65616e3b0a2020765f73746174757320746578743b0a2020765f6e616d6520746578743b0a2020765f656d61696c20746578743b0a2020765f726f6c6520746578743b0a626567696e0a20202d2d204c6f6f6b75702063726564656e7469616c73206279206e6f726d616c697a656420757365726e616d650a202073656c65637420632e6167656e745f69642c20632e70617373776f72645f686173682c20632e69735f74656d706f726172790a20202020696e746f20765f6167656e745f69642c20765f70617373776f72645f686173682c20765f69735f74656d706f726172790a202066726f6d207075626c69632e6167656e745f63726564656e7469616c7320630a20206a6f696e207075626c69632e70726f66696c65732070206f6e20702e6964203d20632e6167656e745f69640a2020776865726520632e757365726e616d65203d20765f757365726e616d650a20202020206f72206c6f77657228702e656d61696c29203d20765f757365726e616d650a20206c696d697420313b0a0a2020696620765f6167656e745f6964206973206e756c6c207468656e0a2020202072657475726e206a736f6e625f6275696c645f6f626a65637428276f6b272c2066616c73652c20276572726f72272c202743726564656e7469616c73206e6f7420666f756e6427293b0a2020656e642069663b0a0a20202d2d205665726966792070617373776f7264207573696e6720706763727970746f0a2020696620637279707428705f70617373776f72642c20765f70617373776f72645f6861736829203c3e20765f70617373776f72645f68617368207468656e0a2020202072657475726e206a736f6e625f6275696c645f6f626a65637428276f6b272c2066616c73652c20276572726f72272c2027496e76616c69642063726564656e7469616c7327293b0a2020656e642069663b0a0a20202d2d20456e666f7263652070617373776f72642d6368616e676520676174696e6720666f722074656d706f726172792063726564656e7469616c73206174204442206c6576656c0a2020696620636f616c6573636528765f69735f74656d706f726172792c2066616c736529207468656e0a2020202072657475726e206a736f6e625f6275696c645f6f626a65637428276f6b272c2066616c73652c20276572726f72272c202750617373776f7264206368616e676520726571756972656427293b0a2020656e642069663b0a0a20202d2d20456e73757265206167656e742065786973747320616e64206973206163746976650a202073656c65637420612e73746174757320696e746f20765f7374617475730a202066726f6d207075626c69632e6167656e747320610a2020776865726520612e6964203d20765f6167656e745f69640a20206c696d697420313b0a0a2020696620765f737461747573206973206e756c6c207468656e0a2020202072657475726e206a736f6e625f6275696c645f6f626a65637428276f6b272c2066616c73652c20276572726f72272c20274167656e74206e6f7420666f756e6427293b0a2020656e642069663b0a0a2020696620765f737461747573203c3e202761637469766527207468656e0a2020202072657475726e206a736f6e625f6275696c645f6f626a65637428276f6b272c2066616c73652c20276572726f72272c20274167656e7420696e61637469766527293b0a2020656e642069663b0a0a20202d2d204c6f61642062617369632070726f66696c6520696e666f0a202073656c65637420702e6e616d652c20702e656d61696c2c20636f616c6573636528702e726f6c652c20276167656e7427290a20202020696e746f20765f6e616d652c20765f656d61696c2c20765f726f6c650a202066726f6d207075626c69632e70726f66696c657320700a2020776865726520702e6964203d20765f6167656e745f69640a20206c696d697420313b0a0a202072657475726e206a736f6e625f6275696c645f6f626a656374280a20202020276f6b272c20747275652c0a20202020276167656e74272c206a736f6e625f6275696c645f6f626a656374280a202020202020276964272c20765f6167656e745f69643a3a746578742c0a202020202020276e616d65272c20636f616c6573636528765f6e616d652c20274167656e7427292c0a20202020202027656d61696c272c20636f616c6573636528765f656d61696c2c20765f757365726e616d65292c0a20202020202027726f6c65272c20636f616c6573636528765f726f6c652c20276167656e7427290a20202020290a2020293b0a656e643b0a2424000000a32d2d20416c6c6f7720756e61757468656e7469636174656420616e642061757468656e7469636174656420636c69656e747320746f206578656375746520647572696e67206c6f67696e0a6772616e742065786563757465206f6e2066756e6374696f6e207075626c69632e61757468656e7469636174655f6d616e616765645f6167656e7428746578742c20746578742920746f2061757468656e746963617465640000004f6772616e742065786563757465206f6e2066756e6374696f6e207075626c69632e61757468656e7469636174655f6d616e616765645f6167656e7428746578742c20746578742920746f20616e6f6e"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"42710","Message":"extension \"pgcrypto\" already exists, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"extension.c","Line":1791,"Routine":"CreateExtension","UnknownFields":null}
NOTICE (42710): extension "pgcrypto" already exists, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE EXTENSION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251010140000_add_set_agent_credentials_rpc.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Ensure required extension for password hashing\ncreate extension if not exists pgcrypto","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- RPC: Set or update agent credentials with hashed password\ncreate or replace function public.set_agent_credentials(\n  p_id uuid,\n  p_username text,\n  p_password text,\n  p_is_temporary boolean default false\n)\nreturns void\nlanguage plpgsql\nsecurity definer\nset search_path = public\nas $$\nbegin\n  -- Upsert credentials: hash password, lowercase username, set temporary flag\n  insert into public.agent_credentials (agent_id, username, password_hash, is_temporary, created_at, updated_at)\n  values (\n    p_id,\n    lower(p_username),\n    crypt(p_password, gen_salt('bf')),\n    coalesce(p_is_temporary, false),\n    now(),\n    now()\n  )\n  on conflict (agent_id) do update set\n    username = excluded.username,\n    password_hash = excluded.password_hash,\n    is_temporary = excluded.is_temporary,\n    updated_at = now();\nend;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Allow both unauthenticated (invite) and authenticated clients to set credentials via server context\ngrant execute on function public.set_agent_credentials(uuid, text, text, boolean) to authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"grant execute on function public.set_agent_credentials(uuid, text, text, boolean) to anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251010140000"},{"text":"add_set_agent_credentials_rpc"},{"binary":"0000000100000000000000190000000400000001000000592d2d20456e7375726520726571756972656420657874656e73696f6e20666f722070617373776f72642068617368696e670a63726561746520657874656e73696f6e206966206e6f742065786973747320706763727970746f000003352d2d205250433a20536574206f7220757064617465206167656e742063726564656e7469616c732077697468206861736865642070617373776f72640a637265617465206f72207265706c6163652066756e6374696f6e207075626c69632e7365745f6167656e745f63726564656e7469616c73280a2020705f696420757569642c0a2020705f757365726e616d6520746578742c0a2020705f70617373776f726420746578742c0a2020705f69735f74656d706f7261727920626f6f6c65616e2064656661756c742066616c73650a290a72657475726e7320766f69640a6c616e677561676520706c706773716c0a736563757269747920646566696e65720a736574207365617263685f70617468203d207075626c69630a61732024240a626567696e0a20202d2d205570736572742063726564656e7469616c733a20686173682070617373776f72642c206c6f7765726361736520757365726e616d652c207365742074656d706f7261727920666c61670a2020696e7365727420696e746f207075626c69632e6167656e745f63726564656e7469616c7320286167656e745f69642c20757365726e616d652c2070617373776f72645f686173682c2069735f74656d706f726172792c20637265617465645f61742c20757064617465645f6174290a202076616c75657320280a20202020705f69642c0a202020206c6f77657228705f757365726e616d65292c0a20202020637279707428705f70617373776f72642c2067656e5f73616c74282762662729292c0a20202020636f616c6573636528705f69735f74656d706f726172792c2066616c7365292c0a202020206e6f7728292c0a202020206e6f7728290a2020290a20206f6e20636f6e666c69637420286167656e745f69642920646f20757064617465207365740a20202020757365726e616d65203d206578636c756465642e757365726e616d652c0a2020202070617373776f72645f68617368203d206578636c756465642e70617373776f72645f686173682c0a2020202069735f74656d706f72617279203d206578636c756465642e69735f74656d706f726172792c0a20202020757064617465645f6174203d206e6f7728293b0a656e643b0a2424000000c92d2d20416c6c6f7720626f746820756e61757468656e746963617465642028696e766974652920616e642061757468656e7469636174656420636c69656e747320746f207365742063726564656e7469616c73207669612073657276657220636f6e746578740a6772616e742065786563757465206f6e2066756e6374696f6e207075626c69632e7365745f6167656e745f63726564656e7469616c7328757569642c20746578742c20746578742c20626f6f6c65616e2920746f2061757468656e74696361746564000000596772616e742065786563757465206f6e2066756e6374696f6e207075626c69632e7365745f6167656e745f63726564656e7469616c7328757569642c20746578742c20746578742c20626f6f6c65616e2920746f20616e6f6e"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"42710","Message":"extension \"pgcrypto\" already exists, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"extension.c","Line":1791,"Routine":"CreateExtension","UnknownFields":null}
NOTICE (42710): extension "pgcrypto" already exists, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE EXTENSION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251010_add_agent_credentials_rpc.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Enable required extension for password hashing\nCREATE EXTENSION IF NOT EXISTS pgcrypto","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create table to store agent credentials if it doesn't exist\nCREATE TABLE IF NOT EXISTS public.agent_credentials (\n  agent_id UUID PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE,\n  username TEXT NOT NULL UNIQUE,\n  password_hash TEXT NOT NULL,\n  is_temporary BOOLEAN NOT NULL DEFAULT false,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Helper function to update updated_at (create if missing)\nCREATE OR REPLACE FUNCTION public.handle_updated_at_generic()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = timezone('utc'::text, now());\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Trigger for updated_at on agent_credentials\nDO $$\nBEGIN\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_trigger WHERE tgname = 'handle_agent_credentials_updated_at'\n  ) THEN\n    CREATE TRIGGER handle_agent_credentials_updated_at\n    BEFORE UPDATE ON public.agent_credentials\n    FOR EACH ROW EXECUTE PROCEDURE public.handle_updated_at_generic();\n  END IF;\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Secure RPC to set agent credentials (upsert)\nCREATE OR REPLACE FUNCTION public.set_agent_credentials(\n  p_id UUID,\n  p_username TEXT,\n  p_password TEXT,\n  p_is_temporary BOOLEAN DEFAULT false\n)\nRETURNS VOID\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n  hashed TEXT;\nBEGIN\n  IF p_id IS NULL OR p_username IS NULL OR p_password IS NULL THEN\n    RAISE EXCEPTION 'Invalid parameters';\n  END IF;\n\n  -- Hash the password using pgcrypto\n  hashed := crypt(p_password, gen_salt('bf'));\n\n  -- Upsert credentials; user name stored in lowercase for consistency\n  INSERT INTO public.agent_credentials(agent_id, username, password_hash, is_temporary)\n  VALUES (p_id, lower(p_username), hashed, COALESCE(p_is_temporary, false))\n  ON CONFLICT (agent_id) DO UPDATE SET\n    username = EXCLUDED.username,\n    password_hash = EXCLUDED.password_hash,\n    is_temporary = EXCLUDED.is_temporary,\n    updated_at = NOW();\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION public.set_agent_credentials(UUID, TEXT, TEXT, BOOLEAN) TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION public.set_agent_credentials(UUID, TEXT, TEXT, BOOLEAN) TO anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251010"},{"text":"add_agent_credentials_rpc"},{"binary":"0000000100000000000000190000000700000001000000592d2d20456e61626c6520726571756972656420657874656e73696f6e20666f722070617373776f72642068617368696e670a43524541544520455854454e53494f4e204946204e4f542045584953545320706763727970746f000001942d2d20437265617465207461626c6520746f2073746f7265206167656e742063726564656e7469616c7320696620697420646f65736e27742065786973740a435245415445205441424c45204946204e4f5420455849535453207075626c69632e6167656e745f63726564656e7469616c7320280a20206167656e745f69642055554944205052494d415259204b4559205245464552454e434553207075626c69632e70726f66696c657328696429204f4e2044454c45544520434153434144452c0a2020757365726e616d652054455854204e4f54204e554c4c20554e495155452c0a202070617373776f72645f686173682054455854204e4f54204e554c4c2c0a202069735f74656d706f7261727920424f4f4c45414e204e4f54204e554c4c2044454641554c542066616c73652c0a2020637265617465645f61742054494d455354414d50545a204e4f54204e554c4c2044454641554c54204e4f5728292c0a2020757064617465645f61742054494d455354414d50545a204e4f54204e554c4c2044454641554c54204e4f5728290a29000000ed2d2d2048656c7065722066756e6374696f6e20746f2075706461746520757064617465645f61742028637265617465206966206d697373696e67290a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f757064617465645f61745f67656e6572696328290a52455455524e5320545249474745522041532024240a424547494e0a20204e45572e757064617465645f6174203d2074696d657a6f6e652827757463273a3a746578742c206e6f772829293b0a202052455455524e204e45573b0a454e443b0a2424204c414e475541474520706c706773716c000001642d2d205472696767657220666f7220757064617465645f6174206f6e206167656e745f63726564656e7469616c730a444f2024240a424547494e0a20204946204e4f542045584953545320280a2020202053454c45435420312046524f4d2070675f747269676765722057484552452074676e616d65203d202768616e646c655f6167656e745f63726564656e7469616c735f757064617465645f6174270a202029205448454e0a2020202043524541544520545249474745522068616e646c655f6167656e745f63726564656e7469616c735f757064617465645f61740a202020204245464f524520555044415445204f4e207075626c69632e6167656e745f63726564656e7469616c730a20202020464f52204541434820524f5720455845435554452050524f434544555245207075626c69632e68616e646c655f757064617465645f61745f67656e6572696328293b0a2020454e442049463b0a454e442024240000038e2d2d205365637572652052504320746f20736574206167656e742063726564656e7469616c732028757073657274290a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e7365745f6167656e745f63726564656e7469616c73280a2020705f696420555549442c0a2020705f757365726e616d6520544558542c0a2020705f70617373776f726420544558542c0a2020705f69735f74656d706f7261727920424f4f4c45414e2044454641554c542066616c73650a290a52455455524e5320564f49440a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a41532024240a4445434c4152450a202068617368656420544558543b0a424547494e0a2020494620705f6964204953204e554c4c204f5220705f757365726e616d65204953204e554c4c204f5220705f70617373776f7264204953204e554c4c205448454e0a20202020524149534520455843455054494f4e2027496e76616c696420706172616d6574657273273b0a2020454e442049463b0a0a20202d2d2048617368207468652070617373776f7264207573696e6720706763727970746f0a2020686173686564203a3d20637279707428705f70617373776f72642c2067656e5f73616c74282762662729293b0a0a20202d2d205570736572742063726564656e7469616c733b2075736572206e616d652073746f72656420696e206c6f7765726361736520666f7220636f6e73697374656e63790a2020494e5345525420494e544f207075626c69632e6167656e745f63726564656e7469616c73286167656e745f69642c20757365726e616d652c2070617373776f72645f686173682c2069735f74656d706f72617279290a202056414c5545532028705f69642c206c6f77657228705f757365726e616d65292c206861736865642c20434f414c4553434528705f69735f74656d706f726172792c2066616c736529290a20204f4e20434f4e464c49435420286167656e745f69642920444f20555044415445205345540a20202020757365726e616d65203d204558434c554445442e757365726e616d652c0a2020202070617373776f72645f68617368203d204558434c554445442e70617373776f72645f686173682c0a2020202069735f74656d706f72617279203d204558434c554445442e69735f74656d706f726172792c0a20202020757064617465645f6174203d204e4f5728293b0a454e443b0a2424000000624752414e542045584543555445204f4e2046554e4354494f4e207075626c69632e7365745f6167656e745f63726564656e7469616c7328555549442c20544558542c20544558542c20424f4f4c45414e2920544f2061757468656e74696361746564000000594752414e542045584543555445204f4e2046554e4354494f4e207075626c69632e7365745f6167656e745f63726564656e7469616c7328555549442c20544558542c20544558542c20424f4f4c45414e2920544f20616e6f6e"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"42710","Message":"extension \"pgcrypto\" already exists, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"extension.c","Line":1791,"Routine":"CreateExtension","UnknownFields":null}
NOTICE (42710): extension "pgcrypto" already exists, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE EXTENSION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251011090000_add_agents_created_by.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add created_by linkage to agents and index for lookups\nALTER TABLE public.agents\n  ADD COLUMN IF NOT EXISTS created_by uuid","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add FK to profiles(id) if not exists\nDO $$\nBEGIN\n  IF NOT EXISTS (\n    SELECT 1\n    FROM pg_constraint c\n    JOIN pg_class t ON c.conrelid = t.oid\n    WHERE t.relname = 'agents'\n      AND c.conname = 'agents_created_by_fkey'\n  ) THEN\n    ALTER TABLE public.agents\n      ADD CONSTRAINT agents_created_by_fkey FOREIGN KEY (created_by)\n      REFERENCES public.profiles(id) ON DELETE SET NULL;\n  END IF;\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Helpful index for queries by creator\nCREATE INDEX IF NOT EXISTS idx_agents_created_by ON public.agents(created_by)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251011090000"},{"text":"add_agents_created_by"},{"binary":"00000001000000000000001900000003000000010000007e2d2d2041646420637265617465645f6279206c696e6b61676520746f206167656e747320616e6420696e64657820666f72206c6f6f6b7570730a414c544552205441424c45207075626c69632e6167656e74730a202041444420434f4c554d4e204946204e4f542045584953545320637265617465645f62792075756964000001992d2d2041646420464b20746f2070726f66696c657328696429206966206e6f74206578697374730a444f2024240a424547494e0a20204946204e4f542045584953545320280a2020202053454c45435420310a2020202046524f4d2070675f636f6e73747261696e7420630a202020204a4f494e2070675f636c6173732074204f4e20632e636f6e72656c6964203d20742e6f69640a20202020574845524520742e72656c6e616d65203d20276167656e7473270a202020202020414e4420632e636f6e6e616d65203d20276167656e74735f637265617465645f62795f666b6579270a202029205448454e0a20202020414c544552205441424c45207075626c69632e6167656e74730a20202020202041444420434f4e53545241494e54206167656e74735f637265617465645f62795f666b657920464f524549474e204b45592028637265617465645f6279290a2020202020205245464552454e434553207075626c69632e70726f66696c657328696429204f4e2044454c45544520534554204e554c4c3b0a2020454e442049463b0a454e44202424000000752d2d2048656c7066756c20696e64657820666f7220717565726965732062792063726561746f720a43524541544520494e444558204946204e4f5420455849535453206964785f6167656e74735f637265617465645f6279204f4e207075626c69632e6167656e747328637265617465645f627929"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251011091000_fix_agent_profile_triggers.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Fix missing agent profile trigger functions and clean up duplicate FK\n\n-- Helper to maintain updated_at (present in repo, included here for safety)\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at := NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create function to handle agent profile insert\nCREATE OR REPLACE FUNCTION handle_agent_profile_insert()\nRETURNS TRIGGER AS $$\nDECLARE\n  v_role TEXT := NEW.role;\nBEGIN\n  -- Only auto-create agent rows for 'agent' profiles\n  IF v_role = 'agent' THEN\n    INSERT INTO public.agents (\n      user_id, name, email, status, country, city, created_at, updated_at\n    ) VALUES (\n      NEW.id, NEW.name, NEW.email, COALESCE(NEW.status, 'active'), NEW.country, NEW.city, NOW(), NOW()\n    )\n    ON CONFLICT (user_id) DO NOTHING;\n  END IF;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create function to handle agent profile update\nCREATE OR REPLACE FUNCTION handle_agent_profile_update()\nRETURNS TRIGGER AS $$\nBEGIN\n  UPDATE public.agents AS a\n  SET\n    name = COALESCE(NEW.name, a.name),\n    email = COALESCE(NEW.email, a.email),\n    status = COALESCE(NEW.status, a.status),\n    country = COALESCE(NEW.country, a.country),\n    city = COALESCE(NEW.city, a.city),\n    updated_at = NOW()\n  WHERE a.user_id = NEW.id;\n\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Wire up triggers on profiles\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM pg_trigger WHERE tgname = 'on_agent_profile_insert'\n  ) THEN\n    EXECUTE 'DROP TRIGGER on_agent_profile_insert ON public.profiles';\n  END IF;\n  EXECUTE 'CREATE TRIGGER on_agent_profile_insert AFTER INSERT ON public.profiles FOR EACH ROW EXECUTE FUNCTION handle_agent_profile_insert()';\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM pg_trigger WHERE tgname = 'on_agent_profile_update'\n  ) THEN\n    EXECUTE 'DROP TRIGGER on_agent_profile_update ON public.profiles';\n  END IF;\n  EXECUTE 'CREATE TRIGGER on_agent_profile_update AFTER UPDATE ON public.profiles FOR EACH ROW EXECUTE FUNCTION handle_agent_profile_update()';\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Ensure updated_at trigger is present\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM pg_trigger WHERE tgname = 'update_profiles_updated_at'\n  ) THEN\n    EXECUTE 'DROP TRIGGER update_profiles_updated_at ON public.profiles';\n  END IF;\n  EXECUTE 'CREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON public.profiles FOR EACH ROW EXECUTE FUNCTION update_updated_at_column()';\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Drop duplicate FK on agents.user_id (keep the ON DELETE CASCADE one)\nALTER TABLE public.agents\nDROP CONSTRAINT IF EXISTS agents_user_id_fkey1","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251011091000"},{"text":"fix_agent_profile_triggers"},{"binary":"00000001000000000000001900000007000000010000012a2d2d20466978206d697373696e67206167656e742070726f66696c6520747269676765722066756e6374696f6e7320616e6420636c65616e207570206475706c696361746520464b0a0a2d2d2048656c70657220746f206d61696e7461696e20757064617465645f6174202870726573656e7420696e207265706f2c20696e636c75646564206865726520666f7220736166657479290a435245415445204f52205245504c4143452046554e4354494f4e207570646174655f757064617465645f61745f636f6c756d6e28290a52455455524e5320545249474745522041532024240a424547494e0a20204e45572e757064617465645f6174203a3d204e4f5728293b0a202052455455524e204e45573b0a454e443b0a2424204c414e475541474520706c706773716c000002482d2d204372656174652066756e6374696f6e20746f2068616e646c65206167656e742070726f66696c6520696e736572740a435245415445204f52205245504c4143452046554e4354494f4e2068616e646c655f6167656e745f70726f66696c655f696e7365727428290a52455455524e5320545249474745522041532024240a4445434c4152450a2020765f726f6c652054455854203a3d204e45572e726f6c653b0a424547494e0a20202d2d204f6e6c79206175746f2d637265617465206167656e7420726f777320666f7220276167656e74272070726f66696c65730a2020494620765f726f6c65203d20276167656e7427205448454e0a20202020494e5345525420494e544f207075626c69632e6167656e747320280a202020202020757365725f69642c206e616d652c20656d61696c2c207374617475732c20636f756e7472792c20636974792c20637265617465645f61742c20757064617465645f61740a20202020292056414c55455320280a2020202020204e45572e69642c204e45572e6e616d652c204e45572e656d61696c2c20434f414c45534345284e45572e7374617475732c202761637469766527292c204e45572e636f756e7472792c204e45572e636974792c204e4f5728292c204e4f5728290a20202020290a202020204f4e20434f4e464c4943542028757365725f69642920444f204e4f5448494e473b0a2020454e442049463b0a202052455455524e204e45573b0a454e443b0a2424204c414e475541474520706c706773716c20534543555249545920444546494e4552000001e92d2d204372656174652066756e6374696f6e20746f2068616e646c65206167656e742070726f66696c65207570646174650a435245415445204f52205245504c4143452046554e4354494f4e2068616e646c655f6167656e745f70726f66696c655f75706461746528290a52455455524e5320545249474745522041532024240a424547494e0a2020555044415445207075626c69632e6167656e747320415320610a20205345540a202020206e616d65203d20434f414c45534345284e45572e6e616d652c20612e6e616d65292c0a20202020656d61696c203d20434f414c45534345284e45572e656d61696c2c20612e656d61696c292c0a20202020737461747573203d20434f414c45534345284e45572e7374617475732c20612e737461747573292c0a20202020636f756e747279203d20434f414c45534345284e45572e636f756e7472792c20612e636f756e747279292c0a2020202063697479203d20434f414c45534345284e45572e636974792c20612e63697479292c0a20202020757064617465645f6174203d204e4f5728290a2020574845524520612e757365725f6964203d204e45572e69643b0a0a202052455455524e204e45573b0a454e443b0a2424204c414e475541474520706c706773716c20534543555249545920444546494e4552000001702d2d2057697265207570207472696767657273206f6e2070726f66696c65730a444f2024240a424547494e0a202049462045584953545320280a2020202053454c45435420312046524f4d2070675f747269676765722057484552452074676e616d65203d20276f6e5f6167656e745f70726f66696c655f696e73657274270a202029205448454e0a2020202045584543555445202744524f502054524947474552206f6e5f6167656e745f70726f66696c655f696e73657274204f4e207075626c69632e70726f66696c6573273b0a2020454e442049463b0a20204558454355544520274352454154452054524947474552206f6e5f6167656e745f70726f66696c655f696e7365727420414654455220494e53455254204f4e207075626c69632e70726f66696c657320464f52204541434820524f5720455845435554452046554e4354494f4e2068616e646c655f6167656e745f70726f66696c655f696e736572742829273b0a454e4420242400000150444f2024240a424547494e0a202049462045584953545320280a2020202053454c45435420312046524f4d2070675f747269676765722057484552452074676e616d65203d20276f6e5f6167656e745f70726f66696c655f757064617465270a202029205448454e0a2020202045584543555445202744524f502054524947474552206f6e5f6167656e745f70726f66696c655f757064617465204f4e207075626c69632e70726f66696c6573273b0a2020454e442049463b0a20204558454355544520274352454154452054524947474552206f6e5f6167656e745f70726f66696c655f75706461746520414654455220555044415445204f4e207075626c69632e70726f66696c657320464f52204541434820524f5720455845435554452046554e4354494f4e2068616e646c655f6167656e745f70726f66696c655f7570646174652829273b0a454e442024240000017f2d2d20456e7375726520757064617465645f617420747269676765722069732070726573656e740a444f2024240a424547494e0a202049462045584953545320280a2020202053454c45435420312046524f4d2070675f747269676765722057484552452074676e616d65203d20277570646174655f70726f66696c65735f757064617465645f6174270a202029205448454e0a2020202045584543555445202744524f502054524947474552207570646174655f70726f66696c65735f757064617465645f6174204f4e207075626c69632e70726f66696c6573273b0a2020454e442049463b0a20204558454355544520274352454154452054524947474552207570646174655f70726f66696c65735f757064617465645f6174204245464f524520555044415445204f4e207075626c69632e70726f66696c657320464f52204541434820524f5720455845435554452046554e4354494f4e207570646174655f757064617465645f61745f636f6c756d6e2829273b0a454e44202424000000902d2d2044726f70206475706c696361746520464b206f6e206167656e74732e757365725f696420286b65657020746865204f4e2044454c4554452043415343414445206f6e65290a414c544552205441424c45207075626c69632e6167656e74730a44524f5020434f4e53545241494e5420494620455849535453206167656e74735f757365725f69645f666b657931"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"constraint \"agents_user_id_fkey1\" of relation \"agents\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"tablecmds.c","Line":12655,"Routine":"ATExecDropConstraint","UnknownFields":null}
NOTICE (00000): constraint "agents_user_id_fkey1" of relation "agents" does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251027010000_add_exec_sql_helper.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Helper RPC to execute arbitrary read-only SQL and return JSON\n-- Intended for admin/service-role usage to audit catalog metadata.\n\nBEGIN","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE OR REPLACE FUNCTION public.exec_sql(sql text)\nRETURNS json\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public, pg_catalog\nAS $$\nDECLARE\n  result json;\nBEGIN\n  -- Wrap the query to return rows as a JSON array\n  EXECUTE format('SELECT coalesce(json_agg(t), ''[]''::json) FROM (%s) t', sql) INTO result;\n  RETURN result;\nEXCEPTION WHEN OTHERS THEN\n  RETURN json_build_object('error', SQLERRM);\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"COMMENT ON FUNCTION public.exec_sql(text) IS 'Admin helper to execute SELECT queries and return JSON results for auditing'","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"COMMIT","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251027010000"},{"text":"add_exec_sql_helper"},{"binary":"00000001000000000000001900000004000000010000008b2d2d2048656c7065722052504320746f20657865637574652061726269747261727920726561642d6f6e6c792053514c20616e642072657475726e204a534f4e0a2d2d20496e74656e64656420666f722061646d696e2f736572766963652d726f6c6520757361676520746f20617564697420636174616c6f67206d657461646174612e0a0a424547494e0000019d435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e657865635f73716c2873716c2074657874290a52455455524e53206a736f6e0a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69632c2070675f636174616c6f670a41532024240a4445434c4152450a2020726573756c74206a736f6e3b0a424547494e0a20202d2d20577261702074686520717565727920746f2072657475726e20726f77732061732061204a534f4e2061727261790a20204558454355544520666f726d6174282753454c45435420636f616c65736365286a736f6e5f6167672874292c2027275b5d27273a3a6a736f6e292046524f4d20282573292074272c2073716c2920494e544f20726573756c743b0a202052455455524e20726573756c743b0a455843455054494f4e205748454e204f5448455253205448454e0a202052455455524e206a736f6e5f6275696c645f6f626a65637428276572726f72272c2053514c4552524d293b0a454e443b0a24240000007a434f4d4d454e54204f4e2046554e4354494f4e207075626c69632e657865635f73716c287465787429204953202741646d696e2068656c70657220746f20657865637574652053454c454354207175657269657320616e642072657475726e204a534f4e20726573756c747320666f72206175646974696e672700000006434f4d4d4954"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"BEGIN"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMENT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMIT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251027011000_add_search_path_for_updated_at_helpers.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Add explicit search_path to updated_at trigger helper functions\n-- and create missing public.update_updated_at_column for consistent usage.\n\nBEGIN","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Ensure public.update_updated_at_column exists and uses explicit search_path\nCREATE OR REPLACE FUNCTION public.update_updated_at_column()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nBEGIN\n  NEW.updated_at := timezone('utc'::text, now());\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Ensure public.handle_updated_at_generic uses explicit search_path\nCREATE OR REPLACE FUNCTION public.handle_updated_at_generic()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nBEGIN\n  NEW.updated_at := timezone('utc'::text, now());\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Provide public.set_timestamp as a compatibility helper\nCREATE OR REPLACE FUNCTION public.set_timestamp()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nBEGIN\n  NEW.updated_at := timezone('utc'::text, now());\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Intentionally avoid creating functions in the \"storage\" schema.\n-- Supabase manages the storage schema via extensions and typical roles\n-- executing migrations may not have CREATE permission there. We rely on\n-- public.update_updated_at_column() and bind triggers to that instead.\n\n-- Ensure sightseeing trigger binds to the public-qualified function\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1\n    FROM pg_trigger t\n    JOIN pg_class c ON c.oid = t.tgrelid\n    JOIN pg_namespace n ON n.oid = c.relnamespace\n    WHERE t.tgname = 'update_sightseeing_updated_at'\n      AND n.nspname = 'public'\n      AND c.relname = 'sightseeing'\n  ) THEN\n    EXECUTE 'DROP TRIGGER update_sightseeing_updated_at ON public.sightseeing';\n  END IF;\n\n  IF EXISTS (\n    SELECT 1 FROM information_schema.routines\n    WHERE routine_schema = 'public'\n      AND routine_name = 'update_updated_at_column'\n  ) THEN\n    EXECUTE 'CREATE TRIGGER update_sightseeing_updated_at BEFORE UPDATE ON public.sightseeing FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column()';\n  END IF;\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"COMMIT","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251027011000"},{"text":"add_search_path_for_updated_at_helpers"},{"binary":"0000000100000000000000190000000600000001000000952d2d20416464206578706c69636974207365617263685f7061746820746f20757064617465645f617420747269676765722068656c7065722066756e6374696f6e730a2d2d20616e6420637265617465206d697373696e67207075626c69632e7570646174655f757064617465645f61745f636f6c756d6e20666f7220636f6e73697374656e742075736167652e0a0a424547494e0000012a2d2d20456e73757265207075626c69632e7570646174655f757064617465645f61745f636f6c756d6e2065786973747320616e642075736573206578706c69636974207365617263685f706174680a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e7570646174655f757064617465645f61745f636f6c756d6e28290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a424547494e0a20204e45572e757064617465645f6174203a3d2074696d657a6f6e652827757463273a3a746578742c206e6f772829293b0a202052455455524e204e45573b0a454e443b0a2424000001212d2d20456e73757265207075626c69632e68616e646c655f757064617465645f61745f67656e657269632075736573206578706c69636974207365617263685f706174680a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f757064617465645f61745f67656e6572696328290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a424547494e0a20204e45572e757064617465645f6174203a3d2074696d657a6f6e652827757463273a3a746578742c206e6f772829293b0a202052455455524e204e45573b0a454e443b0a24240000010a2d2d2050726f76696465207075626c69632e7365745f74696d657374616d70206173206120636f6d7061746962696c6974792068656c7065720a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e7365745f74696d657374616d7028290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a424547494e0a20204e45572e757064617465645f6174203a3d2074696d657a6f6e652827757463273a3a746578742c206e6f772829293b0a202052455455524e204e45573b0a454e443b0a2424000004232d2d20496e74656e74696f6e616c6c792061766f6964206372656174696e672066756e6374696f6e7320696e20746865202273746f726167652220736368656d612e0a2d2d205375706162617365206d616e61676573207468652073746f7261676520736368656d612076696120657874656e73696f6e7320616e64207479706963616c20726f6c65730a2d2d20657865637574696e67206d6967726174696f6e73206d6179206e6f74206861766520435245415445207065726d697373696f6e2074686572652e2057652072656c79206f6e0a2d2d207075626c69632e7570646174655f757064617465645f61745f636f6c756d6e282920616e642062696e6420747269676765727320746f207468617420696e73746561642e0a0a2d2d20456e73757265207369676874736565696e6720747269676765722062696e647320746f20746865207075626c69632d7175616c69666965642066756e6374696f6e0a444f2024240a424547494e0a202049462045584953545320280a2020202053454c45435420310a2020202046524f4d2070675f7472696767657220740a202020204a4f494e2070675f636c6173732063204f4e20632e6f6964203d20742e746772656c69640a202020204a4f494e2070675f6e616d657370616365206e204f4e206e2e6f6964203d20632e72656c6e616d6573706163650a20202020574845524520742e74676e616d65203d20277570646174655f7369676874736565696e675f757064617465645f6174270a202020202020414e44206e2e6e73706e616d65203d20277075626c6963270a202020202020414e4420632e72656c6e616d65203d20277369676874736565696e67270a202029205448454e0a2020202045584543555445202744524f502054524947474552207570646174655f7369676874736565696e675f757064617465645f6174204f4e207075626c69632e7369676874736565696e67273b0a2020454e442049463b0a0a202049462045584953545320280a2020202053454c45435420312046524f4d20696e666f726d6174696f6e5f736368656d612e726f7574696e65730a20202020574845524520726f7574696e655f736368656d61203d20277075626c6963270a202020202020414e4420726f7574696e655f6e616d65203d20277570646174655f757064617465645f61745f636f6c756d6e270a202029205448454e0a202020204558454355544520274352454154452054524947474552207570646174655f7369676874736565696e675f757064617465645f6174204245464f524520555044415445204f4e207075626c69632e7369676874736565696e6720464f52204541434820524f5720455845435554452046554e4354494f4e207075626c69632e7570646174655f757064617465645f61745f636f6c756d6e2829273b0a2020454e442049463b0a454e4420242400000006434f4d4d4954"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"BEGIN"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMIT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251027012000_create_user_profile_data_and_update_trigger.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create a new user_profile_data table and update handle_new_user\n-- to populate it. Agents are created/updated only when role='agent'.\n\n-- 1) New table for capturing signup metadata (avoids touching profiles)\nCREATE TABLE IF NOT EXISTS public.user_profile_data (\n  id uuid PRIMARY KEY,\n  email text NOT NULL,\n  role text,\n  name text,\n  phone text,\n  department text,\n  position text,\n  employee_id text,\n  company_name text,\n  avatar text,\n  profile_image text,\n  preferred_language text,\n  country text,\n  city text,\n  must_change_password boolean DEFAULT false,\n  specializations text[],\n  mobile_numbers text[],\n  documents text[],\n  assigned_staff uuid[],\n  source_type text,\n  source_details text,\n  commission_structure jsonb,\n  created_by uuid,\n  created_by_staff text,\n  created_at timestamptz DEFAULT NOW(),\n  updated_at timestamptz DEFAULT NOW()\n)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE INDEX IF NOT EXISTS idx_user_profile_data_email ON public.user_profile_data(email)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE INDEX IF NOT EXISTS idx_user_profile_data_role ON public.user_profile_data(role)","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- 2) Reset trigger to attach cleanly\nDROP TRIGGER IF EXISTS on_auth_user_created ON auth.users","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- 3) Role-aware function that writes into user_profile_data\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS trigger\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public, auth\nAS $$\nDECLARE\n  -- Common profile-like fields\n  user_name        text := COALESCE(NEW.raw_user_meta_data-\u003e\u003e'name', NEW.raw_user_meta_data-\u003e\u003e'full_name');\n  user_role        text := COALESCE(NEW.raw_user_meta_data-\u003e\u003e'role', 'user');\n  user_phone       text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'phone', '');\n  user_department  text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'department', '');\n  position_title   text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'position', '');\n  employee_id_val  text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'employee_id', '');\n  company_name_val text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'company_name', '');\n  avatar_url       text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'avatar', '');\n  profile_image_url text := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'profile_image', ''), avatar_url);\n  preferred_lang   text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'preferred_language', '');\n  user_country     text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'country', '');\n  user_city        text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'city', '');\n  must_change_pw   boolean := COALESCE((NEW.raw_user_meta_data-\u003e\u003e'must_change_password')::boolean, false);\n  specializations_arr text[] := COALESCE(ARRAY(SELECT jsonb_array_elements_text(NEW.raw_user_meta_data-\u003e'specializations')), NULL);\n  mobile_numbers_arr  text[] := COALESCE(ARRAY(SELECT jsonb_array_elements_text(NEW.raw_user_meta_data-\u003e'mobile_numbers')), NULL);\n  documents_arr       text[] := COALESCE(ARRAY(SELECT jsonb_array_elements_text(NEW.raw_user_meta_data-\u003e'documents')), NULL);\n  assigned_staff_arr  uuid[] := COALESCE(ARRAY(SELECT (jsonb_array_elements_text(NEW.raw_user_meta_data-\u003e'assigned_staff'))::uuid), NULL);\n  source_type_val     text := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'source_type', ''), 'auth');\n  source_details_val  text := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'source_details', ''), 'on_auth_user_created');\n  commission_structure_val jsonb := NEW.raw_user_meta_data-\u003e'commission_structure';\n  created_by_uuid     uuid := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'created_by', '')::uuid;\n  created_by_staff_val text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'created_by_staff', '');\n\n  -- Agent-only fields\n  agency_name      text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'agency_name', '');\n  agency_code      text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'agency_code', '');\n  license_number   text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'license_number', '');\n  iata_number      text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'iata_number', '');\n  business_address text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'business_address', '');\n  business_phone   text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'business_phone', '');\n  business_type    text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'business_type', '');\n  commission_type  text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'commission_type', '');\n  commission_value_num numeric := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'commission_value', '')::numeric;\n  website          text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'website', '');\n  alternate_email  text := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'alternate_email', '');\n  documents_json   jsonb := NEW.raw_user_meta_data-\u003e'documents';\nBEGIN\n  BEGIN\n    -- Write signup metadata into user_profile_data (safe, non-blocking)\n    INSERT INTO public.user_profile_data (\n      id, email, role, name, phone, department, position, employee_id, company_name,\n      avatar, profile_image, preferred_language, country, city, must_change_password,\n      specializations, mobile_numbers, documents, assigned_staff,\n      source_type, source_details, commission_structure,\n      created_by, created_by_staff, created_at, updated_at\n    ) VALUES (\n      NEW.id, NEW.email, user_role, user_name, user_phone, user_department, position_title, employee_id_val, company_name_val,\n      avatar_url, profile_image_url, preferred_lang, user_country, user_city, must_change_pw,\n      specializations_arr, mobile_numbers_arr, documents_arr, assigned_staff_arr,\n      source_type_val, source_details_val, commission_structure_val,\n      created_by_uuid, created_by_staff_val, NOW(), NOW()\n    )\n    ON CONFLICT (id) DO UPDATE SET\n      email = EXCLUDED.email,\n      role = COALESCE(EXCLUDED.role, public.user_profile_data.role),\n      name = COALESCE(EXCLUDED.name, public.user_profile_data.name),\n      phone = COALESCE(EXCLUDED.phone, public.user_profile_data.phone),\n      department = COALESCE(EXCLUDED.department, public.user_profile_data.department),\n      position = COALESCE(EXCLUDED.position, public.user_profile_data.position),\n      employee_id = COALESCE(EXCLUDED.employee_id, public.user_profile_data.employee_id),\n      company_name = COALESCE(EXCLUDED.company_name, public.user_profile_data.company_name),\n      avatar = COALESCE(EXCLUDED.avatar, public.user_profile_data.avatar),\n      profile_image = COALESCE(EXCLUDED.profile_image, public.user_profile_data.profile_image),\n      preferred_language = COALESCE(EXCLUDED.preferred_language, public.user_profile_data.preferred_language),\n      country = COALESCE(EXCLUDED.country, public.user_profile_data.country),\n      city = COALESCE(EXCLUDED.city, public.user_profile_data.city),\n      must_change_password = COALESCE(EXCLUDED.must_change_password, public.user_profile_data.must_change_password),\n      specializations = COALESCE(EXCLUDED.specializations, public.user_profile_data.specializations),\n      mobile_numbers = COALESCE(EXCLUDED.mobile_numbers, public.user_profile_data.mobile_numbers),\n      documents = COALESCE(EXCLUDED.documents, public.user_profile_data.documents),\n      assigned_staff = COALESCE(EXCLUDED.assigned_staff, public.user_profile_data.assigned_staff),\n      source_type = COALESCE(EXCLUDED.source_type, public.user_profile_data.source_type),\n      source_details = COALESCE(EXCLUDED.source_details, public.user_profile_data.source_details),\n      commission_structure = COALESCE(EXCLUDED.commission_structure, public.user_profile_data.commission_structure),\n      created_by = COALESCE(EXCLUDED.created_by, public.user_profile_data.created_by),\n      created_by_staff = COALESCE(EXCLUDED.created_by_staff, public.user_profile_data.created_by_staff),\n      updated_at = NOW();\n\n    -- Create/Update agents only when role='agent'\n    IF user_role = 'agent' THEN\n      IF NOT EXISTS (SELECT 1 FROM public.agents WHERE user_id = NEW.id) THEN\n        INSERT INTO public.agents (\n          user_id, name, email, status, agency_name, agency_code, license_number, iata_number,\n          business_address, business_phone, specializations, commission_structure,\n          country, city, business_type, commission_type, commission_value, profile_image,\n          source_type, source_details, created_by, created_by_staff, website, alternate_email,\n          mobile_numbers, documents, created_at, updated_at\n        ) VALUES (\n          NEW.id, user_name, NEW.email, 'active', agency_name, agency_code, license_number, iata_number,\n          business_address, business_phone, specializations_arr, commission_structure_val,\n          user_country, user_city, business_type, commission_type, commission_value_num, profile_image_url,\n          source_type_val, source_details_val, created_by_uuid, created_by_staff_val, website, alternate_email,\n          mobile_numbers_arr, documents_json, NOW(), NOW()\n        );\n      ELSE\n        UPDATE public.agents AS a SET\n          name = COALESCE(user_name, a.name),\n          email = COALESCE(NEW.email, a.email),\n          status = COALESCE('active', a.status),\n          agency_name = COALESCE(agency_name, a.agency_name),\n          agency_code = COALESCE(agency_code, a.agency_code),\n          license_number = COALESCE(license_number, a.license_number),\n          iata_number = COALESCE(iata_number, a.iata_number),\n          business_address = COALESCE(business_address, a.business_address),\n          business_phone = COALESCE(business_phone, a.business_phone),\n          specializations = COALESCE(specializations_arr, a.specializations),\n          commission_structure = COALESCE(commission_structure_val, a.commission_structure),\n          country = COALESCE(user_country, a.country),\n          city = COALESCE(user_city, a.city),\n          business_type = COALESCE(business_type, a.business_type),\n          commission_type = COALESCE(commission_type, a.commission_type),\n          commission_value = COALESCE(commission_value_num, a.commission_value),\n          profile_image = COALESCE(profile_image_url, a.profile_image),\n          source_type = COALESCE(source_type_val, a.source_type),\n          source_details = COALESCE(source_details_val, a.source_details),\n          created_by = COALESCE(created_by_uuid, a.created_by),\n          created_by_staff = COALESCE(created_by_staff_val, a.created_by_staff),\n          website = COALESCE(website, a.website),\n          alternate_email = COALESCE(alternate_email, a.alternate_email),\n          mobile_numbers = COALESCE(mobile_numbers_arr, a.mobile_numbers),\n          documents = COALESCE(documents_json, a.documents),\n          updated_at = NOW()\n        WHERE a.user_id = NEW.id;\n      END IF;\n    END IF;\n  EXCEPTION WHEN OTHERS THEN\n    -- Do not block signup on downstream issues; log and continue\n    RAISE NOTICE 'handle_new_user error for %: %', NEW.id, SQLERRM;\n  END;\n\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- 4) Reattach trigger to auth.users\nCREATE TRIGGER on_auth_user_created\nAFTER INSERT ON auth.users\nFOR EACH ROW\nEXECUTE FUNCTION public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251027012000"},{"text":"create_user_profile_data_and_update_trigger"},{"binary":"00000001000000000000001900000006000000010000035c2d2d204372656174652061206e657720757365725f70726f66696c655f64617461207461626c6520616e64207570646174652068616e646c655f6e65775f757365720a2d2d20746f20706f70756c6174652069742e204167656e74732061726520637265617465642f75706461746564206f6e6c79207768656e20726f6c653d276167656e74272e0a0a2d2d203129204e6577207461626c6520666f7220636170747572696e67207369676e7570206d65746164617461202861766f69647320746f756368696e672070726f66696c6573290a435245415445205441424c45204946204e4f5420455849535453207075626c69632e757365725f70726f66696c655f6461746120280a202069642075756964205052494d415259204b45592c0a2020656d61696c2074657874204e4f54204e554c4c2c0a2020726f6c6520746578742c0a20206e616d6520746578742c0a202070686f6e6520746578742c0a20206465706172746d656e7420746578742c0a2020706f736974696f6e20746578742c0a2020656d706c6f7965655f696420746578742c0a2020636f6d70616e795f6e616d6520746578742c0a202061766174617220746578742c0a202070726f66696c655f696d61676520746578742c0a20207072656665727265645f6c616e677561676520746578742c0a2020636f756e74727920746578742c0a20206369747920746578742c0a20206d7573745f6368616e67655f70617373776f726420626f6f6c65616e2044454641554c542066616c73652c0a20207370656369616c697a6174696f6e7320746578745b5d2c0a20206d6f62696c655f6e756d6265727320746578745b5d2c0a2020646f63756d656e747320746578745b5d2c0a202061737369676e65645f737461666620757569645b5d2c0a2020736f757263655f7479706520746578742c0a2020736f757263655f64657461696c7320746578742c0a2020636f6d6d697373696f6e5f737472756374757265206a736f6e622c0a2020637265617465645f627920757569642c0a2020637265617465645f62795f737461666620746578742c0a2020637265617465645f61742074696d657374616d70747a2044454641554c54204e4f5728292c0a2020757064617465645f61742074696d657374616d70747a2044454641554c54204e4f5728290a290000005943524541544520494e444558204946204e4f5420455849535453206964785f757365725f70726f66696c655f646174615f656d61696c204f4e207075626c69632e757365725f70726f66696c655f6461746128656d61696c290000005743524541544520494e444558204946204e4f5420455849535453206964785f757365725f70726f66696c655f646174615f726f6c65204f4e207075626c69632e757365725f70726f66696c655f6461746128726f6c65290000005f2d2d203229205265736574207472696767657220746f2061747461636820636c65616e6c790a44524f50205452494747455220494620455849535453206f6e5f617574685f757365725f63726561746564204f4e20617574682e7573657273000024f72d2d20332920526f6c652d61776172652066756e6374696f6e20746861742077726974657320696e746f20757365725f70726f66696c655f646174610a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290a52455455524e5320747269676765720a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69632c20617574680a41532024240a4445434c4152450a20202d2d20436f6d6d6f6e2070726f66696c652d6c696b65206669656c64730a2020757365725f6e616d65202020202020202074657874203a3d20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c204e45572e7261775f757365725f6d6574615f646174612d3e3e2766756c6c5f6e616d6527293b0a2020757365725f726f6c65202020202020202074657874203a3d20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e27726f6c65272c20277573657227293b0a2020757365725f70686f6e652020202020202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2770686f6e65272c202727293b0a2020757365725f6465706172746d656e74202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276465706172746d656e74272c202727293b0a2020706f736974696f6e5f7469746c6520202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27706f736974696f6e272c202727293b0a2020656d706c6f7965655f69645f76616c202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27656d706c6f7965655f6964272c202727293b0a2020636f6d70616e795f6e616d655f76616c2074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f6d70616e795f6e616d65272c202727293b0a20206176617461725f75726c2020202020202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27617661746172272c202727293b0a202070726f66696c655f696d6167655f75726c2074657874203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2770726f66696c655f696d616765272c202727292c206176617461725f75726c293b0a20207072656665727265645f6c616e6720202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e277072656665727265645f6c616e6775616765272c202727293b0a2020757365725f636f756e747279202020202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f756e747279272c202727293b0a2020757365725f63697479202020202020202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2763697479272c202727293b0a20206d7573745f6368616e67655f7077202020626f6f6c65616e203a3d20434f414c4553434528284e45572e7261775f757365725f6d6574615f646174612d3e3e276d7573745f6368616e67655f70617373776f726427293a3a626f6f6c65616e2c2066616c7365293b0a20207370656369616c697a6174696f6e735f61727220746578745b5d203a3d20434f414c455343452841525241592853454c454354206a736f6e625f61727261795f656c656d656e74735f74657874284e45572e7261775f757365725f6d6574615f646174612d3e277370656369616c697a6174696f6e732729292c204e554c4c293b0a20206d6f62696c655f6e756d626572735f6172722020746578745b5d203a3d20434f414c455343452841525241592853454c454354206a736f6e625f61727261795f656c656d656e74735f74657874284e45572e7261775f757365725f6d6574615f646174612d3e276d6f62696c655f6e756d626572732729292c204e554c4c293b0a2020646f63756d656e74735f61727220202020202020746578745b5d203a3d20434f414c455343452841525241592853454c454354206a736f6e625f61727261795f656c656d656e74735f74657874284e45572e7261775f757365725f6d6574615f646174612d3e27646f63756d656e74732729292c204e554c4c293b0a202061737369676e65645f73746166665f6172722020757569645b5d203a3d20434f414c455343452841525241592853454c45435420286a736f6e625f61727261795f656c656d656e74735f74657874284e45572e7261775f757365725f6d6574615f646174612d3e2761737369676e65645f73746166662729293a3a75756964292c204e554c4c293b0a2020736f757263655f747970655f76616c202020202074657874203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27736f757263655f74797065272c202727292c20276175746827293b0a2020736f757263655f64657461696c735f76616c202074657874203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27736f757263655f64657461696c73272c202727292c20276f6e5f617574685f757365725f6372656174656427293b0a2020636f6d6d697373696f6e5f7374727563747572655f76616c206a736f6e62203a3d204e45572e7261775f757365725f6d6574615f646174612d3e27636f6d6d697373696f6e5f737472756374757265273b0a2020637265617465645f62795f75756964202020202075756964203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27637265617465645f6279272c202727293a3a757569643b0a2020637265617465645f62795f73746166665f76616c2074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27637265617465645f62795f7374616666272c202727293b0a0a20202d2d204167656e742d6f6e6c79206669656c64730a20206167656e63795f6e616d6520202020202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276167656e63795f6e616d65272c202727293b0a20206167656e63795f636f646520202020202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276167656e63795f636f6465272c202727293b0a20206c6963656e73655f6e756d62657220202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276c6963656e73655f6e756d626572272c202727293b0a2020696174615f6e756d62657220202020202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27696174615f6e756d626572272c202727293b0a2020627573696e6573735f616464726573732074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27627573696e6573735f61646472657373272c202727293b0a2020627573696e6573735f70686f6e6520202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27627573696e6573735f70686f6e65272c202727293b0a2020627573696e6573735f747970652020202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27627573696e6573735f74797065272c202727293b0a2020636f6d6d697373696f6e5f74797065202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f6d6d697373696f6e5f74797065272c202727293b0a2020636f6d6d697373696f6e5f76616c75655f6e756d206e756d65726963203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f6d6d697373696f6e5f76616c7565272c202727293a3a6e756d657269633b0a2020776562736974652020202020202020202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2777656273697465272c202727293b0a2020616c7465726e6174655f656d61696c202074657874203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27616c7465726e6174655f656d61696c272c202727293b0a2020646f63756d656e74735f6a736f6e2020206a736f6e62203a3d204e45572e7261775f757365725f6d6574615f646174612d3e27646f63756d656e7473273b0a424547494e0a2020424547494e0a202020202d2d205772697465207369676e7570206d6574616461746120696e746f20757365725f70726f66696c655f646174612028736166652c206e6f6e2d626c6f636b696e67290a20202020494e5345525420494e544f207075626c69632e757365725f70726f66696c655f6461746120280a20202020202069642c20656d61696c2c20726f6c652c206e616d652c2070686f6e652c206465706172746d656e742c20706f736974696f6e2c20656d706c6f7965655f69642c20636f6d70616e795f6e616d652c0a2020202020206176617461722c2070726f66696c655f696d6167652c207072656665727265645f6c616e67756167652c20636f756e7472792c20636974792c206d7573745f6368616e67655f70617373776f72642c0a2020202020207370656369616c697a6174696f6e732c206d6f62696c655f6e756d626572732c20646f63756d656e74732c2061737369676e65645f73746166662c0a202020202020736f757263655f747970652c20736f757263655f64657461696c732c20636f6d6d697373696f6e5f7374727563747572652c0a202020202020637265617465645f62792c20637265617465645f62795f73746166662c20637265617465645f61742c20757064617465645f61740a20202020292056414c55455320280a2020202020204e45572e69642c204e45572e656d61696c2c20757365725f726f6c652c20757365725f6e616d652c20757365725f70686f6e652c20757365725f6465706172746d656e742c20706f736974696f6e5f7469746c652c20656d706c6f7965655f69645f76616c2c20636f6d70616e795f6e616d655f76616c2c0a2020202020206176617461725f75726c2c2070726f66696c655f696d6167655f75726c2c207072656665727265645f6c616e672c20757365725f636f756e7472792c20757365725f636974792c206d7573745f6368616e67655f70772c0a2020202020207370656369616c697a6174696f6e735f6172722c206d6f62696c655f6e756d626572735f6172722c20646f63756d656e74735f6172722c2061737369676e65645f73746166665f6172722c0a202020202020736f757263655f747970655f76616c2c20736f757263655f64657461696c735f76616c2c20636f6d6d697373696f6e5f7374727563747572655f76616c2c0a202020202020637265617465645f62795f757569642c20637265617465645f62795f73746166665f76616c2c204e4f5728292c204e4f5728290a20202020290a202020204f4e20434f4e464c494354202869642920444f20555044415445205345540a202020202020656d61696c203d204558434c554445442e656d61696c2c0a202020202020726f6c65203d20434f414c45534345284558434c554445442e726f6c652c207075626c69632e757365725f70726f66696c655f646174612e726f6c65292c0a2020202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c207075626c69632e757365725f70726f66696c655f646174612e6e616d65292c0a20202020202070686f6e65203d20434f414c45534345284558434c554445442e70686f6e652c207075626c69632e757365725f70726f66696c655f646174612e70686f6e65292c0a2020202020206465706172746d656e74203d20434f414c45534345284558434c554445442e6465706172746d656e742c207075626c69632e757365725f70726f66696c655f646174612e6465706172746d656e74292c0a202020202020706f736974696f6e203d20434f414c45534345284558434c554445442e706f736974696f6e2c207075626c69632e757365725f70726f66696c655f646174612e706f736974696f6e292c0a202020202020656d706c6f7965655f6964203d20434f414c45534345284558434c554445442e656d706c6f7965655f69642c207075626c69632e757365725f70726f66696c655f646174612e656d706c6f7965655f6964292c0a202020202020636f6d70616e795f6e616d65203d20434f414c45534345284558434c554445442e636f6d70616e795f6e616d652c207075626c69632e757365725f70726f66696c655f646174612e636f6d70616e795f6e616d65292c0a202020202020617661746172203d20434f414c45534345284558434c554445442e6176617461722c207075626c69632e757365725f70726f66696c655f646174612e617661746172292c0a20202020202070726f66696c655f696d616765203d20434f414c45534345284558434c554445442e70726f66696c655f696d6167652c207075626c69632e757365725f70726f66696c655f646174612e70726f66696c655f696d616765292c0a2020202020207072656665727265645f6c616e6775616765203d20434f414c45534345284558434c554445442e7072656665727265645f6c616e67756167652c207075626c69632e757365725f70726f66696c655f646174612e7072656665727265645f6c616e6775616765292c0a202020202020636f756e747279203d20434f414c45534345284558434c554445442e636f756e7472792c207075626c69632e757365725f70726f66696c655f646174612e636f756e747279292c0a20202020202063697479203d20434f414c45534345284558434c554445442e636974792c207075626c69632e757365725f70726f66696c655f646174612e63697479292c0a2020202020206d7573745f6368616e67655f70617373776f7264203d20434f414c45534345284558434c554445442e6d7573745f6368616e67655f70617373776f72642c207075626c69632e757365725f70726f66696c655f646174612e6d7573745f6368616e67655f70617373776f7264292c0a2020202020207370656369616c697a6174696f6e73203d20434f414c45534345284558434c554445442e7370656369616c697a6174696f6e732c207075626c69632e757365725f70726f66696c655f646174612e7370656369616c697a6174696f6e73292c0a2020202020206d6f62696c655f6e756d62657273203d20434f414c45534345284558434c554445442e6d6f62696c655f6e756d626572732c207075626c69632e757365725f70726f66696c655f646174612e6d6f62696c655f6e756d62657273292c0a202020202020646f63756d656e7473203d20434f414c45534345284558434c554445442e646f63756d656e74732c207075626c69632e757365725f70726f66696c655f646174612e646f63756d656e7473292c0a20202020202061737369676e65645f7374616666203d20434f414c45534345284558434c554445442e61737369676e65645f73746166662c207075626c69632e757365725f70726f66696c655f646174612e61737369676e65645f7374616666292c0a202020202020736f757263655f74797065203d20434f414c45534345284558434c554445442e736f757263655f747970652c207075626c69632e757365725f70726f66696c655f646174612e736f757263655f74797065292c0a202020202020736f757263655f64657461696c73203d20434f414c45534345284558434c554445442e736f757263655f64657461696c732c207075626c69632e757365725f70726f66696c655f646174612e736f757263655f64657461696c73292c0a202020202020636f6d6d697373696f6e5f737472756374757265203d20434f414c45534345284558434c554445442e636f6d6d697373696f6e5f7374727563747572652c207075626c69632e757365725f70726f66696c655f646174612e636f6d6d697373696f6e5f737472756374757265292c0a202020202020637265617465645f6279203d20434f414c45534345284558434c554445442e637265617465645f62792c207075626c69632e757365725f70726f66696c655f646174612e637265617465645f6279292c0a202020202020637265617465645f62795f7374616666203d20434f414c45534345284558434c554445442e637265617465645f62795f73746166662c207075626c69632e757365725f70726f66696c655f646174612e637265617465645f62795f7374616666292c0a202020202020757064617465645f6174203d204e4f5728293b0a0a202020202d2d204372656174652f557064617465206167656e7473206f6e6c79207768656e20726f6c653d276167656e74270a20202020494620757365725f726f6c65203d20276167656e7427205448454e0a2020202020204946204e4f5420455849535453202853454c45435420312046524f4d207075626c69632e6167656e747320574845524520757365725f6964203d204e45572e696429205448454e0a2020202020202020494e5345525420494e544f207075626c69632e6167656e747320280a20202020202020202020757365725f69642c206e616d652c20656d61696c2c207374617475732c206167656e63795f6e616d652c206167656e63795f636f64652c206c6963656e73655f6e756d6265722c20696174615f6e756d6265722c0a20202020202020202020627573696e6573735f616464726573732c20627573696e6573735f70686f6e652c207370656369616c697a6174696f6e732c20636f6d6d697373696f6e5f7374727563747572652c0a20202020202020202020636f756e7472792c20636974792c20627573696e6573735f747970652c20636f6d6d697373696f6e5f747970652c20636f6d6d697373696f6e5f76616c75652c2070726f66696c655f696d6167652c0a20202020202020202020736f757263655f747970652c20736f757263655f64657461696c732c20637265617465645f62792c20637265617465645f62795f73746166662c20776562736974652c20616c7465726e6174655f656d61696c2c0a202020202020202020206d6f62696c655f6e756d626572732c20646f63756d656e74732c20637265617465645f61742c20757064617465645f61740a2020202020202020292056414c55455320280a202020202020202020204e45572e69642c20757365725f6e616d652c204e45572e656d61696c2c2027616374697665272c206167656e63795f6e616d652c206167656e63795f636f64652c206c6963656e73655f6e756d6265722c20696174615f6e756d6265722c0a20202020202020202020627573696e6573735f616464726573732c20627573696e6573735f70686f6e652c207370656369616c697a6174696f6e735f6172722c20636f6d6d697373696f6e5f7374727563747572655f76616c2c0a20202020202020202020757365725f636f756e7472792c20757365725f636974792c20627573696e6573735f747970652c20636f6d6d697373696f6e5f747970652c20636f6d6d697373696f6e5f76616c75655f6e756d2c2070726f66696c655f696d6167655f75726c2c0a20202020202020202020736f757263655f747970655f76616c2c20736f757263655f64657461696c735f76616c2c20637265617465645f62795f757569642c20637265617465645f62795f73746166665f76616c2c20776562736974652c20616c7465726e6174655f656d61696c2c0a202020202020202020206d6f62696c655f6e756d626572735f6172722c20646f63756d656e74735f6a736f6e2c204e4f5728292c204e4f5728290a2020202020202020293b0a202020202020454c53450a2020202020202020555044415445207075626c69632e6167656e74732041532061205345540a202020202020202020206e616d65203d20434f414c4553434528757365725f6e616d652c20612e6e616d65292c0a20202020202020202020656d61696c203d20434f414c45534345284e45572e656d61696c2c20612e656d61696c292c0a20202020202020202020737461747573203d20434f414c455343452827616374697665272c20612e737461747573292c0a202020202020202020206167656e63795f6e616d65203d20434f414c45534345286167656e63795f6e616d652c20612e6167656e63795f6e616d65292c0a202020202020202020206167656e63795f636f6465203d20434f414c45534345286167656e63795f636f64652c20612e6167656e63795f636f6465292c0a202020202020202020206c6963656e73655f6e756d626572203d20434f414c45534345286c6963656e73655f6e756d6265722c20612e6c6963656e73655f6e756d626572292c0a20202020202020202020696174615f6e756d626572203d20434f414c4553434528696174615f6e756d6265722c20612e696174615f6e756d626572292c0a20202020202020202020627573696e6573735f61646472657373203d20434f414c4553434528627573696e6573735f616464726573732c20612e627573696e6573735f61646472657373292c0a20202020202020202020627573696e6573735f70686f6e65203d20434f414c4553434528627573696e6573735f70686f6e652c20612e627573696e6573735f70686f6e65292c0a202020202020202020207370656369616c697a6174696f6e73203d20434f414c45534345287370656369616c697a6174696f6e735f6172722c20612e7370656369616c697a6174696f6e73292c0a20202020202020202020636f6d6d697373696f6e5f737472756374757265203d20434f414c4553434528636f6d6d697373696f6e5f7374727563747572655f76616c2c20612e636f6d6d697373696f6e5f737472756374757265292c0a20202020202020202020636f756e747279203d20434f414c4553434528757365725f636f756e7472792c20612e636f756e747279292c0a2020202020202020202063697479203d20434f414c4553434528757365725f636974792c20612e63697479292c0a20202020202020202020627573696e6573735f74797065203d20434f414c4553434528627573696e6573735f747970652c20612e627573696e6573735f74797065292c0a20202020202020202020636f6d6d697373696f6e5f74797065203d20434f414c4553434528636f6d6d697373696f6e5f747970652c20612e636f6d6d697373696f6e5f74797065292c0a20202020202020202020636f6d6d697373696f6e5f76616c7565203d20434f414c4553434528636f6d6d697373696f6e5f76616c75655f6e756d2c20612e636f6d6d697373696f6e5f76616c7565292c0a2020202020202020202070726f66696c655f696d616765203d20434f414c455343452870726f66696c655f696d6167655f75726c2c20612e70726f66696c655f696d616765292c0a20202020202020202020736f757263655f74797065203d20434f414c4553434528736f757263655f747970655f76616c2c20612e736f757263655f74797065292c0a20202020202020202020736f757263655f64657461696c73203d20434f414c4553434528736f757263655f64657461696c735f76616c2c20612e736f757263655f64657461696c73292c0a20202020202020202020637265617465645f6279203d20434f414c4553434528637265617465645f62795f757569642c20612e637265617465645f6279292c0a20202020202020202020637265617465645f62795f7374616666203d20434f414c4553434528637265617465645f62795f73746166665f76616c2c20612e637265617465645f62795f7374616666292c0a2020202020202020202077656273697465203d20434f414c4553434528776562736974652c20612e77656273697465292c0a20202020202020202020616c7465726e6174655f656d61696c203d20434f414c4553434528616c7465726e6174655f656d61696c2c20612e616c7465726e6174655f656d61696c292c0a202020202020202020206d6f62696c655f6e756d62657273203d20434f414c45534345286d6f62696c655f6e756d626572735f6172722c20612e6d6f62696c655f6e756d62657273292c0a20202020202020202020646f63756d656e7473203d20434f414c4553434528646f63756d656e74735f6a736f6e2c20612e646f63756d656e7473292c0a20202020202020202020757064617465645f6174203d204e4f5728290a2020202020202020574845524520612e757365725f6964203d204e45572e69643b0a202020202020454e442049463b0a20202020454e442049463b0a2020455843455054494f4e205748454e204f5448455253205448454e0a202020202d2d20446f206e6f7420626c6f636b207369676e7570206f6e20646f776e73747265616d206973737565733b206c6f6720616e6420636f6e74696e75650a202020205241495345204e4f54494345202768616e646c655f6e65775f75736572206572726f7220666f7220253a2025272c204e45572e69642c2053514c4552524d3b0a2020454e443b0a0a202052455455524e204e45573b0a454e443b0a24240000009a2d2d203429205265617474616368207472696767657220746f20617574682e75736572730a4352454154452054524947474552206f6e5f617574685f757365725f637265617465640a414654455220494e53455254204f4e20617574682e75736572730a464f52204541434820524f570a455845435554452046554e4354494f4e207075626c69632e68616e646c655f6e65775f757365722829"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TABLE"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE INDEX"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251027013000_fix_agent_details_mapping.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Align agent details mapping from auth metadata and profiles\n-- - Expands handle_new_user to populate agents.agency_name, business_phone, city, country\n-- - Ensures profileâ†’agent triggers also sync company_nameâ†’agency_name and phoneâ†’business_phone\n-- - Keeps SECURITY DEFINER to bypass RLS safely\n\nBEGIN","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- 1) Update handle_new_user to upsert profiles and insert richer agent details\nDROP FUNCTION IF EXISTS public.handle_new_user() CASCADE","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  user_name TEXT;\n  user_role TEXT;\n  user_phone TEXT;\n  user_department TEXT;\n  user_position TEXT;\n  user_employee_id TEXT;\n  user_company_name TEXT;\n  user_city TEXT;\n  user_country TEXT;\nBEGIN\n  -- Extract metadata with sensible fallbacks\n  user_name := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'name', ''), split_part(NEW.email, '@', 1));\n  user_role := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'role', ''), 'agent');\n  user_phone := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'phone', '');\n  user_department := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'department', '');\n  user_position := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'position', '');\n  user_employee_id := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'employee_id', '');\n  user_company_name := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'company_name', '');\n  user_city := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'city', '');\n  user_country := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'country', '');\n\n  -- Upsert profile with extended fields when available\n  INSERT INTO public.profiles (\n    id, email, name, role, phone, department, position, employee_id,\n    company_name, city, country, created_at, updated_at\n  ) VALUES (\n    NEW.id, NEW.email, user_name, user_role, user_phone, user_department, user_position, user_employee_id,\n    user_company_name, user_city, user_country, NOW(), NOW()\n  )\n  ON CONFLICT (id) DO UPDATE SET\n    email = EXCLUDED.email,\n    name = COALESCE(EXCLUDED.name, profiles.name),\n    role = COALESCE(EXCLUDED.role, profiles.role),\n    phone = COALESCE(EXCLUDED.phone, profiles.phone),\n    department = COALESCE(EXCLUDED.department, profiles.department),\n    position = COALESCE(EXCLUDED.position, profiles.position),\n    employee_id = COALESCE(EXCLUDED.employee_id, profiles.employee_id),\n    company_name = COALESCE(EXCLUDED.company_name, profiles.company_name),\n    city = COALESCE(EXCLUDED.city, profiles.city),\n    country = COALESCE(EXCLUDED.country, profiles.country),\n    updated_at = NOW();\n\n  -- Create/Update agent row only for agent role, with richer details\n  IF user_role = 'agent' THEN\n    INSERT INTO public.agents (\n      id, user_id, name, email, agency_name, business_phone, city, country, status, created_at, updated_at\n    ) VALUES (\n      NEW.id, NEW.id, user_name, NEW.email, user_company_name, user_phone, user_city, user_country, 'inactive', NOW(), NOW()\n    )\n    ON CONFLICT (user_id) DO UPDATE SET\n      name = COALESCE(EXCLUDED.name, public.agents.name),\n      email = COALESCE(EXCLUDED.email, public.agents.email),\n      agency_name = COALESCE(EXCLUDED.agency_name, public.agents.agency_name),\n      business_phone = COALESCE(EXCLUDED.business_phone, public.agents.business_phone),\n      city = COALESCE(EXCLUDED.city, public.agents.city),\n      country = COALESCE(EXCLUDED.country, public.agents.country),\n      -- keep existing status; do not override with 'inactive'\n      updated_at = NOW();\n  END IF;\n\n  RETURN NEW;\nEXCEPTION\n  WHEN OTHERS THEN\n    RAISE WARNING 'Error in handle_new_user: %', SQLERRM;\n    RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Re-attach the trigger to auth.users (idempotent)\nDROP TRIGGER IF EXISTS on_auth_user_created ON auth.users","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW\n  EXECUTE FUNCTION public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- 2) Enhance role-aware profileâ†’agent insert to include agency_name and phone\nCREATE OR REPLACE FUNCTION public.handle_agent_profile_insert()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nBEGIN\n  IF NEW.role = 'agent' THEN\n    INSERT INTO public.agents (\n      id, user_id, name, email, agency_name, business_phone, status, country, city, created_at, updated_at\n    ) VALUES (\n      NEW.id, NEW.id, NEW.name, NEW.email, NULLIF(NEW.company_name, ''), NULLIF(NEW.phone, ''), COALESCE(NEW.status, 'active'), NEW.country, NEW.city, NOW(), NOW()\n    )\n    ON CONFLICT (user_id) DO UPDATE SET\n      name = COALESCE(EXCLUDED.name, public.agents.name),\n      email = COALESCE(EXCLUDED.email, public.agents.email),\n      agency_name = COALESCE(EXCLUDED.agency_name, public.agents.agency_name),\n      business_phone = COALESCE(EXCLUDED.business_phone, public.agents.business_phone),\n      country = COALESCE(EXCLUDED.country, public.agents.country),\n      city = COALESCE(EXCLUDED.city, public.agents.city),\n      updated_at = NOW();\n  END IF;\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- 3) Enhance profileâ†’agent update mapping for company_name and phone\nCREATE OR REPLACE FUNCTION public.handle_agent_profile_update()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nBEGIN\n  UPDATE public.agents AS a\n  SET\n    name = COALESCE(NEW.name, a.name),\n    email = COALESCE(NEW.email, a.email),\n    agency_name = COALESCE(NULLIF(NEW.company_name, ''), a.agency_name),\n    business_phone = COALESCE(NULLIF(NEW.phone, ''), a.business_phone),\n    country = COALESCE(NEW.country, a.country),\n    city = COALESCE(NEW.city, a.city),\n    updated_at = NOW()\n  WHERE a.user_id = NEW.id;\n\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"COMMIT","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251027013000"},{"text":"fix_agent_details_mapping"},{"binary":"0000000100000000000000190000000800000001000001372d2d20416c69676e206167656e742064657461696c73206d617070696e672066726f6d2061757468206d6574616461746120616e642070726f66696c65730a2d2d202d20457870616e64732068616e646c655f6e65775f7573657220746f20706f70756c617465206167656e74732e6167656e63795f6e616d652c20627573696e6573735f70686f6e652c20636974792c20636f756e7472790a2d2d202d20456e73757265732070726f66696c65e286926167656e7420747269676765727320616c736f2073796e6320636f6d70616e795f6e616d65e286926167656e63795f6e616d6520616e642070686f6e65e28692627573696e6573735f70686f6e650a2d2d202d204b6565707320534543555249545920444546494e455220746f2062797061737320524c5320736166656c790a0a424547494e000000882d2d203129205570646174652068616e646c655f6e65775f7573657220746f207570736572742070726f66696c657320616e6420696e7365727420726963686572206167656e742064657461696c730a44524f502046554e4354494f4e20494620455849535453207075626c69632e68616e646c655f6e65775f757365722829204341534341444500000c3d435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a4445434c4152450a2020757365725f6e616d6520544558543b0a2020757365725f726f6c6520544558543b0a2020757365725f70686f6e6520544558543b0a2020757365725f6465706172746d656e7420544558543b0a2020757365725f706f736974696f6e20544558543b0a2020757365725f656d706c6f7965655f696420544558543b0a2020757365725f636f6d70616e795f6e616d6520544558543b0a2020757365725f6369747920544558543b0a2020757365725f636f756e74727920544558543b0a424547494e0a20202d2d2045787472616374206d6574616461746120776974682073656e7369626c652066616c6c6261636b730a2020757365725f6e616d65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c202727292c2073706c69745f70617274284e45572e656d61696c2c202740272c203129293b0a2020757365725f726f6c65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27726f6c65272c202727292c20276167656e7427293b0a2020757365725f70686f6e65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2770686f6e65272c202727293b0a2020757365725f6465706172746d656e74203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276465706172746d656e74272c202727293b0a2020757365725f706f736974696f6e203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27706f736974696f6e272c202727293b0a2020757365725f656d706c6f7965655f6964203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27656d706c6f7965655f6964272c202727293b0a2020757365725f636f6d70616e795f6e616d65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f6d70616e795f6e616d65272c202727293b0a2020757365725f63697479203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2763697479272c202727293b0a2020757365725f636f756e747279203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f756e747279272c202727293b0a0a20202d2d205570736572742070726f66696c65207769746820657874656e646564206669656c6473207768656e20617661696c61626c650a2020494e5345525420494e544f207075626c69632e70726f66696c657320280a2020202069642c20656d61696c2c206e616d652c20726f6c652c2070686f6e652c206465706172746d656e742c20706f736974696f6e2c20656d706c6f7965655f69642c0a20202020636f6d70616e795f6e616d652c20636974792c20636f756e7472792c20637265617465645f61742c20757064617465645f61740a2020292056414c55455320280a202020204e45572e69642c204e45572e656d61696c2c20757365725f6e616d652c20757365725f726f6c652c20757365725f70686f6e652c20757365725f6465706172746d656e742c20757365725f706f736974696f6e2c20757365725f656d706c6f7965655f69642c0a20202020757365725f636f6d70616e795f6e616d652c20757365725f636974792c20757365725f636f756e7472792c204e4f5728292c204e4f5728290a2020290a20204f4e20434f4e464c494354202869642920444f20555044415445205345540a20202020656d61696c203d204558434c554445442e656d61696c2c0a202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c2070726f66696c65732e6e616d65292c0a20202020726f6c65203d20434f414c45534345284558434c554445442e726f6c652c2070726f66696c65732e726f6c65292c0a2020202070686f6e65203d20434f414c45534345284558434c554445442e70686f6e652c2070726f66696c65732e70686f6e65292c0a202020206465706172746d656e74203d20434f414c45534345284558434c554445442e6465706172746d656e742c2070726f66696c65732e6465706172746d656e74292c0a20202020706f736974696f6e203d20434f414c45534345284558434c554445442e706f736974696f6e2c2070726f66696c65732e706f736974696f6e292c0a20202020656d706c6f7965655f6964203d20434f414c45534345284558434c554445442e656d706c6f7965655f69642c2070726f66696c65732e656d706c6f7965655f6964292c0a20202020636f6d70616e795f6e616d65203d20434f414c45534345284558434c554445442e636f6d70616e795f6e616d652c2070726f66696c65732e636f6d70616e795f6e616d65292c0a2020202063697479203d20434f414c45534345284558434c554445442e636974792c2070726f66696c65732e63697479292c0a20202020636f756e747279203d20434f414c45534345284558434c554445442e636f756e7472792c2070726f66696c65732e636f756e747279292c0a20202020757064617465645f6174203d204e4f5728293b0a0a20202d2d204372656174652f557064617465206167656e7420726f77206f6e6c7920666f72206167656e7420726f6c652c2077697468207269636865722064657461696c730a2020494620757365725f726f6c65203d20276167656e7427205448454e0a20202020494e5345525420494e544f207075626c69632e6167656e747320280a20202020202069642c20757365725f69642c206e616d652c20656d61696c2c206167656e63795f6e616d652c20627573696e6573735f70686f6e652c20636974792c20636f756e7472792c207374617475732c20637265617465645f61742c20757064617465645f61740a20202020292056414c55455320280a2020202020204e45572e69642c204e45572e69642c20757365725f6e616d652c204e45572e656d61696c2c20757365725f636f6d70616e795f6e616d652c20757365725f70686f6e652c20757365725f636974792c20757365725f636f756e7472792c2027696e616374697665272c204e4f5728292c204e4f5728290a20202020290a202020204f4e20434f4e464c4943542028757365725f69642920444f20555044415445205345540a2020202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c207075626c69632e6167656e74732e6e616d65292c0a202020202020656d61696c203d20434f414c45534345284558434c554445442e656d61696c2c207075626c69632e6167656e74732e656d61696c292c0a2020202020206167656e63795f6e616d65203d20434f414c45534345284558434c554445442e6167656e63795f6e616d652c207075626c69632e6167656e74732e6167656e63795f6e616d65292c0a202020202020627573696e6573735f70686f6e65203d20434f414c45534345284558434c554445442e627573696e6573735f70686f6e652c207075626c69632e6167656e74732e627573696e6573735f70686f6e65292c0a20202020202063697479203d20434f414c45534345284558434c554445442e636974792c207075626c69632e6167656e74732e63697479292c0a202020202020636f756e747279203d20434f414c45534345284558434c554445442e636f756e7472792c207075626c69632e6167656e74732e636f756e747279292c0a2020202020202d2d206b656570206578697374696e67207374617475733b20646f206e6f74206f7665727269646520776974682027696e616374697665270a202020202020757064617465645f6174203d204e4f5728293b0a2020454e442049463b0a0a202052455455524e204e45573b0a455843455054494f4e0a20205748454e204f5448455253205448454e0a202020205241495345205741524e494e4720274572726f7220696e2068616e646c655f6e65775f757365723a2025272c2053514c4552524d3b0a2020202052455455524e204e45573b0a454e443b0a24240000006d2d2d2052652d61747461636820746865207472696767657220746f20617574682e757365727320286964656d706f74656e74290a44524f50205452494747455220494620455849535453206f6e5f617574685f757365725f63726561746564204f4e20617574682e75736572730000007b4352454154452054524947474552206f6e5f617574685f757365725f637265617465640a2020414654455220494e53455254204f4e20617574682e75736572730a2020464f52204541434820524f570a2020455845435554452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290000042c2d2d20322920456e68616e636520726f6c652d61776172652070726f66696c65e286926167656e7420696e7365727420746f20696e636c756465206167656e63795f6e616d6520616e642070686f6e650a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6167656e745f70726f66696c655f696e7365727428290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a41532024240a424547494e0a20204946204e45572e726f6c65203d20276167656e7427205448454e0a20202020494e5345525420494e544f207075626c69632e6167656e747320280a20202020202069642c20757365725f69642c206e616d652c20656d61696c2c206167656e63795f6e616d652c20627573696e6573735f70686f6e652c207374617475732c20636f756e7472792c20636974792c20637265617465645f61742c20757064617465645f61740a20202020292056414c55455320280a2020202020204e45572e69642c204e45572e69642c204e45572e6e616d652c204e45572e656d61696c2c204e554c4c4946284e45572e636f6d70616e795f6e616d652c202727292c204e554c4c4946284e45572e70686f6e652c202727292c20434f414c45534345284e45572e7374617475732c202761637469766527292c204e45572e636f756e7472792c204e45572e636974792c204e4f5728292c204e4f5728290a20202020290a202020204f4e20434f4e464c4943542028757365725f69642920444f20555044415445205345540a2020202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c207075626c69632e6167656e74732e6e616d65292c0a202020202020656d61696c203d20434f414c45534345284558434c554445442e656d61696c2c207075626c69632e6167656e74732e656d61696c292c0a2020202020206167656e63795f6e616d65203d20434f414c45534345284558434c554445442e6167656e63795f6e616d652c207075626c69632e6167656e74732e6167656e63795f6e616d65292c0a202020202020627573696e6573735f70686f6e65203d20434f414c45534345284558434c554445442e627573696e6573735f70686f6e652c207075626c69632e6167656e74732e627573696e6573735f70686f6e65292c0a202020202020636f756e747279203d20434f414c45534345284558434c554445442e636f756e7472792c207075626c69632e6167656e74732e636f756e747279292c0a20202020202063697479203d20434f414c45534345284558434c554445442e636974792c207075626c69632e6167656e74732e63697479292c0a202020202020757064617465645f6174203d204e4f5728293b0a2020454e442049463b0a202052455455524e204e45573b0a454e443b0a24240000026a2d2d20332920456e68616e63652070726f66696c65e286926167656e7420757064617465206d617070696e6720666f7220636f6d70616e795f6e616d6520616e642070686f6e650a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6167656e745f70726f66696c655f75706461746528290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a41532024240a424547494e0a2020555044415445207075626c69632e6167656e747320415320610a20205345540a202020206e616d65203d20434f414c45534345284e45572e6e616d652c20612e6e616d65292c0a20202020656d61696c203d20434f414c45534345284e45572e656d61696c2c20612e656d61696c292c0a202020206167656e63795f6e616d65203d20434f414c45534345284e554c4c4946284e45572e636f6d70616e795f6e616d652c202727292c20612e6167656e63795f6e616d65292c0a20202020627573696e6573735f70686f6e65203d20434f414c45534345284e554c4c4946284e45572e70686f6e652c202727292c20612e627573696e6573735f70686f6e65292c0a20202020636f756e747279203d20434f414c45534345284e45572e636f756e7472792c20612e636f756e747279292c0a2020202063697479203d20434f414c45534345284e45572e636974792c20612e63697479292c0a20202020757064617465645f6174203d204e4f5728290a2020574845524520612e757365725f6964203d204e45572e69643b0a0a202052455455524e204e45573b0a454e443b0a242400000006434f4d4d4954"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"BEGIN"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"drop cascades to trigger on_auth_user_created on table auth.users","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dependency.c","Line":1176,"Routine":"reportDependentObjects","UnknownFields":null}
NOTICE (00000): drop cascades to trigger on_auth_user_created on table auth.users
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"trigger \"on_auth_user_created\" for relation \"auth.users\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
NOTICE (00000): trigger "on_auth_user_created" for relation "auth.users" does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMIT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251027014000_fix_agent_role_triggers.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Ensure only 'agent' profiles create rows in public.agents\n-- Drop legacy unguarded triggers and clean up existing non-agent rows\n\nBEGIN","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- 1) Drop legacy triggers that sync agents without role checks\nDO $$\nBEGIN\n  IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'on_profile_insert_sync_agent') THEN\n    EXECUTE 'DROP TRIGGER on_profile_insert_sync_agent ON public.profiles';\n  END IF;\n  IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'on_profile_update_sync_agent') THEN\n    EXECUTE 'DROP TRIGGER on_profile_update_sync_agent ON public.profiles';\n  END IF;\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- 2) Role-aware agent sync functions (idempotent)\nCREATE OR REPLACE FUNCTION public.handle_agent_profile_insert()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nBEGIN\n  IF NEW.role = 'agent' THEN\n    INSERT INTO public.agents (\n      user_id, name, email, status, country, city, created_at, updated_at\n    ) VALUES (\n      NEW.id, NEW.name, NEW.email, COALESCE(NEW.status, 'active'), NEW.country, NEW.city, NOW(), NOW()\n    )\n    ON CONFLICT (user_id) DO NOTHING;\n  END IF;\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE OR REPLACE FUNCTION public.handle_agent_profile_update()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nBEGIN\n  UPDATE public.agents AS a\n  SET\n    name = COALESCE(NEW.name, a.name),\n    email = COALESCE(NEW.email, a.email),\n    status = COALESCE(NEW.status, a.status),\n    country = COALESCE(NEW.country, a.country),\n    city = COALESCE(NEW.city, a.city),\n    updated_at = NOW()\n  WHERE a.user_id = NEW.id;\n\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- 3) Ensure role-aware triggers are attached (and only these)\nDO $$\nBEGIN\n  IF NOT EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'on_agent_profile_insert') THEN\n    EXECUTE 'CREATE TRIGGER on_agent_profile_insert AFTER INSERT ON public.profiles FOR EACH ROW EXECUTE FUNCTION public.handle_agent_profile_insert()';\n  END IF;\n  IF NOT EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'on_agent_profile_update') THEN\n    EXECUTE 'CREATE TRIGGER on_agent_profile_update AFTER UPDATE ON public.profiles FOR EACH ROW EXECUTE FUNCTION public.handle_agent_profile_update()';\n  END IF;\nEND $$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- 4) Ensure handle_new_user only creates agent rows for agent role\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  user_name TEXT;\n  user_role TEXT;\n  user_phone TEXT;\n  user_department TEXT;\n  user_position TEXT;\n  user_employee_id TEXT;\nBEGIN\n  user_name := COALESCE(NEW.raw_user_meta_data-\u003e\u003e'name', split_part(NEW.email, '@', 1));\n  user_role := COALESCE(NEW.raw_user_meta_data-\u003e\u003e'role', 'agent');\n  user_phone := NEW.raw_user_meta_data-\u003e\u003e'phone';\n  user_department := NEW.raw_user_meta_data-\u003e\u003e'department';\n  user_position := NEW.raw_user_meta_data-\u003e\u003e'position';\n  user_employee_id := NEW.raw_user_meta_data-\u003e\u003e'employee_id';\n\n  INSERT INTO public.profiles (\n    id, email, name, role, phone, department, position, employee_id, created_at, updated_at\n  ) VALUES (\n    NEW.id, NEW.email, user_name, user_role, user_phone, user_department, user_position, user_employee_id, NOW(), NOW()\n  )\n  ON CONFLICT (id) DO UPDATE SET\n    name = COALESCE(EXCLUDED.name, profiles.name),\n    role = COALESCE(EXCLUDED.role, profiles.role),\n    phone = COALESCE(EXCLUDED.phone, profiles.phone),\n    department = COALESCE(EXCLUDED.department, profiles.department),\n    position = COALESCE(EXCLUDED.position, profiles.position),\n    employee_id = COALESCE(EXCLUDED.employee_id, profiles.employee_id),\n    updated_at = NOW();\n\n  IF user_role = 'agent' THEN\n    INSERT INTO public.agents (\n      user_id, name, email, status, created_at, updated_at\n    ) VALUES (\n      NEW.id, user_name, NEW.email, 'active', NOW(), NOW()\n    )\n    ON CONFLICT (user_id) DO NOTHING;\n  END IF;\n\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- 5) Cleanup: remove agent rows tied to non-agent profiles\nDELETE FROM public.agents a\nUSING public.profiles p\nWHERE a.user_id = p.id\nAND COALESCE(p.role, 'agent') \u003c\u003e 'agent'","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"COMMIT","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251027014000"},{"text":"fix_agent_role_triggers"},{"binary":"00000001000000000000001900000008000000010000008a2d2d20456e73757265206f6e6c7920276167656e74272070726f66696c65732063726561746520726f777320696e207075626c69632e6167656e74730a2d2d2044726f70206c656761637920756e6775617264656420747269676765727320616e6420636c65616e207570206578697374696e67206e6f6e2d6167656e7420726f77730a0a424547494e000001b22d2d2031292044726f70206c656761637920747269676765727320746861742073796e63206167656e747320776974686f757420726f6c6520636865636b730a444f2024240a424547494e0a2020494620455849535453202853454c45435420312046524f4d2070675f747269676765722057484552452074676e616d65203d20276f6e5f70726f66696c655f696e736572745f73796e635f6167656e742729205448454e0a2020202045584543555445202744524f502054524947474552206f6e5f70726f66696c655f696e736572745f73796e635f6167656e74204f4e207075626c69632e70726f66696c6573273b0a2020454e442049463b0a2020494620455849535453202853454c45435420312046524f4d2070675f747269676765722057484552452074676e616d65203d20276f6e5f70726f66696c655f7570646174655f73796e635f6167656e742729205448454e0a2020202045584543555445202744524f502054524947474552206f6e5f70726f66696c655f7570646174655f73796e635f6167656e74204f4e207075626c69632e70726f66696c6573273b0a2020454e442049463b0a454e44202424000001f92d2d20322920526f6c652d6177617265206167656e742073796e632066756e6374696f6e7320286964656d706f74656e74290a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6167656e745f70726f66696c655f696e7365727428290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a41532024240a424547494e0a20204946204e45572e726f6c65203d20276167656e7427205448454e0a20202020494e5345525420494e544f207075626c69632e6167656e747320280a202020202020757365725f69642c206e616d652c20656d61696c2c207374617475732c20636f756e7472792c20636974792c20637265617465645f61742c20757064617465645f61740a20202020292056414c55455320280a2020202020204e45572e69642c204e45572e6e616d652c204e45572e656d61696c2c20434f414c45534345284e45572e7374617475732c202761637469766527292c204e45572e636f756e7472792c204e45572e636974792c204e4f5728292c204e4f5728290a20202020290a202020204f4e20434f4e464c4943542028757365725f69642920444f204e4f5448494e473b0a2020454e442049463b0a202052455455524e204e45573b0a454e443b0a2424000001be435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6167656e745f70726f66696c655f75706461746528290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a41532024240a424547494e0a2020555044415445207075626c69632e6167656e747320415320610a20205345540a202020206e616d65203d20434f414c45534345284e45572e6e616d652c20612e6e616d65292c0a20202020656d61696c203d20434f414c45534345284e45572e656d61696c2c20612e656d61696c292c0a20202020737461747573203d20434f414c45534345284e45572e7374617475732c20612e737461747573292c0a20202020636f756e747279203d20434f414c45534345284e45572e636f756e7472792c20612e636f756e747279292c0a2020202063697479203d20434f414c45534345284e45572e636974792c20612e63697479292c0a20202020757064617465645f6174203d204e4f5728290a2020574845524520612e757365725f6964203d204e45572e69643b0a0a202052455455524e204e45573b0a454e443b0a2424000002492d2d20332920456e7375726520726f6c652d6177617265207472696767657273206172652061747461636865642028616e64206f6e6c79207468657365290a444f2024240a424547494e0a20204946204e4f5420455849535453202853454c45435420312046524f4d2070675f747269676765722057484552452074676e616d65203d20276f6e5f6167656e745f70726f66696c655f696e736572742729205448454e0a202020204558454355544520274352454154452054524947474552206f6e5f6167656e745f70726f66696c655f696e7365727420414654455220494e53455254204f4e207075626c69632e70726f66696c657320464f52204541434820524f5720455845435554452046554e4354494f4e207075626c69632e68616e646c655f6167656e745f70726f66696c655f696e736572742829273b0a2020454e442049463b0a20204946204e4f5420455849535453202853454c45435420312046524f4d2070675f747269676765722057484552452074676e616d65203d20276f6e5f6167656e745f70726f66696c655f7570646174652729205448454e0a202020204558454355544520274352454154452054524947474552206f6e5f6167656e745f70726f66696c655f75706461746520414654455220555044415445204f4e207075626c69632e70726f66696c657320464f52204541434820524f5720455845435554452046554e4354494f4e207075626c69632e68616e646c655f6167656e745f70726f66696c655f7570646174652829273b0a2020454e442049463b0a454e442024240000068c2d2d20342920456e737572652068616e646c655f6e65775f75736572206f6e6c792063726561746573206167656e7420726f777320666f72206167656e7420726f6c650a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a4445434c4152450a2020757365725f6e616d6520544558543b0a2020757365725f726f6c6520544558543b0a2020757365725f70686f6e6520544558543b0a2020757365725f6465706172746d656e7420544558543b0a2020757365725f706f736974696f6e20544558543b0a2020757365725f656d706c6f7965655f696420544558543b0a424547494e0a2020757365725f6e616d65203a3d20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c2073706c69745f70617274284e45572e656d61696c2c202740272c203129293b0a2020757365725f726f6c65203a3d20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e27726f6c65272c20276167656e7427293b0a2020757365725f70686f6e65203a3d204e45572e7261775f757365725f6d6574615f646174612d3e3e2770686f6e65273b0a2020757365725f6465706172746d656e74203a3d204e45572e7261775f757365725f6d6574615f646174612d3e3e276465706172746d656e74273b0a2020757365725f706f736974696f6e203a3d204e45572e7261775f757365725f6d6574615f646174612d3e3e27706f736974696f6e273b0a2020757365725f656d706c6f7965655f6964203a3d204e45572e7261775f757365725f6d6574615f646174612d3e3e27656d706c6f7965655f6964273b0a0a2020494e5345525420494e544f207075626c69632e70726f66696c657320280a2020202069642c20656d61696c2c206e616d652c20726f6c652c2070686f6e652c206465706172746d656e742c20706f736974696f6e2c20656d706c6f7965655f69642c20637265617465645f61742c20757064617465645f61740a2020292056414c55455320280a202020204e45572e69642c204e45572e656d61696c2c20757365725f6e616d652c20757365725f726f6c652c20757365725f70686f6e652c20757365725f6465706172746d656e742c20757365725f706f736974696f6e2c20757365725f656d706c6f7965655f69642c204e4f5728292c204e4f5728290a2020290a20204f4e20434f4e464c494354202869642920444f20555044415445205345540a202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c2070726f66696c65732e6e616d65292c0a20202020726f6c65203d20434f414c45534345284558434c554445442e726f6c652c2070726f66696c65732e726f6c65292c0a2020202070686f6e65203d20434f414c45534345284558434c554445442e70686f6e652c2070726f66696c65732e70686f6e65292c0a202020206465706172746d656e74203d20434f414c45534345284558434c554445442e6465706172746d656e742c2070726f66696c65732e6465706172746d656e74292c0a20202020706f736974696f6e203d20434f414c45534345284558434c554445442e706f736974696f6e2c2070726f66696c65732e706f736974696f6e292c0a20202020656d706c6f7965655f6964203d20434f414c45534345284558434c554445442e656d706c6f7965655f69642c2070726f66696c65732e656d706c6f7965655f6964292c0a20202020757064617465645f6174203d204e4f5728293b0a0a2020494620757365725f726f6c65203d20276167656e7427205448454e0a20202020494e5345525420494e544f207075626c69632e6167656e747320280a202020202020757365725f69642c206e616d652c20656d61696c2c207374617475732c20637265617465645f61742c20757064617465645f61740a20202020292056414c55455320280a2020202020204e45572e69642c20757365725f6e616d652c204e45572e656d61696c2c2027616374697665272c204e4f5728292c204e4f5728290a20202020290a202020204f4e20434f4e464c4943542028757365725f69642920444f204e4f5448494e473b0a2020454e442049463b0a0a202052455455524e204e45573b0a454e443b0a2424000000af2d2d20352920436c65616e75703a2072656d6f7665206167656e7420726f7773207469656420746f206e6f6e2d6167656e742070726f66696c65730a44454c4554452046524f4d207075626c69632e6167656e747320610a5553494e47207075626c69632e70726f66696c657320700a574845524520612e757365725f6964203d20702e69640a414e4420434f414c4553434528702e726f6c652c20276167656e742729203c3e20276167656e742700000006434f4d4d4954"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"BEGIN"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DO"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DELETE 0"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMIT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251027015000_fix_handle_new_user_agent_status.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Harden handle_new_user for agent signup: avoid invalid status and column mismatches\n-- - Inserts/Upserts into profiles only\n-- - Creates agent row with minimal columns and valid status ('inactive')\n-- - Keeps SECURITY DEFINER and exception handling to prevent signup failures\n\nBEGIN","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DROP FUNCTION IF EXISTS public.handle_new_user() CASCADE","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  user_name TEXT;\n  user_role TEXT;\n  user_phone TEXT;\n  user_department TEXT;\n  user_position TEXT;\n  user_employee_id TEXT;\nBEGIN\n  -- Extract metadata with fallbacks\n  user_name := COALESCE(NEW.raw_user_meta_data-\u003e\u003e'name', split_part(NEW.email, '@', 1));\n  user_role := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'role', ''), 'agent');\n  user_phone := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'phone', '');\n  user_department := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'department', '');\n  user_position := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'position', '');\n  user_employee_id := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'employee_id', '');\n\n  -- Upsert profile\n  INSERT INTO public.profiles (\n    id, email, name, role, phone, department, position, employee_id, created_at, updated_at\n  ) VALUES (\n    NEW.id, NEW.email, user_name, user_role, user_phone, user_department, user_position, user_employee_id, NOW(), NOW()\n  )\n  ON CONFLICT (id) DO UPDATE SET\n    email = EXCLUDED.email,\n    name = COALESCE(EXCLUDED.name, profiles.name),\n    role = COALESCE(EXCLUDED.role, profiles.role),\n    phone = COALESCE(EXCLUDED.phone, profiles.phone),\n    department = COALESCE(EXCLUDED.department, profiles.department),\n    position = COALESCE(EXCLUDED.position, profiles.position),\n    employee_id = COALESCE(EXCLUDED.employee_id, profiles.employee_id),\n    updated_at = NOW();\n\n  -- Create agent row only for agent role, with valid status\n  IF user_role = 'agent' THEN\n    INSERT INTO public.agents (\n      user_id, name, email, status, created_at, updated_at\n    ) VALUES (\n      NEW.id, user_name, NEW.email, 'inactive', NOW(), NOW()\n    )\n    ON CONFLICT (user_id) DO NOTHING;\n  END IF;\n\n  RETURN NEW;\nEXCEPTION\n  WHEN OTHERS THEN\n    RAISE WARNING 'Error in handle_new_user: %', SQLERRM;\n    RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Ensure trigger is attached to auth.users\nDROP TRIGGER IF EXISTS on_auth_user_created ON auth.users","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW\n  EXECUTE FUNCTION public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"COMMIT","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251027015000"},{"text":"fix_handle_new_user_agent_status"},{"binary":"00000001000000000000001900000006000000010000011d2d2d2048617264656e2068616e646c655f6e65775f7573657220666f72206167656e74207369676e75703a2061766f696420696e76616c69642073746174757320616e6420636f6c756d6e206d69736d6174636865730a2d2d202d20496e73657274732f5570736572747320696e746f2070726f66696c6573206f6e6c790a2d2d202d2043726561746573206167656e7420726f772077697468206d696e696d616c20636f6c756d6e7320616e642076616c696420737461747573202827696e61637469766527290a2d2d202d204b6565707320534543555249545920444546494e455220616e6420657863657074696f6e2068616e646c696e6720746f2070726576656e74207369676e7570206661696c757265730a0a424547494e0000003844524f502046554e4354494f4e20494620455849535453207075626c69632e68616e646c655f6e65775f75736572282920434153434144450000077f435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a4445434c4152450a2020757365725f6e616d6520544558543b0a2020757365725f726f6c6520544558543b0a2020757365725f70686f6e6520544558543b0a2020757365725f6465706172746d656e7420544558543b0a2020757365725f706f736974696f6e20544558543b0a2020757365725f656d706c6f7965655f696420544558543b0a424547494e0a20202d2d2045787472616374206d6574616461746120776974682066616c6c6261636b730a2020757365725f6e616d65203a3d20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c2073706c69745f70617274284e45572e656d61696c2c202740272c203129293b0a2020757365725f726f6c65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27726f6c65272c202727292c20276167656e7427293b0a2020757365725f70686f6e65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2770686f6e65272c202727293b0a2020757365725f6465706172746d656e74203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276465706172746d656e74272c202727293b0a2020757365725f706f736974696f6e203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27706f736974696f6e272c202727293b0a2020757365725f656d706c6f7965655f6964203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27656d706c6f7965655f6964272c202727293b0a0a20202d2d205570736572742070726f66696c650a2020494e5345525420494e544f207075626c69632e70726f66696c657320280a2020202069642c20656d61696c2c206e616d652c20726f6c652c2070686f6e652c206465706172746d656e742c20706f736974696f6e2c20656d706c6f7965655f69642c20637265617465645f61742c20757064617465645f61740a2020292056414c55455320280a202020204e45572e69642c204e45572e656d61696c2c20757365725f6e616d652c20757365725f726f6c652c20757365725f70686f6e652c20757365725f6465706172746d656e742c20757365725f706f736974696f6e2c20757365725f656d706c6f7965655f69642c204e4f5728292c204e4f5728290a2020290a20204f4e20434f4e464c494354202869642920444f20555044415445205345540a20202020656d61696c203d204558434c554445442e656d61696c2c0a202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c2070726f66696c65732e6e616d65292c0a20202020726f6c65203d20434f414c45534345284558434c554445442e726f6c652c2070726f66696c65732e726f6c65292c0a2020202070686f6e65203d20434f414c45534345284558434c554445442e70686f6e652c2070726f66696c65732e70686f6e65292c0a202020206465706172746d656e74203d20434f414c45534345284558434c554445442e6465706172746d656e742c2070726f66696c65732e6465706172746d656e74292c0a20202020706f736974696f6e203d20434f414c45534345284558434c554445442e706f736974696f6e2c2070726f66696c65732e706f736974696f6e292c0a20202020656d706c6f7965655f6964203d20434f414c45534345284558434c554445442e656d706c6f7965655f69642c2070726f66696c65732e656d706c6f7965655f6964292c0a20202020757064617465645f6174203d204e4f5728293b0a0a20202d2d20437265617465206167656e7420726f77206f6e6c7920666f72206167656e7420726f6c652c20776974682076616c6964207374617475730a2020494620757365725f726f6c65203d20276167656e7427205448454e0a20202020494e5345525420494e544f207075626c69632e6167656e747320280a202020202020757365725f69642c206e616d652c20656d61696c2c207374617475732c20637265617465645f61742c20757064617465645f61740a20202020292056414c55455320280a2020202020204e45572e69642c20757365725f6e616d652c204e45572e656d61696c2c2027696e616374697665272c204e4f5728292c204e4f5728290a20202020290a202020204f4e20434f4e464c4943542028757365725f69642920444f204e4f5448494e473b0a2020454e442049463b0a0a202052455455524e204e45573b0a455843455054494f4e0a20205748454e204f5448455253205448454e0a202020205241495345205741524e494e4720274572726f7220696e2068616e646c655f6e65775f757365723a2025272c2053514c4552524d3b0a2020202052455455524e204e45573b0a454e443b0a2424000000652d2d20456e73757265207472696767657220697320617474616368656420746f20617574682e75736572730a44524f50205452494747455220494620455849535453206f6e5f617574685f757365725f63726561746564204f4e20617574682e75736572730000007b4352454154452054524947474552206f6e5f617574685f757365725f637265617465640a2020414654455220494e53455254204f4e20617574682e75736572730a2020464f52204541434820524f570a2020455845435554452046554e4354494f4e207075626c69632e68616e646c655f6e65775f75736572282900000006434f4d4d4954"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"BEGIN"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"drop cascades to trigger on_auth_user_created on table auth.users","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dependency.c","Line":1176,"Routine":"reportDependentObjects","UnknownFields":null}
NOTICE (00000): drop cascades to trigger on_auth_user_created on table auth.users
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Severity":"NOTICE","SeverityUnlocalized":"NOTICE","Code":"00000","Message":"trigger \"on_auth_user_created\" for relation \"auth.users\" does not exist, skipping","Detail":"","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"","TableName":"","ColumnName":"","DataTypeName":"","ConstraintName":"","File":"dropcmds.c","Line":523,"Routine":"does_not_exist_skipping","UnknownFields":null}
NOTICE (00000): trigger "on_auth_user_created" for relation "auth.users" does not exist, skipping
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMIT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251027_fix_profiles_rls_recursion_with_rpc.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Fix profiles RLS recursion by introducing a SECURITY DEFINER RPC\n-- This function safely returns the current user's profile and creates it if missing,\n-- bypassing table RLS evaluation paths that can recurse.\n\nBEGIN","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Create or replace SECURITY DEFINER function\nCREATE OR REPLACE FUNCTION public.get_or_create_profile_for_current_user()\nRETURNS public.profiles\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nDECLARE\n  v_profile public.profiles;\n  v_uid uuid := auth.uid();\n  v_email text;\nBEGIN\n  -- Fetch existing profile without RLS restrictions (SECURITY DEFINER)\n  SELECT p.* INTO v_profile\n  FROM public.profiles p\n  WHERE p.id = v_uid;\n\n  IF v_profile IS NOT NULL THEN\n    RETURN v_profile;\n  END IF;\n\n  -- Try to get email from auth.users (requires SECURITY DEFINER)\n  SELECT u.email INTO v_email\n  FROM auth.users u\n  WHERE u.id = v_uid;\n\n  -- Create minimal profile row if missing\n  INSERT INTO public.profiles (\n    id, email, name, role, department, status, position, created_at, updated_at\n  ) VALUES (\n    v_uid,\n    COALESCE(v_email, v_uid::text || '@local'),\n    COALESCE(split_part(v_email, '@', 1), v_uid::text),\n    'agent',\n    'General',\n    'active',\n    'Agent',\n    NOW(),\n    NOW()\n  )\n  RETURNING * INTO v_profile;\n\n  RETURN v_profile;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION public.get_or_create_profile_for_current_user() TO authenticated","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"COMMIT","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251027"},{"text":"fix_profiles_rls_recursion_with_rpc"},{"binary":"0000000100000000000000190000000400000001000000da2d2d204669782070726f66696c657320524c5320726563757273696f6e20627920696e74726f647563696e67206120534543555249545920444546494e4552205250430a2d2d20546869732066756e6374696f6e20736166656c792072657475726e73207468652063757272656e74207573657227732070726f66696c6520616e642063726561746573206974206966206d697373696e672c0a2d2d20627970617373696e67207461626c6520524c53206576616c756174696f6e20706174687320746861742063616e20726563757273652e0a0a424547494e0000042f2d2d20437265617465206f72207265706c61636520534543555249545920444546494e45522066756e6374696f6e0a435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e6765745f6f725f6372656174655f70726f66696c655f666f725f63757272656e745f7573657228290a52455455524e53207075626c69632e70726f66696c65730a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69630a41532024240a4445434c4152450a2020765f70726f66696c65207075626c69632e70726f66696c65733b0a2020765f7569642075756964203a3d20617574682e75696428293b0a2020765f656d61696c20746578743b0a424547494e0a20202d2d204665746368206578697374696e672070726f66696c6520776974686f757420524c53207265737472696374696f6e732028534543555249545920444546494e4552290a202053454c45435420702e2a20494e544f20765f70726f66696c650a202046524f4d207075626c69632e70726f66696c657320700a2020574845524520702e6964203d20765f7569643b0a0a2020494620765f70726f66696c65204953204e4f54204e554c4c205448454e0a2020202052455455524e20765f70726f66696c653b0a2020454e442049463b0a0a20202d2d2054727920746f2067657420656d61696c2066726f6d20617574682e75736572732028726571756972657320534543555249545920444546494e4552290a202053454c45435420752e656d61696c20494e544f20765f656d61696c0a202046524f4d20617574682e757365727320750a2020574845524520752e6964203d20765f7569643b0a0a20202d2d20437265617465206d696e696d616c2070726f66696c6520726f77206966206d697373696e670a2020494e5345525420494e544f207075626c69632e70726f66696c657320280a2020202069642c20656d61696c2c206e616d652c20726f6c652c206465706172746d656e742c207374617475732c20706f736974696f6e2c20637265617465645f61742c20757064617465645f61740a2020292056414c55455320280a20202020765f7569642c0a20202020434f414c4553434528765f656d61696c2c20765f7569643a3a74657874207c7c2027406c6f63616c27292c0a20202020434f414c455343452873706c69745f7061727428765f656d61696c2c202740272c2031292c20765f7569643a3a74657874292c0a20202020276167656e74272c0a202020202747656e6572616c272c0a2020202027616374697665272c0a20202020274167656e74272c0a202020204e4f5728292c0a202020204e4f5728290a2020290a202052455455524e494e47202a20494e544f20765f70726f66696c653b0a0a202052455455524e20765f70726f66696c653b0a454e443b0a24240000005a4752414e542045584543555445204f4e2046554e4354494f4e207075626c69632e6765745f6f725f6372656174655f70726f66696c655f666f725f63757272656e745f75736572282920544f2061757468656e7469636174656400000006434f4d4d4954"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"BEGIN"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMIT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
Applying migration 20251027_full_handle_new_user_agent_profile.sql...
2025/11/05 15:50:23 PG Send: {"Type":"Query","String":"RESET ALL"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"RESET"}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"-- Comprehensive handle_new_user to populate profiles and agents on signup\n-- Notes:\n-- - SECURITY DEFINER with explicit search_path to stabilize resolution and bypass RLS\n-- - Extracts extensive metadata from auth.users.raw_user_meta_data\n-- - Upserts into public.profiles; ensures a single agents row per user_id\n-- - Swallows errors to avoid blocking auth signup\n\nBEGIN","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"DROP FUNCTION IF EXISTS public.handle_new_user() CASCADE","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public, auth\nAS $$\nDECLARE\n  -- Profile fields\n  user_name TEXT;\n  user_role TEXT;\n  user_department TEXT;\n  user_phone TEXT;\n  user_status TEXT;\n  user_position TEXT;\n  user_employee_id TEXT;\n  user_company_name TEXT;\n  user_avatar TEXT;\n  user_preferred_language TEXT;\n  user_country TEXT;\n  user_city TEXT;\n  user_must_change_password BOOLEAN;\n\n  -- Agent fields\n  agency_name TEXT;\n  agency_code TEXT;\n  license_number TEXT;\n  iata_number TEXT;\n  business_address TEXT;\n  business_phone TEXT;\n  specializations TEXT[];\n  commission_type TEXT;\n  commission_value TEXT;\n  business_type TEXT;\n  profile_image TEXT;\n  source_type TEXT;\n  source_details TEXT;\n  website TEXT;\n  alternate_email TEXT;\n  mobile_numbers TEXT[];\n  documents TEXT[];\n  assigned_staff UUID[];\n  created_by UUID;\n  created_by_staff TEXT;\nBEGIN\n  -- Extract metadata with fallbacks\n  user_name := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'name',''), split_part(NEW.email,'@',1));\n  user_role := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'role',''), 'agent');\n  user_department := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'department','');\n  user_phone := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'phone','');\n  user_status := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'status',''), 'active');\n  user_position := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'position','');\n  user_employee_id := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'employee_id','');\n  user_company_name := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'company_name','');\n  user_avatar := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'avatar','');\n  user_preferred_language := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'preferred_language','');\n  user_country := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'country','');\n  user_city := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'city','');\n  user_must_change_password := COALESCE((NEW.raw_user_meta_data-\u003e\u003e'must_change_password')::BOOLEAN, FALSE);\n\n  agency_name := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'agency_name',''), user_company_name);\n  agency_code := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'agency_code','');\n  license_number := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'license_number','');\n  iata_number := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'iata_number','');\n  business_address := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'business_address','');\n  business_phone := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'business_phone',''), user_phone);\n  commission_type := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'commission_type','');\n  commission_value := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'commission_value','');\n  business_type := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'business_type','');\n  profile_image := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'profile_image','');\n  source_type := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'source_type',''), 'auth');\n  source_details := COALESCE(NULLIF(NEW.raw_user_meta_data-\u003e\u003e'source_details',''), 'on_auth_user_created');\n  website := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'website','');\n  alternate_email := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'alternate_email','');\n  created_by := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'created_by','')::UUID;\n  created_by_staff := NULLIF(NEW.raw_user_meta_data-\u003e\u003e'created_by_staff','');\n\n  -- Arrays\n  IF NEW.raw_user_meta_data ? 'specializations' THEN\n    specializations := ARRAY(SELECT jsonb_array_elements_text(NEW.raw_user_meta_data-\u003e'specializations'));\n  END IF;\n  IF NEW.raw_user_meta_data ? 'mobile_numbers' THEN\n    mobile_numbers := ARRAY(SELECT jsonb_array_elements_text(NEW.raw_user_meta_data-\u003e'mobile_numbers'));\n  END IF;\n  IF NEW.raw_user_meta_data ? 'documents' THEN\n    documents := ARRAY(SELECT jsonb_array_elements_text(NEW.raw_user_meta_data-\u003e'documents'));\n  END IF;\n  IF NEW.raw_user_meta_data ? 'assigned_staff' THEN\n    assigned_staff := ARRAY(SELECT jsonb_array_elements(NEW.raw_user_meta_data-\u003e'assigned_staff')::uuid);\n  END IF;\n\n  -- Upsert into profiles\n  INSERT INTO public.profiles (\n    id, name, email, role, department, phone, status, position, employee_id,\n    created_at, updated_at, company_name, avatar, preferred_language, country, city,\n    must_change_password, uuid\n  ) VALUES (\n    NEW.id, user_name, NEW.email, user_role, user_department, user_phone, user_status, user_position, user_employee_id,\n    NOW(), NOW(), user_company_name, user_avatar, user_preferred_language, user_country, user_city,\n    user_must_change_password, NULL\n  )\n  ON CONFLICT (id) DO UPDATE SET\n    name = COALESCE(EXCLUDED.name, profiles.name),\n    email = COALESCE(EXCLUDED.email, profiles.email),\n    role = COALESCE(EXCLUDED.role, profiles.role),\n    department = COALESCE(EXCLUDED.department, profiles.department),\n    phone = COALESCE(EXCLUDED.phone, profiles.phone),\n    status = COALESCE(EXCLUDED.status, profiles.status),\n    position = COALESCE(EXCLUDED.position, profiles.position),\n    employee_id = COALESCE(EXCLUDED.employee_id, profiles.employee_id),\n    company_name = COALESCE(EXCLUDED.company_name, profiles.company_name),\n    avatar = COALESCE(EXCLUDED.avatar, profiles.avatar),\n    preferred_language = COALESCE(EXCLUDED.preferred_language, profiles.preferred_language),\n    country = COALESCE(EXCLUDED.country, profiles.country),\n    city = COALESCE(EXCLUDED.city, profiles.city),\n    must_change_password = COALESCE(EXCLUDED.must_change_password, profiles.must_change_password),\n    updated_at = NOW();\n\n  -- Ensure a single agents row per user_id\n  IF NOT EXISTS (SELECT 1 FROM public.agents WHERE user_id = NEW.id) THEN\n    INSERT INTO public.agents (\n      user_id, name, email, status, agency_name, agency_code, license_number, iata_number,\n      business_address, business_phone, specializations, commission_structure,\n      country, city, business_type, commission_type, commission_value, profile_image,\n      source_type, source_details, created_by, created_by_staff, website, alternate_email,\n      mobile_numbers, documents, assigned_staff, created_at, updated_at\n    ) VALUES (\n      NEW.id, user_name, NEW.email, 'active', agency_name, agency_code, license_number, iata_number,\n      business_address, business_phone, specializations, COALESCE(NEW.raw_user_meta_data-\u003e'commission_structure', '{\"type\":\"percentage\",\"value\":10}'::jsonb),\n      user_country, user_city, business_type, commission_type, commission_value, profile_image,\n      source_type, source_details, created_by, created_by_staff, website, alternate_email,\n      mobile_numbers, documents, assigned_staff, NOW(), NOW()\n    );\n  ELSE\n    UPDATE public.agents SET\n      name = COALESCE(user_name, agents.name),\n      email = COALESCE(NEW.email, agents.email),\n      status = COALESCE(user_status, agents.status),\n      agency_name = COALESCE(agency_name, agents.agency_name),\n      agency_code = COALESCE(agency_code, agents.agency_code),\n      license_number = COALESCE(license_number, agents.license_number),\n      iata_number = COALESCE(iata_number, agents.iata_number),\n      business_address = COALESCE(business_address, agents.business_address),\n      business_phone = COALESCE(business_phone, agents.business_phone),\n      specializations = COALESCE(specializations, agents.specializations),\n      commission_structure = COALESCE(NEW.raw_user_meta_data-\u003e'commission_structure', agents.commission_structure),\n      country = COALESCE(user_country, agents.country),\n      city = COALESCE(user_city, agents.city),\n      business_type = COALESCE(business_type, agents.business_type),\n      commission_type = COALESCE(commission_type, agents.commission_type),\n      commission_value = COALESCE(commission_value, agents.commission_value),\n      profile_image = COALESCE(profile_image, agents.profile_image),\n      source_type = COALESCE(source_type, agents.source_type),\n      source_details = COALESCE(source_details, agents.source_details),\n      created_by = COALESCE(created_by, agents.created_by),\n      created_by_staff = COALESCE(created_by_staff, agents.created_by_staff),\n      website = COALESCE(website, agents.website),\n      alternate_email = COALESCE(alternate_email, agents.alternate_email),\n      mobile_numbers = COALESCE(mobile_numbers, agents.mobile_numbers),\n      documents = COALESCE(documents, agents.documents),\n      assigned_staff = COALESCE(assigned_staff, agents.assigned_staff),\n      updated_at = NOW()\n    WHERE user_id = NEW.id;\n  END IF;\n\n  RETURN NEW;\nEXCEPTION WHEN OTHERS THEN\n  RAISE WARNING 'handle_new_user error: %', SQLERRM;\n  RETURN NEW;\nEND;\n$$","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"CREATE TRIGGER on_auth_user_created\nAFTER INSERT ON auth.users\nFOR EACH ROW\nEXECUTE FUNCTION public.handle_new_user()","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"GRANT EXECUTE ON FUNCTION public.handle_new_user() TO authenticated, anon","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"ALTER FUNCTION public.handle_new_user() OWNER TO postgres","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"COMMIT","ParameterOIDs":null}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":null,"Parameters":[],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Parse","Name":"","Query":"INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)","ParameterOIDs":[25,25,1009]}
2025/11/05 15:50:23 PG Send: {"Type":"Bind","DestinationPortal":"","PreparedStatement":"","ParameterFormatCodes":[0,0,1],"Parameters":[{"text":"20251027"},{"text":"full_handle_new_user_agent_profile"},{"binary":"0000000100000000000000190000000800000001000001742d2d20436f6d70726568656e736976652068616e646c655f6e65775f7573657220746f20706f70756c6174652070726f66696c657320616e64206167656e7473206f6e207369676e75700a2d2d204e6f7465733a0a2d2d202d20534543555249545920444546494e45522077697468206578706c69636974207365617263685f7061746820746f2073746162696c697a65207265736f6c7574696f6e20616e642062797061737320524c530a2d2d202d20457874726163747320657874656e73697665206d657461646174612066726f6d20617574682e75736572732e7261775f757365725f6d6574615f646174610a2d2d202d205570736572747320696e746f207075626c69632e70726f66696c65733b20656e737572657320612073696e676c65206167656e747320726f772070657220757365725f69640a2d2d202d205377616c6c6f7773206572726f727320746f2061766f696420626c6f636b696e672061757468207369676e75700a0a424547494e0000003944524f50205452494747455220494620455849535453206f6e5f617574685f757365725f63726561746564204f4e20617574682e75736572730000003844524f502046554e4354494f4e20494620455849535453207075626c69632e68616e646c655f6e65775f7573657228292043415343414445000020fa435245415445204f52205245504c4143452046554e4354494f4e207075626c69632e68616e646c655f6e65775f7573657228290a52455455524e5320545249474745520a4c414e475541474520706c706773716c0a534543555249545920444546494e45520a534554207365617263685f70617468203d207075626c69632c20617574680a41532024240a4445434c4152450a20202d2d2050726f66696c65206669656c64730a2020757365725f6e616d6520544558543b0a2020757365725f726f6c6520544558543b0a2020757365725f6465706172746d656e7420544558543b0a2020757365725f70686f6e6520544558543b0a2020757365725f73746174757320544558543b0a2020757365725f706f736974696f6e20544558543b0a2020757365725f656d706c6f7965655f696420544558543b0a2020757365725f636f6d70616e795f6e616d6520544558543b0a2020757365725f61766174617220544558543b0a2020757365725f7072656665727265645f6c616e677561676520544558543b0a2020757365725f636f756e74727920544558543b0a2020757365725f6369747920544558543b0a2020757365725f6d7573745f6368616e67655f70617373776f726420424f4f4c45414e3b0a0a20202d2d204167656e74206669656c64730a20206167656e63795f6e616d6520544558543b0a20206167656e63795f636f646520544558543b0a20206c6963656e73655f6e756d62657220544558543b0a2020696174615f6e756d62657220544558543b0a2020627573696e6573735f6164647265737320544558543b0a2020627573696e6573735f70686f6e6520544558543b0a20207370656369616c697a6174696f6e7320544558545b5d3b0a2020636f6d6d697373696f6e5f7479706520544558543b0a2020636f6d6d697373696f6e5f76616c756520544558543b0a2020627573696e6573735f7479706520544558543b0a202070726f66696c655f696d61676520544558543b0a2020736f757263655f7479706520544558543b0a2020736f757263655f64657461696c7320544558543b0a20207765627369746520544558543b0a2020616c7465726e6174655f656d61696c20544558543b0a20206d6f62696c655f6e756d6265727320544558545b5d3b0a2020646f63756d656e747320544558545b5d3b0a202061737369676e65645f737461666620555549445b5d3b0a2020637265617465645f627920555549443b0a2020637265617465645f62795f737461666620544558543b0a424547494e0a20202d2d2045787472616374206d6574616461746120776974682066616c6c6261636b730a2020757365725f6e616d65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276e616d65272c2727292c2073706c69745f70617274284e45572e656d61696c2c2740272c3129293b0a2020757365725f726f6c65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27726f6c65272c2727292c20276167656e7427293b0a2020757365725f6465706172746d656e74203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276465706172746d656e74272c2727293b0a2020757365725f70686f6e65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2770686f6e65272c2727293b0a2020757365725f737461747573203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27737461747573272c2727292c202761637469766527293b0a2020757365725f706f736974696f6e203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27706f736974696f6e272c2727293b0a2020757365725f656d706c6f7965655f6964203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27656d706c6f7965655f6964272c2727293b0a2020757365725f636f6d70616e795f6e616d65203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f6d70616e795f6e616d65272c2727293b0a2020757365725f617661746172203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27617661746172272c2727293b0a2020757365725f7072656665727265645f6c616e6775616765203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e277072656665727265645f6c616e6775616765272c2727293b0a2020757365725f636f756e747279203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f756e747279272c2727293b0a2020757365725f63697479203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2763697479272c2727293b0a2020757365725f6d7573745f6368616e67655f70617373776f7264203a3d20434f414c4553434528284e45572e7261775f757365725f6d6574615f646174612d3e3e276d7573745f6368616e67655f70617373776f726427293a3a424f4f4c45414e2c2046414c5345293b0a0a20206167656e63795f6e616d65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276167656e63795f6e616d65272c2727292c20757365725f636f6d70616e795f6e616d65293b0a20206167656e63795f636f6465203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276167656e63795f636f6465272c2727293b0a20206c6963656e73655f6e756d626572203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e276c6963656e73655f6e756d626572272c2727293b0a2020696174615f6e756d626572203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27696174615f6e756d626572272c2727293b0a2020627573696e6573735f61646472657373203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27627573696e6573735f61646472657373272c2727293b0a2020627573696e6573735f70686f6e65203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27627573696e6573735f70686f6e65272c2727292c20757365725f70686f6e65293b0a2020636f6d6d697373696f6e5f74797065203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f6d6d697373696f6e5f74797065272c2727293b0a2020636f6d6d697373696f6e5f76616c7565203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27636f6d6d697373696f6e5f76616c7565272c2727293b0a2020627573696e6573735f74797065203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27627573696e6573735f74797065272c2727293b0a202070726f66696c655f696d616765203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2770726f66696c655f696d616765272c2727293b0a2020736f757263655f74797065203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27736f757263655f74797065272c2727292c20276175746827293b0a2020736f757263655f64657461696c73203a3d20434f414c45534345284e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27736f757263655f64657461696c73272c2727292c20276f6e5f617574685f757365725f6372656174656427293b0a202077656273697465203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e2777656273697465272c2727293b0a2020616c7465726e6174655f656d61696c203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27616c7465726e6174655f656d61696c272c2727293b0a2020637265617465645f6279203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27637265617465645f6279272c2727293a3a555549443b0a2020637265617465645f62795f7374616666203a3d204e554c4c4946284e45572e7261775f757365725f6d6574615f646174612d3e3e27637265617465645f62795f7374616666272c2727293b0a0a20202d2d204172726179730a20204946204e45572e7261775f757365725f6d6574615f64617461203f20277370656369616c697a6174696f6e7327205448454e0a202020207370656369616c697a6174696f6e73203a3d2041525241592853454c454354206a736f6e625f61727261795f656c656d656e74735f74657874284e45572e7261775f757365725f6d6574615f646174612d3e277370656369616c697a6174696f6e732729293b0a2020454e442049463b0a20204946204e45572e7261775f757365725f6d6574615f64617461203f20276d6f62696c655f6e756d6265727327205448454e0a202020206d6f62696c655f6e756d62657273203a3d2041525241592853454c454354206a736f6e625f61727261795f656c656d656e74735f74657874284e45572e7261775f757365725f6d6574615f646174612d3e276d6f62696c655f6e756d626572732729293b0a2020454e442049463b0a20204946204e45572e7261775f757365725f6d6574615f64617461203f2027646f63756d656e747327205448454e0a20202020646f63756d656e7473203a3d2041525241592853454c454354206a736f6e625f61727261795f656c656d656e74735f74657874284e45572e7261775f757365725f6d6574615f646174612d3e27646f63756d656e74732729293b0a2020454e442049463b0a20204946204e45572e7261775f757365725f6d6574615f64617461203f202761737369676e65645f737461666627205448454e0a2020202061737369676e65645f7374616666203a3d2041525241592853454c454354206a736f6e625f61727261795f656c656d656e7473284e45572e7261775f757365725f6d6574615f646174612d3e2761737369676e65645f737461666627293a3a75756964293b0a2020454e442049463b0a0a20202d2d2055707365727420696e746f2070726f66696c65730a2020494e5345525420494e544f207075626c69632e70726f66696c657320280a2020202069642c206e616d652c20656d61696c2c20726f6c652c206465706172746d656e742c2070686f6e652c207374617475732c20706f736974696f6e2c20656d706c6f7965655f69642c0a20202020637265617465645f61742c20757064617465645f61742c20636f6d70616e795f6e616d652c206176617461722c207072656665727265645f6c616e67756167652c20636f756e7472792c20636974792c0a202020206d7573745f6368616e67655f70617373776f72642c20757569640a2020292056414c55455320280a202020204e45572e69642c20757365725f6e616d652c204e45572e656d61696c2c20757365725f726f6c652c20757365725f6465706172746d656e742c20757365725f70686f6e652c20757365725f7374617475732c20757365725f706f736974696f6e2c20757365725f656d706c6f7965655f69642c0a202020204e4f5728292c204e4f5728292c20757365725f636f6d70616e795f6e616d652c20757365725f6176617461722c20757365725f7072656665727265645f6c616e67756167652c20757365725f636f756e7472792c20757365725f636974792c0a20202020757365725f6d7573745f6368616e67655f70617373776f72642c204e554c4c0a2020290a20204f4e20434f4e464c494354202869642920444f20555044415445205345540a202020206e616d65203d20434f414c45534345284558434c554445442e6e616d652c2070726f66696c65732e6e616d65292c0a20202020656d61696c203d20434f414c45534345284558434c554445442e656d61696c2c2070726f66696c65732e656d61696c292c0a20202020726f6c65203d20434f414c45534345284558434c554445442e726f6c652c2070726f66696c65732e726f6c65292c0a202020206465706172746d656e74203d20434f414c45534345284558434c554445442e6465706172746d656e742c2070726f66696c65732e6465706172746d656e74292c0a2020202070686f6e65203d20434f414c45534345284558434c554445442e70686f6e652c2070726f66696c65732e70686f6e65292c0a20202020737461747573203d20434f414c45534345284558434c554445442e7374617475732c2070726f66696c65732e737461747573292c0a20202020706f736974696f6e203d20434f414c45534345284558434c554445442e706f736974696f6e2c2070726f66696c65732e706f736974696f6e292c0a20202020656d706c6f7965655f6964203d20434f414c45534345284558434c554445442e656d706c6f7965655f69642c2070726f66696c65732e656d706c6f7965655f6964292c0a20202020636f6d70616e795f6e616d65203d20434f414c45534345284558434c554445442e636f6d70616e795f6e616d652c2070726f66696c65732e636f6d70616e795f6e616d65292c0a20202020617661746172203d20434f414c45534345284558434c554445442e6176617461722c2070726f66696c65732e617661746172292c0a202020207072656665727265645f6c616e6775616765203d20434f414c45534345284558434c554445442e7072656665727265645f6c616e67756167652c2070726f66696c65732e7072656665727265645f6c616e6775616765292c0a20202020636f756e747279203d20434f414c45534345284558434c554445442e636f756e7472792c2070726f66696c65732e636f756e747279292c0a2020202063697479203d20434f414c45534345284558434c554445442e636974792c2070726f66696c65732e63697479292c0a202020206d7573745f6368616e67655f70617373776f7264203d20434f414c45534345284558434c554445442e6d7573745f6368616e67655f70617373776f72642c2070726f66696c65732e6d7573745f6368616e67655f70617373776f7264292c0a20202020757064617465645f6174203d204e4f5728293b0a0a20202d2d20456e7375726520612073696e676c65206167656e747320726f772070657220757365725f69640a20204946204e4f5420455849535453202853454c45435420312046524f4d207075626c69632e6167656e747320574845524520757365725f6964203d204e45572e696429205448454e0a20202020494e5345525420494e544f207075626c69632e6167656e747320280a202020202020757365725f69642c206e616d652c20656d61696c2c207374617475732c206167656e63795f6e616d652c206167656e63795f636f64652c206c6963656e73655f6e756d6265722c20696174615f6e756d6265722c0a202020202020627573696e6573735f616464726573732c20627573696e6573735f70686f6e652c207370656369616c697a6174696f6e732c20636f6d6d697373696f6e5f7374727563747572652c0a202020202020636f756e7472792c20636974792c20627573696e6573735f747970652c20636f6d6d697373696f6e5f747970652c20636f6d6d697373696f6e5f76616c75652c2070726f66696c655f696d6167652c0a202020202020736f757263655f747970652c20736f757263655f64657461696c732c20637265617465645f62792c20637265617465645f62795f73746166662c20776562736974652c20616c7465726e6174655f656d61696c2c0a2020202020206d6f62696c655f6e756d626572732c20646f63756d656e74732c2061737369676e65645f73746166662c20637265617465645f61742c20757064617465645f61740a20202020292056414c55455320280a2020202020204e45572e69642c20757365725f6e616d652c204e45572e656d61696c2c2027616374697665272c206167656e63795f6e616d652c206167656e63795f636f64652c206c6963656e73655f6e756d6265722c20696174615f6e756d6265722c0a202020202020627573696e6573735f616464726573732c20627573696e6573735f70686f6e652c207370656369616c697a6174696f6e732c20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e27636f6d6d697373696f6e5f737472756374757265272c20277b2274797065223a2270657263656e74616765222c2276616c7565223a31307d273a3a6a736f6e62292c0a202020202020757365725f636f756e7472792c20757365725f636974792c20627573696e6573735f747970652c20636f6d6d697373696f6e5f747970652c20636f6d6d697373696f6e5f76616c75652c2070726f66696c655f696d6167652c0a202020202020736f757263655f747970652c20736f757263655f64657461696c732c20637265617465645f62792c20637265617465645f62795f73746166662c20776562736974652c20616c7465726e6174655f656d61696c2c0a2020202020206d6f62696c655f6e756d626572732c20646f63756d656e74732c2061737369676e65645f73746166662c204e4f5728292c204e4f5728290a20202020293b0a2020454c53450a20202020555044415445207075626c69632e6167656e7473205345540a2020202020206e616d65203d20434f414c4553434528757365725f6e616d652c206167656e74732e6e616d65292c0a202020202020656d61696c203d20434f414c45534345284e45572e656d61696c2c206167656e74732e656d61696c292c0a202020202020737461747573203d20434f414c4553434528757365725f7374617475732c206167656e74732e737461747573292c0a2020202020206167656e63795f6e616d65203d20434f414c45534345286167656e63795f6e616d652c206167656e74732e6167656e63795f6e616d65292c0a2020202020206167656e63795f636f6465203d20434f414c45534345286167656e63795f636f64652c206167656e74732e6167656e63795f636f6465292c0a2020202020206c6963656e73655f6e756d626572203d20434f414c45534345286c6963656e73655f6e756d6265722c206167656e74732e6c6963656e73655f6e756d626572292c0a202020202020696174615f6e756d626572203d20434f414c4553434528696174615f6e756d6265722c206167656e74732e696174615f6e756d626572292c0a202020202020627573696e6573735f61646472657373203d20434f414c4553434528627573696e6573735f616464726573732c206167656e74732e627573696e6573735f61646472657373292c0a202020202020627573696e6573735f70686f6e65203d20434f414c4553434528627573696e6573735f70686f6e652c206167656e74732e627573696e6573735f70686f6e65292c0a2020202020207370656369616c697a6174696f6e73203d20434f414c45534345287370656369616c697a6174696f6e732c206167656e74732e7370656369616c697a6174696f6e73292c0a202020202020636f6d6d697373696f6e5f737472756374757265203d20434f414c45534345284e45572e7261775f757365725f6d6574615f646174612d3e27636f6d6d697373696f6e5f737472756374757265272c206167656e74732e636f6d6d697373696f6e5f737472756374757265292c0a202020202020636f756e747279203d20434f414c4553434528757365725f636f756e7472792c206167656e74732e636f756e747279292c0a20202020202063697479203d20434f414c4553434528757365725f636974792c206167656e74732e63697479292c0a202020202020627573696e6573735f74797065203d20434f414c4553434528627573696e6573735f747970652c206167656e74732e627573696e6573735f74797065292c0a202020202020636f6d6d697373696f6e5f74797065203d20434f414c4553434528636f6d6d697373696f6e5f747970652c206167656e74732e636f6d6d697373696f6e5f74797065292c0a202020202020636f6d6d697373696f6e5f76616c7565203d20434f414c4553434528636f6d6d697373696f6e5f76616c75652c206167656e74732e636f6d6d697373696f6e5f76616c7565292c0a20202020202070726f66696c655f696d616765203d20434f414c455343452870726f66696c655f696d6167652c206167656e74732e70726f66696c655f696d616765292c0a202020202020736f757263655f74797065203d20434f414c4553434528736f757263655f747970652c206167656e74732e736f757263655f74797065292c0a202020202020736f757263655f64657461696c73203d20434f414c4553434528736f757263655f64657461696c732c206167656e74732e736f757263655f64657461696c73292c0a202020202020637265617465645f6279203d20434f414c4553434528637265617465645f62792c206167656e74732e637265617465645f6279292c0a202020202020637265617465645f62795f7374616666203d20434f414c4553434528637265617465645f62795f73746166662c206167656e74732e637265617465645f62795f7374616666292c0a20202020202077656273697465203d20434f414c4553434528776562736974652c206167656e74732e77656273697465292c0a202020202020616c7465726e6174655f656d61696c203d20434f414c4553434528616c7465726e6174655f656d61696c2c206167656e74732e616c7465726e6174655f656d61696c292c0a2020202020206d6f62696c655f6e756d62657273203d20434f414c45534345286d6f62696c655f6e756d626572732c206167656e74732e6d6f62696c655f6e756d62657273292c0a202020202020646f63756d656e7473203d20434f414c4553434528646f63756d656e74732c206167656e74732e646f63756d656e7473292c0a20202020202061737369676e65645f7374616666203d20434f414c455343452861737369676e65645f73746166662c206167656e74732e61737369676e65645f7374616666292c0a202020202020757064617465645f6174203d204e4f5728290a20202020574845524520757365725f6964203d204e45572e69643b0a2020454e442049463b0a0a202052455455524e204e45573b0a455843455054494f4e205748454e204f5448455253205448454e0a20205241495345205741524e494e47202768616e646c655f6e65775f75736572206572726f723a2025272c2053514c4552524d3b0a202052455455524e204e45573b0a454e443b0a2424000000754352454154452054524947474552206f6e5f617574685f757365725f637265617465640a414654455220494e53455254204f4e20617574682e75736572730a464f52204541434820524f570a455845435554452046554e4354494f4e207075626c69632e68616e646c655f6e65775f757365722829000000494752414e542045584543555445204f4e2046554e4354494f4e207075626c69632e68616e646c655f6e65775f75736572282920544f2061757468656e746963617465642c20616e6f6e00000039414c5445522046554e4354494f4e207075626c69632e68616e646c655f6e65775f757365722829204f574e455220544f20706f73746772657300000006434f4d4d4954"}],"ResultFormatCodes":[]}
2025/11/05 15:50:23 PG Send: {"Type":"Describe","ObjectType":"P","Name":""}
2025/11/05 15:50:23 PG Send: {"Type":"Execute","Portal":"","MaxRows":0}
2025/11/05 15:50:23 PG Send: {"Type":"Sync"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"BEGIN"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"DROP FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"CREATE TRIGGER"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"GRANT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"ALTER FUNCTION"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"CommandComplete","CommandTag":"COMMIT"}
2025/11/05 15:50:23 PG Recv: {"Type":"ParseComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"BindComplete"}
2025/11/05 15:50:23 PG Recv: {"Type":"NoData"}
2025/11/05 15:50:23 PG Recv: {"Type":"ErrorResponse","Severity":"ERROR","SeverityUnlocalized":"ERROR","Code":"23505","Message":"duplicate key value violates unique constraint \"schema_migrations_pkey\"","Detail":"Key (version)=(20251027) already exists.","Hint":"","Position":0,"InternalPosition":0,"InternalQuery":"","Where":"","SchemaName":"supabase_migrations","TableName":"schema_migrations","ColumnName":"","DataTypeName":"","ConstraintName":"schema_migrations_pkey","File":"nbtinsert.c","Line":666,"Routine":"_bt_check_unique","UnknownFields":null}
2025/11/05 15:50:23 PG Recv: {"Type":"ReadyForQuery","TxStatus":"I"}
2025/11/05 15:50:23 PG Send: {"Type":"Terminate"}
Stopping containers...
Pruned containers: [4ceee2dbbaf55aa6257251b513ffc3543aa1261e4a19a55ff478927decf1cd9c]
Pruned volumes: [supabase_db_xzofytokwszfwiupsdvi supabase_config_xzofytokwszfwiupsdvi]
Pruned network: [supabase_network_xzofytokwszfwiupsdvi]
ERROR: duplicate key value violates unique constraint "schema_migrations_pkey" (SQLSTATE 23505)
Key (version)=(20251027) already exists.                                                       
At statement: 8                                                                                
INSERT INTO supabase_migrations.schema_migrations(version, name, statements) VALUES($1, $2, $3)
