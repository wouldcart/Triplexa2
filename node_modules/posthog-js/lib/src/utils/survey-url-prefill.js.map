{"version":3,"file":"survey-url-prefill.js","sourceRoot":"","sources":["../../../src/utils/survey-url-prefill.ts"],"names":[],"mappings":"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","sourcesContent":["import { Survey, SurveyQuestion, SurveyQuestionType } from '../posthog-surveys-types'\nimport { getSurveyResponseKey } from '../extensions/surveys/surveys-extension-utils'\nimport { logger } from './logger'\nimport { isUndefined } from '@posthog/core'\n\n/**\n * Extracted URL prefill parameters by question index\n */\nexport interface PrefillParams {\n    [questionIndex: number]: string[]\n}\n\n/**\n * Extract prefill parameters from URL search string\n * Format: ?q0=1&q1=8&q2=0&q2=2&auto_submit=true\n * NOTE: Manual parsing for IE11/op_mini compatibility (no URLSearchParams)\n */\nexport function extractPrefillParamsFromUrl(searchString: string): {\n    params: PrefillParams\n    autoSubmit: boolean\n} {\n    const params: PrefillParams = {}\n    let autoSubmit = false\n\n    // Remove leading ? if present\n    const cleanSearch = searchString.replace(/^\\?/, '')\n    if (!cleanSearch) {\n        return { params, autoSubmit }\n    }\n\n    // Split by & to get key-value pairs\n    const pairs = cleanSearch.split('&')\n\n    for (const pair of pairs) {\n        const [key, value] = pair.split('=')\n        if (!key || isUndefined(value)) {\n            continue\n        }\n\n        const decodedKey = decodeURIComponent(key)\n        const decodedValue = decodeURIComponent(value)\n\n        // Check for auto_submit parameter\n        if (decodedKey === 'auto_submit' && decodedValue === 'true') {\n            autoSubmit = true\n            continue\n        }\n\n        // Check for question parameters (q0, q1, etc.)\n        const match = decodedKey.match(/^q(\\d+)$/)\n        if (match) {\n            const questionIndex = parseInt(match[1], 10)\n            if (!params[questionIndex]) {\n                params[questionIndex] = []\n            }\n            params[questionIndex].push(decodedValue)\n        }\n    }\n\n    return { params, autoSubmit }\n}\n\n/**\n * Convert URL prefill values to SDK response format\n */\nexport function convertPrefillToResponses(survey: Survey, prefillParams: PrefillParams): Record<string, any> {\n    const responses: Record<string, any> = {}\n\n    survey.questions.forEach((question: SurveyQuestion, index: number) => {\n        if (!prefillParams[index] || !question.id) {\n            return\n        }\n\n        const values = prefillParams[index]\n        const responseKey = getSurveyResponseKey(question.id)\n\n        try {\n            switch (question.type) {\n                case SurveyQuestionType.SingleChoice: {\n                    if (!question.choices || question.choices.length === 0) {\n                        logger.warn(`[Survey Prefill] Question ${index} has no choices`)\n                        return\n                    }\n                    const choiceIndex = parseInt(values[0], 10)\n                    if (isNaN(choiceIndex) || choiceIndex < 0 || choiceIndex >= question.choices.length) {\n                        logger.warn(`[Survey Prefill] Invalid choice index for q${index}: ${values[0]}`)\n                        return\n                    }\n                    responses[responseKey] = question.choices[choiceIndex]\n                    break\n                }\n\n                case SurveyQuestionType.MultipleChoice: {\n                    if (!question.choices || question.choices.length === 0) {\n                        logger.warn(`[Survey Prefill] Question ${index} has no choices`)\n                        return\n                    }\n                    const choiceIndices = values\n                        .map((v) => parseInt(v, 10))\n                        .filter((i) => !isNaN(i) && i >= 0 && i < question.choices.length)\n\n                    if (choiceIndices.length === 0) {\n                        logger.warn(`[Survey Prefill] No valid choices for q${index}`)\n                        return\n                    }\n\n                    // Remove duplicates and map to choice values\n                    const uniqueChoices = [...new Set(choiceIndices.map((i) => question.choices[i]))]\n                    if (uniqueChoices.length < choiceIndices.length) {\n                        logger.warn(`[Survey Prefill] Removed duplicate choices for q${index}`)\n                    }\n                    responses[responseKey] = uniqueChoices\n                    break\n                }\n\n                case SurveyQuestionType.Rating: {\n                    const rating = parseInt(values[0], 10)\n                    const scale = question.scale || 10\n\n                    if (isNaN(rating) || rating < 0 || rating > scale) {\n                        logger.warn(`[Survey Prefill] Invalid rating for q${index}: ${values[0]} (scale: 0-${scale})`)\n                        return\n                    }\n                    responses[responseKey] = rating\n                    break\n                }\n\n                default:\n                    logger.info(`[Survey Prefill] Question type ${question.type} does not support prefill`)\n            }\n        } catch (error) {\n            logger.error(`[Survey Prefill] Error converting q${index}:`, error)\n        }\n    })\n\n    return responses\n}\n\n/**\n * Check if all REQUIRED questions that support prefill are filled\n */\nexport function allRequiredQuestionsFilled(survey: Survey, responses: Record<string, any>): boolean {\n    return survey.questions.every((question: SurveyQuestion) => {\n        // Optional questions don't block auto-submit\n        if (question.optional) {\n            return true\n        }\n\n        // Link and open questions don't support prefill currently, so they don't block auto-submit\n        // If support is added in the future, they will be checked like other question types below\n        if (question.type === SurveyQuestionType.Link || question.type === SurveyQuestionType.Open) {\n            return true\n        }\n\n        // Required question must have a valid ID and response\n        if (!question.id) {\n            return false\n        }\n\n        const responseKey = getSurveyResponseKey(question.id)\n        const hasResponse = responses.hasOwnProperty(responseKey)\n\n        // For question types that support prefill, require a response\n        return hasResponse\n    })\n}\n"]}